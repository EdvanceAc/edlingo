<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdLingo Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%8D%3C/text%3E%3C/svg%3E" />
    <script src="/env.js"></script>
    <script>
        // Fallback loader if /env.js fails (e.g., served on 127.0.0.1 or different base)
        (function(){
          function loadScript(src){
            return new Promise((resolve)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>resolve(true); s.onerror=()=>resolve(false); document.head.appendChild(s); });
          }
          if(!window.__ENV__){
            const candidates = [
              '/env.js',
              './env.js',
              location.origin + '/env.js'
            ];
            (async ()=>{
              for(const c of candidates){
                const ok = await loadScript(c);
                if(ok && window.__ENV__){ console.log('env.js loaded from', c); break; }
              }
              if(!window.__ENV__){ console.warn('env.js could not be loaded; will rely on localStorage if available'); }
            })();
          }
        })();
    </script>
    <script type="module">
        // Utility function to detect if we're in Electron environment
        window.isElectron = typeof window.electronAPI !== 'undefined' && !(window.electronAPI && window.electronAPI._isShim);
        
        // Mock MCP client for browser environments
        if (!window.isElectron) {
            // For browser environments, provide simplified MCP functionality
            window.mcpSQL = {
                execute: async (query, options = {}) => {
                    console.log('Browser MCP client: executing SQL', query);
                    // Return mock data for demonstration
                    return {
                        success: false,
                        error: { message: 'MCP client requires Electron environment' },
                        data: null
                    };
                },
                test: async () => ({ success: false, error: 'MCP not available in browser' })
            };
        }
    </script>

    <style>
        /* Existing styles kept for compatibility */
        .admin-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Modern luxury theme additions */
        :root {
          --lux-primary: #6366f1; /* indigo-500 */
          --lux-secondary: #22d3ee; /* cyan-400 */
          --lux-accent: #a78bfa; /* violet-400 */
          --lux-card-bg: rgba(255, 255, 255, 0.7);
          --lux-border: rgba(255, 255, 255, 0.55);
        }

        body {
          position: relative;
          background-image:
            radial-gradient(90rem 40rem at 10% -10%, rgba(99,102,241,0.08), transparent 60%),
            radial-gradient(90rem 40rem at 90% 0%, rgba(34,211,238,0.08), transparent 60%);
          background-repeat: no-repeat;
        }

        .glass-card {
          background: var(--lux-card-bg);
          -webkit-backdrop-filter: saturate(140%) blur(12px);
          backdrop-filter: saturate(140%) blur(12px);
          border: 1px solid var(--lux-border);
          border-radius: 16px;
          box-shadow: 0 10px 30px rgba(2,6,23,0.06);
        }

        .gradient-border { position: relative; border-radius: 16px; }
        .gradient-border::before {
          content: "";
          position: absolute;
          inset: 0;
          padding: 1px;
          border-radius: inherit;
          background: linear-gradient(135deg, var(--lux-primary), var(--lux-secondary));
          -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
          mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
          -webkit-mask-composite: xor;
                  mask-composite: exclude;
          pointer-events: none;
        }

        .shine-on-hover { position: relative; overflow: hidden; }
        .shine-on-hover::after {
          content: '';
          position: absolute;
          inset: -150% -30%;
          background: linear-gradient(120deg, transparent, rgba(255,255,255,0.35), transparent);
          transform: translateX(-100%);
        }
        .shine-on-hover:hover::after { animation: shine 1.2s ease; }
        @keyframes shine { to { transform: translateX(100%); } }

        .section-title {
          background: linear-gradient(135deg, var(--lux-primary), var(--lux-secondary));
          -webkit-background-clip: text;
                  background-clip: text;
          color: transparent;
        }

        .icon-blob { position: relative; z-index: 0; }
        .icon-blob::before {
          content: '';
          position: absolute;
          inset: -6px;
          border-radius: 9999px;
          background: radial-gradient(circle at 50% 50%, rgba(99,102,241,0.25), transparent 60%);
          filter: blur(3px);
          z-index: -1;
        }

        .lux-action {
          border-radius: 14px;
          border: 1px solid transparent;
          background: linear-gradient(#ffffff,#ffffff) padding-box,
                      linear-gradient(135deg, rgba(99,102,241,0.6), rgba(34,211,238,0.6)) border-box;
          transition: all .25s ease;
        }
        .lux-action:hover {
          background: linear-gradient(rgba(255,255,255,0.92), rgba(255,255,255,0.92)) padding-box,
                      linear-gradient(135deg, var(--lux-primary), var(--lux-secondary)) border-box;
          box-shadow: 0 10px 25px rgba(2,6,23,.06);
          transform: translateY(-2px);
        }

        .lux-muted {
          color: rgb(75 85 99); /* gray-600 */
        }

        /* Luxury Header Buttons */
        .glass-icon-btn {
          width: 36px; height: 36px;
          display: inline-flex; align-items: center; justify-content: center;
          border-radius: 12px;
          border: 1px solid rgba(255,255,255,0.35);
          background: rgba(255,255,255,0.18);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          transition: all .25s ease;
        }
        .glass-icon-btn:hover {
          background: rgba(255,255,255,0.28);
          transform: translateY(-1px);
          box-shadow: 0 10px 24px rgba(2,6,23,.12);
        }
        .glass-icon-btn i { transition: transform .25s ease; }
        .glass-icon-btn:hover i { transform: scale(1.05) rotate(8deg); }

        /* Header ornaments */
        .header-ornament { position: absolute; inset: 0; pointer-events: none; }
        .header-ornament .blob { position: absolute; filter: blur(24px); opacity: .35; }
        .header-ornament .blob.b1 { width: 220px; height: 220px; top: -40px; left: -40px; background: radial-gradient(closest-side, var(--lux-primary), transparent); }
        .header-ornament .blob.b2 { width: 260px; height: 260px; right: -60px; bottom: -60px; background: radial-gradient(closest-side, var(--lux-secondary), transparent); }
        .brand-glow { text-shadow: 0 2px 10px rgba(255,255,255,.25); }

        /* Luxury Tabs */
        .lux-tabs { position: sticky; top: 0; z-index: 30; }
        .lux-tab { position: relative; border-bottom: 2px solid transparent; border-radius: 10px; transition: all .25s ease; }
        .lux-tab:hover { background: linear-gradient(180deg, rgba(99,102,241,0.08), rgba(34,211,238,0.06)); transform: translateY(-1px); }
        .lux-tab::after { content: ""; position: absolute; left: 10px; right: 10px; bottom: -2px; height: 2px; border-radius: 2px;
          background: linear-gradient(90deg, var(--lux-primary), var(--lux-secondary)); transform: scaleX(0); transform-origin: left; transition: transform .25s ease; }
        .lux-tab:hover::after { transform: scaleX(1); }
        .lux-tab.border-blue-500::after { transform: scaleX(1); }
        .lux-tab i { transition: transform .25s ease, color .25s ease; }
        .lux-tab:hover i { transform: translateY(-1px); }

        /* Tooltip (glass) via global portal (prevents clipping) */
        .tooltip { position: relative; }
        .tooltip::before, .tooltip::after { display: none !important; }
        #tooltip-portal { position: fixed; left: 0; top: 0; opacity: 0; visibility: hidden; pointer-events: none; z-index: 1000;
          background: rgba(17,24,39,0.86); color: #fff; padding: 8px 12px; font-size: 12px; line-height: 1.2; border-radius: 8px;
          border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 10px 24px rgba(2,6,23,.25); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
          white-space: nowrap; transform: translate(-50%, 4px) scale(.98); transition: opacity .15s ease, transform .15s ease; }
        #tooltip-portal.visible { opacity: 1; visibility: visible; transform: translate(-50%, 0) scale(1); }
        #tooltip-portal::after { content: ""; position: absolute; width: 10px; height: 10px; background: rgba(17,24,39,0.86);
          border-left: 1px solid rgba(255,255,255,0.14); border-top: 1px solid rgba(255,255,255,0.14); transform: rotate(45deg); }
        #tooltip-portal[data-placement="bottom"]::after { top: -5px; left: 50%; transform: translateX(-50%) rotate(45deg); }
        #tooltip-portal[data-placement="top"]::after { bottom: -5px; left: 50%; transform: translateX(-50%) rotate(45deg); }
        /* Safety: prevent accidental horizontal overflow */
        html, body { max-width: 100%; overflow-x: hidden; }

        /* Minimal Dark Theme scaffold (non-invasive) */
        [data-theme="dark"] body { background: radial-gradient(circle at 20% 0%, rgba(2,6,23,1) 0%, rgba(15,23,42,1) 45%, rgba(17,24,39,1) 100%); }
        [data-theme="dark"] .admin-gradient { background: linear-gradient(135deg, #242850 0%, #282e63 50%, #0f1a3a 100%); }
        [data-theme="dark"] nav.bg-white { background: rgba(15,23,42,0.70) !important; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-color: rgba(148,163,184,0.18) !important; }
        [data-theme="dark"] .glass-icon-btn { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.28); }
        [data-theme="dark"] .glass-icon-btn:hover { background: rgba(255,255,255,0.20); box-shadow: 0 10px 28px rgba(0,0,0,.35); }
        [data-theme="dark"] .section-title { background: linear-gradient(90deg, #93c5fd, #67e8f9); -webkit-background-clip: text; background-clip: text; color: transparent; }
        /* Overview polish: reveal animations, KPI numbers, activity timeline, and interactions */
        .reveal { opacity: 0; transform: translateY(12px) scale(.98); transition: opacity .45s ease, transform .45s cubic-bezier(.22,.61,.36,1); transition-delay: var(--reveal-delay, 0ms); }
        .reveal.revealed { opacity: 1; transform: none; }
        .kpi-number { font-variant-numeric: tabular-nums; letter-spacing: 0.2px; display: inline-block; transform-origin: center; }
        /* KPI pulse animation */
        .kpi-pulse { animation: kpiPulse .5s ease-out; }
        @keyframes kpiPulse { 0% { transform: scale(1) } 20% { transform: scale(1.08) } 100% { transform: scale(1) } }
        #overview-content .glass-card:hover { box-shadow: 0 18px 40px rgba(2,6,23,.10); }
        /* Quick Actions micro-interactions */
        .lux-action { position: relative; overflow: hidden; }
        .lux-action:active { transform: translateY(0) scale(.98); }
        .lux-action::before { content:""; position:absolute; inset:0; background: radial-gradient(300px 120px at var(--rx,50%) var(--ry,50%), rgba(99,102,241,.12), transparent 60%); opacity:0; transition: opacity .25s ease; }
        .lux-action:hover::before { opacity:1; }
        /* Recent Activity timeline styling (non-invasive) */
        #activity-list.activity-timeline { position: relative; margin-left: 10px; padding-left: 8px; border-left: 2px dashed rgba(99,102,241,.22); }
        #activity-list .activity-item { position: relative; padding-left: 10px; }
        #activity-list .activity-item::before { content: ""; position: absolute; left: -10px; top: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 9999px; background: linear-gradient(135deg, var(--lux-primary), var(--lux-secondary)); box-shadow: 0 0 0 2px #fff; }
        /* Motion preferences */
        @media (prefers-reduced-motion: reduce) {
          .reveal { opacity: 1 !important; transform: none !important; transition: none !important; }
          .glass-card, .lux-action, .lux-tab, .glass-icon-btn { transition: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Notifications Container -->
    <div id="toast-container" aria-live="polite" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none"></div>

    <!-- Global Loading Overlay -->
    <div id="global-loading" class="fixed inset-0 bg-gray-900 bg-opacity-30 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-xl shadow-xl px-5 py-4 flex items-center space-x-3">
            <div class="h-6 w-6 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-gray-700 text-sm font-medium" id="global-loading-text">Loading...</div>
        </div>
    </div>
    <!-- Header -->
    <header class="admin-gradient text-white shadow-lg relative overflow-hidden">
        <div class="header-ornament" aria-hidden="true">
            <div class="blob b1"></div>
            <div class="blob b2"></div>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i data-lucide="graduation-cap" class="w-8 h-8 mr-3"></i>
                    <h1 class="text-2xl font-bold brand-glow">EdLingo Admin Dashboard</h1>
                </div>
                <div class="flex items-center space-x-3 overflow-visible">
                    <span class="text-sm opacity-90">Welcome, Admin</span>
                    <button class="glass-icon-btn tooltip" onclick="refreshData()" aria-label="Refresh" data-tooltip="Refresh data">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button class="glass-icon-btn tooltip" onclick="toggleDarkMode()" aria-label="Dark Mode" data-tooltip="Toggle dark/light mode">
                        <i id="theme-icon" data-lucide="moon" class="w-4 h-4"></i>
                    </button>
                    <button class="glass-icon-btn tooltip" onclick="logout()" aria-label="Logout" data-tooltip="Sign out">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm border-b border-gray-200 lux-tabs">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-2 sm:space-x-4">
                <button id="overview-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-blue-500 text-blue-600 font-medium" onclick="showTab('overview')">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span>Overview</span>
                </button>
                <button id="users-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('users')">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Users</span>
                </button>
                <button id="courses-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('courses')">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span>Courses</span>
                </button>
                <button id="assessments-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showAssessmentsTab()">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    <span>CEFR Assessments</span>
                </button>
                <button id="files-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showFilesTab()">
                    <i data-lucide="folder" class="w-5 h-5"></i>
                    <span>Files</span>
                </button>
                <button id="support-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('support')">
                    <i data-lucide="life-buoy" class="w-5 h-5"></i>
                    <span>Support</span>
                </button>
                <button id="notifications-tab" class="lux-tab flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('notifications')">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span>Notifications</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Tab -->
        <div id="overview-content" class="tab-content">
            <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 reveal" style="--reveal-delay: 40ms">
            <div class="bg-white glass-card gradient-border shine-on-hover rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 icon-blob">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Users</p>
                        <p class="text-2xl font-semibold text-gray-900 kpi-number" id="total-users">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white glass-card gradient-border shine-on-hover rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 icon-blob">
                        <i data-lucide="book-open" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Grammar Lessons</p>
                        <p class="text-2xl font-semibold text-gray-900 kpi-number" id="total-lessons">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white glass-card gradient-border shine-on-hover rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 icon-blob">
                        <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Vocabulary Words</p>
                        <p class="text-2xl font-semibold text-gray-900 kpi-number" id="total-vocabulary">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white glass-card gradient-border shine-on-hover rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 icon-blob">
                        <i data-lucide="trophy" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Achievements</p>
                        <p class="text-2xl font-semibold text-gray-900 kpi-number" id="total-achievements">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Quick Actions -->
        <div class="bg-white glass-card gradient-border mb-8">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="text-lg font-semibold section-title">Quick Actions</h2>
                <div class="hidden md:flex items-center text-sm lux-muted">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    <span>Speed up your workflow</span>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button class="lux-action flex items-center justify-center p-5 border rounded-lg transition-all shine-on-hover" onclick="showTab('courses')">
                        <div class="text-center">
                            <i data-lucide="book-open" class="w-8 h-8 mx-auto text-gray-500 mb-2"></i>
                            <span class="text-sm font-medium text-gray-800">Manage Courses</span>
                        </div>
                    </button>
                    <button class="lux-action flex items-center justify-center p-5 border rounded-lg transition-all shine-on-hover" onclick="showTab('assignments')">
                        <div class="text-center">
                            <i data-lucide="file-text" class="w-8 h-8 mx-auto text-gray-500 mb-2"></i>
                            <span class="text-sm font-medium text-gray-800">Manage Assignments</span>
                        </div>
                    </button>
                    <button class="lux-action flex items-center justify-center p-5 border rounded-lg transition-all shine-on-hover" onclick="showTab('users')">
                        <div class="text-center">
                            <i data-lucide="users" class="w-8 h-8 mx-auto text-gray-500 mb-2"></i>
                            <span class="text-sm font-medium text-gray-800">Manage Users</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="bg-white glass-card gradient-border mb-8">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="text-lg font-semibold section-title">Recent Activity</h2>
                <div class="hidden md:flex items-center text-sm lux-muted">
                    <i data-lucide="activity" class="w-4 h-4 mr-2"></i>
                    <span>Latest events across the platform</span>
                </div>
            </div>
            <div class="p-6">
                <div id="activity-list">
                    <div class="loading text-center text-gray-500">Loading recent activity...</div>
                </div>
            </div>
        </div>

        <!-- Data Management Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Vocabulary Management -->
            <div class="bg-white glass-card gradient-border shine-on-hover">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-lg font-semibold section-title">Vocabulary Management</h2>
                    <div class="hidden md:flex items-center text-sm lux-muted">
                        <i data-lucide="list" class="w-4 h-4 mr-2"></i>
                        <span>Manage your word sets</span>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="vocabulary-list">
                        <div class="loading text-center text-gray-500">Loading vocabulary...</div>
                    </div>
                </div>
            </div>

            <!-- Grammar Lessons Management -->
            <div class="bg-white glass-card gradient-border shine-on-hover">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-lg font-semibold section-title">Grammar Lessons</h2>
                    <div class="hidden md:flex items-center text-sm lux-muted">
                        <i data-lucide="graduation-cap" class="w-4 h-4 mr-2"></i>
                        <span>Curate and refine lessons</span>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="lessons-list">
                        <div class="loading text-center text-gray-500">Loading lessons...</div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Support Tab -->
        <div id="support-content" class="tab-content hidden">
            <div class="bg-white glass-card gradient-border mb-8">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-blue-50 text-blue-600 mr-3">
                            <i data-lucide="life-buoy" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold section-title">Support Center</h2>
                            <p class="text-xs lux-muted">View tickets and reply in realtime</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Ticket list -->
                        <div class="md:col-span-1 border rounded-lg overflow-hidden">
                            <div class="px-4 py-3 border-b font-medium">Tickets</div>
                            <div id="support-ticket-list" class="max-h-[60vh] overflow-auto">
                                <div class="p-4 text-sm text-gray-500">Loading tickets...</div>
                            </div>
                        </div>
                        <!-- Thread -->
                        <div class="md:col-span-2 border rounded-lg flex flex-col min-h-[60vh]">
                            <div id="support-thread-header" class="px-4 py-3 border-b font-medium">Select a ticket</div>
                            <div id="support-message-list" class="flex-1 overflow-auto p-4 space-y-3">
                                <div class="text-sm text-gray-500">No ticket selected.</div>
                            </div>
                            <div class="border-t p-3">
                                <div class="flex items-end gap-2">
                                    <textarea id="support-reply-text" rows="2" class="flex-1 border rounded-md p-2" placeholder="Type a reply..."></textarea>
                                    <button id="support-reply-send" class="px-4 py-2 rounded-md bg-blue-600 text-white disabled:opacity-60">Send</button>
                                </div>
                                <div id="support-reply-hint" class="text-[11px] text-gray-500 mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-content" class="tab-content hidden">
            <!-- Users Management (Redesigned) -->
            <div class="bg-white glass-card gradient-border shine-on-hover mb-8">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-blue-50 text-blue-600 mr-3">
                            <i data-lucide="users" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold section-title">User Management</h2>
                            <p class="text-xs lux-muted">Manage accounts, monitor activity, and perform quick actions</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="hidden sm:inline-flex items-center px-2.5 py-1 rounded-full text-xs bg-blue-50 text-blue-700 border border-blue-100" id="users-total-chip">Total: <span id="users-total-count" class="ml-1">0</span></span>
                        <button id="export-users-btn" class="lux-action px-3 py-2 rounded-lg flex items-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Export CSV
                        </button>
                        <button id="refresh-users-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="relative">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input id="users-search" type="text" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Search users...">
                        </div>
                        <select id="users-level-filter" class="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="elementary">Elementary</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        <select id="users-activity-filter" class="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">All Activity</option>
                            <option value="active">Active (7 days)</option>
                            <option value="inactive">Inactive (30+ days)</option>
                            <option value="new">New Users (7 days)</option>
                        </select>
                        <div class="flex items-center space-x-2">
                            <select id="users-per-page" class="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors" onclick="sortUsersTable('id')">
                                    <div class="flex items-center">
                                        User ID
                                        <i data-lucide="chevrons-up-down" class="w-3 h-3 ml-1 opacity-50"></i>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors" onclick="sortUsersTable('email')">
                                    <div class="flex items-center">
                                        Email
                                        <i data-lucide="chevrons-up-down" class="w-3 h-3 ml-1 opacity-50"></i>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors" onclick="sortUsersTable('name')">
                                    <div class="flex items-center">
                                        Full Name
                                        <i data-lucide="chevrons-up-down" class="w-3 h-3 ml-1 opacity-50"></i>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors" onclick="sortUsersTable('created')">
                                    <div class="flex items-center">
                                        Joined
                                        <i data-lucide="chevrons-up-down" class="w-3 h-3 ml-1 opacity-50"></i>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Progress & Activity
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="users-table-body-tab">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
                                        <div class="text-sm font-medium">Loading users...</div>
                                        <div class="text-xs text-gray-400 mt-1">Please wait while we fetch user data</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between" id="users-pagination" style="display: none;">
                    <div class="flex items-center text-sm text-gray-600">
                        <span>Showing <span id="users-showing-start">1</span> to <span id="users-showing-end">25</span> of <span id="users-showing-total">0</span> users</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="users-prev-page" class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <div id="users-page-numbers" class="flex items-center space-x-1">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button id="users-next-page" class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
















        </div>

        <!-- Courses Tab -->
        <div id="courses-content" class="tab-content hidden">
            <!-- Course Management Header -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Course Management</h2>
                        <div class="flex space-x-3">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showTemplateGallery()">
                                <i data-lucide="layout-template" class="w-4 h-4 mr-2"></i>
                                Templates
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddCourseModal()">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Create Course
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Course Sub-navigation -->
                <div class="px-6">
                    <nav class="flex space-x-8" aria-label="Course Tabs">
                        <button id="course-overview-tab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="showCourseSubTab('overview')">
                            Overview
                        </button>
                        <button id="course-ai-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('ai')">
                            AI Creation
                        </button>
                        <button id="course-templates-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('templates')">
                            Templates
                        </button>
                        <button id="course-versions-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('versions')">
                            Version Control
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Course Overview Sub-tab -->
            <div id="course-overview-content" class="course-subtab-content">
                <!-- Course Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i data-lucide="book-open" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Courses</p>
                                <p class="text-2xl font-semibold text-gray-900" id="total-courses-stat">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Enrolled Students</p>
                                <p class="text-2xl font-semibold text-gray-900" id="enrolled-students-stat">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i data-lucide="trending-up" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Completion Rate</p>
                                <p class="text-2xl font-semibold text-gray-900" id="completion-rate-stat">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i data-lucide="star" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Avg Rating</p>
                                <p class="text-2xl font-semibold text-gray-900" id="avg-rating-stat">0.0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <div class="flex flex-col space-y-4 lg:flex-row lg:justify-between lg:items-center lg:space-y-0">
                            <h3 class="text-lg font-semibold text-gray-900">All Courses</h3>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 items-stretch sm:items-center lg:w-auto w-full">
                                <div class="relative group flex-1">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 transition-colors group-focus-within:text-blue-500"></i>
                                    <input type="text" placeholder="Search courses..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 hover:border-gray-400 focus:shadow-lg" id="course-search">
                                </div>
                                <div class="relative">
                                    <select class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 hover:border-gray-400 focus:shadow-lg appearance-none bg-white pr-8" id="course-filter">
                                        <option value="">All Levels</option>
                                        <option value="A1">A1 - Beginner</option>
                                        <option value="A2">A2 - Elementary</option>
                                        <option value="B1">B1 - Intermediate</option>
                                        <option value="B2">B2 - Upper Intermediate</option>
                                        <option value="C1">C1 - Advanced</option>
                                        <option value="C2">C2 - Proficient</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none"></i>
                                </div>
                                <button class="px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-md" id="clear-filters" title="Clear Filters">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        <!-- Loading State -->
                        <div id="courses-loading" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Skeleton Card 1 -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                                    <div class="h-3 bg-gray-200 rounded w-2/3 mb-4"></div>
                                    <div class="flex justify-between items-center">
                                        <div class="h-6 bg-gray-200 rounded w-16"></div>
                                        <div class="h-8 bg-gray-200 rounded w-20"></div>
                                    </div>
                                </div>
                                <!-- Skeleton Card 2 -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                                    <div class="h-3 bg-gray-200 rounded w-2/3 mb-4"></div>
                                    <div class="flex justify-between items-center">
                                        <div class="h-6 bg-gray-200 rounded w-16"></div>
                                        <div class="h-8 bg-gray-200 rounded w-20"></div>
                                    </div>
                                </div>
                                <!-- Skeleton Card 3 -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                                    <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                                    <div class="h-3 bg-gray-200 rounded w-2/3 mb-4"></div>
                                    <div class="flex justify-between items-center">
                                        <div class="h-6 bg-gray-200 rounded w-16"></div>
                                        <div class="h-8 bg-gray-200 rounded w-20"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Courses Grid -->
                        <div id="courses-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Empty State -->
                            <div id="courses-empty" class="col-span-full text-center py-12">
                                <i data-lucide="book-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
                                <p class="text-gray-500 mb-6">Create your first course to get started.</p>
                                <button class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center mx-auto" onclick="showAddCourseModal()">
                                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                    Create Course
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Assignment Management</h2>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddAssignmentModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Assignment
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="assignments-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="file-text" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No assignments found</h3>
                            <p class="text-gray-500 mb-4">Create your first assignment to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddAssignmentModal()">
                                Create Assignment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Tab -->
        <div id="questions-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Question Management</h2>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddQuestionModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Question
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Assignment/Test Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Assignment/Test</label>
                        <select id="questionAssignmentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadQuestionsForAssignment()">
                            <option value="">Select an assignment or test...</option>
                        </select>
                    </div>
                    
                    <!-- Questions List -->
                    <div id="questions-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="help-circle" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No questions found</h3>
                            <p class="text-gray-500 mb-4">Select an assignment or test above, then create your first question.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddQuestionModal()" disabled id="createQuestionBtn">
                                Create Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CEFR Assessments Tab -->
        <div id="assessments-content" class="tab-content hidden">
            <!-- Assessment Overview Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Assessments</p>
                            <p class="text-2xl font-semibold text-gray-900" id="total-assessments">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i data-lucide="users" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Students Assessed</p>
                            <p class="text-2xl font-semibold text-gray-900" id="students-assessed">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i data-lucide="target" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Avg CEFR Level</p>
                            <p class="text-2xl font-semibold text-gray-900" id="avg-cefr-level">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i data-lucide="trending-up" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Completion Rate</p>
                            <p class="text-2xl font-semibold text-gray-900" id="completion-rate">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Management Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button id="assessment-questions-tab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="showAssessmentSubTab('questions')">
                            Question Bank
                        </button>
                        <button id="assessment-analytics-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showAssessmentSubTab('analytics')">
                            Analytics Dashboard
                        </button>
                        <button id="assessment-settings-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showAssessmentSubTab('settings')">
                            CEFR Settings
                        </button>
                    </nav>
                </div>

                <!-- Question Bank Sub-tab -->
                <div id="assessment-questions-content" class="assessment-subtab-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">CEFR Assessment Questions</h3>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showCreateAssessmentQuestionModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Question
                        </button>
                    </div>

                    <!-- CEFR Level Filter -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <select id="cefr-level-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All CEFR Levels</option>
                            <option value="A1">A1 - Beginner</option>
                            <option value="A2">A2 - Elementary</option>
                            <option value="B1">B1 - Intermediate</option>
                            <option value="B2">B2 - Upper Intermediate</option>
                            <option value="C1">C1 - Advanced</option>
                            <option value="C2">C2 - Proficient</option>
                        </select>
                        <select id="skill-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All Skills</option>
                            <option value="reading">Reading</option>
                            <option value="writing">Writing</option>
                            <option value="listening">Listening</option>
                            <option value="speaking">Speaking</option>
                        </select>
                        <select id="question-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All Question Types</option>
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="fill_blank">Fill in the Blank</option>
                            <option value="essay">Essay</option>
                            <option value="listening_comprehension">Listening Comprehension</option>
                            <option value="speaking_prompt">Speaking Prompt</option>
                        </select>
                    </div>

                    <!-- Questions List -->
                    <div id="assessment-questions-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No assessment questions found</h3>
                            <p class="text-gray-500 mb-4">Create your first CEFR assessment question to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showCreateAssessmentQuestionModal()">
                                Create Question
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Dashboard Sub-tab -->
                <div id="assessment-analytics-content" class="assessment-subtab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Student Assessment Analytics</h3>
                    
                    <!-- CEFR Level Distribution Chart -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">CEFR Level Distribution</h4>
                            <div id="cefr-distribution-chart" class="h-64">
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <i data-lucide="bar-chart-3" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">Assessment Progress</h4>
                            <div id="progress-chart" class="h-64">
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <i data-lucide="trending-up" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Progress chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Performance Table -->
                    <div class="bg-white border border-gray-200 rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h4 class="text-md font-semibold text-gray-900">Student Performance Overview</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current CEFR Level</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reading</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Writing</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listening</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Speaking</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Assessment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="student-performance-table">
                                    <tr>
                                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                            <div class="loading">Loading student performance data...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CEFR Settings Sub-tab -->
                <div id="assessment-settings-content" class="assessment-subtab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">CEFR Assessment Configuration</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Level Thresholds -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">CEFR Level Thresholds</h4>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">A1 (Beginner)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="0" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 20%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">A2 (Elementary)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="21" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 40%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">B1 (Intermediate)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="41" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 60%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">B2 (Upper Intermediate)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="61" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 75%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">C1 (Advanced)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="76" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 90%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">C2 (Proficient)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="91" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 100%</span>
                                </div>
                            </div>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                Save Thresholds
                            </button>
                        </div>

                        <!-- Assessment Settings -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">Assessment Configuration</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Questions per Assessment</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="25" min="10" max="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="45" min="15" max="120">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Adaptive Assessment</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="enabled">Enabled</option>
                                        <option value="disabled">Disabled</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Retake Policy</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="unlimited">Unlimited</option>
                                        <option value="once_per_week">Once per week</option>
                                        <option value="once_per_month">Once per month</option>
                                        <option value="no_retakes">No retakes</option>
                                    </select>
                                </div>
                            </div>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files Tab -->
        <div id="files-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">File Management</h2>
                        <div class="flex space-x-3">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showUploadModal()">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Upload Files
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="refreshFiles()">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Storage Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-blue-100 text-blue-600">
                                    <i data-lucide="hard-drive" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Total Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="total-files">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-green-100 text-green-600">
                                    <i data-lucide="database" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Storage Used</p>
                                    <p class="text-xl font-semibold text-gray-900" id="storage-used">0 MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-yellow-100 text-yellow-600">
                                    <i data-lucide="folder" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Course Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="course-files">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-purple-100 text-purple-600">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Assignment Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="assignment-files">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Filters -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="flex-1 min-w-64">
                            <input type="text" id="file-search" placeholder="Search files..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <select id="file-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                            <option value="image">Images</option>
                        </select>
                        <select id="file-category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Categories</option>
                            <option value="courses">Courses</option>
                            <option value="assignments">Assignments</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <!-- Files List -->
                    <div id="files-list" class="space-y-3">
                        <div class="text-center py-12">
                            <i data-lucide="folder-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No files found</h3>
                            <p class="text-gray-500 mb-4">Upload your first file to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showUploadModal()">
                                Upload Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Composer -->
                <div class="bg-white glass-card gradient-border shine-on-hover lg:col-span-2">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold section-title">Create Notification</h2>
                            <p class="text-xs lux-muted">Send announcements directly from the dashboard.</p>
                        </div>
                        <span id="notification-last-sent" class="text-xs text-gray-400">Never sent</span>
                    </div>
                    <div class="p-6">
                        <details class="mb-5 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <summary class="text-sm font-semibold text-blue-700 cursor-pointer">Sending Tips</summary>
                            <p class="text-sm text-gray-700 mt-3">
                                 <strong>Message</strong>: keep it short and actionable (e.g., 50% off this week).<br>
                                 <strong>Type</strong>: choose the tone that best matches your content (Info, Success, Reminder).<br>
                                 <strong>Priority</strong>: use High only for urgent alerts so learners notice the badge immediately.<br>
                                 <strong>Audience</strong>:<br>
                                &nbsp;&nbsp; <em>All learners</em> sends it to everyone.<br>
                                &nbsp;&nbsp; <em>Specific learners</em>: fill Target identifiers with username, email, or user_id (comma separated).<br>
                                &nbsp;&nbsp; <em>Course enrollees</em>: provide course UUIDs in Course IDs.<br>
                                 <strong>Action URL</strong>: optional link that opens when the learner taps the notification.<br>
                                 Toggle Show immediately to control whether the message is visible right after dispatch.
                            </p>
                        </details>
                        <form id="notification-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" name="title" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Week Warrior unlocked">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Message *</label>
                                <textarea name="message" rows="4" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Share the update" required></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select name="type" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="info">Info</option>
                                        <option value="success">Success</option>
                                        <option value="reminder">Reminder</option>
                                        <option value="achievement">Achievement</option>
                                        <option value="discount">Discount</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select name="priority" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Audience</label>
                                <select name="audience" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">All learners</option>
                                    <option value="user">Specific learners (comma separated)</option>
                                    <option value="course">Course enrollees (course IDs)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Target identifiers</label>
                                <input type="text" name="targetIdentifiers" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="username, email or user_id">
                                <p class="text-xs text-gray-500 mt-1">Only required when audience = specific learners.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course IDs</label>
                                <input type="text" name="courseIds" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="uuid-1, uuid-2">
                                <p class="text-xs text-gray-500 mt-1">Only required when audience = course enrollees.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Action URL</label>
                                <input type="url" name="actionUrl" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/lesson">
                            </div>
                            <label class="inline-flex items-center text-sm text-gray-700">
                                <input type="checkbox" name="isVisible" class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                Show immediately after sending
                            </label>
                            <button id="send-notification-btn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                                <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                                Send Notification
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Feed -->
                <div class="bg-white glass-card gradient-border shine-on-hover lg:col-span-3">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold section-title">Recent Deliveries</h2>
                            <div class="text-xs text-gray-500 flex items-center gap-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-700" id="notification-realtime-chip">Realtime: idle</span>
                                <span id="notification-feed-count">0 entries</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="glass-icon-btn" onclick="refreshNotificationFeed()" aria-label="Refresh feed">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div id="notification-feed" class="p-6 space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="bell" class="w-8 h-8 mx-auto mb-2"></i>
                            <p>No notifications yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-500"> 2024 EdLingo Admin Dashboard. All rights reserved.</p>
                <div class="flex space-x-4">
                    <span class="text-xs text-gray-400" id="last-updated">Last updated: Never</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Course Creation Wizard Modal -->
    <div id="courseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[95vh] overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 id="courseModalTitle" class="text-xl font-semibold text-gray-900">Create New Course</h3>
                        <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <!-- Progress Indicator -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span id="stepIndicator">Step 1 of 4</span>
                            <span id="stepTitle">Basic Information</span>
                        </div>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="flex h-[calc(95vh-140px)]">
                    <!-- Step Navigation -->
                    <div class="w-56 bg-gray-50 border-r border-gray-200 p-4">
                        <nav class="space-y-2">
                            <div id="step1Nav" class="flex items-center p-3 rounded-lg bg-blue-100 text-blue-700 cursor-pointer" onclick="showWizardStep(1)">
                                <div class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center mr-3">1</div>
                                <span class="text-sm font-medium">Basic Info</span>
                            </div>
                            <div id="step2Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(2)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">2</div>
                                <span class="text-sm font-medium">Course Content</span>
                            </div>
                            <div id="step3Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(3)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">3</div>
                                <span class="text-sm font-medium">Instructor Settings</span>
                            </div>
                            <div id="step4Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(4)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">4</div>
                                <span class="text-sm font-medium">Review & Publish</span>
                            </div>
                        </nav>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="flex-1 overflow-y-auto">
                        <form id="courseForm" class="h-full">
                            <!-- Step 1: Basic Information -->
                            <div id="step-1" class="step-content p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Course Information</h4>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Title *</label>
                                        <input type="text" id="courseTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Category</label>
                                        <select id="courseCategory" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="general">General English</option>
                                            <option value="business">Business English</option>
                                            <option value="academic">Academic English</option>
                                            <option value="conversation">Conversation</option>
                                            <option value="grammar">Grammar</option>
                                            <option value="vocabulary">Vocabulary</option>
                                            <option value="pronunciation">Pronunciation</option>
                                            <option value="test-prep">Test Preparation</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Description</label>
                                    <textarea id="courseDescription" name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Describe what students will learn in this course..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">CEFR Level</label>
                                        <select id="cefrLevel" name="level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="A1">A1 - Beginner</option>
                                            <option value="A2">A2 - Elementary</option>
                                            <option value="B1">B1 - Intermediate</option>
                                            <option value="B2">B2 - Upper Intermediate</option>
                                            <option value="C1">C1 - Advanced</option>
                                            <option value="C2">C2 - Proficiency</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Language</label>
                                        <select id="courseLanguage" name="language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="it">Italian</option>
                                            <option value="pt">Portuguese</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Duration (weeks)</label>
                                        <input type="number" id="courseDuration" name="duration" min="1" max="52" value="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Hours per week</label>
                                        <input type="number" id="courseHours" name="hoursPerWeek" min="1" max="40" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Students</label>
                                        <input type="number" id="maxStudents" name="maxStudents" min="1" max="100" value="25" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Price</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <input type="number" id="coursePrice" name="price" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <select id="courseCurrency" name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="USD">USD ($)</option>
                                                <option value="EUR">EUR ()</option>
                                                <option value="GBP">GBP ()</option>
                                                <option value="CAD">CAD ($)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Course Content & Lessons -->
                            <div id="step-2" class="wizard-step hidden p-6 space-y-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold text-gray-900">Course Content & Lessons</h4>
                                    <button type="button" onclick="addLesson()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                        Add Lesson
                                    </button>
                                </div>
                                
                                <!-- Course Overview -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Learning Objectives</label>
                                            <textarea id="learningObjectives" name="objectives" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="What will students achieve by the end of this course?"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prerequisites</label>
                                            <textarea id="prerequisites" name="prerequisites" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="What should students know before taking this course?"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Skills Focus</label>
                                        <div class="grid grid-cols-4 gap-4">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="listeningSkill" name="skillsFocus" value="listening" class="mr-2 text-blue-600">
                                                <span class="text-sm">Listening</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="speakingSkill" name="skillsFocus" value="speaking" class="mr-2 text-blue-600">
                                                <span class="text-sm">Speaking</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="readingSkill" name="skillsFocus" value="reading" class="mr-2 text-blue-600">
                                                <span class="text-sm">Reading</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="writingSkill" name="skillsFocus" value="writing" class="mr-2 text-blue-600">
                                                <span class="text-sm">Writing</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Lessons Container -->
                                <div id="lessonsContainer" class="space-y-4">
                                    <!-- Lessons will be dynamically added here -->
                                </div>

                                <!-- AI Content Assistant -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-blue-900 mb-2">AI Content Assistant</h5>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="generateSyllabus()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>
                                            Generate Syllabus
                                        </button>
                                        <button type="button" onclick="generateLessons()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="book-open" class="w-4 h-4 mr-1"></i>
                                            Generate Lessons
                                        </button>
                                        <button type="button" onclick="generateLessonContent()" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i>
                                            Generate Content
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Instructor Settings -->
                            <div id="step-3" class="wizard-step hidden p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Instructor & Course Settings</h4>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Name</label>
                                        <input type="text" id="instructorName" name="instructor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Email</label>
                                        <input type="email" id="instructorEmail" name="instructorEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="instructor@example.com">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Bio</label>
                                    <textarea id="instructorBio" name="instructorBio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Brief description of your teaching experience and qualifications..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Start Date</label>
                                        <input type="date" id="startDate" name="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Enrollment Deadline</label>
                                        <input type="date" id="enrollmentDeadline" name="enrollmentDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Schedule</label>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Days of Week</label>
                                            <select id="courseDays" name="days" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="mon-wed-fri">Mon, Wed, Fri</option>
                                                <option value="tue-thu">Tue, Thu</option>
                                                <option value="weekends">Weekends</option>
                                                <option value="daily">Daily</option>
                                                <option value="flexible">Flexible</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Start Time</label>
                                            <input type="time" id="startTime" name="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Duration (minutes)</label>
                                            <input type="number" id="sessionDuration" name="sessionDuration" min="30" max="180" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Method</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="continuous" class="mr-2 text-blue-600">
                                            <span>Continuous Assessment (quizzes, assignments)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="final" class="mr-2 text-blue-600">
                                            <span>Final Exam</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="mixed" class="mr-2 text-blue-600" checked>
                                            <span>Mixed (continuous + final)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="portfolio" class="mr-2 text-blue-600">
                                            <span>Portfolio-based</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Policies</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="allowLateSubmissions" name="policies" value="late-submissions" class="mr-2 text-blue-600">
                                            <span>Allow late submissions (with penalty)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="requireAttendance" name="policies" value="attendance" class="mr-2 text-blue-600" checked>
                                            <span>Attendance required (minimum 80%)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="allowMakeupSessions" name="policies" value="makeup" class="mr-2 text-blue-600">
                                            <span>Allow makeup sessions</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Review & Publish -->
                            <div id="step-4" class="wizard-step hidden p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Review & Publish Course</h4>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-blue-900 mb-3">Course Summary</h5>
                                    <div id="courseSummary" class="text-sm text-blue-800 space-y-2">
                                        <!-- Course summary will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Lessons and Materials Review Section -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-green-900 mb-3">Lessons & Materials</h5>
                                    <div id="lessonsReview" class="space-y-4">
                                        <!-- Lessons and materials will be populated here -->
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h6 class="font-medium text-gray-900 mb-2">Course Details</h6>
                                        <div id="courseDetailsReview" class="text-sm text-gray-700 space-y-1">
                                            <!-- Course details will be populated here -->
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h6 class="font-medium text-gray-900 mb-2">Instructor Info</h6>
                                        <div id="instructorReview" class="text-sm text-gray-700 space-y-1">
                                            <!-- Instructor info will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h6 class="font-medium text-yellow-900 mb-2">Publishing Options</h6>
                                    <div class="space-y-3">
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="draft" class="mr-2 text-blue-600" checked>
                                            <span class="text-sm">Save as Draft (you can edit and publish later)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="review" class="mr-2 text-blue-600">
                                            <span class="text-sm">Submit for Review (admin approval required)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="publish" class="mr-2 text-blue-600">
                                            <span class="text-sm">Publish Immediately (course goes live)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h6 class="font-medium text-green-900 mb-2">Next Steps</h6>
                                    <ul class="text-sm text-green-800 space-y-1">
                                        <li> Course will be created in your dashboard</li>
                                        <li> You can add lessons and assignments after creation</li>
                                        <li> Students can enroll once published</li>
                                        <li> You'll receive notifications for new enrollments</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="flex justify-between pt-6 border-t border-gray-200">
                                <button type="button" id="prevBtn" onclick="prevWizardStep()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="display: none;">
                                    <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>
                                    Previous
                                </button>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="saveDraft()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                        <i data-lucide="save" class="w-4 h-4 mr-1"></i>
                                        Save Draft
                                    </button>
                                    <button type="button" id="nextBtn" onclick="nextWizardStep()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                        Next
                                        <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                                    </button>
                                    <button type="button" id="verifyFilesBtn" onclick="verifyLessonFiles()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors" style="display: none;">
                                        <i data-lucide="search" class="w-4 h-4 mr-1"></i>
                                        Verify Files
                                    </button>
                                    <button type="submit" id="finishBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" style="display: none;">
                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                        Create Course
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

    <!-- Assignment Creation Modal -->
    <div id="assignmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Create New Assignment</h3>
                        <button onclick="closeAssignmentModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <form id="assignmentForm" class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Title</label>
                        <input type="text" id="assignmentTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                        <textarea id="assignmentInstructions" name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                            <input type="datetime-local" id="assignmentDueDate" name="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                            <input type="number" id="assignmentPoints" name="points" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">Assignment Materials</label>
                        <div class="space-y-4">
                            <!-- PDF Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">PDF Documents</span>
                                    <i data-lucide="file-text" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentPdfs" multiple accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-xs text-gray-500 mt-1">Upload PDF worksheets and reading materials</p>
                            </div>
                            <!-- Audio Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Audio Files</span>
                                    <i data-lucide="headphones" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentAudio" multiple accept=".mp3,.wav,.ogg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <p class="text-xs text-gray-500 mt-1">Upload audio for listening exercises</p>
                            </div>
                            <!-- Video Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Video Files</span>
                                    <i data-lucide="video" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentVideos" multiple accept=".mp4,.webm,.ogg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                <p class="text-xs text-gray-500 mt-1">Upload instructional videos</p>
                            </div>
                            <!-- Image Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Images</span>
                                    <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentImages" multiple accept=".jpg,.jpeg,.png,.gif,.webp" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                                <p class="text-xs text-gray-500 mt-1">Upload reference images and visual aids</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Create Assignment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Question Creation Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Create New Question</h3>
                        <button onclick="closeQuestionModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <form id="questionForm" class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                        <textarea id="questionText" name="questionText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required placeholder="Enter the question text..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                        <select id="questionType" name="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="handleQuestionTypeChange()" required>
                            <option value="">Select question type...</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                            <option value="short-answer">Short Answer</option>
                            <option value="essay">Essay</option>
                            <option value="fill-in-blank">Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <!-- Multiple Choice Options -->
                    <div id="multipleChoiceOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Answer Options</label>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="0" id="option0Radio" class="text-blue-600">
                                <input type="text" id="option0" placeholder="Option A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="1" id="option1Radio" class="text-blue-600">
                                <input type="text" id="option1" placeholder="Option B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="2" id="option2Radio" class="text-blue-600">
                                <input type="text" id="option2" placeholder="Option C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="3" id="option3Radio" class="text-blue-600">
                                <input type="text" id="option3" placeholder="Option D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- True/False Options -->
                    <div id="trueFalseOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="trueFalseAnswer" value="true" class="text-blue-600 mr-2">
                                <span>True</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="trueFalseAnswer" value="false" class="text-blue-600 mr-2">
                                <span>False</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Short Answer/Essay/Fill-in-blank Answer -->
                    <div id="textAnswerOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sample Answer/Keywords</label>
                        <textarea id="sampleAnswer" name="sampleAnswer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sample answer or keywords for grading..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">For short answer and fill-in-blank questions, provide keywords. For essays, provide a sample answer.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                            <input type="number" id="questionPoints" name="points" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Difficulty</label>
                            <select id="questionDifficulty" name="difficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Explanation (Optional)</label>
                        <textarea id="questionExplanation" name="explanation" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Provide an explanation for the correct answer..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeQuestionModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Create Question</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Upload Files</h3>
                    <button onclick="closeFileUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="fileUploadForm" onsubmit="handleFileUpload(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">File Category</label>
                        <select id="fileCategory" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Select category...</option>
                            <option value="courses">Course Materials</option>
                            <option value="assignments">Assignment Files</option>
                            <option value="general">General Files</option>
                            <option value="images">Images</option>
                            <option value="documents">Documents</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Files</label>
                        <input type="file" id="fileInput" name="files" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp3,.mp4,.zip">
                        <p class="text-xs text-gray-500 mt-1">Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF, MP3, MP4, ZIP</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea id="fileDescription" name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Brief description of the files..."></textarea>
                    </div>
                    
                    <div id="uploadProgress" class="mb-4 hidden">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600 mt-1">Uploading...</p>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeFileUploadModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" id="uploadButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                            Upload Files
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Assessment Question Modal -->
    <div id="assessmentQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Create CEFR Assessment Question</h3>
                    <button onclick="closeAssessmentQuestionModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="assessmentQuestionForm" onsubmit="handleAssessmentQuestionSubmit(event)">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column - Question Details -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Question Type *</label>
                                <select id="questionType" name="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required onchange="updateQuestionTypeFields()">
                                    <option value="">Select question type...</option>
                                    <option value="multiple-choice">Multiple Choice</option>
                                    <option value="true-false">True/False</option>
                                    <option value="short-answer">Short Answer</option>
                                    <option value="essay">Essay</option>
                                    <option value="fill-in-blank">Fill in the Blank</option>
                                    <option value="listening">Listening</option>
                                    <option value="speaking">Speaking</option>
                                    <option value="reading">Reading</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CEFR Level *</label>
                                <select id="questionCefrLevel" name="cefrLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select CEFR level...</option>
                                    <option value="A1">A1 - Beginner</option>
                                    <option value="A2">A2 - Elementary</option>
                                    <option value="B1">B1 - Intermediate</option>
                                    <option value="B2">B2 - Upper Intermediate</option>
                                    <option value="C1">C1 - Advanced</option>
                                    <option value="C2">C2 - Proficient</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Skill Type *</label>
                                <select id="skillType" name="skillType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select skill type...</option>
                                    <option value="reading">Reading</option>
                                    <option value="writing">Writing</option>
                                    <option value="listening">Listening</option>
                                    <option value="speaking">Speaking</option>
                                    <option value="grammar">Grammar</option>
                                    <option value="vocabulary">Vocabulary</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Question Text *</label>
                                <textarea id="assessmentQuestionText" name="questionText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the question text..." required></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions (Optional)</label>
                                <textarea id="questionInstructions" name="questionInstructions" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Additional instructions for students..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Points *</label>
                                <input type="number" id="questionPoints" name="questionPoints" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="1" min="1" max="10" required>
                            </div>
                        </div>
                        
                        <!-- Right Column - Media & Options -->
                        <div class="space-y-4">
                            <!-- Media Upload Section -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-md font-semibold text-gray-900 mb-3">Media Files (Optional)</h4>
                                
                                <!-- Image Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                                    <input type="file" id="questionImage" name="questionImage" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="image/*" onchange="previewMedia('image')">
                                    <div id="imagePreview" class="mt-2 hidden">
                                        <img id="imagePreviewImg" class="max-w-full h-32 object-cover rounded" alt="Image preview" loading="lazy" decoding="async" crossorigin="anonymous" referrerpolicy="no-referrer" fetchpriority="low" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22160%22><rect width=%22240%22 height=%22160%22 fill=%23f3f4f6/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%236b7280%22>Image unavailable</text></svg>';">
                                        <button type="button" onclick="removeMedia('image')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Audio Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Audio</label>
                                    <input type="file" id="questionAudio" name="questionAudio" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="audio/*" onchange="previewMedia('audio')">
                                    <div id="audioPreview" class="mt-2 hidden">
                                        <audio id="audioPreviewPlayer" controls class="w-full">
                                            <source id="audioPreviewSource" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                        <button type="button" onclick="removeMedia('audio')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Video Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Video</label>
                                    <input type="file" id="questionVideo" name="questionVideo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="video/*" onchange="previewMedia('video')">
                                    <div id="videoPreview" class="mt-2 hidden">
                                        <video id="videoPreviewPlayer" controls class="w-full h-32 object-cover rounded">
                                            <source id="videoPreviewSource" type="video/mp4">
                                            Your browser does not support the video element.
                                        </video>
                                        <button type="button" onclick="removeMedia('video')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- PDF Upload -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PDF Document</label>
                                    <input type="file" id="questionPdf" name="questionPdf" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept=".pdf" onchange="previewMedia('pdf')">
                                    <div id="pdfPreview" class="mt-2 hidden">
                                        <div class="flex items-center p-2 bg-white border rounded">
                                            <i data-lucide="file-text" class="w-6 h-6 text-red-600 mr-2"></i>
                                            <span id="pdfFileName" class="text-sm text-gray-700"></span>
                                            <button type="button" onclick="removeMedia('pdf')" class="ml-auto text-red-600 text-sm hover:text-red-800">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Answer Options Section -->
                            <div id="answerOptionsSection" class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-md font-semibold text-gray-900 mb-3">Answer Options</h4>
                                <div id="answerOptionsContainer">
                                    <!-- Dynamic content based on question type -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 mt-6">
                        <button type="button" onclick="closeAssessmentQuestionModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Create Question
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import supabaseStorageService from './src/renderer/services/supabaseStorageService.standalone.js';
        // Initialize Supabase client with environment variables

        const isLocalDevHost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
        // Seed localStorage from env.js when running on local dev for convenience
        if (isLocalDevHost && window.__ENV__) {
            try {
                const keys = ['VITE_SUPABASE_URL', 'VITE_SUPABASE_ANON_KEY', 'VITE_SUPABASE_SERVICE_ROLE_KEY'];
                keys.forEach((k) => {
                    const v = window.__ENV__[k];
                    if (v && !localStorage.getItem(k)) {
                        localStorage.setItem(k, v);
                    }
                });

                console.log(' Seeded localStorage from env.js for', window.location.hostname);

            } catch (e) {
                console.warn('Failed to seed localStorage from env.js', e);
            }
        }


        // Values come from env.js (window.__ENV__) or localStorage (dev convenience)
        const supabaseUrl = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_URL) 
            || localStorage.getItem('VITE_SUPABASE_URL') || '';
            
        const supabaseAnonKey = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_ANON_KEY) 
            || localStorage.getItem('VITE_SUPABASE_ANON_KEY') || '';
            
        const supabaseServiceKey = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_SERVICE_ROLE_KEY) 
            || localStorage.getItem('VITE_SUPABASE_SERVICE_ROLE_KEY') || '';

        // Log configuration source
        if (window.__ENV__) {
            console.log(' Using environment variables from env.js');
        } else if (localStorage.getItem('VITE_SUPABASE_URL')) {

            console.log(' Using localStorage for local development');
        } else {
            console.warn(' No environment variables found - please configure environment variables');
        }

        if (!supabaseUrl || !supabaseAnonKey) {
            console.error(' Supabase URL or Anon Key is missing. Please configure environment variables.');
        }
            
        // Create regular client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // Create admin client only if service key is available
        let supabaseAdmin = null;
        if (supabaseServiceKey && supabaseServiceKey !== 'undefined') {
            supabaseAdmin = window.supabase.createClient(supabaseUrl, supabaseServiceKey);
            console.log(' Admin client initialized with service role key');
        } else {
            console.warn(' Service role key not found. Admin operations will be limited.');
            console.warn('Please add VITE_SUPABASE_SERVICE_ROLE_KEY to your environment variables (Netlify) or localStorage for localhost.');
            // Use regular client as fallback (will be limited by RLS)
            supabaseAdmin = supabase;
        }
        
        // Expose clients to global window object for admin-scripts.js
        window.supabaseClient = supabase;
        window.supabaseAdminClient = supabaseAdmin;
        console.log(' Supabase clients exposed to window object');
        
        // Connection status check
        async function checkConnection() {
            try {
                const { data, error } = await supabase.from('user_profiles').select('id').limit(1);
                if (error && error.code === '42P01') {
                    console.warn(' Database tables not found. Please run the database migration.');
                    return false;
                }
                return true;
            } catch (error) {
                console.error(' Connection check failed:', error);
                return false;
            }
        }
         
        // Display demo users for testing and when RLS prevents data access
        function displayDemoUsers() {
             const demoUsers = [
                 {
                     id: 'demo-user-1',
                     email: 'john.doe@example.com',
                     full_name: 'John Doe',
                     created_at: '2024-01-15T10:30:00Z',
                     user_progress: [{
                         current_level: 'intermediate',
                         total_xp: 1250,
                         daily_streak: 15
                     }]
                 },
                 {
                     id: 'demo-user-2',
                     email: 'maria.garcia@example.com',
                     full_name: 'Maria Garcia',
                     created_at: '2024-01-20T14:15:00Z',
                     user_progress: [{
                         current_level: 'beginner',
                         total_xp: 680,
                         daily_streak: 8
                     }]
                 },
                 {
                     id: 'demo-user-3',
                     email: 'alex.chen@example.com',
                     full_name: 'Alex Chen',
                     created_at: '2024-01-10T09:45:00Z',
                     user_progress: [{
                         current_level: 'advanced',
                         total_xp: 2890,
                         daily_streak: 32
                     }]
                 },
                 {
                     id: 'demo-user-4',
                     email: 'sophie.martin@example.com',
                     full_name: 'Sophie Martin',
                     created_at: '2024-01-25T16:20:00Z',
                     user_progress: [{
                         current_level: 'intermediate',
                         total_xp: 1890,
                         daily_streak: 22
                     }]
                 },
                 {
                     id: 'demo-user-5',
                     email: 'carlos.rodriguez@example.com',
                     full_name: 'Carlos Rodriguez',
                     created_at: '2024-01-05T11:10:00Z',
                     user_progress: [{
                         current_level: 'beginner',
                         total_xp: 420,
                         daily_streak: 5
                     }]
                 }
             ];
             
             const tableBody = document.getElementById('users-table-body-tab');
             if (!tableBody) {
                 console.error(' Could not find users-table-body-tab element');
                 return;
             }
             
             console.log(' Rendering demo user table with', demoUsers.length, 'users');
             tableBody.innerHTML = demoUsers.map(user => {
                 const progress = user.user_progress?.[0] || {};
                 const createdAt = new Date(user.created_at).toLocaleDateString();
                 
                 return `
                     <tr class="hover:bg-gray-50">
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
                             ${user.id.substring(0, 8)}...
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${user.email || 'N/A'}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${user.full_name || user.email || 'N/A'}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${createdAt}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             <div class="flex flex-col">
                                 <span class="text-xs text-gray-500">Level: ${progress.current_level || 'beginner'}</span>
                                 <span class="text-xs text-gray-500">XP: ${progress.total_xp || 0}</span>
                                 <span class="text-xs text-gray-500">Streak: ${progress.daily_streak || 0}</span>
                             </div>
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                             <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewUser('${user.id}')">
                                 View
                             </button>
                             <button class="text-red-600 hover:text-red-900" onclick="deleteUser('${user.id}')">
                                 Delete
                             </button>
                         </td>
                     </tr>
                 `;
             }).join('');
             
             // Add a notice that this is demo data
             const noticeRow = `
                 <tr>
                     <td colspan="6" class="px-6 py-2">
                         <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                             <div class="flex items-center">
                                 <i data-lucide="info" class="w-4 h-4 text-blue-600 mr-2"></i>
                                 <span class="text-sm text-blue-800">Demo Data: Showing sample users for demonstration purposes</span>
                             </div>
                         </div>
                     </td>
                 </tr>
             `;
             
             tableBody.innerHTML += noticeRow;
             lucide.createIcons();
             console.log(' Demo user table rendered successfully');
         }

        // Handle question type changes in the modal
        function handleQuestionTypeChange() {
            const questionTypeElement = document.getElementById('questionType');
            const answerOptionsDiv = document.getElementById('answerOptions');
            
            if (!questionTypeElement || !answerOptionsDiv) {
                console.error('Question type form elements not found');
                return;
            }
            
            const questionType = questionTypeElement.value;
            
            // Clear previous content
            answerOptionsDiv.innerHTML = '';
            
            if (questionType === 'multiple-choice') {
                answerOptionsDiv.innerHTML = `
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">Answer Options</label>
                        <div id="mcOptions" class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="0" class="text-blue-600">
                                <input type="text" name="option" placeholder="Option 1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="1" class="text-blue-600">
                                <input type="text" name="option" placeholder="Option 2" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        <button type="button" onclick="addMCOption()" class="text-blue-600 hover:text-blue-800 text-sm">+ Add Option</button>
                    </div>
                `;
            } else if (questionType === 'true-false') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="tfCorrectAnswer" value="true" class="text-blue-600 mr-2">
                                <span>True</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tfCorrectAnswer" value="false" class="text-blue-600 mr-2">
                                <span>False</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (questionType === 'short-answer') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="shortAnswer" class="block text-sm font-medium text-gray-700 mb-2">Sample Answer (Optional)</label>
                        <textarea name="shortAnswer" id="shortAnswer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Provide a sample answer or key points..."></textarea>
                    </div>
                `;
            } else if (questionType === 'essay') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="essayAnswer" class="block text-sm font-medium text-gray-700 mb-2">Grading Rubric (Optional)</label>
                        <textarea name="essayAnswer" id="essayAnswer" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Describe the grading criteria or key points to look for..."></textarea>
                    </div>
                `;
            } else if (questionType === 'fill-in-blank') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="fillBlankAnswer" class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <input type="text" name="fillBlankAnswer" id="fillBlankAnswer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the correct answer" required>
                        <p class="text-sm text-gray-500 mt-1">Use _____ in your question text to indicate where the blank should be.</p>
                    </div>
                `;
            }
        }

        // Add new multiple choice option
        function addMCOption() {
            const mcOptions = document.getElementById('mcOptions');
            const optionCount = mcOptions.children.length;
            
            const newOption = document.createElement('div');
            newOption.className = 'flex items-center space-x-2';
            newOption.innerHTML = `
                <input type="radio" name="correctAnswer" value="${optionCount}" class="text-blue-600">
                <input type="text" name="option" placeholder="Option ${optionCount + 1}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <button type="button" onclick="removeMCOption(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
            `;
            
            mcOptions.appendChild(newOption);
        }

        // Remove multiple choice option
        function removeMCOption(button) {
            const mcOptions = document.getElementById('mcOptions');
            if (mcOptions.children.length > 2) {
                button.parentElement.remove();
                
                // Update radio button values
                const options = mcOptions.children;
                for (let i = 0; i < options.length; i++) {
                    const radio = options[i].querySelector('input[type="radio"]');
                    const textInput = options[i].querySelector('input[type="text"]');
                    radio.value = i;
                    textInput.placeholder = `Option ${i + 1}`;
                }
            }
        }

        // Auto-refresh dashboard data every 30 seconds
        let refreshInterval = null;

        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(async () => {
                try {
                    console.log(' Auto-refreshing dashboard data...');
                    const isConnected = await checkConnection();
                    if (isConnected) {
                        await loadDashboardData();
                        console.log(' Auto-refresh completed');
                    } else {
                        console.warn(' Auto-refresh skipped - database connection unavailable');
                    }
                } catch (error) {
                    console.error(' Auto-refresh failed:', error);
                }
            }, 30000); // 30 seconds
            
            console.log(' Auto-refresh started (30 second intervals)');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log(' Auto-refresh stopped');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            const overlay = document.getElementById('global-loading');
            try {
                if (overlay) overlay.classList.remove('hidden');
                // Check authentication first
                if (!checkAuthentication()) {
                    redirectToLogin();
                    return;
                }
                
                // Authenticate with Supabase using a demo user
                await authenticateWithSupabase();
                
                // Check connection first
                const isConnected = await checkConnection();
                if (isConnected) {
                    await loadDashboardData();
                    // Start auto-refresh only after initial load succeeds
                    startAutoRefresh();
                    createToast({ type: 'success', message: 'Dashboard is ready' });
                } else {
                    showConnectionError();
                }
                
                // Initialize course management
                initializeCourseManagement();
            } catch (e) {
                console.error(e);
            } finally {
                if (overlay) overlay.classList.add('hidden');
            }
        });

        // Stop auto-refresh when page is about to unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // Pause auto-refresh when page is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
                console.log(' Page hidden - pausing auto-refresh');
            } else {
                startAutoRefresh();
                console.log(' Page visible - resuming auto-refresh');
            }
        });

        // Question form submission
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const assignmentId = document.getElementById('questionAssignmentSelect').value;
            const questionText = formData.get('questionText');
            const questionType = formData.get('questionType');
            const points = formData.get('points');
            const difficulty = formData.get('difficulty');
            const explanation = formData.get('explanation');
            
            if (!assignmentId) {
                showError('Please select an assignment first');
                return;
            }
            
            if (!questionText || !questionType) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Collect answer options based on question type
            let options = null;
            let correctAnswer = null;
            
            if (questionType === 'multiple-choice') {
                const optionInputs = document.querySelectorAll('[name="option"]');
                const correctAnswerInput = document.querySelector('[name="correctAnswer"]:checked');
                
                options = Array.from(optionInputs).map(input => input.value).filter(val => val.trim());
                correctAnswer = correctAnswerInput ? correctAnswerInput.value : null;
                
                if (options.length < 2) {
                    showError('Please provide at least 2 options for multiple choice questions');
                    return;
                }
                if (!correctAnswer) {
                    showError('Please select the correct answer');
                    return;
                }
            } else if (questionType === 'true-false') {
                const correctAnswerInput = document.querySelector('[name="tfCorrectAnswer"]:checked');
                correctAnswer = correctAnswerInput ? correctAnswerInput.value : null;
                
                if (!correctAnswer) {
                    showError('Please select the correct answer for true/false question');
                    return;
                }
            } else if (questionType === 'short-answer' || questionType === 'essay') {
                correctAnswer = formData.get('shortAnswer') || formData.get('essayAnswer');
            } else if (questionType === 'fill-in-blank') {
                correctAnswer = formData.get('fillBlankAnswer');
                if (!correctAnswer) {
                    showError('Please provide the correct answer for fill-in-the-blank question');
                    return;
                }
            }
            
            // Show loading state
            const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                // Create question in database
                const { data, error } = await supabase
                    .from('questions')
                    .insert({
                        assignment_id: assignmentId,
                        question_text: questionText,
                        question_type: questionType,
                        options: options ? JSON.stringify(options) : null,
                        correct_answer: correctAnswer,
                        points: parseInt(points) || 1,
                        difficulty: difficulty || 'medium',
                        explanation: explanation || null
                    })
                    .select();
                
                if (error) throw error;
                
                // Reset form and close modal
                e.target.reset();
                closeQuestionModal();
                
                // Refresh questions list
                await loadQuestionsForAssignment();
                updateLastUpdated();
                
                // Show success message
                createToast({ type: 'success', message: 'Question created successfully!' });
                
            } catch (error) {
                console.error('Error creating question:', error);
                showError('Failed to create question: ' + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
        });

        // Question management functions
        function editQuestion(questionId) {
            console.log('Editing question:', questionId);
            // TODO: Implement question editing functionality
            createToast({ type: 'info', message: 'Question editing functionality will be implemented soon.' });
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('questions')
                    .delete()
                    .eq('id', questionId);
                
                if (error) throw error;
                
                await loadQuestionsForAssignment();
                updateLastUpdated();
                
                createToast({ type: 'success', message: 'Question deleted successfully!' });
            } catch (error) {
                console.error('Error deleting question:', error);
                showError('Failed to delete question');
            }
        }
        
        function checkAuthentication() {
            return localStorage.getItem('adminAuthenticated') === 'true';
        }
        
        function redirectToLogin() {
            if (window.isElectron) {
                window.location.href = '#/admin-login';
            } else {
                window.location.href = 'admin-login.html';
            }
        }
        
        async function authenticateWithSupabase() {
             try {
                 // For admin dashboard, we'll use a service role approach
                 // First check if we can access the database without authentication
                 const { data: testData, error: testError } = await supabase
                     .from('user_profiles')
                     .select('id')
                     .limit(1);
                 
                 if (!testError) {
                     console.log(' Admin dashboard connected to Supabase (public access)');
                     return true;
                 }
                 
                 // If public access fails, try with a valid admin email
                 const { data, error } = await supabase.auth.signInWithPassword({
                     email: 'admin@edlingo.com',
                     password: 'admin123456'
                 });
                 
                 if (error) {
                     console.warn('Admin auth failed, attempting to create admin user:', error.message);
                     
                     // Try to create the admin user with a valid email format
                     const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                         email: 'admin@edlingo.com',
                         password: 'admin123456',
                         options: {
                             data: {
                                 full_name: 'Admin User',
                                 role: 'admin'
                             }
                         }
                     });
                     
                     if (signUpError) {
                         console.error('Failed to create admin user:', signUpError);
                         // Continue without authentication for read-only access
                         console.log(' Continuing with read-only access');
                         return false;
                     } else {
                         console.log(' Admin user created successfully');
                         return true;
                     }
                 } else {
                     console.log(' Authenticated with Supabase as admin');
                     return true;
                 }
             } catch (error) {
                 console.error('Authentication error:', error);
                 return false;
             }
         }
         
         async function logout() {
             try {
                 await supabase.auth.signOut();
                 localStorage.removeItem('adminAuthenticated');
                 redirectToLogin();
             } catch (error) {
                 console.error('Logout error:', error);
             }
         }
        
        function showConnectionError() {
            const errorMessage = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                        <h3 class="text-red-800 font-medium">Database Connection Error</h3>
                    </div>
                    <p class="text-red-700 mt-2">Unable to connect to the database. Please check:</p>
                    <ul class="text-red-700 mt-2 ml-4 list-disc">
                        <li>Database is running and accessible</li>
                        <li>Environment variables are correctly set</li>
                        <li>Database schema has been applied</li>
                    </ul>
                    <p class="text-red-700 mt-2">See SETUP_DATABASE.md for setup instructions.</p>
                </div>
            `;
            document.querySelector('main').innerHTML = errorMessage;
            lucide.createIcons();
        }

        async function loadDashboardData() {
            try {
                console.log(' Loading dashboard data...');
                await Promise.all([
                    loadStats(),
                    loadUsers(),
                    loadVocabulary(),
                    loadGrammarLessons(),
                    loadCourses(),
                    loadAssignments(),
                    loadRecentActivity()
                ]);
                updateLastUpdated();
                // Initialize reveal animations and timeline hooks after content is in DOM
                if (window.initReveals) initReveals();
                if (window.applyActivityTimeline) applyActivityTimeline();
                console.log(' Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        // duplicate removed: updateLastUpdated is defined once in Utility functions section

        async function loadCourses() {
            try {
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('id,title,description,level,language,duration,duration_weeks,hours_per_week,is_active,created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const coursesList = document.getElementById('courses-list');
                
                if (!courses || courses.length === 0) {
                    if (coursesList) {
                        coursesList.innerHTML = `
                            <div class="text-center py-12">
                                <i data-lucide="book-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
                                <p class="text-gray-500 mb-4">Create your first course to get started.</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddCourseModal()">
                                    Create Course
                                </button>
                            </div>
                        `;
                    }
                    return;
                }

                if (coursesList) {
                    coursesList.innerHTML = courses.map(course => {
                        const createdAt = new Date(course.created_at).toLocaleDateString();
                        const durationText = course.duration ? `${course.duration} weeks` : 'Duration not set';
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${course.title || 'Untitled Course'}</h3>
                                        <p class="text-gray-600 mb-3">${course.description || 'No description'}</p>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                ${course.level || 'beginner'}
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                ${course.language || 'Language not set'}
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                ${durationText}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500">Created: ${createdAt}</p>
                                    </div>
                                    <div class="flex space-x-2 ml-4">
                                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="editCourse('${course.id}')">
                                            <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                                            Edit
                                        </button>
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="deleteCourse('${course.id}')">
                                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                                    <span class="text-sm text-gray-500">
                                        Status: <span class="font-medium ${course.is_active ? 'text-green-600' : 'text-red-600'}">
                                            ${course.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </span>
                                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="viewCourseDetails('${course.id}')">
                                        View Details 
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Re-initialize Lucide icons for the new content
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                const coursesList = document.getElementById('courses-list');
                if (coursesList) {
                    coursesList.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Error loading courses</h3>
                            <p class="text-red-500 mb-4">${error.message}</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="loadCourses()">
                                Try Again
                            </button>
                        </div>
                    `;
                    
                    // Re-initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }
        }

        async function loadAssignments() {
            try {
                const { data: assignments, error } = await supabase
                    .from('assignments')
                    .select('id,title,description,due_date,created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const assignmentsTableBody = document.getElementById('assignments-table-body');
                
                if (!assignments || assignments.length === 0) {
                    if (assignmentsTableBody) {
                        assignmentsTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                    No assignments found
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                if (assignmentsTableBody) {
                    assignmentsTableBody.innerHTML = assignments.map(assignment => {
                        const createdAt = new Date(assignment.created_at).toLocaleDateString();
                        const dueDate = assignment.due_date ? new Date(assignment.due_date).toLocaleDateString() : 'No due date';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${assignment.title || 'Untitled Assignment'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${assignment.description || 'No description'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${dueDate}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${assignment.max_score !== undefined ? assignment.max_score : 0} points
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editAssignment('${assignment.id}')">
                                        Edit
                                    </button>
                                    <button class="text-red-600 hover:text-red-900" onclick="deleteAssignment('${assignment.id}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                const assignmentsTableBody = document.getElementById('assignments-table-body');
                if (assignmentsTableBody) {
                    assignmentsTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-red-500">
                                Error loading assignments: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        async function loadStats() {
            try {
                console.log(' Loading stats...');
                // Load stats with fallback for missing tables
                const statsPromises = [
                    loadTableCount('user_profiles', 'total-users'),
                    loadTableCount('grammar_lessons', 'total-lessons'),
                    loadTableCount('user_vocabulary', 'total-vocabulary'),
                    loadTableCount('user_achievements', 'total-achievements'),
                    loadTableCount('courses', 'total-courses-stat')
                ];

                await Promise.allSettled(statsPromises);
                console.log(' Stats loaded');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // UI helper utilities
        function updateKpiValue(elementId, value) {
            try {
                const el = document.getElementById(elementId);
                if (!el) return;
                const text = String(value);
                // Update content
                el.textContent = text;
                // Restart pulse animation
                el.classList.remove('kpi-pulse');
                // Force reflow to restart animation reliably
                void el.offsetWidth;
                el.classList.add('kpi-pulse');
            } catch (e) {
                console.warn('updateKpiValue error:', e);
            }
        }
        
        function initReveals() {
            try {
                const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const items = document.querySelectorAll('.reveal');
                if (!items || items.length === 0) return;
                if (prefersReduced) {
                    items.forEach(el => el.classList.add('revealed'));
                    return;
                }
                const io = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('revealed');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                items.forEach(el => io.observe(el));
            } catch (e) {
                console.warn('initReveals error:', e);
            }
        }
        window.initReveals = window.initReveals || initReveals;
        
        function applyActivityTimeline() {
            try {
                const el = document.getElementById('activity-list');
                if (el && !el.classList.contains('activity-timeline')) {
                    el.classList.add('activity-timeline');
                }
            } catch (e) {
                console.warn('applyActivityTimeline error:', e);
            }
        }
        window.applyActivityTimeline = window.applyActivityTimeline || applyActivityTimeline;
        
        async function loadTableCount(tableName, elementId) {
            try {
                console.log(` Loading count for ${tableName}...`);
                
                // Try MCP first if in Electron environment
                if (window.isElectron && window.electronAPI?.runMcp) {
                    try {
                        console.log(` Using MCP for ${tableName} count...`);
                        const mcpResult = await window.electronAPI.runMcp(
                            'mcp.config.usrlocalmcp.Postgrest',
                            'postgrestRequest',
                            {
                                method: 'GET',
                                path: `/${tableName}?select=count()&head=true`
                            }
                        );
                        
                        if (mcpResult && !mcpResult.error) {
                            // PostgREST returns count in response headers or as a single value
                            let count = 0;
                            if (mcpResult.data && Array.isArray(mcpResult.data)) {
                                count = mcpResult.data.length;
                            } else if (mcpResult.count !== undefined) {
                                count = mcpResult.count;
                            } else if (typeof mcpResult.data === 'number') {
                                count = mcpResult.data;
                            }
                            
                            console.log(` MCP ${tableName} count: ${count}`);
                            updateKpiValue(elementId, count);
                            return;
                        } else {
                            console.warn(` MCP failed for ${tableName}:`, mcpResult?.error);
                            // Fall through to Supabase client
                        }
                    } catch (mcpError) {
                        console.warn(` MCP error for ${tableName}:`, mcpError);
                        // Fall through to Supabase client
                    }
                }
                
                // Fallback to direct Supabase client
                console.log(` Using Supabase client for ${tableName} count...`);
                const adminTables = ['user_profiles', 'user_achievements', 'user_vocabulary'];
                const client = adminTables.includes(tableName) ? supabaseAdmin : supabase;
                const { count, error } = await client
                    .from(tableName)
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === '42P01') {
                        // Table doesn't exist
                        console.warn(` Table ${tableName} does not exist, setting count to 0`);
                        updateKpiValue(elementId, '0');
                    } else if (error.code === '42501' || error.message.includes('row-level security')) {
                        // RLS policy restriction - show 0 for user_profiles, demo for others
                        console.warn(` RLS restriction for ${tableName}`);
                        if (tableName === 'user_profiles') {
                            updateKpiValue(elementId, '0');
                        } else {
                            const demoCount = getDemoCount(tableName);
                            updateKpiValue(elementId, demoCount);
                        }
                    } else {
                        console.error(` Error with table ${tableName}:`, error);
                        updateKpiValue(elementId, '0');
                    }
                } else {
                    console.log(` ${tableName} count: ${count}`);
                    updateKpiValue(elementId, count || 0);
                }
            } catch (error) {
                console.error(`Error loading count for ${tableName}:`, error);
                // Show appropriate message based on error type
                if (tableName === 'user_profiles') {
                    if (error.code === '42501' || error.message.includes('row-level security')) {
                        document.getElementById(elementId).textContent = 'RLS Active';
                        document.getElementById(elementId).title = 'Row Level Security policies are preventing access to user count';
                    } else {
                        updateKpiValue(elementId, '0');
                    }
                } else {
                    const demoCount = getDemoCount(tableName);
                    updateKpiValue(elementId, demoCount);
                }
            }
        }
        
        function getDemoCount(tableName) {
            const demoCounts = {
                'user_profiles': 5,
                'grammar_lessons': 12,
                'user_vocabulary': 248,
                'user_achievements': 18,
                'courses': 3
            };
            return demoCounts[tableName] || 0;
        }

        async function loadUsers() {
            try {
                console.log(' Loading users from auth.users...');
                
                // Try to load users from auth.users table (requires admin access)
                let { data: authUsers, error: authError } = await supabaseAdmin.auth.admin.listUsers();
                
                if (authError) {
                    console.warn('Failed to load from auth.users, trying user_profiles:', authError.message);
                    
                    // Fallback to user_profiles table
                    let { data: users, error } = await supabaseAdmin
                        .from('user_profiles')
                        .select(`
                            id,
                            email,
                            full_name,
                            created_at,
                            avatar_url,
                            last_active_at,
                            user_progress(
                                current_level,
                                total_xp,
                                daily_streak
                            )
                        `)
                        .order('created_at', { ascending: false });

                    if (error) {
                        // If relationship fails, try loading users without progress
                        console.warn('Failed to load users with progress, trying without:', error.message);
                        
                        const { data: simpleUsers, error: simpleError } = await supabaseAdmin
                            .from('user_profiles')
                            .select('id,email,full_name,created_at,avatar_url,last_active_at')
                            .order('created_at', { ascending: false });
                        
                        if (simpleError) {
                            if (simpleError.code === '42P01') {
                                // Table doesn't exist
                                const tableBody = document.getElementById('users-table-body-tab');
                                if (tableBody) {
                                    tableBody.innerHTML = `
                                        <tr>
                                            <td colspan="6" class="px-6 py-4">
                                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                    <div class="flex items-center">
                                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
                                                        <h3 class="text-sm font-medium text-blue-800">No User Data</h3>
                                                    </div>
                                                    <div class="mt-2 text-sm text-blue-700">
                                                        <p>The user_profiles table doesn't exist yet. Users will appear here once they start using the application.</p>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                    lucide.createIcons();
                                }
                                return;
                            }
                            throw simpleError;
                        }
                        
                        users = simpleUsers;
                    }
                    
                    // Process user_profiles data
                    await renderUsersTable(users, 'user_profiles');
                    return;
                }
                
                // Process auth.users data
                 const users = authUsers.users || [];
                 await renderUsersTable(users, 'auth_users');
                 
            } catch (error) {
                console.error('Error loading users:', error);
                await handleUserLoadError(error);
            }
        }
        
        async function renderUsersTable(users, dataSource) {
            console.log(` Found ${users ? users.length : 0} users from ${dataSource}`);
            
            if (!users || users.length === 0) {
                console.log(' No users found');
                usersCache = [];
                filteredUsers = [];
                
                // Update the total users count to 0 in the overview
                const totalUsersElement = document.getElementById('total-users');
                if (totalUsersElement) {
                    if (window.updateKpiValue) updateKpiValue('total-users', '0'); else totalUsersElement.textContent = '0';
                }
                
                const tableBody = document.getElementById('users-table-body-tab');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i data-lucide="users" class="w-5 h-5 text-blue-600 mr-2"></i>
                                        <h3 class="text-sm font-medium text-blue-800">No Users Found</h3>
                                    </div>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <p>No users have registered yet. Users will appear here once they sign up for the application.</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                }
                return;
            }

            console.log(' Processing user data for filtering system');
            
            // Normalize and cache user data
            usersCache = users.map(user => {
                let normalizedUser;
                
                if (dataSource === 'auth_users') {
                    // auth.users format
                    normalizedUser = {
                        id: user.id,
                        user_id: user.id,
                        email: user.email,
                        full_name: user.user_metadata?.full_name || user.user_metadata?.name || user.email,
                        name: user.user_metadata?.full_name || user.user_metadata?.name || user.email,
                        created_at: user.created_at,
                        updated_at: user.updated_at,
                        last_activity: user.last_sign_in_at || user.updated_at,
                        level: 'beginner' // Default level for auth users
                    };
                } else {
                    // user_profiles format
                    const progress = user.user_progress?.[0] || {};
                    normalizedUser = {
                        id: user.id,
                        user_id: user.id,
                        email: user.email,
                        full_name: user.full_name || user.email,
                        name: user.full_name || user.email,
                        created_at: user.created_at,
                        updated_at: user.updated_at,
                        last_activity: user.last_activity || user.updated_at,
                        level: progress.current_level || 'beginner'
                    };
                }
                
                return normalizedUser;
            });
            
            // Initialize filtered users with all users
            filteredUsers = [...usersCache];
            
            // Update the total users count in the overview
            const totalUsersElement = document.getElementById('total-users');
            if (totalUsersElement) {
                if (window.updateKpiValue) updateKpiValue('total-users', usersCache.length); 
                else totalUsersElement.textContent = usersCache.length;
            }
            
            // Use the new filtering system to render users
            filterAndRenderUsers();
        }
        
        async function handleUserLoadError(error) {
            console.error('Error loading users:', error);
            const tableBody = document.getElementById('users-table-body-tab');
            if (!tableBody) return;
            
            // Handle RLS restrictions
            if (error.code === '42501' || error.message.includes('row-level security')) {
                console.log(' RLS restriction detected');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="shield-alert" class="w-5 h-5 text-yellow-600 mr-2"></i>
                                    <h3 class="text-sm font-medium text-yellow-800">Row Level Security Active</h3>
                                </div>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p>The user_profiles table has Row Level Security (RLS) policies enabled.</p>
                                    <p class="mt-1">This prevents unauthorized access to user data, which is a security feature.</p>
                                    <p class="mt-2"><strong>To view users:</strong></p>
                                    <ul class="list-disc ml-4 mt-1">
                                        <li>Authenticate as an admin user, or</li>
                                        <li>Modify RLS policies to allow admin access, or</li>
                                        <li>Use the service role key instead of anon key</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-yellow-600">Current status: Using anonymous access (limited permissions)</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                                    <h3 class="text-sm font-medium text-red-800">Error Loading Users</h3>
                                </div>
                                <div class="mt-2 text-sm text-red-700">
                                    <p>Failed to load user data: ${error.message}</p>
                                    <p class="mt-1">Please check the database connection and table structure.</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            lucide.createIcons();
        }

         // User management functions
         window.viewUser = window.viewUser || function(userId) {
             createToast({ type: 'info', message: `View user details for ID: ${userId}. This feature will show detailed user information, progress, and activity history.` });
         };

         window.deleteUser = window.deleteUser || async function(userId) {
             if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                 // Placeholder in early section; real implementation exists later
                 console.log(`Delete user with ID: ${userId}`);
                 createToast({ type: 'info', message: 'User deletion functionality would be implemented here.' });
             }
         };

        // Users tab functionality
        let usersCache = [];
        let filteredUsers = [];
        let currentUsersPage = 1;
        let usersPerPage = 10;
        let currentSortField = 'created';
        let currentSortDirection = 'desc';

        // Initialize Users tab
        function initializeUsersTab() {
            // Set up event listeners
            const searchInput = document.getElementById('users-search');
            const levelFilter = document.getElementById('users-level-filter');
            const activityFilter = document.getElementById('users-activity-filter');
            const perPageSelect = document.getElementById('users-per-page');
            const exportBtn = document.getElementById('export-users-btn');
            const refreshBtn = document.getElementById('refresh-users-btn');

            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterAndRenderUsers, 300));
            }
            if (levelFilter) {
                levelFilter.addEventListener('change', filterAndRenderUsers);
            }
            if (activityFilter) {
                activityFilter.addEventListener('change', filterAndRenderUsers);
            }
            if (perPageSelect) {
                perPageSelect.addEventListener('change', (e) => {
                    usersPerPage = parseInt(e.target.value);
                    currentUsersPage = 1;
                    filterAndRenderUsers();
                });
            }
            if (exportBtn) {
                exportBtn.addEventListener('click', exportUsersToCSV);
            }
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadUsers();
                    createToast({ type: 'success', message: 'Users data refreshed successfully!' });
                });
            }
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Filter and render users
        function filterAndRenderUsers() {
            // If no users in cache, don't filter
            if (!usersCache || usersCache.length === 0) {
                filteredUsers = [];
                renderFilteredUsers();
                return;
            }

            const searchTerm = document.getElementById('users-search')?.value.toLowerCase() || '';
            const levelFilter = document.getElementById('users-level-filter')?.value || 'all';
            const activityFilter = document.getElementById('users-activity-filter')?.value || 'all';

            filteredUsers = usersCache.filter(user => {
                // Search filter - improved to search in email and full name
                const matchesSearch = !searchTerm || 
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
                    (user.name && user.name.toLowerCase().includes(searchTerm));

                // Level filter
                const userLevel = user.level || 'beginner';
                const matchesLevel = levelFilter === 'all' || userLevel === levelFilter;

                // Activity filter
                let matchesActivity = true;
                if (activityFilter !== 'all') {
                    const lastActivity = user.last_activity || user.updated_at || user.created_at;
                    if (lastActivity) {
                        const daysSinceActivity = Math.floor((Date.now() - new Date(lastActivity).getTime()) / (1000 * 60 * 60 * 24));
                        if (activityFilter === 'active' && daysSinceActivity > 7) matchesActivity = false;
                        if (activityFilter === 'inactive' && daysSinceActivity <= 7) matchesActivity = false;
                    }
                }

                return matchesSearch && matchesLevel && matchesActivity;
            });

            // Sort filtered users
            sortFilteredUsers();
            
            // Reset to first page
            currentUsersPage = 1;
            
            // Render users
            renderFilteredUsers();
        }

        // Sort filtered users
        function sortFilteredUsers() {
            filteredUsers.sort((a, b) => {
                let aVal = a[currentSortField];
                let bVal = b[currentSortField];

                // Handle different data types
                if (currentSortField === 'created' || currentSortField === 'updated_at') {
                    aVal = new Date(aVal || 0).getTime();
                    bVal = new Date(bVal || 0).getTime();
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        // Sort users table
        function sortUsersTable(field) {
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }

            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.innerHTML = '';
            });

            const currentHeader = document.querySelector(`[onclick="sortUsersTable('${field}')"]`);
            if (currentHeader) {
                const indicator = currentHeader.querySelector('.sort-indicator') || 
                    (() => {
                        const span = document.createElement('span');
                        span.className = 'sort-indicator ml-1';
                        currentHeader.appendChild(span);
                        return span;
                    })();
                indicator.innerHTML = currentSortDirection === 'asc' ? '' : '';
            }

            filterAndRenderUsers();
        }

        // Render filtered users with pagination
        function renderFilteredUsers() {
            const tableBody = document.getElementById('users-table-body-tab');
            if (!tableBody) return;

            // Update total count
            const totalUsersElement = document.getElementById('total-users');
            if (totalUsersElement) {
                totalUsersElement.textContent = filteredUsers.length;
            }

            // Calculate pagination
            const startIndex = (currentUsersPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);

            // Render users
            if (pageUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center">
                            <div class="text-gray-400">
                                <i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">No users found</h3>
                                <p class="text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = pageUsers.map(user => {
                    const userId = user.id || user.user_id;
                    const email = user.email || 'No email';
                    const name = user.full_name || user.name || 'No name';
                    const created = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
                    const level = user.level || 'beginner';
                    const lastActivity = user.last_activity || user.updated_at;
                    const activityText = lastActivity ? getTimeAgo(new Date(lastActivity)) : 'No activity';

                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${userId}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${email}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${created}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                    level === 'advanced' ? 'bg-purple-100 text-purple-800' :
                                    level === 'intermediate' ? 'bg-blue-100 text-blue-800' :
                                    'bg-green-100 text-green-800'
                                }">
                                    ${level}
                                </span>
                                <div class="text-xs text-gray-500 mt-1">${activityText}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-blue-600 hover:text-blue-900 mr-3 transition-colors" onclick="viewUser('${userId}')">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 transition-colors" onclick="deleteUser('${userId}')">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Update pagination
            updateUsersPagination();
            
            // Recreate icons
            lucide.createIcons();
        }

        // Update pagination controls
        function updateUsersPagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const paginationContainer = document.getElementById('users-pagination');
            
            if (!paginationContainer || totalPages <= 1) {
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing ${((currentUsersPage - 1) * usersPerPage) + 1} to ${Math.min(currentUsersPage * usersPerPage, filteredUsers.length)} of ${filteredUsers.length} results
                    </div>
                    <div class="flex items-center space-x-2">
            `;

            // Previous button
            paginationHTML += `
                <button onclick="changeUsersPage(${currentUsersPage - 1})" 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors ${
                            currentUsersPage === 1 ? 'opacity-50 cursor-not-allowed' : ''
                        }" 
                        ${currentUsersPage === 1 ? 'disabled' : ''}>
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
            `;

            // Page numbers
            const startPage = Math.max(1, currentUsersPage - 2);
            const endPage = Math.min(totalPages, currentUsersPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="changeUsersPage(${i})" 
                            class="px-3 py-2 text-sm font-medium rounded-md transition-colors ${
                                i === currentUsersPage 
                                    ? 'bg-blue-600 text-white' 
                                    : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50'
                            }">
                        ${i}
                    </button>
                `;
            }

            // Next button
            paginationHTML += `
                <button onclick="changeUsersPage(${currentUsersPage + 1})" 
                        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors ${
                            currentUsersPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''
                        }" 
                        ${currentUsersPage === totalPages ? 'disabled' : ''}>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            `;

            paginationHTML += `
                    </div>
                </div>
            `;

            paginationContainer.innerHTML = paginationHTML;
            lucide.createIcons();
        }

        // Change users page
        function changeUsersPage(page) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentUsersPage = page;
            renderFilteredUsers();
        }

        // Export users to CSV
        function exportUsersToCSV() {
            if (filteredUsers.length === 0) {
                createToast({ type: 'warning', message: 'No users to export!' });
                return;
            }

            const headers = ['ID', 'Email', 'Name', 'Created Date', 'Level', 'Last Activity'];
            const csvContent = [
                headers.join(','),
                ...filteredUsers.map(user => [
                    user.id || user.user_id || '',
                    `"${(user.email || '').replace(/"/g, '""')}"`,
                    `"${(user.full_name || user.name || '').replace(/"/g, '""')}"`,
                    user.created_at ? new Date(user.created_at).toLocaleDateString() : '',
                    user.level || 'beginner',
                    user.last_activity ? new Date(user.last_activity).toLocaleDateString() : 'No activity'
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `users_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            createToast({ type: 'success', message: `Exported ${filteredUsers.length} users to CSV!` });
        }

        // Make functions globally available
        window.sortUsersTable = sortUsersTable;
        window.changeUsersPage = changeUsersPage;
        window.initializeUsersTab = initializeUsersTab;
        window.filterAndRenderUsers = filterAndRenderUsers;

        async function loadVocabulary() {
            try {
                const { data: vocabulary, error } = await supabase
                    .from('user_vocabulary')
                    .select('id,word,translation,difficulty_level,created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const vocabularyList = document.getElementById('vocabulary-list');
                
                if (!vocabulary || vocabulary.length === 0) {
                    vocabularyList.innerHTML = '<div class="text-center text-gray-500">No vocabulary words found</div>';
                    return;
                }

                vocabularyList.innerHTML = vocabulary.map(word => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div>
                            <h3 class="font-medium text-gray-900">${word.word}</h3>
                            <p class="text-sm text-gray-500">${word.translation}</p>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${word.difficulty_level || 'beginner'}
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editVocabulary('${word.id}')">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteVocabulary('${word.id}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading vocabulary:', error);
                document.getElementById('vocabulary-list').innerHTML = `
                    <div class="text-center text-red-500">Error loading vocabulary: ${error.message}</div>
                `;
            }
        }

        async function loadGrammarLessons() {
            try {
                // Check if grammar_lessons table exists first
                const { data: lessons, error } = await supabase
                    .from('grammar_lessons')
                    .select('id,title,description,language,level,created_at,is_active')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    // If table doesn't exist, show setup message
                    if (error.message.includes('does not exist')) {
                        document.getElementById('lessons-list').innerHTML = `
                            <div class="text-center p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="text-yellow-800 mb-2">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-2"></i>
                                    <h3 class="font-medium">Grammar Lessons Table Missing</h3>
                                </div>
                                <p class="text-sm text-yellow-700 mb-3">
                                    The grammar_lessons table needs to be created in your Supabase database.
                                </p>
                                <button onclick="showGrammarSetupInstructions()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                                    Show Setup Instructions
                                </button>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                    throw error;
                }

                const lessonsList = document.getElementById('lessons-list');
                
                if (!lessons || lessons.length === 0) {
                    lessonsList.innerHTML = '<div class="text-center text-gray-500">No grammar lessons found</div>';
                    return;
                }

                lessonsList.innerHTML = lessons.map(lesson => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div>
                            <h3 class="font-medium text-gray-900">${lesson.title}</h3>
                            <p class="text-sm text-gray-500">${lesson.description}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    ${lesson.level || 'beginner'}
                                </span>
                                <span class="text-xs text-gray-500">Language: ${lesson.language || 'Spanish'}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editLesson('${lesson.id}')">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteLesson('${lesson.id}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading grammar lessons:', error);
                document.getElementById('lessons-list').innerHTML = `
                    <div class="text-center text-red-500">Error loading lessons: ${error.message}</div>
                `;
            }
        }

        // Toast helper
        function createToast({ type = 'info', message = '', duration = 3000 } = {}) {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.warn('Toast container not found:', message);
                return;
            }
            const id = 'toast-' + Math.random().toString(36).slice(2);
            const colorMap = {
                success: { bg: 'bg-green-600', icon: 'check-circle', ring: 'ring-green-500/20' },
                error: { bg: 'bg-red-600', icon: 'alert-triangle', ring: 'ring-red-500/20' },
                info: { bg: 'bg-blue-600', icon: 'info', ring: 'ring-blue-500/20' },
                warning: { bg: 'bg-yellow-600', icon: 'alert-circle', ring: 'ring-yellow-500/20' }
            }[type] || { bg: 'bg-gray-800', icon: 'bell', ring: 'ring-gray-500/20' };

            const wrapper = document.createElement('div');
            wrapper.id = id;
            wrapper.className = `pointer-events-auto transform transition-all duration-300 translate-y-0 opacity-0`;

            wrapper.innerHTML = `
                <div class="flex items-start gap-3 text-white shadow-lg rounded-lg px-4 py-3 ${colorMap.bg} ring-1 ${colorMap.ring}">
                    <i data-lucide="${colorMap.icon}" class="w-5 h-5 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm leading-5">${message}</div>
                    <button type="button" aria-label="Close" class="ml-2 opacity-80 hover:opacity-100">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>`;

            container.appendChild(wrapper);
            lucide.createIcons({ attrs: { 'stroke-width': 2 } });
            requestAnimationFrame(() => {
                wrapper.classList.remove('opacity-0');
                wrapper.classList.add('opacity-100');
            });

            const remove = () => {
                wrapper.classList.remove('opacity-100');
                wrapper.classList.add('opacity-0');
                setTimeout(() => wrapper.remove(), 250);
            };

            const closeBtn = wrapper.querySelector('button');
            closeBtn.addEventListener('click', remove);
            if (duration > 0) setTimeout(remove, duration);
        }

        // Utility functions
        window.updateLastUpdated = window.updateLastUpdated || function() {
            const now = new Date();
            const timeString = now.toLocaleString();
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Last updated: ${timeString}`;
            }
        };

        function showError(message) {
            createToast({ type: 'error', message });
        }

        function showSuccess(message) {
            createToast({ type: 'success', message });
        }

        function saveDraft() {
            // Save current wizard data as draft
            saveCurrentStepData();
            
            // Store draft in localStorage for now (in production, save to database)
            localStorage.setItem('courseWizardDraft', JSON.stringify(courseWizardData));
            
            showSuccess('Draft saved successfully!');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

            if (diffInMinutes < 60) {
                return `${diffInMinutes} minutes ago`;
            } else if (diffInHours < 24) {
                return `${diffInHours} hours ago`;
            } else {
                return `${diffInDays} days ago`;
            }
        }

        async function loadRecentActivity() {
            try {
                console.log('Loading recent activity...');

                // Connection guard to fail fast with better error handling
                if (typeof checkConnection === 'function') {
                    const ok = await checkConnection();
                    if (!ok) {
                        const activityList = document.getElementById('activity-list');
                        if (activityList) {
                            activityList.innerHTML = `
                                <div class="text-center p-6">
                                    <div class="text-yellow-600 mb-4">
                                        <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-2"></i>
                                        <h3 class="text-lg font-semibold">Database connection unavailable</h3>
                                    </div>
                                    <p class="text-gray-600">Please ensure the database is reachable and try again.</p>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                        return;
                    }
                }

                // Step 1: fetch recent sessions with minimal columns (avoid select(*))
                const { data: sessions, error: sessionsError } = await supabase
                    .from('learning_sessions')
                    .select('id,user_id,created_at,lesson_type,completed')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (sessionsError) {
                    console.error('Supabase error in loadRecentActivity (sessions):', sessionsError);
                    throw sessionsError;
                }

                console.log('Recent activity sessions:', sessions);
                const activityList = document.getElementById('activity-list');
                
                if (!sessions || sessions.length === 0) {
                    activityList.innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-gray-400 mb-4">
                                <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2"></i>
                                <h3 class="text-lg font-semibold text-gray-600">No Recent Activity</h3>
                            </div>
                            <p class="text-gray-500 mb-4">Learning sessions will appear here once users start using the application.</p>
                            <div class="text-sm text-gray-400">
                                <p> Tip: Users need to complete lessons or assessments to generate activity data.</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Step 2: fetch user profiles in separate call (avoid relational select)
                const userIds = Array.from(new Set(sessions.map(s => s.user_id).filter(Boolean)));
                let profilesById = {};
                if (userIds.length > 0) {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id,full_name,email')
                        .in('id', userIds);

                    if (profilesError) {
                        console.warn('Non-fatal: failed to fetch user profiles for recent activity:', profilesError);
                    } else if (profiles && profiles.length) {
                        profilesById = profiles.reduce((acc, p) => {
                            acc[p.id] = p;
                            return acc;
                        }, {});
                    }
                }

                // Render list
                activityList.innerHTML = sessions.map(activity => {
                    const profile = profilesById[activity.user_id] || null;
                    const userName = profile?.full_name || profile?.email || 'Unknown User';
                    const timeAgo = getTimeAgo(new Date(activity.created_at));
                    const action = activity.completed ? 'Completed session' : 'Started session';
                    const target = activity.lesson_type || 'Learning session';
                    
                    return `
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${userName}</p>
                                <p class="text-sm text-gray-500">${action}: ${target}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="text-xs text-gray-400">${timeAgo}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading recent activity:', error);
                const activityList = document.getElementById('activity-list');
                if (activityList) {
                    const msg = (error && error.message) ? error.message : 'Unknown error';
                    activityList.innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-red-600 mb-4">
                                <i data-lucide="wifi-off" class="w-12 h-12 mx-auto mb-2"></i>
                                <h3 class="text-lg font-semibold">Unable to load recent activity</h3>
                            </div>
                            <p class="text-gray-600 mb-2">${msg}</p>
                            <p class="text-gray-500">Please check your internet connection or try again shortly.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        }

        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('[id$="-tab"]');
            tabs.forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active state to selected tab
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Load data for specific tabs
            if (tabName === 'users') {
                loadUsers();
                // Initialize users tab functionality if not already done
                if (typeof window.usersTabInitialized === 'undefined') {
                    initializeUsersTab();
                    window.usersTabInitialized = true;
                }
            } else if (tabName === 'questions') {
                loadQuestions();
            } else if (tabName === 'notifications') {
                initNotificationsTab();
            } else if (tabName === 'support') {
                initSupportTab();
            }
        }
        
        window.showTab = window.showTab || showTab;

        let notificationsTabInitialized = false;

        function parseCommaList(value = '') {
            return value
                .split(',')
                .map((entry) => entry.trim())
                .filter(Boolean);
        }

        function formatNotificationTimestamp(value) {
            try {
                const date = new Date(value);
                if (isNaN(date.getTime())) return value || '';
                return date.toLocaleString();
            } catch (_) {
                return value || '';
            }
        }

        /* =========================
         * Support Tickets (Admin)
         * ========================= */
        let supportInit = false;
        let supportTicketsCh = null;
        let supportMsgsCh = null;
        let supportCurrentTicket = null;
        let supportCurrentUserId = null;

        async function initSupportTab() {
            try {
                if (!supportInit) {
                    const u = await supabase.auth.getUser().catch(() => ({ data: { user: null } }));
                    supportCurrentUserId = (u && u.data && u.data.user && u.data.user.id) ? u.data.user.id : null;
                    await supportLoadTickets();

                    if (!supportTicketsCh) {
                        supportTicketsCh = supabase
                            .channel('admin_support_tickets')
                            .on('postgres_changes', { event: '*', schema: 'public', table: 'support_tickets' }, () => {
                                supportLoadTickets();
                            })
                            .subscribe();
                    }

                    const sendBtn = document.getElementById('support-reply-send');
                    if (sendBtn && !sendBtn.dataset.bound) {
                        sendBtn.addEventListener('click', supportSendReply);
                        sendBtn.dataset.bound = '1';
                    }
                    supportInit = true;
                } else {
                    await supportLoadTickets();
                }
            } catch (err) {
                console.error('initSupportTab error:', err);
                const list = document.getElementById('support-ticket-list');
                if (list) list.innerHTML = `<div class="p-4 text-sm text-red-600">Failed to load tickets: ${ (err && err.message) ? err.message : err }</div>`;
            }
        }

        async function supportLoadTickets() {
            const list = document.getElementById('support-ticket-list');
            if (!list) return;
            list.innerHTML = `<div class="p-4 text-sm text-gray-500">Loading tickets</div>`;
            try {
                const client = (typeof supabaseAdmin !== 'undefined' && supabaseAdmin) ? supabaseAdmin : supabase;
                const { data, error } = await client
                    .from('support_tickets')
                    .select('id,subject,user_id,priority,status,last_message_at,unread_by_admin')
                    .order('last_message_at', { ascending: false })
                    .limit(200);
                if (error) throw error;

                const tickets = data || [];
                if (!tickets.length) {
                    list.innerHTML = `<div class="p-4 text-sm text-gray-500">No tickets found.</div>`;
                    return;
                }

                const frag = document.createDocumentFragment();
                tickets.forEach(t => {
                    const row = document.createElement('button');
                    row.className = 'w-full text-left px-4 py-3 border-b hover:bg-gray-50';
                    const last = t.last_message_at ? new Date(t.last_message_at).toLocaleString() : '';
                    const badgeClass = t.unread_by_admin ? 'text-red-600' : 'text-gray-400';
                    row.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="font-medium truncate">${supportEscape(t.subject || '(no subject)')}</div>
                            <span class="text-xs ${badgeClass}">${supportEscape(t.status || '')}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${last}</div>
                    `;
                    row.addEventListener('click', () => supportOpenTicket(t));
                    frag.appendChild(row);
                });

                list.innerHTML = '';
                list.appendChild(frag);
            } catch (err) {
                console.error('supportLoadTickets error:', err);
                list.innerHTML = `<div class="p-4 text-sm text-red-600">Failed to load tickets.</div>`;
            }
        }

        async function supportOpenTicket(ticket) {
            supportCurrentTicket = ticket;

            const header = document.getElementById('support-thread-header');
            if (header) {
                const subject = supportEscape(ticket.subject || '(no subject)');
                const st = supportEscape(ticket.status || '');
                header.textContent = `${subject}  ${st}`;
            }

            // Unsubscribe previous
            if (supportMsgsCh) {
                try { supportMsgsCh.unsubscribe(); } catch (_) {}
                supportMsgsCh = null;
            }

            await supportLoadMessages(ticket.id);

            // Realtime for messages of this ticket
            const rtClient = (typeof supabaseAdmin !== 'undefined' && supabaseAdmin) ? supabaseAdmin : supabase;
            supportMsgsCh = rtClient
                .channel(`support_ticket_${ticket.id}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'support_messages', filter: `ticket_id=eq.${ticket.id}` }, (payload) => {
                    const msg = payload && payload.new;
                    if (msg) supportAppendMessage(msg);
                })
                .subscribe();
        }

        async function supportLoadMessages(ticketId) {
            const box = document.getElementById('support-message-list');
            if (!box) return;
            box.innerHTML = `<div class="text-sm text-gray-500">Loading messages</div>`;
            try {
                const client = (typeof supabaseAdmin !== 'undefined' && supabaseAdmin) ? supabaseAdmin : supabase;
                const { data, error } = await client
                    .from('support_messages')
                    .select('id,ticket_id,sender_id,sender_role,content,created_at')
                    .eq('ticket_id', ticketId)
                    .order('created_at', { ascending: true });
                if (error) throw error;
                box.innerHTML = '';
                (data || []).forEach(m => supportAppendMessage(m));
            } catch (err) {
                console.error('supportLoadMessages error:', err);
                box.innerHTML = `<div class="text-sm text-red-600">Failed to load messages.</div>`;
            }
        }

        function supportAppendMessage(m) {
            const box = document.getElementById('support-message-list');
            if (!box) return;
            const mine = m.sender_role === 'admin';
            const wrap = document.createElement('div');
            wrap.className = `flex ${mine ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] rounded-lg px-3 py-2 text-sm ${mine ? 'bg-emerald-50 text-emerald-900' : 'bg-gray-100 text-gray-900'}`;
            const who = mine ? 'Admin' : 'User';
            const when = m.created_at ? new Date(m.created_at).toLocaleString() : '';
            bubble.innerHTML = `<div class="text-xs opacity-70 mb-1">${who}</div><div class="whitespace-pre-wrap break-words">${supportEscape(m.content || '')}</div><div class="text-[10px] opacity-60 mt-1">${when}</div>`;
            wrap.appendChild(bubble);
            box.appendChild(wrap);
            box.scrollTop = box.scrollHeight;
        }

        async function supportSendReply() {
            const input = document.getElementById('support-reply-text');
            const hint = document.getElementById('support-reply-hint');
            if (!supportCurrentTicket || !input) return;
            const text = (input.value || '').trim();
            if (!text) return;

            try {
                // Use secure RPC that runs with SECURITY DEFINER to bypass RLS safely for admins
                const rpcClient = (typeof supabaseAdmin !== 'undefined' && supabaseAdmin) ? supabaseAdmin : supabase;
                const { data, error } = await rpcClient.rpc('admin_add_support_message', {
                    p_ticket_id: supportCurrentTicket.id,
                    p_content: text
                });
                if (error) throw error;
                if (data) supportAppendMessage(data);
                input.value = '';
                if (hint) { hint.textContent = 'Sent'; setTimeout(() => hint.textContent = '', 1200); }
            } catch (err) {
                console.error('supportSendReply error:', err);
                const msg = (err && (err.message || err.error_description)) || 'Failed to send message';
                if (hint) hint.textContent = msg;
            }
        }

        function supportEscape(s) {
            try {
                return String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            } catch (_) {
                return '';
            }
        }

        function updateNotificationRealtimeChip(stateText = 'idle') {
            const chip = document.getElementById('notification-realtime-chip');
            if (chip) {
                chip.textContent = `Realtime: ${stateText}`;
            }
        }

        // Ensure we are authenticated as admin for actions that require RLS admin
        async function ensureAdminSession() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user && user.email && /@edlingo\.com\s*$/i.test(user.email)) {
                    return user;
                }
                // Try sign in; if fails, try sign up then sign in
                let { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@edlingo.com',
                    password: 'admin123456'
                });
                if (error) {
                    const su = await supabase.auth.signUp({
                        email: 'admin@edlingo.com',
                        password: 'admin123456',
                        options: { data: { full_name: 'Admin User', role: 'admin' } }
                    });
                    // Try sign in again
                    await supabase.auth.signInWithPassword({
                        email: 'admin@edlingo.com',
                        password: 'admin123456'
                    });
                }
                const res = await supabase.auth.getUser();
                return res?.data?.user || null;
            } catch (_) {
                return null;
            }
        }

        async function initNotificationsTab(force = false) {
            const form = document.getElementById('notification-form');
            if (form && !form.dataset.bound) {
                form.addEventListener('submit', handleNotificationFormSubmit);
                form.dataset.bound = 'true';
            }

            if (!notificationsTabInitialized || force) {
                notificationsTabInitialized = true;
                updateNotificationRealtimeChip('ready');
            }

            await refreshNotificationFeed();
        }

        async function handleNotificationFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('send-notification-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>Sending...';
            }

            const formData = new FormData(form);
            const payload = {
                p_title: (formData.get('title') || '').trim(),
                p_content: (formData.get('message') || '').trim(),
                p_type: formData.get('type') || 'info',
                p_priority: formData.get('priority') || 'normal',
                p_audience: formData.get('audience') || 'all',
                p_target_identifiers: parseCommaList(formData.get('targetIdentifiers') || ''),
                p_course_ids: parseCommaList(formData.get('courseIds') || ''),
                p_action_url: (formData.get('actionUrl') || '').trim(),
                p_metadata: {},
                p_is_visible: formData.get('isVisible') === 'on'
            };

            if (!payload.p_content) {
                createToast({ type: 'warning', message: 'Message body is required' });
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Notification';
                return;
            }

            if (payload.p_audience === 'user' && payload.p_target_identifiers.length === 0) {
                createToast({ type: 'warning', message: '     ' });
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Notification';
                return;
            }

            if (payload.p_audience === 'course' && payload.p_course_ids.length === 0) {
                createToast({ type: 'warning', message: '     ' });
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Notification';
                return;
            }

            if (payload.p_target_identifiers.length === 0) payload.p_target_identifiers = null;
            if (payload.p_course_ids.length === 0) payload.p_course_ids = null;

            try {
                const { error } = await supabaseAdmin.rpc('admin_dispatch_notification', payload);
                if (error) throw error;
                createToast({ type: 'success', message: 'Notification sent successfully' });
                form.reset();
                const lastSent = document.getElementById('notification-last-sent');
                if (lastSent) lastSent.textContent = `Sent: ${new Date().toLocaleTimeString()}`;
                await refreshNotificationFeed();
            } catch (err) {
                console.error('Failed to send notification', err);
                createToast({ type: 'error', message: err.message || 'Failed to send notification' });
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Notification';
                }
            }
        }

        async function refreshNotificationFeed() {
            const container = document.getElementById('notification-feed');
            const countChip = document.getElementById('notification-feed-count');
            if (!container) return;

            container.innerHTML = `
                <div class="flex items-center justify-center text-gray-500 py-10">
                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                    Loading notifications...
                </div>
            `;
            lucide.createIcons();

            try {
                const { data, error } = await supabaseAdmin
                    .from('notifications')
                    .select('id,title,content,type,priority,is_visible,is_read,created_at,action_url')
                    .order('created_at', { ascending: false })
                    .limit(50);
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <i data-lucide="bell" class="w-8 h-8 mx-auto mb-3"></i>
                            No notifications yet.
                        </div>
                    `;
                    countChip && (countChip.textContent = '0 entries');
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = data.map((item) => `
                    <div class="border border-gray-100 rounded-xl p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900">${item.title || 'Announcement'}</h3>
                                <p class="text-sm text-gray-600 mt-1">${item.content || ''}</p>
                                <div class="flex flex-wrap gap-2 text-xs text-gray-500 mt-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-700 capitalize">${item.type}</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full ${item.priority === 'high' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                        Priority: ${item.priority || 'normal'}
                                    </span>
                                    <span>${formatNotificationTimestamp(item.created_at)}</span>
                                    ${item.action_url ? `<a href="${item.action_url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">Open link</a>` : ''}
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-500">
                                <button class="text-blue-600 hover:text-blue-800 block" onclick="toggleNotificationVisibility('${item.id}', ${item.is_visible})">
                                    ${item.is_visible ? 'Hide' : 'Show'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (countChip) countChip.textContent = `${data.length} entries`;
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load notification feed', err);
                container.innerHTML = `
                    <div class="text-center text-red-500 py-12">
                        Failed to load notifications: ${err.message || 'Unknown error'}
                    </div>
                `;
            }
        }

        async function toggleNotificationVisibility(id, currentlyVisible) {
            try {
                const { error } = await supabaseAdmin
                    .from('notifications')
                    .update({ is_visible: !currentlyVisible })
                    .eq('id', id);
                if (error) throw error;
                createToast({ type: 'success', message: !currentlyVisible ? 'Notification is now visible' : 'Notification is hidden' });
                await refreshNotificationFeed();
            } catch (err) {
                console.error('Failed to toggle notification visibility', err);
                createToast({ type: 'error', message: err.message || 'Failed to update notification visibility' });
            }
        }

        window.refreshNotificationFeed = window.refreshNotificationFeed || refreshNotificationFeed;
        window.toggleNotificationVisibility = window.toggleNotificationVisibility || toggleNotificationVisibility;
        
        // Modal functions
        window.showAddCourseModal = window.showAddCourseModal || function() {
            // Reset modal to create mode
            const modalTitleElement = document.getElementById('courseModalTitle');
            const finishBtnElement = document.getElementById('finishBtn');
            if (modalTitleElement) {
                modalTitleElement.textContent = 'Create New Course';
            }
            if (finishBtnElement) {
                finishBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Create Course';
            }
            // Clear any edit data and reset form
            const form = document.getElementById('courseForm');
            if (form) {
                delete form.dataset.courseId;
                delete form.dataset.isEdit;
                form.reset();
            }
            // Reset wizard data and show first step if available
            try {
                if (typeof showWizardStep === 'function') {
                    if (typeof window.courseWizardData !== 'object') {
                        window.courseWizardData = {};
                    } else {
                        window.courseWizardData = {};
                    }
                    if (typeof window.currentWizardStep !== 'number') {
                        window.currentWizardStep = 1;
                    } else {
                        window.currentWizardStep = 1;
                    }
                    showWizardStep(1);
                }
            } catch (e) {
                console.warn('Wizard init not available:', e);
            }
            const modalEl = document.getElementById('courseModal');
            if (modalEl) {
                modalEl.classList.remove('hidden');
            }
        };

        function closeCourseModal() {
            document.getElementById('courseModal').classList.add('hidden');
            
            // Reset form and clear edit data
            const form = document.getElementById('courseForm');
            form.reset();
            delete form.dataset.courseId;
            delete form.dataset.isEdit;
            
            // Reset modal to default state
            const modalTitleElement = document.getElementById('courseModalTitle');
            const finishBtnElement = document.getElementById('finishBtn');
            
            if (modalTitleElement) {
                modalTitleElement.textContent = 'Create New Course';
            }
            if (finishBtnElement) {
                finishBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Create Course';
            }
            
            // Reset wizard to first step
            showWizardStep(1);
        }
        window.closeCourseModal = window.closeCourseModal || closeCourseModal;

        // Course Creation Wizard Functions
        let currentWizardStep = 1;
        const totalWizardSteps = 4;
        let courseWizardData = {};

        function showWizardStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= totalWizardSteps; i++) {
                const step = document.getElementById(`step-${i}`);
                if (step) {
                    step.classList.add('hidden');
                }
            }
            
            // Show current step
            const currentStep = document.getElementById(`step-${stepNumber}`);
            if (currentStep) {
                currentStep.classList.remove('hidden');
            }
            
            // Ensure a default lesson with one material exists when entering Course Content (Step 2)
            if (stepNumber === 2) {
                try {
                    const lessonsContainer = document.getElementById('lessonsContainer');
                    if (lessonsContainer) {
                        const existingLessons = lessonsContainer.querySelectorAll('.lesson-item');
                        if (existingLessons.length === 0 && typeof addLesson === 'function') {
                            // Add the first lesson
                            addLesson();
                            
                            // Add a default content item and basic defaults
                            const firstLesson = lessonsContainer.querySelector('.lesson-item');
                            if (firstLesson) {
                                const titleInput = firstLesson.querySelector('.lesson-title');
                                if (titleInput && !titleInput.value) {
                                    titleInput.value = 'Lesson 1';
                                }
                                const objectivesInput = firstLesson.querySelector('.lesson-objectives');
                                if (objectivesInput && !objectivesInput.value) {
                                    objectivesInput.value = 'Introduce the lesson and outline goals.';
                                }
                                
                                const addContentBtn = firstLesson.querySelector('button[onclick*="addLessonContent"]');
                                if (addContentBtn) {
                                    addContentBtn.click();
                                    
                                    const contentItem = firstLesson.querySelector('.content-item');
                                    if (contentItem) {
                                        const contentTitle = contentItem.querySelector('.content-title');
                                        if (contentTitle && !contentTitle.value) {
                                            contentTitle.value = 'Welcome Text';
                                        }
                                        const contentText = contentItem.querySelector('.content-text');
                                        if (contentText && !contentText.value) {
                                            contentText.value = 'This is a starter material. Replace or add more as needed.';
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Failed to inject default lesson/material:', e);
                }
            }
            
            // Update navigation highlighting
            updateNavigationHighlighting(stepNumber);
            
            // Update progress indicator
            updateProgressIndicator(stepNumber);
            
            // Update navigation buttons
            updateNavigationButtons(stepNumber);
            
            currentWizardStep = stepNumber;
        }
        window.showWizardStep = window.showWizardStep || showWizardStep;

        function updateNavigationHighlighting(currentStep) {
            // Reset all navigation items
            for (let i = 1; i <= totalWizardSteps; i++) {
                const navItem = document.getElementById(`step${i}Nav`);
                const circle = navItem?.querySelector('div');
                
                if (navItem && circle) {
                    if (i === currentStep) {
                        // Current step - highlighted
                        navItem.className = 'flex items-center p-3 rounded-lg bg-blue-100 text-blue-700 cursor-pointer';
                        circle.className = 'w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center mr-3';
                    } else {
                        // Other steps - default
                        navItem.className = 'flex items-center p-3 rounded-lg text-gray-500 cursor-pointer';
                        circle.className = 'w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3';
                    }
                }
            }
        }

        function updateProgressIndicator(currentStep) {
            // Update textual step indicator (e.g., "Step 2 of 4")
            const stepIndicator = document.getElementById('stepIndicator');
            if (stepIndicator) {
                stepIndicator.textContent = `Step ${currentStep} of ${totalWizardSteps}`;
            }

            // Update the step title based on the current step
            const stepTitle = document.getElementById('stepTitle');
            if (stepTitle) {
                const titles = {
                    1: 'Basic Information',
                    2: 'Course Content',
                    3: 'Instructor Settings',
                    4: 'Review & Publish'
                };
                stepTitle.textContent = titles[currentStep] || '';
            }

            // Update the progress bar width. Prefer the header progress bar inside the course modal.
            const courseModal = document.getElementById('courseModal');
            const progressBar = courseModal ? courseModal.querySelector('#progressBar') : document.getElementById('progressBar');
            if (progressBar) {
                const percent = Math.max(0, Math.min(100, (currentStep / totalWizardSteps) * 100));
                progressBar.style.width = `${percent}%`;
            }
        }

        function updateNavigationButtons(currentStep) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const createBtn = document.getElementById('finishBtn');
            const verifyBtn = document.getElementById('verifyFilesBtn');
            
            // Previous button
            if (prevBtn) {
                prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
            }
            
            // Verification button - show in step 4 or when editing existing course
            if (verifyBtn) {
                const isEditMode = document.getElementById('courseModalTitle')?.textContent?.includes('Edit');
                verifyBtn.style.display = (currentStep === totalWizardSteps || isEditMode) ? 'inline-flex' : 'none';
            }
            
            // Next/Create button
            if (currentStep === totalWizardSteps) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (createBtn) createBtn.style.display = 'inline-flex';
                // Update review step when reaching final step
                updateReviewStep();
            } else {
                if (nextBtn) nextBtn.style.display = 'inline-flex';
                if (createBtn) createBtn.style.display = 'none';
            }
        }

        function nextWizardStep() {
            if (validateCurrentStep() && currentWizardStep < totalWizardSteps) {
                saveCurrentStepData();
                showWizardStep(currentWizardStep + 1);
            }
        }
        window.nextWizardStep = window.nextWizardStep || nextWizardStep;

        function prevWizardStep() {
            if (currentWizardStep > 1) {
                showWizardStep(currentWizardStep - 1);
            }
        }
        window.prevWizardStep = window.prevWizardStep || prevWizardStep;

        function validateCurrentStep() {
            switch (currentWizardStep) {
                case 1: // Basic Information
                    const title = document.getElementById('courseTitle')?.value;
                    const category = document.getElementById('courseCategory')?.value;
                    const cefrLevel = document.getElementById('cefrLevel')?.value;
                    if (!title || !category || !cefrLevel) {
                        showError('Please fill in all required fields');
                        return false;
                    }
                    return true;
                case 2: // Course Content
                    const objectives = document.getElementById('learningObjectives')?.value;
                    if (!objectives) {
                        showError('Please provide learning objectives');
                        return false;
                    }
                    return true;
                case 3: // Instructor Settings
                    const instructorName = document.getElementById('instructorName')?.value;
                    const instructorEmail = document.getElementById('instructorEmail')?.value;
                    if (!instructorName || !instructorEmail) {
                        showError('Please provide instructor information');
                        return false;
                    }
                    return true;
                case 4: // Review & Publish
                    return true;
                default:
                    return true;
            }
        }

        function saveCurrentStepData() {
            switch (currentWizardStep) {
                case 1: // Basic Information
                    courseWizardData.title = document.getElementById('courseTitle')?.value;
                    courseWizardData.category = document.getElementById('courseCategory')?.value;
                    courseWizardData.description = document.getElementById('courseDescription')?.value;
                    courseWizardData.cefrLevel = document.getElementById('cefrLevel')?.value;
                    courseWizardData.language = document.getElementById('courseLanguage')?.value;
                    courseWizardData.duration = document.getElementById('courseDuration')?.value;
                    courseWizardData.hoursPerWeek = document.getElementById('courseHours')?.value;
                    courseWizardData.maxStudents = document.getElementById('maxStudents')?.value;
                    courseWizardData.price = document.getElementById('coursePrice')?.value;
                    courseWizardData.currency = document.getElementById('courseCurrency')?.value;
                    break;
                case 2: // Course Content
                    courseWizardData.learningObjectives = document.getElementById('learningObjectives')?.value;
            courseWizardData.prerequisites = document.getElementById('prerequisites')?.value;
            // Collect skills focus selections
            courseWizardData.skillsFocus = Array.from(document.querySelectorAll('input[name="skillsFocus"]:checked')).map(cb => cb.value);
            courseWizardData.materials = document.getElementById('requiredMaterials')?.value;
                    courseWizardData.syllabus = document.getElementById('courseSyllabus')?.value;
                    
                    // Collect lesson data
                    try {
                        courseWizardData.lessons = collectLessonsData();
                        console.log(' Lessons data collected and saved to courseWizardData:', courseWizardData.lessons);
                    } catch (error) {
                        console.error(' Error collecting lessons data:', error);
                        courseWizardData.lessons = [];
                    }
                    break;
                case 3: // Instructor Settings
                    courseWizardData.instructorName = document.getElementById('instructorName')?.value;
                    courseWizardData.instructorEmail = document.getElementById('instructorEmail')?.value;
                    courseWizardData.instructorBio = document.getElementById('instructorBio')?.value;
                    courseWizardData.startDate = document.getElementById('startDate')?.value;
                    courseWizardData.enrollmentDeadline = document.getElementById('enrollmentDeadline')?.value;
                    courseWizardData.cancellationPolicy = document.getElementById('cancellationPolicy')?.value;
                    break;
                case 4: // Review & Publish
                    // All data already saved in previous steps
                    break;
            }
        }

        function updateReviewStep() {
            // Update course summary
            const courseSummary = document.getElementById('courseSummary');
            const courseDetailsReview = document.getElementById('courseDetailsReview');
            const instructorReview = document.getElementById('instructorReview');

            // Render lessons & materials into the review step
            const lessonsReview = document.getElementById('lessonsReview');
            if (lessonsReview) {
                const renderLessons = (lessonsArr) => {
                    lessonsReview.innerHTML = '';
                    const lessonsData = Array.isArray(lessonsArr) ? lessonsArr : [];
                    if (lessonsData.length === 0) {
                        lessonsReview.innerHTML = '<div class="text-sm text-gray-600">No lessons added yet. Go back to Step 2 to add lessons and materials.</div>';
                        return;
                    }
                    lessonsData.forEach((lesson, idx) => {
                        const safe = v => (v === null || v === undefined) ? '' : v;
                        const materials = Array.isArray(lesson.materials) ? lesson.materials : [];
                        const materialsHtml = materials.map((m, mi) => {
                            const type = (m.type || '').toUpperCase();
                            let detail = '';
                            if (m.type === 'text') {
                                const text = String(safe(m.content));
                                const preview = text.length > 140 ? text.slice(0, 140) + '' : text;
                                detail = `<div class=\"text-gray-700\">${preview}</div>`;
                            } else if (m.file_url || m.url) {
                                 const linkUrl = m.file_url || m.url;
                                 detail = `<a class=\"text-blue-700 underline break-all\" href=\"${linkUrl}\" target=\"_blank\" rel=\"noopener\">${linkUrl}</a>`;
                            } else if (m.content) {
                                detail = `<div class=\"text-gray-700\">${m.content}</div>`;
                            }
                            const meta = m.metadata ? `<div class=\"text-xs text-gray-500\">${Object.entries(m.metadata).map(([k,v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`).join('  ')}</div>` : '';
                            return `
                                <li class=\"pl-2\">
                                    <div class=\"text-sm\"><span class=\"inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-800 mr-2\">${type}</span> ${m.metadata?.title || m.content || `Material ${mi+1}`}</div>
                                    ${detail}
                                    ${meta}
                                </li>
                            `;
                        }).join('');

                        const block = `
                            <div class=\"bg-white rounded border border-gray-200 p-3\">
                                <div class=\"font-medium text-gray-900\">Lesson ${lesson.order_number || idx + 1}: ${lesson.title || 'Untitled'}</div>
                                ${lesson.description ? `<div class=\"text-sm text-gray-600 mt-1\">${lesson.description}</div>` : ''}
                                <ul class=\"list-disc ml-5 mt-2 space-y-1\">${materialsHtml || '<li class=\"text-sm text-gray-500\">No materials added</li>'}</ul>
                            </div>
                        `;
                        lessonsReview.insertAdjacentHTML('beforeend', block);
                    });
                };

                // Resolve lessons if it's a Promise
                let candidate = (typeof courseWizardData !== 'undefined') ? courseWizardData.lessons : undefined;

                // Fallback: if no cached lessons yet but DOM has lessons, collect directly from DOM
                try {
                    const hasDomLessons = document.querySelectorAll('.lesson-item').length > 0;
                    if ((!candidate || (Array.isArray(candidate) && candidate.length === 0)) && hasDomLessons) {
                        const collected = collectLessonsData(); // async, returns a Promise
                        if (collected && typeof collected.then === 'function') {
                            courseWizardData.lessons = collected;
                            candidate = collected; // will be handled by the Promise branch below
                        } else if (Array.isArray(collected)) {
                            courseWizardData.lessons = collected;
                            candidate = collected;
                        }
                    }
                } catch (err) {
                    console.warn('Could not collect lessons on review step:', err);
                }

                if (candidate && typeof candidate.then === 'function') {
                    lessonsReview.innerHTML = '<div class="text-sm text-gray-600">Collecting lesson data</div>';
                    candidate.then(ls => renderLessons(ls)).catch(err => {
                        console.error('Failed to resolve lessons for review:', err);
                        lessonsReview.innerHTML = '<div class="text-sm text-red-700">Failed to load lessons. Please go back to Step 2 and try again.</div>';
                    });
                } else {
                    renderLessons(candidate);
                }
            }
            
            if (courseSummary) {
                const title = document.getElementById('courseTitle')?.value || 'Untitled Course';
                const category = document.getElementById('courseCategory')?.value || 'General';
                const cefrLevel = document.getElementById('cefrLevel')?.value || 'A1';
                const duration = document.getElementById('courseDuration')?.value || '4';
                const hours = document.getElementById('courseHours')?.value || '2';
                const price = document.getElementById('coursePrice')?.value || '0';
                const currency = document.getElementById('courseCurrency')?.value || 'USD';
                
                courseSummary.innerHTML = `
                    <div><strong>${title}</strong></div>
                    <div>Category: ${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div>CEFR Level: ${cefrLevel}</div>
                    <div>Duration: ${duration} weeks (${hours} hours/week)</div>
                    <div>Price: ${price} ${currency}</div>
                `;
            }
            
            if (courseDetailsReview) {
                const maxStudents = document.getElementById('maxStudents')?.value || '20';
                const duration = document.getElementById('courseDuration')?.value || '4';
                const hours = document.getElementById('courseHours')?.value || '2';
                const cefrLevel = document.getElementById('cefrLevel')?.value || 'A1';
                const category = document.getElementById('courseCategory')?.value || 'General';
                const language = document.getElementById('courseLanguage')?.value || 'English';
                
                courseDetailsReview.innerHTML = `
                    <div>Max Students: ${maxStudents}</div>
                    <div>Duration: ${duration} weeks</div>
                    <div>Hours per week: ${hours}</div>
                    <div>CEFR Level: ${cefrLevel}</div>
                    <div>Category: ${category}</div>
                    <div>Language: ${language}</div>
                `;
            }
            
            if (instructorReview) {
                const instructorName = document.getElementById('instructorName')?.value || 'Not specified';
                const instructorEmail = document.getElementById('instructorEmail')?.value || 'Not specified';
                const startDate = document.getElementById('startDate')?.value || 'Not set';
                const enrollmentDeadline = document.getElementById('enrollmentDeadline')?.value || 'Not set';
                
                instructorReview.innerHTML = `
                    <div>Name: ${instructorName}</div>
                    <div>Email: ${instructorEmail}</div>
                    <div>Start Date: ${startDate}</div>
                    <div>Enrollment Deadline: ${enrollmentDeadline}</div>
                `;
            }
        }



        // Lesson Management Functions
        function addLesson(databaseId = null) {
            const lessonsContainer = document.getElementById('lessonsContainer');
            const lessonCount = document.querySelectorAll('.lesson-item').length + 1;
            
            const lessonHTML = `
                <div id="lesson-${lessonCount}" class="lesson-item bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4" data-lesson-db-id="${databaseId || ''}">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-900">Lesson ${lessonCount}</h4>
                        <button type="button" onclick="removeLesson(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Title</label>
                            <input type="text" class="lesson-title w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter lesson title">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">CEFR Level</label>
                            <select class="lesson-cefr w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="A1">A1 - Beginner</option>
                                <option value="A2">A2 - Elementary</option>
                                <option value="B1">B1 - Intermediate</option>
                                <option value="B2">B2 - Upper Intermediate</option>
                                <option value="C1">C1 - Advanced</option>
                                <option value="C2">C2 - Proficient</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes)</label>
                            <input type="number" class="lesson-duration w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="30" min="5" max="120">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                            <select class="lesson-content-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="mixed">Mixed Content</option>
                                <option value="reading">Reading Focus</option>
                                <option value="listening">Listening Focus</option>
                                <option value="speaking">Speaking Focus</option>
                                <option value="writing">Writing Focus</option>
                                <option value="grammar">Grammar Focus</option>
                                <option value="vocabulary">Vocabulary Focus</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Learning Objectives</label>
                        <textarea class="lesson-objectives w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="What will students learn in this lesson?"></textarea>
                    </div>
                    
                    <!-- Lesson Content Section -->
                    <div class="mt-4 border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-medium text-gray-800">Lesson Content</h5>
                            <button type="button" onclick="addLessonContent(this)" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Add Content
                            </button>
                        </div>
                        <div class="lesson-content-container space-y-3">
                            <!-- Content items will be added here -->
                        </div>
                    </div>
                    
                    <div class="mt-3 flex space-x-2">
                        <button type="button" onclick="generateLessonContent(this)" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                            AI Generate Content
                        </button>
                        <button type="button" onclick="addLessonQuestions(this)" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <i data-lucide="help-circle" class="w-4 h-4 inline mr-1"></i>
                            Add Questions
                        </button>
                    </div>

                    <!-- Lesson Files (auto-linked by lesson number) -->
                    <div class="mt-4 border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-medium text-gray-800">Lesson Files</h5>
                            <button type="button" class="refresh-lesson-files px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Refresh</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">These links are pulled from the course-materials storage under the folder for this lesson.</div>
                        <div class="lesson-files-list border rounded-lg p-3 bg-white">
                            <div class="text-gray-500 text-sm">No files found for this lesson.</div>
                        </div>
                    </div>
                </div>
            `;
            
            lessonsContainer.insertAdjacentHTML('beforeend', lessonHTML);
            lucide.createIcons();
            // Initialize the Lesson Files section for the newly added lesson
            const lessonItemEl = document.getElementById(`lesson-${lessonCount}`);
            if (lessonItemEl && typeof setupLessonFilesSection === 'function') {
                setupLessonFilesSection(lessonItemEl);
            }
        }

        async function removeLesson(button) {
            if (!button) {
                console.error('Button element is null in removeLesson');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found');
                return;
            }
            
            const databaseId = lessonItem.getAttribute('data-lesson-db-id');
            
            // If lesson has a database ID, delete from database
            if (databaseId && databaseId.trim() !== '') {
                try {
                    const client = supabaseAdmin || supabase;
                    const { error } = await client
                        .from('lessons')
                        .delete()
                        .eq('id', databaseId);
                    
                    if (error) {
                        console.error(' Failed to delete lesson from database:', error);
                        alert('Failed to delete lesson from database. Please try again.');
                        return;
                    }
                    
                    console.log(' Lesson deleted from database:', databaseId);
                } catch (error) {
                    console.error(' Error deleting lesson:', error);
                    alert('Error deleting lesson. Please try again.');
                    return;
                }
            }
            
            lessonItem.remove();
            
            // Renumber remaining lessons
            document.querySelectorAll('.lesson-item').forEach((item, index) => {
                const title = item.querySelector('h4');
                if (title && title.textContent.startsWith('Lesson ')) {
                    title.textContent = `Lesson ${index + 1}`;
                }
            });

            // After renumbering, refresh files list for all lessons to reflect new lesson numbers
            if (typeof refreshAllLessonFiles === 'function') {
                refreshAllLessonFiles();
            }
        }
        window.removeLesson = window.removeLesson || removeLesson;

        // ===== Lesson Files helpers (Supabase Storage) =====
        function getSanitizedCourseFolder() {
            let courseName = '';
            const courseTitleInput = document.getElementById('courseTitle') || document.querySelector('input[name="title"]');
            if (courseTitleInput && courseTitleInput.value) {
                courseName = courseTitleInput.value.trim();
            }
            if (courseName) {
                return courseName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
            }
            return 'course_content';
        }

        async function renderLessonFilesForItem(lessonItem) {
            try {
                const lessonsContainer = document.getElementById('lessonsContainer');
                const items = Array.from(lessonsContainer.querySelectorAll('.lesson-item'));
                const lessonNumber = items.indexOf(lessonItem) + 1; // 1-based index

                const listEl = lessonItem.querySelector('.lesson-files-list');
                if (!listEl) return;

                listEl.innerHTML = '<div class="text-gray-500 text-sm">Loading files</div>';

                const courseFolder = getSanitizedCourseFolder();
                const folderPath = `${courseFolder}/lesson_${lessonNumber}`;

                let files = [];
                try {
                    files = await supabaseStorageService.listFiles('course-materials', folderPath);
                } catch (err) {
                    console.warn('Failed to list lesson files:', err);
                }

                if (!files || files.length === 0) {
                    listEl.innerHTML = '<div class="text-gray-500 text-sm">No files found for this lesson.</div>';
                    return;
                }

                const linksHtml = files.map(f => {
                    const filePath = `${folderPath}/${f.name}`;
                    const url = supabaseStorageService.getFileUrl('course-materials', filePath);
                    const icon = f.type?.startsWith('image/') ? '' : f.type?.startsWith('audio/') ? '' : f.type?.startsWith('video/') ? '' : f.name.toLowerCase().endsWith('.pdf') ? '' : '';
                    return `<li class=\"py-1 flex items-center gap-2\"><span>${icon}</span><a class=\"text-blue-600 hover:underline break-all\" href=\"${url}\" target=\"_blank\" rel=\"noopener\">${f.name}</a></li>`;
                }).join('');

                listEl.innerHTML = `<ul class=\"list-disc pl-5\">${linksHtml}</ul>`;
            } catch (e) {
                console.error('Error rendering lesson files:', e);
            }
        }

        function setupLessonFilesSection(lessonItem) {
            const refreshBtn = lessonItem.querySelector('.refresh-lesson-files');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => renderLessonFilesForItem(lessonItem));
            }
            // Initial render
            renderLessonFilesForItem(lessonItem);
        }

        function refreshAllLessonFiles() {
            const lessons = document.querySelectorAll('.lesson-item');
            lessons.forEach(item => renderLessonFilesForItem(item));
        }

        // Refresh lesson files when course title changes (so folder path updates)
        const courseTitleEl = document.getElementById('courseTitle') || document.querySelector('input[name="title"]');
        if (courseTitleEl) {
            let debounceTimer;
            courseTitleEl.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => refreshAllLessonFiles(), 500);
            });
        }

        // Lesson Content Management Functions
        function addLessonContent(button) {
            if (!button) {
                console.error('Button element is null in addLessonContent');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found');
                return;
            }
            const contentContainer = lessonItem.querySelector('.lesson-content-container');
            const contentCount = contentContainer.querySelectorAll('.content-item').length + 1;
            
            const contentHTML = `
                <div class="content-item bg-white p-3 rounded border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h6 class="font-medium text-gray-700">Content Item ${contentCount}</h6>
                        <button type="button" onclick="removeLessonContent(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Content Type</label>
                            <select class="content-type w-full px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateContentFields(this)">
                                <option value="text">Text Content</option>
                                <option value="image">Image</option>
                                <option value="audio">Audio</option>
                                <option value="video">Video</option>
                                <option value="pdf">PDF Document</option>
                                <option value="quiz">Interactive Quiz</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Content Title</label>
                            <input type="text" class="content-title w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Enter content title">
                        </div>
                    </div>
                    
                    <!-- Dynamic content fields based on type -->
                    <div class="content-fields">
                        <!-- Text Content (default) -->
                        <div class="text-content-fields">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                            <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-2 flex space-x-2">
                        <button type="button" onclick="previewContent(this)" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                            <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>
                            Preview
                        </button>
                        <button type="button" onclick="moveContentUp(this)" class="px-2 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                            <i data-lucide="arrow-up" class="w-3 h-3 inline mr-1"></i>
                            Up
                        </button>
                        <button type="button" onclick="moveContentDown(this)" class="px-2 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                            <i data-lucide="arrow-down" class="w-3 h-3 inline mr-1"></i>
                            Down
                        </button>
                    </div>
                </div>
            `;
            
            contentContainer.insertAdjacentHTML('beforeend', contentHTML);
            lucide.createIcons();
        }
        window.addLessonContent = window.addLessonContent || addLessonContent;

        function removeLessonContent(button) {
            if (!button) {
                console.error('Button element is null in removeLessonContent');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const container = contentItem.parentElement;
            contentItem.remove();
            
            // Renumber remaining content items
            container.querySelectorAll('.content-item').forEach((item, index) => {
                const title = item.querySelector('h6');
                if (title && title.textContent.startsWith('Content Item ')) {
                    title.textContent = `Content Item ${index + 1}`;
                }
            });
        }
        window.removeLessonContent = window.removeLessonContent || removeLessonContent;

        function updateContentFields(selectElement) {
            if (!selectElement) {
                console.error('Select element is null in updateContentFields');
                return;
            }
            const contentItem = selectElement.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const contentFields = contentItem.querySelector('.content-fields');
            const contentType = selectElement.value;
            
            let fieldsHTML = '';
            
            switch(contentType) {
                case 'text':
                    fieldsHTML = `
                        <div class="text-content-fields">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                            <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                        </div>
                    `;
                    break;
                case 'image':
                    fieldsHTML = `
                        <div class="image-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Image Source</label>
                                    <select class="image-source-type w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2" onchange="toggleImageSourceFields(this)">
                                        <option value="upload">Upload New Image</option>
                                        <option value="existing">Select Existing Image</option>
                                    </select>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="image/*" onchange="handleImageUpload(this)">
                                    <select class="existing-image-select w-full px-2 py-1 border border-gray-300 rounded text-sm" style="display: none;" onchange="handleExistingImageSelect(this)">
                                        <option value="">Loading existing images...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Alt Text</label>
                                    <input type="text" class="content-alt w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Describe the image">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Caption (optional)</label>
                                <input type="text" class="content-caption w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Image caption">
                            </div>
                            <!-- Image preview and management section -->
                            <div class="image-loaded-preview mt-3" style="display: none;">
                                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                                    <div class="flex items-start justify-between mb-2">
                                        <label class="block text-sm font-medium text-gray-600">Current Image</label>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                                Replace
                                            </button>
                                            <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                                <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                    <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous" fetchpriority="low" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22160%22><rect width=%22240%22 height=%22160%22 fill=%23f3f4f6/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%236b7280%22>Image unavailable</text></svg>';">
                                    <input type="hidden" class="current-image-url" value="">
                                    <input type="hidden" class="material-id" value="">
                                </div>
                            </div>
                            <!-- File replacement input (hidden) -->
                            <input type="file" class="replace-file-input" accept="image/*" style="display: none;" onchange="handleImageReplace(this)">
                        </div>
                    `;
                    break;
                case 'audio':
                    fieldsHTML = `
                        <div class="audio-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Audio File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="audio/*">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Duration (seconds)</label>
                                    <input type="number" class="content-duration w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Audio duration">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Transcript (optional)</label>
                                <textarea class="content-transcript w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Audio transcript for accessibility"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'video':
                    fieldsHTML = `
                        <div class="video-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Video File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="video/*">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Duration (seconds)</label>
                                    <input type="number" class="content-duration w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Video duration">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Video Description</label>
                                <textarea class="content-description w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Describe what the video covers"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'pdf':
                    fieldsHTML = `
                        <div class="pdf-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">PDF File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept=".pdf">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Page Range (optional)</label>
                                    <input type="text" class="content-pages w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="e.g., 1-10">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Teaching Tool PDF Synonym</label>
                                <input type="text" class="content-synonym w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Alternative name or teaching tool reference for this PDF">
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Reading Instructions</label>
                                <textarea class="content-instructions w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Instructions for students on how to use this PDF"></textarea>
                            </div>

                            <div class="mt-4 pdf-highlights">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-800">PDF Highlights</label>
                                    <div class="flex space-x-2">
                                        <button type="button" class="auto-fetch-btn px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700" onclick="autoFetchPdfHighlights(this.closest('.content-item'))">
                                            <i data-lucide="download" class="w-3 h-3 inline mr-1"></i>Fetch Existing
                                        </button>
                                        <button type="button" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700" onclick="addPdfHighlightRow(this)">Add Row</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto border border-gray-200 rounded">
                                    <table class="min-w-full text-sm pdf-highlights-table">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-2 py-2 text-left">Word/Phrase</th>
                                                <th class="px-2 py-2 text-left">Synonyms (comma)</th>
                                                <th class="px-2 py-2 text-left">Page</th>
                                                <th class="px-2 py-2 text-left">X</th>
                                                <th class="px-2 py-2 text-left">Y</th>
                                                <th class="px-2 py-2 text-left">W</th>
                                                <th class="px-2 py-2 text-left">H</th>
                                                <th class="px-2 py-2 text-left">Image</th>
                                                <th class="px-2 py-2 text-left">Audio</th>
                                                <th class="px-2 py-2 text-left">Video</th>
                                                <th class="px-2 py-2 text-left">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <p class="mt-2 text-xs text-gray-500">Note: X,Y,W,H are normalized (01) relative to the PDF page.</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'quiz':
                    fieldsHTML = `
                        <div class="quiz-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Quiz Type</label>
                                    <select class="quiz-type w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="true-false">True/False</option>
                                        <option value="fill-blank">Fill in the Blank</option>
                                        <option value="matching">Matching</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Number of Questions</label>
                                    <input type="number" class="quiz-questions w-full px-2 py-1 border border-gray-300 rounded text-sm" value="5" min="1" max="20">
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" onclick="openQuizBuilder(this)" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                    <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i>
                                    Build Quiz Questions
                                </button>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            contentFields.innerHTML = fieldsHTML;
            
            // Refresh lucide icons after updating HTML
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            // If PDF content type is selected, automatically try to fetch existing highlights
            if (contentType === 'pdf') {
                setTimeout(() => {
                    autoFetchPdfHighlights(contentItem);
                }, 500); // Small delay to ensure DOM is fully updated
            }
            
            // If image content type is selected, automatically check for existing images
            if (contentType === 'image') {
                setTimeout(async () => {
                    try {
                        // Get lesson ID from the lesson container
                        const lessonItem = contentItem.closest('.lesson-item');
                        const lessonId = lessonItem?.getAttribute('data-lesson-db-id');
                        
                        if (lessonId) {
                            // Get content item index within the lesson
                            const contentContainer = lessonItem.querySelector('.lesson-content-container');
                            const contentItems = contentContainer.querySelectorAll('.content-item');
                            const contentIndex = Array.from(contentItems).indexOf(contentItem);
                            
                            // Check and load existing image
                            await checkAndLoadExistingImage(lessonId, contentIndex, contentItem);
                        }
                    } catch (error) {
                        console.error('Error auto-loading existing image:', error);
                    }
                }, 100);
            }
        }



        function previewContent(button) {
            if (!button) {
                console.error('Button element is null in previewContent');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const contentType = contentItem.querySelector('.content-type').value;
            const contentTitle = contentItem.querySelector('.content-title').value;
            
            // Create a simple preview modal or alert
            alert(`Preview: ${contentType.toUpperCase()} - ${contentTitle || 'Untitled'}`);
        }

        // ==== PDF Highlights Helpers ====
        function appendPdfHighlightRowWithValues(contentItem, h = {}) {
            try {
                const tbody = contentItem?.querySelector('.pdf-highlights-table tbody');
                if (!tbody) return;
                const row = document.createElement('tr');
                const rect = h.rect || {};
                const refs = h.refs || {};
                const imageUrl = Array.isArray(refs.images) && refs.images.length ? refs.images[0] : '';
                const audioUrl = Array.isArray(refs.audio) && refs.audio.length ? refs.audio[0] : '';
                const videoUrl = Array.isArray(refs.video) && refs.video.length ? refs.video[0] : '';
                row.innerHTML = `
                    <td class="px-2 py-1"><input type="text" class="hl-word w-40 px-2 py-1 border rounded" placeholder="word" value="${(h.word || '').replace(/"/g,'&quot;')}"></td>
                    <td class="px-2 py-1"><input type="text" class="hl-synonyms w-48 px-2 py-1 border rounded" placeholder="fast, quick" value="${Array.isArray(h.synonyms) ? h.synonyms.join(', ') : (h.synonyms || '')}"></td>
                    <td class="px-2 py-1"><input type="number" class="hl-page w-16 px-2 py-1 border rounded" min="1" value="${Number(h.page||1)}"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-x w-16 px-2 py-1 border rounded" min="0" max="1" value="${Number(rect.x||0)}"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-y w-16 px-2 py-1 border rounded" min="0" max="1" value="${Number(rect.y||0)}"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-w w-16 px-2 py-1 border rounded" min="0" max="1" value="${Number(rect.w||0.1)}"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-h w-16 px-2 py-1 border rounded" min="0" max="1" value="${Number(rect.h||0.03)}"></td>

                    <td class="px-2 py-1">
                      <input type="file" accept="image/*" class="hl-img-file hidden" onchange="uploadHlAsset(this, 'image')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-image-url" value="${imageUrl}">
                    </td>

                    <td class="px-2 py-1">
                      <input type="file" accept="audio/*" class="hl-audio-file hidden" onchange="uploadHlAsset(this, 'audio')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-audio-url" value="${audioUrl}">
                    </td>

                    <td class="px-2 py-1">
                      <input type="file" accept="video/*" class="hl-video-file hidden" onchange="uploadHlAsset(this, 'video')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-video-url" value="${videoUrl}">
                    </td>

                    <td class="px-2 py-1">
                      <button type="button" class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="this.closest('tr').remove()">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (e) {
                console.error('appendPdfHighlightRowWithValues error:', e);
            }
        }

        function addPdfHighlightRow(btn) {
            try {
                const contentItem = btn.closest('.content-item');
                const tbody = contentItem?.querySelector('.pdf-highlights-table tbody');
                if (!tbody) return;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-1"><input type="text" class="hl-word w-40 px-2 py-1 border rounded" placeholder="word"></td>
                    <td class="px-2 py-1"><input type="text" class="hl-synonyms w-48 px-2 py-1 border rounded" placeholder="fast, quick"></td>
                    <td class="px-2 py-1"><input type="number" class="hl-page w-16 px-2 py-1 border rounded" min="1" value="1"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-x w-16 px-2 py-1 border rounded" min="0" max="1" value="0"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-y w-16 px-2 py-1 border rounded" min="0" max="1" value="0"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-w w-16 px-2 py-1 border rounded" min="0" max="1" value="0.1"></td>
                    <td class="px-2 py-1"><input type="number" step="0.001" class="hl-h w-16 px-2 py-1 border rounded" min="0" max="1" value="0.03"></td>

                    <td class="px-2 py-1">
                      <input type="file" accept="image/*" class="hl-img-file hidden" onchange="uploadHlAsset(this, 'image')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-image-url" value="">
                    </td>

                    <td class="px-2 py-1">
                      <input type="file" accept="audio/*" class="hl-audio-file hidden" onchange="uploadHlAsset(this, 'audio')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-audio-url" value="">
                    </td>

                    <td class="px-2 py-1">
                      <input type="file" accept="video/*" class="hl-video-file hidden" onchange="uploadHlAsset(this, 'video')">
                      <button type="button" class="px-2 py-1 bg-gray-100 border rounded text-xs" onclick="this.previousElementSibling.click()">Upload</button>
                      <input type="hidden" class="hl-video-url" value="">
                    </td>

                    <td class="px-2 py-1">
                      <button type="button" class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="this.closest('tr').remove()">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (e) {
                console.error('addPdfHighlightRow error:', e);
            }
        }

        async function uploadHlAsset(input, kind) {
            try {
                const file = input?.files?.[0];
                if (!file) return;
                const url = await uploadSingleFile(file, 'highlights');
                const row = input.closest('tr');
                if (!row) return;
                if (kind === 'image') row.querySelector('.hl-image-url').value = url;
                if (kind === 'audio') row.querySelector('.hl-audio-url').value = url;
                if (kind === 'video') row.querySelector('.hl-video-url').value = url;
            } catch (e) {
                console.error('uploadHlAsset failed:', e);
                alert('Failed to upload file: ' + (e?.message || e));
            } finally {
                if (input) input.value = '';
            }
        }

        function collectPdfHighlightsFromContentItem(contentItem) {
            try {
                const rows = contentItem?.querySelectorAll('.pdf-highlights-table tbody tr') || [];
                const out = [];
                console.log('collectPdfHighlightsFromContentItem: Found', rows.length, 'rows');
                
                rows.forEach((tr, idx) => {
                    const word = tr.querySelector('.hl-word')?.value?.trim();
                    const synonymsRaw = tr.querySelector('.hl-synonyms')?.value || '';
                    
                    console.log(`Row ${idx}: word="${word}", synonyms="${synonymsRaw}"`);
                    
                    if (!word) {
                        console.log(`Skipping row ${idx} - no word`);
                        return;
                    }
                    
                    const synonyms = synonymsRaw.split(',').map(s => s.trim()).filter(Boolean);
                    const page = Number(tr.querySelector('.hl-page')?.value || 1);
                    const x = Number(tr.querySelector('.hl-x')?.value || 0);
                    const y = Number(tr.querySelector('.hl-y')?.value || 0);
                    const w = Number(tr.querySelector('.hl-w')?.value || 0.1);
                    const h = Number(tr.querySelector('.hl-h')?.value || 0.03);
                    const image = tr.querySelector('.hl-image-url')?.value || null;
                    const audio = tr.querySelector('.hl-audio-url')?.value || null;
                    const video = tr.querySelector('.hl-video-url')?.value || null;
                    const id = (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : `hl_${Date.now()}_${idx}`;
                    
                    const highlight = { id, word, synonyms, page, rect: { x, y, w, h }, refs: { images: image ? [image] : [], audio: audio ? [audio] : [], video: video ? [video] : [] } };
                    console.log(`Collected highlight ${idx}:`, highlight);
                    out.push(highlight);
                });
                
                console.log('collectPdfHighlightsFromContentItem: Total collected:', out.length);
                return out;
            } catch (e) {
                console.warn('collectPdfHighlightsFromContentItem error:', e);
                return [];
            }
        }

        // Fetch PDF highlights from database for a specific course and PDF URL
        async function fetchPdfHighlightsFromDatabase(courseId, pdfUrl) {
            try {
                const client = supabaseAdmin || supabase;
                if (!client?.from) {
                    console.error('fetchPdfHighlightsFromDatabase: No Supabase client available');
                    return [];
                }

                console.log('fetchPdfHighlightsFromDatabase: Fetching highlights for course:', courseId, 'PDF:', pdfUrl);

                // First, find the book for this course and PDF URL
                const { data: books, error: booksError } = await client
                    .from('books')
                    .select('id')
                    .eq('course_id', courseId)
                    .eq('pdf_url', pdfUrl)
                    .limit(1);

                if (booksError) {
                    console.error('fetchPdfHighlightsFromDatabase: Error fetching books:', booksError.message);
                    return [];
                }

                if (!books || books.length === 0) {
                    console.log('fetchPdfHighlightsFromDatabase: No book found for this PDF');
                    return [];
                }

                const bookId = books[0].id;
                console.log('fetchPdfHighlightsFromDatabase: Found book ID:', bookId);

                // Fetch highlights for this book
                const { data: highlights, error: highlightsError } = await client
                    .from('word_highlights')
                    .select('id, word, synonyms, page_number, position')
                    .eq('book_id', bookId)
                    .order('page_number', { ascending: true });

                if (highlightsError) {
                    console.error('fetchPdfHighlightsFromDatabase: Error fetching highlights:', highlightsError.message);
                    return [];
                }

                if (!highlights || highlights.length === 0) {
                    console.log('fetchPdfHighlightsFromDatabase: No highlights found for this book');
                    return [];
                }

                console.log('fetchPdfHighlightsFromDatabase: Found', highlights.length, 'highlights');

                // Convert database format to the format expected by the UI
                const formattedHighlights = highlights.map(h => {
                    const position = h.position || {};
                    const rect = position.rect || {};
                    const refs = position.refs || {};
                    
                    return {
                        id: h.id,
                        word: h.word || '',
                        synonyms: Array.isArray(h.synonyms) ? h.synonyms : [],
                        page: h.page_number || 1,
                        rect: {
                            x: rect.x || 0,
                            y: rect.y || 0,
                            w: rect.w || rect.width || 0.1,
                            h: rect.h || rect.height || 0.03
                        },
                        refs: {
                            images: Array.isArray(refs.images) ? refs.images : [],
                            audio: Array.isArray(refs.audio) ? refs.audio : [],
                            video: Array.isArray(refs.video) ? refs.video : []
                        }
                    };
                });

                console.log('fetchPdfHighlightsFromDatabase: Formatted highlights:', formattedHighlights);
                return formattedHighlights;

            } catch (e) {
                console.error('fetchPdfHighlightsFromDatabase: Error:', e?.message || e);
                return [];
            }
        }

        // Populate PDF highlights table with data from database
        async function populatePdfHighlightsTable(contentItem, courseId, pdfUrl) {
            try {
                if (!contentItem || !courseId || !pdfUrl) {
                    console.log('populatePdfHighlightsTable: Missing required parameters');
                    return;
                }

                console.log('populatePdfHighlightsTable: Populating highlights for PDF:', pdfUrl);

                // Fetch highlights from database
                const highlights = await fetchPdfHighlightsFromDatabase(courseId, pdfUrl);

                if (highlights.length === 0) {
                    console.log('populatePdfHighlightsTable: No highlights to populate');
                    return;
                }

                // Clear existing rows (except the empty template row if it exists)
                const tbody = contentItem.querySelector('.pdf-highlights-table tbody');
                if (tbody) {
                    // Keep one empty row if no highlights exist, remove all others
                    tbody.innerHTML = '';
                }

                // Add each highlight as a row
                highlights.forEach(highlight => {
                    appendPdfHighlightRowWithValues(contentItem, highlight);
                });

                console.log('populatePdfHighlightsTable: Populated', highlights.length, 'highlights');

            } catch (e) {
                console.error('populatePdfHighlightsTable: Error:', e?.message || e);
            }
        }

        // Automatically fetch and populate PDF highlights when PDF content is created
        async function autoFetchPdfHighlights(contentItem) {
            try {
                if (!contentItem) {
                    console.log('autoFetchPdfHighlights: No content item provided');
                    return;
                }

                // Check if this is a PDF content type
                const typeSelect = contentItem.querySelector('.content-type');
                if (!typeSelect || typeSelect.value !== 'pdf') {
                    console.log('autoFetchPdfHighlights: Not a PDF content type');
                    return;
                }

                // Get the course ID from the form or current editing context
                const courseId = getCurrentCourseId();
                if (!courseId) {
                    console.log('autoFetchPdfHighlights: No course ID available');
                    return;
                }

                console.log('autoFetchPdfHighlights: Starting auto-fetch for course:', courseId);

                // Show loading indicator
                const fetchBtn = contentItem.querySelector('.auto-fetch-btn');
                if (fetchBtn) {
                    fetchBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 inline mr-1 animate-spin"></i>Fetching...';
                    fetchBtn.disabled = true;
                    if (window.lucide) {
                        window.lucide.createIcons();
                    }
                }

                // Strategy 1: Check if there's a PDF file selected
                const pdfFile = contentItem.querySelector('.content-file')?.files[0];
                const existingPdfUrl = contentItem.querySelector('.content-file')?.dataset.existingUrl;
                
                let pdfUrl = null;
                if (pdfFile) {
                    console.log('autoFetchPdfHighlights: New PDF file detected, will need to wait for upload');
                    pdfUrl = `placeholder:${pdfFile.name}`;
                } else if (existingPdfUrl) {
                    pdfUrl = existingPdfUrl;
                    console.log('autoFetchPdfHighlights: Using existing PDF URL:', pdfUrl);
                } else {
                    // Strategy 2: Find any PDF for this course (for existing courses like Elementry)
                    pdfUrl = await findAnyPdfForCourse(courseId);
                    if (pdfUrl) {
                        console.log('autoFetchPdfHighlights: Found PDF for course:', pdfUrl);
                    }
                }

                // Strategy 3: If still no PDF URL, check if we're editing and try to find based on content title
                if (!pdfUrl || pdfUrl.startsWith('placeholder:')) {
                    pdfUrl = await findExistingPdfUrl(contentItem, courseId);
                    if (pdfUrl) {
                        console.log('autoFetchPdfHighlights: Found PDF by title matching:', pdfUrl);
                    }
                }

                if (!pdfUrl || pdfUrl.startsWith('placeholder:')) {
                    console.log('autoFetchPdfHighlights: No valid PDF URL found, but will still try to find any highlights for course');
                    // Try to fetch highlights for any PDF in this course
                    await fetchAnyHighlightsForCourse(contentItem, courseId);
                } else {
                    console.log('autoFetchPdfHighlights: Attempting to fetch highlights for PDF:', pdfUrl);
                    // Fetch and populate highlights for specific PDF
                    await populatePdfHighlightsTable(contentItem, courseId, pdfUrl);
                }

            } catch (e) {
                console.error('autoFetchPdfHighlights: Error:', e?.message || e);
            } finally {
                // Restore fetch button
                const fetchBtn = contentItem.querySelector('.auto-fetch-btn');
                if (fetchBtn) {
                    fetchBtn.innerHTML = '<i data-lucide="download" class="w-3 h-3 inline mr-1"></i>Fetch Existing';
                    fetchBtn.disabled = false;
                    if (window.lucide) {
                        window.lucide.createIcons();
                    }
                }
            }
        }
        window.updateContentFields = window.updateContentFields || updateContentFields;

        // Get current course ID from various sources
        function getCurrentCourseId() {
            // Try to get from form dataset (when editing)
            const courseForm = document.getElementById('courseForm');
            if (courseForm?.dataset?.courseId) {
                return courseForm.dataset.courseId;
            }

            // Try to get from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const courseIdFromUrl = urlParams.get('courseId');
            if (courseIdFromUrl) {
                return courseIdFromUrl;
            }

            // Try to get from global variable (if set)
            if (window.currentCourseId) {
                return window.currentCourseId;
            }

            return null;
        }

        // Find existing PDF URL for content item when editing
        async function findExistingPdfUrl(contentItem, courseId) {
            try {
                // This would be called when editing existing content
                // For now, we'll check if there's any indication of an existing PDF
                const titleInput = contentItem.querySelector('.content-title');
                const title = titleInput?.value || '';
                
                if (!title) {
                    return null;
                }

                // Try to find books with similar titles for this course
                const client = supabaseAdmin || supabase;
                const { data: books, error } = await client
                    .from('books')
                    .select('pdf_url, title')
                    .eq('course_id', courseId)
                    .ilike('title', `%${title}%`)
                    .limit(1);

                if (error || !books || books.length === 0) {
                    return null;
                }

                return books[0].pdf_url;
            } catch (e) {
                console.error('findExistingPdfUrl: Error:', e?.message || e);
                return null;
            }
        }

        // Find any PDF for a course (useful for auto-fetching)
        async function findAnyPdfForCourse(courseId) {
            try {
                const client = supabaseAdmin || supabase;
                const { data: books, error } = await client
                    .from('books')
                    .select('pdf_url')
                    .eq('course_id', courseId)
                    .limit(1);

                if (error || !books || books.length === 0) {
                    return null;
                }

                return books[0].pdf_url;
            } catch (e) {
                console.error('findAnyPdfForCourse: Error:', e?.message || e);
                return null;
            }
        }

        // Fetch any highlights for a course (when no specific PDF URL is known)
        async function fetchAnyHighlightsForCourse(contentItem, courseId) {
            try {
                const client = supabaseAdmin || supabase;
                
                // Get all books for this course
                const { data: books, error: booksError } = await client
                    .from('books')
                    .select('id, title, pdf_url')
                    .eq('course_id', courseId);

                if (booksError || !books || books.length === 0) {
                    console.log('fetchAnyHighlightsForCourse: No books found for course');
                    return;
                }

                console.log(`fetchAnyHighlightsForCourse: Found ${books.length} books for course`);

                // Get all highlights for all books in this course
                const bookIds = books.map(book => book.id);
                const { data: highlights, error: highlightsError } = await client
                    .from('word_highlights')
                    .select('id, word, synonyms, page_number, position, book_id')
                    .in('book_id', bookIds)
                    .order('page_number', { ascending: true });

                if (highlightsError || !highlights || highlights.length === 0) {
                    console.log('fetchAnyHighlightsForCourse: No highlights found for any books in course');
                    return;
                }

                console.log(`fetchAnyHighlightsForCourse: Found ${highlights.length} highlights across all books`);

                // Convert to UI format and populate table
                const formattedHighlights = highlights.map(h => {
                    const position = h.position || {};
                    const rect = position.rect || {};
                    const refs = position.refs || {};
                    
                    return {
                        id: h.id,
                        word: h.word || '',
                        synonyms: Array.isArray(h.synonyms) ? h.synonyms : [],
                        page: h.page_number || 1,
                        rect: {
                            x: rect.x || 0,
                            y: rect.y || 0,
                            w: rect.w || rect.width || 0.1,
                            h: rect.h || rect.height || 0.03
                        },
                        refs: {
                            images: Array.isArray(refs.images) ? refs.images : [],
                            audio: Array.isArray(refs.audio) ? refs.audio : [],
                            video: Array.isArray(refs.video) ? refs.video : []
                        }
                    };
                });

                // Clear existing table and populate with all highlights
                const tbody = contentItem.querySelector('.pdf-highlights-table tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                }

                formattedHighlights.forEach(highlight => {
                    appendPdfHighlightRowWithValues(contentItem, highlight);
                });

                console.log(`fetchAnyHighlightsForCourse: Populated ${formattedHighlights.length} highlights`);

            } catch (e) {
                console.error('fetchAnyHighlightsForCourse: Error:', e?.message || e);
            }
        }

        // Enhanced PDF highlights table with auto-fetch button
        function addAutoFetchButton(contentItem) {
            try {
                const pdfHighlightsDiv = contentItem.querySelector('.pdf-highlights');
                if (!pdfHighlightsDiv) {
                    return;
                }

                // Check if auto-fetch button already exists
                if (pdfHighlightsDiv.querySelector('.auto-fetch-btn')) {
                    return;
                }

                // Add auto-fetch button next to "Add Row" button
                const headerDiv = pdfHighlightsDiv.querySelector('.flex.items-center.justify-between');
                if (headerDiv) {
                    const autoFetchBtn = document.createElement('button');
                    autoFetchBtn.type = 'button';
                    autoFetchBtn.className = 'auto-fetch-btn px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 mr-2';
                    autoFetchBtn.innerHTML = '<i data-lucide="download" class="w-3 h-3 inline mr-1"></i>Fetch Existing';
                    autoFetchBtn.onclick = () => autoFetchPdfHighlights(contentItem);
                    
                    // Insert before the "Add Row" button
                    const addRowBtn = headerDiv.querySelector('button');
                    if (addRowBtn) {
                        addRowBtn.parentNode.insertBefore(autoFetchBtn, addRowBtn);
                        // Refresh lucide icons
                        if (window.lucide) {
                            window.lucide.createIcons();
                        }
                    }
                }
            } catch (e) {
                console.error('addAutoFetchButton: Error:', e?.message || e);
            }

            const contentType = contentItem.querySelector('.content-type').value;
            const contentTitle = contentItem.querySelector('.content-title').value;
            
            // Create a simple preview modal or alert
            createToast({ type: 'info', message: `Preview: ${contentType.toUpperCase()} - ${contentTitle || 'Untitled'}` });
        }
        window.previewContent = window.previewContent || previewContent;


        function moveContentUp(button) {
            if (!button) {
                console.error('Button is null in moveContentUp');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found in moveContentUp');
                return;
            }
            const previousItem = contentItem.previousElementSibling;
            if (previousItem) {
                contentItem.parentNode.insertBefore(contentItem, previousItem);
                renumberContentItems(contentItem.parentNode);
            }
        }

        function moveContentDown(button) {
            if (!button) {
                console.error('Button is null in moveContentDown');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found in moveContentDown');
                return;
            }
            const nextItem = contentItem.nextElementSibling;
            if (nextItem) {
                contentItem.parentNode.insertBefore(nextItem, contentItem);
                renumberContentItems(contentItem.parentNode);
            }
        }

        function renumberContentItems(container) {
            container.querySelectorAll('.content-item').forEach((item, index) => {
                const title = item.querySelector('h6');
                if (title && title.textContent.startsWith('Content Item ')) {
                    title.textContent = `Content Item ${index + 1}`;
                }
            });
        }

        function openQuizBuilder(button) {
            // This would open a more detailed quiz builder modal
            createToast({ type: 'info', message: 'Quiz Builder would open here - allowing creation of detailed quiz questions' });
        }

        // Question Management Functions
        function addQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionCount = document.querySelectorAll('.question-item').length + 1;
            
            const questionHTML = `
                <div class="question-item bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-900">Question ${questionCount}</h4>
                        <button type="button" onclick="removeQuestion(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
                            <select class="question-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="true-false">True/False</option>
                                <option value="fill-blank">Fill in the Blank</option>
                                <option value="short-answer">Short Answer</option>
                                <option value="essay">Essay</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
                            <select class="question-difficulty w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Points</label>
                            <input type="number" class="question-points w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="1" min="1" max="10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Question Text</label>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Enter your question here..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="generateQuestionContent(this)" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                            AI Generate
                        </button>
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
            lucide.createIcons();
        }

        function removeQuestion(button) {
            if (!button) {
                console.error('Button is null in removeQuestion');
                return;
            }
            const questionItem = button.closest('.question-item');
            if (!questionItem) {
                console.error('Question item not found in removeQuestion');
                return;
            }
            questionItem.remove();
            
            // Renumber remaining questions
            document.querySelectorAll('.question-item').forEach((item, index) => {
                const title = item.querySelector('h4');
                if (title && title.textContent.startsWith('Question ')) {
                    title.textContent = `Question ${index + 1}`;
                }
            });
        }

        // AI Content Generation Functions
        async function generateLessonContent(button) {
            if (!button) {
                console.error('Button is null in generateLessonContent');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found in generateLessonContent');
                return;
            }
            const titleElement = lessonItem.querySelector('.lesson-title');
            const cefrElement = lessonItem.querySelector('.lesson-cefr');
            const contentTypeElement = lessonItem.querySelector('.lesson-content-type');
            
            if (!titleElement || !cefrElement || !contentTypeElement) {
                showError('Required lesson fields not found');
                return;
            }
            
            const title = titleElement.value;
            const cefrLevel = cefrElement.value;
            const contentType = contentTypeElement.value;
            
            if (!title) {
                showError('Please enter a lesson title first');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Generating...';
            
            try {
                // Simulate AI content generation (replace with actual AI service call)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const objectives = lessonItem.querySelector('.lesson-objectives');
                if (!objectives) {
                    showError('Objectives field not found');
                    return;
                }
                const generatedContent = `Students will learn ${contentType} skills at ${cefrLevel} level through "${title}". Key objectives include vocabulary building, comprehension exercises, and practical application.`;
                
                objectives.value = generatedContent;
                showSuccess('Lesson content generated successfully!');
            } catch (error) {
                console.error('Error generating lesson content:', error);
                showError('Failed to generate lesson content');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>AI Generate Content';
                lucide.createIcons();
            }
        }

        async function generateQuestionContent(button) {
            if (!button) {
                console.error('Button is null in generateQuestionContent');
                return;
            }
            const questionItem = button.closest('.question-item');
            if (!questionItem) {
                console.error('Question item not found in generateQuestionContent');
                return;
            }
            const questionTypeElement = questionItem.querySelector('.question-type');
            const difficultyElement = questionItem.querySelector('.question-difficulty');
            
            if (!questionTypeElement || !difficultyElement) {
                showError('Required question fields not found');
                return;
            }
            
            const questionType = questionTypeElement.value;
            const difficulty = difficultyElement.value;
            
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Generating...';
            
            try {
                // Simulate AI question generation (replace with actual AI service call)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const questionText = questionItem.querySelector('.question-text');
                if (!questionText) {
                    showError('Question text field not found');
                    return;
                }
                const generatedQuestion = `This is a ${difficulty} ${questionType} question generated by AI based on the course content and CEFR level.`;
                
                questionText.value = generatedQuestion;
                showSuccess('Question generated successfully!');
            } catch (error) {
                console.error('Error generating question:', error);
                showError('Failed to generate question');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>AI Generate';
                lucide.createIcons();
            }
        }

        // Course Creation Function
        async function createCourseFromWizard() {
            try {
                // Save final step data
                saveCurrentStepData();
                
                // Validate all required data
                if (!courseWizardData.title || !courseWizardData.category || !courseWizardData.instructorName) {
                    showError('Missing required course information');
                    return;
                }
                
                // Show loading state
                const createBtn = document.getElementById('finishBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Creating Course...';
                }
                
                // Check if publishing immediately
                const publishImmediately = document.getElementById('publishImmediately')?.checked || false;
                
                // Capture the review HTML from the lesson review section
                let reviewHtml = '';
                const lessonsReviewElement = document.getElementById('lessonsReview');
                if (lessonsReviewElement) {
                    reviewHtml = lessonsReviewElement.innerHTML;
                    console.log(' Captured review HTML:', reviewHtml);
                }

                // Create course in database
                const courseData = {
                    title: courseWizardData.title,
                    description: courseWizardData.description,
                    category: courseWizardData.category,
                    level: courseWizardData.cefrLevel,
                    language: courseWizardData.language,
                    duration_weeks: parseInt(courseWizardData.duration) || 4,
                    hours_per_week: parseInt(courseWizardData.hoursPerWeek) || 2,
                    max_students: parseInt(courseWizardData.maxStudents) || 20,
                    price: parseFloat(courseWizardData.price) || 0,
                    currency: courseWizardData.currency || 'USD',
                    learning_objectives: courseWizardData.learningObjectives,
                    prerequisites: courseWizardData.prerequisites,
                    skills_focus: courseWizardData.skillsFocus || [],
                    required_materials: courseWizardData.materials,
                    syllabus: courseWizardData.syllabus,
                    instructor_name: courseWizardData.instructorName,
                    instructor_email: courseWizardData.instructorEmail,
                    instructor_bio: courseWizardData.instructorBio,
                    start_date: courseWizardData.startDate,
                    enrollment_deadline: courseWizardData.enrollmentDeadline,
                    cancellation_policy: courseWizardData.cancellationPolicy,
                    is_active: publishImmediately,
                    review_html: reviewHtml, // Save the captured review HTML
                    created_at: new Date().toISOString()
                };
                
                // Create course using Supabase Admin client for proper permissions
                console.log(' Using admin client for course creation to bypass RLS policies');
                console.log(' Course data being inserted:', courseData);
                
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'supabaseAdmin' : 'supabase (fallback)');
                
                const { data, error } = await client
                    .from('courses')
                    .insert([courseData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                const createdCourse = data[0];
                console.log(' Course created successfully:', createdCourse);
                
                // Now save lessons if any exist
                if (courseWizardData.lessons && courseWizardData.lessons.length > 0) {
                    console.log(' Saving lessons for course:', createdCourse.id);
                    
                    try {
                        // Collect lessons data
                        const lessonsData = await collectLessonsData();
                        
                        if (lessonsData && lessonsData.length > 0) {
                            // Use IPC to save lessons if in Electron environment
                            if (window.isElectron) {
                                const result = await window.electronAPI.invoke('db:createLessons', createdCourse.id, lessonsData);
                                if (result.success) {
                                    console.log(' Lessons saved successfully via Electron IPC');
                                    try { await persistPdfHighlightsToDb(createdCourse.id, lessonsData); } catch (e) { console.warn('persistPdfHighlightsToDb warning:', e?.message || e); }
                                } else {
                                    console.error(' Failed to save lessons via IPC:', result.error);
                                    throw new Error(result.error);
                                }
                            } else {
                                // Fallback to direct Supabase insertion for web environment
                                const lessonsToInsert = lessonsData.map(lesson => ({
                                    course_id: createdCourse.id,
                                    title: lesson.title,
                                    description: lesson.description || '',
                                    lesson_type: lesson.type || 'content',
                                    content: lesson.content,
                                    order_index: lesson.order_index || 0,
                                    duration_minutes: lesson.duration || 30,
                                    difficulty_level: lesson.level || 'beginner',
                                    learning_objectives: lesson.objectives || [],
                                    is_published: publishImmediately
                                }));
                                
                                const { error: lessonsError } = await client
                                    .from('lessons')
                                    .insert(lessonsToInsert);
                                
                                if (lessonsError) {
                                    console.error(' Failed to save lessons:', lessonsError);
                                    throw lessonsError;
                                }
                                
                                console.log(' Lessons saved successfully via direct Supabase');
                                try { await persistPdfHighlightsToDb(createdCourse.id, lessonsData); } catch (e) { console.warn('persistPdfHighlightsToDb warning:', e?.message || e); }
                            }
                        }
                    } catch (lessonError) {
                        console.error(' Error saving lessons:', lessonError);
                        // Don't fail the entire course creation, just warn
                        showError('Course created but failed to save lessons: ' + lessonError.message);
                    }
                }
                
                const message = publishImmediately ? 'Course created and published successfully!' : 'Course created as draft successfully!';
                showSuccess(message);
                closeCourseModal();
                
                // Reset wizard data
                courseWizardData = {};
                currentWizardStep = 1;
                
                // Reload courses
                if (typeof loadCourses === 'function') {
                    loadCourses();
                }
                
            } catch (error) {
                console.error('Error creating course:', error);
                showError('Failed to create course: ' + (error.message || 'Unknown error'));
            } finally {
                const createBtn = document.getElementById('finishBtn');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'Create Course';
                    lucide.createIcons();
                }
            }
        }

        // Initialize wizard when modal opens
        // Delegate to global guarded function to avoid duplicate declarations
        function showAddCourseModal() {
            if (typeof window.showAddCourseModal === 'function' && window.showAddCourseModal !== showAddCourseModal) {
                return window.showAddCourseModal();
            }
            // Fallback in case global is missing
            const titleEl = document.getElementById('courseModalTitle');
            if (titleEl) titleEl.textContent = 'Create New Course';
            const form = document.getElementById('courseForm');
            if (form) {
                delete form.dataset.courseId;
                delete form.dataset.isEdit;
                form.reset();
            }
            try {
                if (typeof showWizardStep === 'function') {
                    window.courseWizardData = {};
                    window.currentWizardStep = 1;
                    showWizardStep(1);
                }
            } catch (e) {
                console.warn('Wizard fallback init issue:', e);
            }
            const modal = document.getElementById('courseModal');
            if (modal) modal.classList.remove('hidden');
        }

        function showAddAssignmentModal() {
            document.getElementById('assignmentModal').classList.remove('hidden');
        }
        window.showAddAssignmentModal = window.showAddAssignmentModal || showAddAssignmentModal;

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('hidden');
            document.getElementById('assignmentForm').reset();
        }
        window.closeAssignmentModal = window.closeAssignmentModal || closeAssignmentModal;

        function showAddQuestionModal() {
            document.getElementById('questionModal').classList.remove('hidden');
        }
        window.showAddQuestionModal = window.showAddQuestionModal || showAddQuestionModal;

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.add('hidden');
            document.getElementById('questionForm').reset();
        }
        window.closeQuestionModal = window.closeQuestionModal || closeQuestionModal;

        async function loadQuestionsForAssignment() {
            const assignmentSelect = document.getElementById('questionAssignmentSelect');
            const selectedAssignmentId = assignmentSelect.value;
            const questionsContainer = document.getElementById('questionsContainer');
            const noQuestionsMessage = document.getElementById('noQuestionsMessage');
            const createQuestionBtn = document.getElementById('createQuestionBtn');
            
            if (!selectedAssignmentId) {
                questionsContainer.innerHTML = '';
                noQuestionsMessage.classList.remove('hidden');
                createQuestionBtn.disabled = true;
                return;
            }
            
            createQuestionBtn.disabled = false;
            
            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('id,assignment_id,question_text,question_type,points,difficulty,options,created_at')
                    .eq('assignment_id', selectedAssignmentId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (questions && questions.length > 0) {
                    questionsContainer.innerHTML = questions.map(question => `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900">${question.question_text}</h4>
                                <div class="flex space-x-2">
                                    <button onclick="editQuestion('${question.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        Edit
                                    </button>
                                    <button onclick="deleteQuestion('${question.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="inline-block bg-gray-100 px-2 py-1 rounded mr-2">Type: ${question.question_type}</span>
                                <span class="inline-block bg-blue-100 px-2 py-1 rounded mr-2">Points: ${question.points}</span>
                                <span class="inline-block bg-green-100 px-2 py-1 rounded">Difficulty: ${question.difficulty}</span>
                            </div>
                            ${question.options ? `<div class="text-sm text-gray-600">Options: ${JSON.parse(question.options).join(', ')}</div>` : ''}
                        </div>
                    `).join('');
                    noQuestionsMessage.classList.add('hidden');
                } else {
                    questionsContainer.innerHTML = '';
                    noQuestionsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                showError('Failed to load questions');
            }
        }

        async function loadQuestions() {
            try {
                // Load assignments for the dropdown
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('assignments')
                    .select('id, title')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (assignmentsError) throw assignmentsError;
                
                const assignmentSelect = document.getElementById('questionAssignmentSelect');
                assignmentSelect.innerHTML = '<option value="">Select an assignment/test...</option>';
                
                if (assignments && assignments.length > 0) {
                    assignments.forEach(assignment => {
                        assignmentSelect.innerHTML += `<option value="${assignment.id}">${assignment.title}</option>`;
                    });
                } else {
                    assignmentSelect.innerHTML += '<option value="" disabled>No assignments available</option>';
                }
            } catch (error) {
                console.error('Error loading assignments for questions:', error);
                showError('Failed to load assignments');
            }
        }

        function showGrammarSetupInstructions() {
            const instructions = `
To fix the missing grammar_lessons table, please run the following SQL in your Supabase SQL Editor:

CREATE TABLE IF NOT EXISTS public.grammar_lessons (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    language TEXT NOT NULL DEFAULT 'Spanish',
    level TEXT DEFAULT 'beginner',
    content JSONB,
    difficulty_score INTEGER DEFAULT 1,
    estimated_duration_minutes INTEGER DEFAULT 15,
    tags TEXT[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_grammar_lessons_language ON public.grammar_lessons(language);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_level ON public.grammar_lessons(level);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_created_at ON public.grammar_lessons(created_at);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_active ON public.grammar_lessons(is_active);

ALTER TABLE public.grammar_lessons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active grammar lessons" ON public.grammar_lessons
    FOR SELECT USING (is_active = true);

CREATE POLICY "Authenticated users can manage grammar lessons" ON public.grammar_lessons
    FOR ALL USING (auth.role() = 'authenticated');

CREATE TRIGGER update_grammar_lessons_updated_at
    BEFORE UPDATE ON public.grammar_lessons
    FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

INSERT INTO public.grammar_lessons (title, description, language, level, content, difficulty_score, estimated_duration_minutes, tags) VALUES
('Present Tense Basics', 'Learn the fundamentals of present tense in Spanish', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 2, 20, '{"grammar", "present-tense", "verbs"}'),
('Ser vs Estar', 'Understanding the difference between ser and estar', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 3, 25, '{"grammar", "verbs", "ser", "estar"}'),
('Past Tense (Pretrito)', 'Master the Spanish past tense', 'Spanish', 'intermediate', '{"type": "lesson", "exercises": []}', 5, 30, '{"grammar", "past-tense", "preterito"}'),
('Subjunctive Mood', 'Introduction to the subjunctive mood', 'Spanish', 'advanced', '{"type": "lesson", "exercises": []}', 8, 45, '{"grammar", "subjunctive", "mood"}'),
('Articles and Gender', 'Learn about definite and indefinite articles', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 2, 15, '{"grammar", "articles", "gender"}');

After running this SQL, refresh the admin dashboard to see the grammar lessons.
            `;
            console.log(instructions);
            createToast({ type: 'info', message: 'Lesson builder SQL instructions printed to console.' });
        }

        function showUserManagementSetup() {
            const instructions = `
To fix the User Management relationship errors, please run the following SQL in your Supabase SQL Editor:

-- Fix user_progress table column names
ALTER TABLE public.user_progress 
ADD COLUMN IF NOT EXISTS current_level TEXT,
ADD COLUMN IF NOT EXISTS total_xp INTEGER,
ADD COLUMN IF NOT EXISTS daily_streak INTEGER;

UPDATE public.user_progress 
SET 
    current_level = level,
    total_xp = xp_points,
    daily_streak = streak_days
WHERE current_level IS NULL OR total_xp IS NULL OR daily_streak IS NULL;

ALTER TABLE public.user_progress 
ALTER COLUMN current_level SET DEFAULT 'beginner',
ALTER COLUMN total_xp SET DEFAULT 0,
ALTER COLUMN daily_streak SET DEFAULT 0;

ALTER TABLE public.user_progress 
ALTER COLUMN current_level SET NOT NULL,
ALTER COLUMN total_xp SET NOT NULL,
ALTER COLUMN daily_streak SET NOT NULL;

-- Add foreign key constraint
ALTER TABLE public.user_progress 
ADD CONSTRAINT fk_user_progress_user_profiles 
FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;

-- Fix learning_sessions table
ALTER TABLE public.learning_sessions 
ADD COLUMN IF NOT EXISTS user_id UUID,
ADD COLUMN IF NOT EXISTS lesson_type TEXT DEFAULT 'general',
ADD COLUMN IF NOT EXISTS completed BOOLEAN DEFAULT false;

ALTER TABLE public.learning_sessions 
ADD CONSTRAINT fk_learning_sessions_user_profiles 
FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_user_progress_current_level ON public.user_progress(current_level);
CREATE INDEX IF NOT EXISTS idx_learning_sessions_user_id ON public.learning_sessions(user_id);

After running this SQL, refresh the admin dashboard to see the user management working properly.
            `;
            console.log(instructions);
            createToast({ type: 'info', message: 'User management setup instructions printed to console.' });
        }

        // File upload helper function
         async function uploadFiles(files, folder, courseId = null, assignmentId = null) {
             if (uploadFiles.uploading) return [];
             uploadFiles.uploading = true;
             const uploadedFiles = [];
             const client = window.supabaseAdminClient || window.supabaseClient || supabase;

             try {
                 for (const file of files) {
                     const contentType = file.name.toLowerCase().endsWith('.pdf') ? 'application/pdf' : file.type;
                     try {
                         const result = await supabaseStorageService.uploadFile(file, 'course-materials', folder, { contentType });

                         try {
                             await client.from('documents').upsert({
                                 name: file.name,
                                 path: result.path,
                                 bucket: 'course-materials',
                                 url: result.url
                             }, { onConflict: 'path' });
                         } catch (dbError) {
                             console.error('Error storing file info:', dbError);
                         }

                         uploadedFiles.push({
                             name: file.name,
                             url: result.url,
                             type: contentType,
                             size: file.size,
                             path: result.path
                         });
                     } catch (error) {
                         console.error(`Error uploading ${file.name}:`, error);
                     }
                 }
             } finally {
                 uploadFiles.uploading = false;
             }

             return uploadedFiles;
         }

         // Persist PDF highlights to database tables (books, word_highlights) in addition to lesson_materials metadata
         async function persistPdfHighlightsToDb(courseId, lessonsData) {
             try {
                 if (!Array.isArray(lessonsData) || lessonsData.length === 0) {
                     console.log('persistPdfHighlightsToDb: No lessons data provided');
                     return;
                 }
                 
                 // Use admin client if available, otherwise regular client
                 const client = supabaseAdmin || supabase;
                 if (!client?.from) {
                     console.error('persistPdfHighlightsToDb: No Supabase client available');
                     return;
                 }
                 
                 console.log('persistPdfHighlightsToDb: Starting with courseId:', courseId, 'lessons:', lessonsData.length);
                 
                 // Verify course exists first
                 const { data: courseExists, error: courseError } = await client
                     .from('courses')
                     .select('id')
                     .eq('id', courseId)
                     .single();
                 
                 if (courseError) {
                     console.error('persistPdfHighlightsToDb: Course not found:', courseError.message);
                     return;
                 }

                 for (const lesson of lessonsData) {
                     const materials = Array.isArray(lesson.materials) ? lesson.materials : [];
                     for (const m of materials) {
                         if ((m.type || '').toLowerCase() !== 'pdf') continue;
                         const meta = m.metadata || {};
                         const hs = Array.isArray(meta.highlights) ? meta.highlights : [];
                         if (!hs.length) continue;

                         // Ensure a book row exists for this PDF (books: course_id, title, pdf_url)
                         let bookId = null;
                         const pdfUrl = m.file_url || m.url || null;
                         console.log('persistPdfHighlightsToDb: Processing PDF:', pdfUrl);
                         
                         if (!pdfUrl) {
                             console.warn('persistPdfHighlightsToDb: No PDF URL found, skipping highlights');
                             continue;
                         }
                         
                         try {
                             // Try find existing by course_id + pdf_url
                             const { data: existingBooks, error: selectError } = await client
                                 .from('books')
                                 .select('id,pdf_url')
                                 .eq('course_id', courseId)
                                 .eq('pdf_url', pdfUrl)
                                 .limit(1);
                             
                             if (selectError) {
                                 console.error('persistPdfHighlightsToDb: Error querying books:', selectError.message);
                                 continue;
                             }
                             
                             const existing = Array.isArray(existingBooks) ? existingBooks[0] : null;
                             if (existing?.id) {
                                 bookId = existing.id;
                                 console.log('persistPdfHighlightsToDb: Found existing book:', bookId);
                             } else {
                                 console.log('persistPdfHighlightsToDb: Creating new book entry...');
                                 const { data: ins, error: insErr } = await client
                                     .from('books')
                                     .insert({ 
                                         course_id: courseId, 
                                         title: lesson.title || 'Lesson PDF', 
                                         pdf_url: pdfUrl 
                                     })
                                     .select('id')
                                     .single();
                                 
                                 if (insErr) {
                                     console.error('persistPdfHighlightsToDb: Error creating book:', insErr.message);
                                     continue;
                                 }
                                 
                                 if (ins?.id) {
                                     bookId = ins.id;
                                     console.log('persistPdfHighlightsToDb: Created book:', bookId);
                                 }
                             }
                         } catch (e) {
                             console.error('persistPdfHighlightsToDb: Book operation failed:', e?.message || e);
                             continue;
                         }

                         if (!bookId) {
                             console.warn('persistPdfHighlightsToDb: Could not create or fetch books row; skipping structured highlight rows');
                             continue;
                         }

                         // Insert highlights as rows in word_highlights
                         console.log('persistPdfHighlightsToDb: Inserting', hs.length, 'highlights for book:', bookId);
                         
                         for (const h of hs) {
                             try {
                                 const payload = {
                                     book_id: bookId,
                                     word: h.word || '',
                                     synonyms: Array.isArray(h.synonyms) ? h.synonyms : [],
                                     page_number: Number(h.page) || 1,
                                     position: { rect: h.rect || null, refs: h.refs || null }
                                 };
                                 
                                 console.log('persistPdfHighlightsToDb: Inserting highlight:', payload);
                                 
                                 const { error: hlErr } = await client
                                     .from('word_highlights')
                                     .insert(payload);
                                 
                                 if (hlErr) {
                                     console.error('persistPdfHighlightsToDb: word_highlights insert error:', hlErr.message, hlErr);
                                 } else {
                                     console.log('persistPdfHighlightsToDb: Successfully inserted highlight for word:', h.word);
                                 }
                             } catch (e) {
                                 console.error('persistPdfHighlightsToDb: word_highlights insert failed:', e?.message || e);
                             }
                         }
                     }
                 }
             } catch (e) {
                 console.warn('persistPdfHighlightsToDb failed (non-fatal):', e?.message || e);
             }
         }

         // Course form submission
         document.getElementById('courseForm').addEventListener('submit', async function(e) {
            console.log('Form submission triggered!');
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const description = formData.get('description');
            const level = formData.get('level');
            const publishStatus = formData.get('publishStatus'); // Get publish status from radio buttons
            
            console.log('Form data:', { title, description, level, publishStatus });
            
            // Check if this is an edit operation
            const isEdit = e.target.dataset.isEdit === 'true';
            const courseId = e.target.dataset.courseId;
            
            if (!title || !description) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (isEdit && !courseId) {
                showError('Course ID not found for update operation');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = isEdit ? 'Updating...' : 'Creating...';
                submitBtn.disabled = true;
                
                // Collect lesson data
                const lessonsData = await collectLessonsData();
                
                // Collect course overview data
                const learningObjectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (!learningObjectivesElement || !prerequisitesElement) {
                    showError('Required course overview fields not found');
                    return;
                }
                
                const learningObjectives = learningObjectivesElement.value;
                const prerequisites = prerequisitesElement.value;
                const skillsFocus = Array.from(document.querySelectorAll('input[name="skillsFocus"]:checked')).map(cb => cb.value);
                
                // Get additional form fields
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                
                // Capture review HTML from review tab if present
                let reviewHtml = '';
                const reviewEl = document.getElementById('lessonsReview');
                if (reviewEl) {
                    reviewHtml = reviewEl.innerHTML;
                }

                const courseData = {
                    title: title,
                    description: description,
                    language: languageElement ? languageElement.value : 'Spanish',
                    cefr_level: level || 'A1', // Use cefr_level column as per database schema
                    duration_weeks: durationElement ? parseInt(durationElement.value) : 10,
                    hours_per_week: hoursElement ? parseInt(hoursElement.value) : 3,
                    category: categoryElement ? categoryElement.value : 'language',
                    is_active: publishStatus === 'publish', // Set active only if publish is selected
                    learning_objectives: learningObjectives,
                    prerequisites: prerequisites,
                    skills_focus: skillsFocus,
                    required_materials: '', // Default empty materials
                    syllabus: '', // Default empty syllabus
                    instructor_name: 'Default Instructor',
                    instructor_email: 'instructor@edlingo.com',
                    review_html: reviewHtml
                };
                
                let result;
                let createdCourse;
                if (isEdit) {
                    // Update existing course
                    result = await supabase
                        .from('courses')
                        .update(courseData)
                        .eq('id', courseId)
                        .select();
                    createdCourse = result.data && result.data.length ? result.data[0] : null;
                } else {
                    // Create new course
                    result = await supabase
                        .from('courses')
                        .insert(courseData)
                        .select();
                    createdCourse = result.data && result.data.length ? result.data[0] : null;
                }
                
                if (result.error) throw result.error;

                // Create lessons if any
                if (lessonsData && lessonsData.length > 0 && createdCourse) {
                    console.log(' Creating lessons for course:', createdCourse.id);
                    try {
                            if (window.isElectron) {
                            const lessonResult = await window.electronAPI.invoke('db:createLessons', createdCourse.id, lessonsData);
                            if (lessonResult && lessonResult.error) {
                                console.error(' Failed to create lessons via IPC:', lessonResult.error);
                                showError('Course saved but lessons failed: ' + lessonResult.error);
                            } else {
                                console.log(' Lessons created via IPC:', lessonResult);
                                    try { await persistPdfHighlightsToDb(createdCourse.id, lessonsData); } catch (e) { console.warn('persistPdfHighlightsToDb warning:', e?.message || e); }
                            }
                        } else {
                            const { data: lessonData, error: lessonError } = await supabase
                                .rpc('upsert_lessons_with_materials', { p_course_id: createdCourse.id, p_lessons: lessonsData });
                            if (lessonError) {
                                console.error(' Failed to create lessons via Supabase:', lessonError);
                                showError('Course saved but lessons failed: ' + lessonError.message);
                            } else {
                                console.log(' Lessons created via Supabase:', lessonData);
                                    try { await persistPdfHighlightsToDb(createdCourse.id, lessonsData); } catch (e) { console.warn('persistPdfHighlightsToDb warning:', e?.message || e); }
                            }
                        }
                    } catch (lessonError) {
                        console.error(' Error creating lessons:', lessonError);
                        showError('Course saved but lessons failed: ' + lessonError.message);
                    }
                }
                
                // Reset form and close modal
                e.target.reset();
                delete e.target.dataset.isEdit;
                delete e.target.dataset.courseId;
                closeCourseModal();
                
                // Refresh courses list
                await loadCourses();
                updateLastUpdated();
                
                // Show success message
                const successMessage = isEdit ? 'Course updated successfully!' : (lessonsData && lessonsData.length > 0 ? `Course created successfully with ${lessonsData.length} lessons!` : 'Course created successfully!');
                createToast({ type: 'success', message: successMessage });
                
            } catch (error) {
                console.error(isEdit ? 'Error updating course:' : 'Error creating course:', error);
                showError((isEdit ? 'Failed to update course: ' : 'Failed to create course: ') + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
         });

         // Add direct click event listener for finishBtn as backup
         document.getElementById('finishBtn').addEventListener('click', function(e) {
            console.log('FinishBtn clicked!');
            console.log('Button type:', e.target.type);
            console.log('Button disabled:', e.target.disabled);
            
            // Check form field values
            const titleField = document.querySelector('input[name="title"]');
            const descField = document.querySelector('textarea[name="description"]');
            console.log('Title field value:', titleField ? titleField.value : 'not found');
            console.log('Description field value:', descField ? descField.value : 'not found');
            
            const courseForm = document.getElementById('courseForm');
            if (courseForm) {
                console.log('Triggering form submission manually');
                // Trigger form submission
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                courseForm.dispatchEvent(submitEvent);
            } else {
                console.error('Course form not found!');
            }
         });

         // Function to collect lessons data from the form
         async function collectLessonsData() {
            const lessons = [];
            const lessonItems = document.querySelectorAll('.lesson-item');
            
            for (let i = 0; i < lessonItems.length; i++) {
                const lessonItem = lessonItems[i];
                
                const titleElement = lessonItem.querySelector('.lesson-title');
                const levelElement = lessonItem.querySelector('.lesson-cefr');
                const durationElement = lessonItem.querySelector('.lesson-duration');
                const contentTypeElement = lessonItem.querySelector('.lesson-content-type');
                const objectivesElement = lessonItem.querySelector('.lesson-objectives');
                
                if (!titleElement || !levelElement || !durationElement || !contentTypeElement || !objectivesElement) {
                    console.error('Missing lesson fields in lesson item', i);
                    continue;
                }
                
                // Determine folder names for organized uploads
                const lessonNameForPath = (titleElement.value || `lesson_${i + 1}`).trim();
                const sectionNameForPath = 'Course Content';
                
                const materials = [];
                
                // Collect materials for this lesson
                const contentItemElements = lessonItem.querySelectorAll('.content-item');
                for (let j = 0; j < contentItemElements.length; j++) {
                    const contentItem = contentItemElements[j];
                    
                    const contentTypeElement = contentItem.querySelector('.content-type');
                    const contentTitleElement = contentItem.querySelector('.content-title');
                    
                    if (!contentTypeElement || !contentTitleElement) {
                        console.error('Missing content fields in content item', j, 'of lesson', i);
                        continue;
                    }
                    
                    const materialType = contentTypeElement.value;
                    const materialTitle = contentTitleElement.value;
                    
                    // Base material data structure matching the enhanced lesson_materials schema
                    const materialData = {
                        type: materialType,
                        content: materialTitle,
                        order_number: j + 1,
                        file_url: null,
                        file_size: null,
                        file_type: null,
                        duration: null,
                        metadata: {}
                    };
                    
                    // Collect type-specific data and handle file uploads
                    switch(materialType) {
                        case 'text':
                            const textContent = contentItem.querySelector('.content-text')?.value || '';
                            materialData.content = textContent;
                            materialData.metadata = {
                                title: materialTitle,
                                word_count: textContent.split(' ').length
                            };
                            break;
                            
                        case 'image':
                            const imageFile = contentItem.querySelector('.content-file')?.files[0];
                            if (imageFile) {
                                try {
                                    const lessonDbId = lessonItem.getAttribute('data-lesson-db-id');
                                    const opts = lessonDbId ? { lessonId: lessonDbId, contentIndex: j } : {};
                                    materialData.file_url = await uploadSingleFile(imageFile, 'lessons', sectionNameForPath, lessonNameForPath, i, opts);
                                    materialData.file_size = imageFile.size;
                                    materialData.file_type = imageFile.type;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        alt_text: contentItem.querySelector('.content-alt')?.value || '',
                                        caption: contentItem.querySelector('.content-caption')?.value || ''
                                    };
                                } catch (error) {
                                    console.error('Failed to upload image file:', error);
                                }
                            }
                            break;
                            
                        case 'audio':
                            const audioFile = contentItem.querySelector('.content-file')?.files[0];
                            if (audioFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(audioFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = audioFile.size;
                                    materialData.file_type = audioFile.type;
                                    const durationValue = contentItem.querySelector('.content-duration')?.value;
                                    materialData.duration = durationValue ? parseInt(durationValue) : null;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        transcript: contentItem.querySelector('.content-transcript')?.value || '',
                                        quality: 'standard'
                                    };
                                } catch (error) {
                                    console.error('Failed to upload audio file:', error);
                                }
                            }
                            break;
                            
                        case 'video':
                            const videoFile = contentItem.querySelector('.content-file')?.files[0];
                            if (videoFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(videoFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = videoFile.size;
                                    materialData.file_type = videoFile.type;
                                    const durationValue = contentItem.querySelector('.content-duration')?.value;
                                    materialData.duration = durationValue ? parseInt(durationValue) : null;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        description: contentItem.querySelector('.content-description')?.value || '',
                                        resolution: '720p',
                                        has_subtitles: false
                                    };
                                } catch (error) {
                                    console.error('Failed to upload video file:', error);
                                }
                            }
                            break;
                            
                        case 'pdf':
                            const pdfFile = contentItem.querySelector('.content-file')?.files[0];
                            if (pdfFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(pdfFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = pdfFile.size;
                                    materialData.file_type = pdfFile.type;
                                } catch (error) {
                                    console.error('Failed to upload PDF file:', error);
                                }
                            }
                            const hl = collectPdfHighlightsFromContentItem(contentItem);
                            console.log('collectLessonsData: PDF highlights collected for material:', materialTitle, '- Count:', hl.length);
                            materialData.metadata = {
                                title: materialTitle,
                                page_range: contentItem.querySelector('.content-pages')?.value || '',
                                instructions: contentItem.querySelector('.content-instructions')?.value || '',
                                page_count: 0,
                                highlights: hl
                            };
                            if (hl.length > 0) {
                                console.log('collectLessonsData: PDF highlights data:', hl);
                            }
                            break;
                            
                        case 'quiz':
                            materialData.content = materialTitle;
                            materialData.metadata = {
                                title: materialTitle,
                                quiz_type: contentItem.querySelector('.quiz-type')?.value || 'multiple-choice',
                                question_count: parseInt(contentItem.querySelector('.quiz-questions')?.value) || 5,
                                time_limit: 30,
                                passing_score: 70
                            };
                            break;
                            
                        case 'interactive':
                            materialData.content = materialTitle;
                            materialData.metadata = {
                                title: materialTitle,
                                interaction_type: 'exercise',
                                estimated_time: 15
                            };
                            break;
                    }
                    
                    materials.push(materialData);
                }
                
                // Get database ID if this is an existing lesson
                const databaseId = lessonItem.getAttribute('data-lesson-db-id');
                
                // Create lesson data structure that matches the enhanced database schema
                const lessonData = {
                    title: titleElement.value,
                    description: `${contentTypeElement.value} lesson for ${levelElement.value} level - ${objectivesElement.value}`,
                    order_number: i + 1,
                    materials: materials
                };
                
                // Add database ID if this is an existing lesson
                if (databaseId && databaseId !== '') {
                    lessonData.id = databaseId;
                }
                
                lessons.push(lessonData);
            }
            
            console.log(' Collected lessons data with multimedia materials:', lessons);
            return lessons;
         }

         // Make collectLessonsData available globally
         window.collectLessonsData = collectLessonsData;

         // Helper function to upload a single file with organized folder structure
         async function uploadSingleFile(file, folder, sectionName = '', lessonName = '', lessonIndex = 0, options = {}) {
            try {
                let fileName = '';
                let filePath = '';
                
                if (options && options.lessonId && (options.contentIndex !== undefined && options.contentIndex !== null)) {
                    const ext = file.name.split('.').pop();
                    const safeLessonId = options.lessonId;
                    const idx = options.contentIndex; // 0-based index
                    fileName = `lesson-${safeLessonId}-content-${idx}-${Date.now()}.${ext}`;
                    filePath = `lessons/${safeLessonId}/content/${fileName}`;
                } else {
                    const generated = `${Date.now()}_${file.name}`;
                    
                    // Get course name from DOM
                    let courseName = '';
                    const courseTitleInput = document.getElementById('courseTitle') || document.querySelector('input[name="title"]');
                    if (courseTitleInput && courseTitleInput.value) {
                        courseName = courseTitleInput.value.trim();
                    }
                    
                    // Create organized path structure: courseName/lesson_number/fileName
                    if (courseName) {
                        const sanitizedCourse = courseName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
                        filePath = `${sanitizedCourse}/lesson_${lessonIndex + 1}/${generated}`;
                    } else {
                        filePath = `course_content/lesson_${lessonIndex + 1}/${generated}`;
                    }
                    fileName = generated;
                }
                

                // Add lesson number (1-based index)
                const lessonNumber = lessonIndex + 1;
                filePath += `/lesson_${lessonNumber}`;

                filePath += `/${fileName}`;

                // Ensure the bucket exists before uploading
                await supabaseStorageService.ensureBucket('course-materials');


                // Use IPC for file upload if in Electron environment
                if (window.isElectron) {
                    // Convert file to buffer for IPC
                    const arrayBuffer = await file.arrayBuffer();
                    const buffer = new Uint8Array(arrayBuffer);

                    const result = await window.electronAPI.invoke('db:uploadFile', buffer, fileName, 'course-materials', filePath);

                    if (result.success) {
                        const publicUrl = result.result.publicUrl || result.result;
                        const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                        try {
                            await client.from('documents').upsert({
                                name: file.name,
                                path: filePath,
                                bucket: 'course-materials',
                                url: publicUrl
                            }, { onConflict: 'path' });
                        } catch (dbError) {
                            console.error('Error storing file info:', dbError);
                        }

                        console.log(' File uploaded successfully via Electron IPC:', publicUrl);
                        if (typeof refreshAllLessonFiles === 'function') {
                            try { refreshAllLessonFiles(); } catch (e) { console.warn('refreshAllLessonFiles error:', e); }
                        }
                        return publicUrl;
                    } else {
                        console.error(' Failed to upload file via IPC:', result.error);
                        throw new Error(result.error);
                    }
                } else {
                    // Fallback to direct Supabase upload for web environment (prefer admin client if available)
                    const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                    const contentType = fileName.toLowerCase().endsWith('.pdf') ? 'application/pdf' : file.type;
                    const folderPath = filePath.substring(0, filePath.lastIndexOf('/'));
                    const result = await supabaseStorageService.uploadFile(file, 'course-materials', folderPath, { contentType });

                    // Store path and public URL in documents table
                    try {
                        await client.from('documents').upsert({
                            name: file.name,
                            path: result.path,
                            bucket: 'course-materials',
                            url: result.url
                        }, { onConflict: 'path' });
                    } catch (dbError) {
                        console.error('Error storing file info:', dbError);
                    }

                    console.log(' File uploaded successfully via direct Supabase:', result.url);
                    if (typeof refreshAllLessonFiles === 'function') {
                        try { refreshAllLessonFiles(); } catch (e) { console.warn('refreshAllLessonFiles error:', e); }
                    }
                    return result.url;
                }
            } catch (error) {
                console.error(' Error uploading file:', error);
                throw error;
            }
         }

         // Make uploadSingleFile available globally
         window.uploadSingleFile = uploadSingleFile;

        // Assignment form submission
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const description = formData.get('description');
            const dueDate = formData.get('dueDate');
            const points = formData.get('points');
            const pdfFiles = document.getElementById('assignmentPdfs').files;
            const audioFiles = document.getElementById('assignmentAudio').files;
            const videoFiles = document.getElementById('assignmentVideos').files;
            const imageFiles = document.getElementById('assignmentImages').files;
            
            if (!title || !description) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Show loading state
                const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                // Upload files if any
                let uploadedFiles = [];
                if (pdfFiles.length > 0 || audioFiles.length > 0 || videoFiles.length > 0 || imageFiles.length > 0) {
                    const allFiles = [...pdfFiles, ...audioFiles, ...videoFiles, ...imageFiles];
                    uploadedFiles = await uploadFiles(allFiles, 'assignments');
                }
                
                // Create assignment in database
                 const { data, error } = await supabase
                     .from('assignments')
                     .insert({
                         course_id: null, // Will be set by admin later
                         title: title,
                         description: description,
                         assignment_type: 'exercise',
                         difficulty_level: 'beginner',
                         // points field omitted; max_score column not present in current DB schema
                         due_date: dueDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Default to 7 days from now
                         is_active: true
                     })
                     .select();
                
                if (error) throw error;
                
                // Reset form and close modal
                e.target.reset();
                closeAssignmentModal();
                
                // Refresh assignments list
                await loadAssignments();
                updateLastUpdated();
                
                // Show success message
                createToast({ type: 'success', message: 'Assignment created successfully!' });
                
            } catch (error) {
                console.error('Error creating assignment:', error);
                showError('Failed to create assignment: ' + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        });

        // Action functions
        async function refreshData() {
            const overlay = document.getElementById('global-loading');
            const refreshBtn = document.querySelector('header button[onclick="refreshData()"]');
            try {
                if (overlay) overlay.classList.remove('hidden');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.classList.add('opacity-50','cursor-not-allowed');
                }
                await loadDashboardData();
                updateLastUpdated();
                createToast({ type: 'success', message: 'Dashboard refreshed' });
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh data');
            } finally {
                if (overlay) overlay.classList.add('hidden');
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('opacity-50','cursor-not-allowed');
                }
            }
        }

        async function refreshUsers() {
            try {
                await loadUsers();
                updateLastUpdated();
            } catch (error) {
                console.error('Error refreshing users:', error);
                showError('Failed to refresh users');
            }
        }

        function viewUser(userId) {
            if (typeof window.viewUser === 'function' && window.viewUser !== viewUser) {
                return window.viewUser(userId);
            }
            createToast({ type: 'info', message: `View user details for: ${userId}` });
        }

        async function deleteUser(userId) {
            if (typeof window.deleteUser === 'function' && window.deleteUser !== deleteUser) {
                return window.deleteUser(userId);
            }
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                await loadUsers();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
            }
        }

        function editVocabulary(wordId) {
            createToast({ type: 'info', message: `Edit vocabulary word: ${wordId}` });
        }

        async function deleteVocabulary(wordId) {
            if (!confirm('Are you sure you want to delete this vocabulary word?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_vocabulary')
                    .delete()
                    .eq('id', wordId);
                
                if (error) throw error;
                
                await loadVocabulary();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting vocabulary:', error);
                showError('Failed to delete vocabulary word');
            }
        }

        function editLesson(lessonId) {
            createToast({ type: 'info', message: `Edit lesson: ${lessonId}` });
        }

        async function deleteLesson(lessonId) {
            if (!confirm('Are you sure you want to delete this lesson?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('grammar_lessons')
                    .delete()
                    .eq('id', lessonId);
                
                if (error) throw error;
                
                await loadGrammarLessons();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting lesson:', error);
                showError('Failed to delete lesson');
            }
        }

        // Course management functions
        async function editCourse(courseId) {
            console.log('editCourse called with courseId:', courseId);
            
            // Handle test course ID
            if (courseId === 'test-course-id') {
                console.log('Test course detected, showing modal with test data');
                
                // Populate form with test data
                const titleElement = document.getElementById('courseTitle');
                const descElement = document.getElementById('courseDescription');
                const levelElement = document.getElementById('cefrLevel'); // Fixed: use the correct ID
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                const modalElement = document.getElementById('courseModal');
                
                if (titleElement) titleElement.value = 'Test Course';
                if (descElement) descElement.value = 'This is a test course for debugging';
                if (levelElement) levelElement.value = 'A1'; // Fixed: use valid CEFR level
                if (categoryElement) categoryElement.value = 'conversation';
                if (languageElement) languageElement.value = 'es';
                if (durationElement) durationElement.value = 12;
                if (hoursElement) hoursElement.value = 5;
                
                // Populate instructor fields for test course
                const instructorNameElement = document.getElementById('instructorName');
                const instructorEmailElement = document.getElementById('instructorEmail');
                const instructorBioElement = document.getElementById('instructorBio');
                
                if (instructorNameElement) instructorNameElement.value = 'Test Instructor';
                if (instructorEmailElement) instructorEmailElement.value = 'test@example.com';
                if (instructorBioElement) instructorBioElement.value = 'Test instructor bio for debugging purposes';
                
                // Update modal title and button
                const modalTitleElement = document.getElementById('courseModalTitle');
                const submitBtnElement = document.getElementById('finishBtn');
                
                if (modalTitleElement) modalTitleElement.textContent = 'Edit Test Course';
                if (submitBtnElement) {
                    submitBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Update Course';
                    submitBtnElement.style.display = 'inline-flex'; // Show the button for editing
                }
                
                // Start from step 1 for editing to show all form steps
                showWizardStep(1);
                
                // Load test lesson content
                const testCourse = {
                    learning_objectives: 'Learn basic Spanish conversation skills',
                    prerequisites: 'No prior Spanish knowledge required',
                    skills_focus: ['speaking', 'listening'],
                    lessons: [
                        {
                            title: 'Introduction to Spanish',
                            level: 'A1',
                            duration: '45 minutes',
                            objectives: 'Learn basic greetings and introductions',
                            content: [
                                {
                                    type: 'text',
                                    content: 'Welcome to Spanish! In this lesson, we will learn basic greetings.'
                                },
                                {
                                    type: 'audio',
                                    description: 'Listen to basic greetings',
                                    duration: '2 minutes'
                                },
                                {
                                    type: 'quiz',
                                    title: 'Greetings Quiz',
                                    questions: '5'
                                }
                            ]
                        },
                        {
                            title: 'Numbers and Colors',
                            level: 'A1',
                            duration: '30 minutes',
                            objectives: 'Learn numbers 1-20 and basic colors',
                            content: [
                                {
                                    type: 'text',
                                    content: 'In this lesson, we will learn numbers and colors in Spanish.'
                                },
                                {
                                    type: 'image',
                                    description: 'Color chart in Spanish'
                                },
                                {
                                    type: 'video',
                                    description: 'Numbers pronunciation guide',
                                    duration: '3 minutes'
                                },
                                {
                                    type: 'pdf',
                                    page_range: '1-5',
                                    synonym: 'Spanish Numbers Reference Guide',
                                    instructions: 'Use this PDF as a reference for practicing numbers and colors'
                                }
                            ]
                        }
                    ]
                };
                
                await loadLessonContent(testCourse);
                
                // Store course ID for update
                document.getElementById('courseForm').dataset.courseId = courseId;
                document.getElementById('courseForm').dataset.isEdit = 'true';
                
                // Show modal
                if (modalElement) {
                    modalElement.classList.remove('hidden');
                    console.log('Test modal should be visible now');
                }
                return; // Early return to prevent executing the real course loading code
            }
            
            try {
                // Check if supabase is available
                if (typeof supabase === 'undefined') {
                    console.error('Supabase client not initialized');
                    createToast({ type: 'error', message: 'Database connection not available. Please refresh the page.' });
                    return;
                }

                console.log('Fetching course data...');
                // Fetch course data
                const { data: course, error } = await supabase
                    .from('courses')
                    .select('id,title,description,level,cefr_level,language,category,duration,duration_weeks,hours_per_week,is_active,created_at,instructor_name,instructor_email,instructor_bio,learning_objectives,prerequisites,skills_focus')
                    .eq('id', courseId)
                    .single();

                if (error) {
                    console.error('Error fetching course:', error);
                    createToast({ type: 'error', message: 'Error loading course data: ' + error.message });
                    return;
                }

                console.log('Course data fetched:', course);

                // Check if form elements exist
                const titleElement = document.getElementById('courseTitle');
                const descElement = document.getElementById('courseDescription');
                const levelElement = document.getElementById('cefrLevel'); // Fixed: use the correct ID
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                const modalElement = document.getElementById('courseModal');
                
                if (!titleElement || !descElement || !levelElement || !modalElement) {
                    console.error('Required form elements not found');
                    createToast({ type: 'error', message: 'Form elements not found. Please refresh the page.' });
                    return;
                }

                // Populate form with course data
                titleElement.value = course.title || '';
                descElement.value = course.description || '';
                // Map course level to CEFR level format
                const cefrLevel = course.level || course.cefr_level || 'A1';
                levelElement.value = cefrLevel;
                
                // Populate other form fields if they exist
                if (categoryElement) categoryElement.value = course.category || 'general';
                if (languageElement) languageElement.value = course.language || 'Spanish';
                if (durationElement) durationElement.value = course.duration_weeks || course.duration || 8;
                if (hoursElement) hoursElement.value = course.hours_per_week || 3;
                
                // Populate instructor fields
                const instructorNameElement = document.getElementById('instructorName');
                const instructorEmailElement = document.getElementById('instructorEmail');
                const instructorBioElement = document.getElementById('instructorBio');
                
                if (instructorNameElement) instructorNameElement.value = course.instructor_name || '';
                if (instructorEmailElement) instructorEmailElement.value = course.instructor_email || '';
                if (instructorBioElement) instructorBioElement.value = course.instructor_bio || '';
                
                // Populate step 2 fields (learning objectives, prerequisites, skills focus)
                const objectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (objectivesElement) objectivesElement.value = course.learning_objectives || '';
                if (prerequisitesElement) prerequisitesElement.value = course.prerequisites || '';

                // Update modal title and button
                const modalTitleElement = document.getElementById('courseModalTitle');
                const submitBtnElement = document.getElementById('finishBtn');
                
                if (modalTitleElement) modalTitleElement.textContent = 'Edit Course';
                if (submitBtnElement) {
                    submitBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Update Course';
                    submitBtnElement.style.display = 'inline-flex'; // Show the button for editing
                }
                
                // Start from step 1 for editing to show all form steps
                showWizardStep(1);

                // Load lesson content from database
                await loadLessonContentFromDatabase(courseId);

                // Store course ID for update
                document.getElementById('courseForm').dataset.courseId = courseId;
                document.getElementById('courseForm').dataset.isEdit = 'true';

                console.log('Showing modal...');
                // Show modal
                modalElement.classList.remove('hidden');
                console.log('Modal should be visible now');
            } catch (error) {
                console.error('Error in editCourse:', error);
                createToast({ type: 'error', message: 'Error loading course for editing: ' + error.message });
            }
        }

        window.editCourse = window.editCourse || editCourse;

        async function deleteCourse(courseId) {
            console.log(' Delete course called with ID:', courseId);
            
            if (!confirm('Are you sure you want to delete this course?')) {
                console.log(' User cancelled course deletion');
                return;
            }
            
            console.log(' User confirmed deletion, proceeding...');
            
            try {
                // Use admin client for delete operations to bypass RLS
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'Admin' : 'Regular');
                
                const { data, error } = await client
                    .from('courses')
                    .delete()
                    .eq('id', courseId);
                
                console.log(' Delete operation result:', { data, error });
                
                if (error) {
                    console.error(' Supabase delete error:', error);
                    throw error;
                }
                
                console.log(' Course deleted successfully, reloading courses...');
                await loadCourses();
                updateLastUpdated();
                console.log(' Course list reloaded');
            } catch (error) {
                console.error(' Error deleting course:', error);
                showError(`Failed to delete course: ${error.message}`);
            }
        }

        // Load lesson content for editing
        async function loadLessonContent(course) {
            try {
                // Clear existing lessons
                const lessonsContainer = document.getElementById('lessonsContainer');
                if (lessonsContainer) {
                    lessonsContainer.innerHTML = '';
                }

                // Populate learning objectives, prerequisites, and skills focus
                const objectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (objectivesElement && course.learning_objectives) {
                    objectivesElement.value = course.learning_objectives;
                }
                if (prerequisitesElement && course.prerequisites) {
                    prerequisitesElement.value = course.prerequisites;
                }

                // Handle skills focus checkboxes
                // First clear all checkboxes to avoid stale selections
                const allSkillCheckboxes = document.querySelectorAll('input[name="skillsFocus"]');
                allSkillCheckboxes.forEach(cb => { cb.checked = false; });
                // Then set based on course data
                if (course.skills_focus) {
                    const skills = Array.isArray(course.skills_focus) ? course.skills_focus : course.skills_focus.split(',');
                    skills.forEach(skill => {
                        const checkbox = document.querySelector(`input[name="skillsFocus"][value="${skill.trim()}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }

                // Load lessons if available
                if (course.lessons && Array.isArray(course.lessons)) {
                    course.lessons.forEach((lesson, index) => {
                        addLesson();
                        
                        // Populate lesson data
                        const lessonItem = document.querySelector(`#lesson-${index + 1}`);
                        if (lessonItem) {
                            const titleInput = lessonItem.querySelector('.lesson-title');
                            const levelSelect = lessonItem.querySelector('.lesson-cefr');
                            const durationInput = lessonItem.querySelector('.lesson-duration');
                            const objectivesTextarea = lessonItem.querySelector('.lesson-objectives');
                            
                            if (titleInput) titleInput.value = lesson.title || '';
                            if (levelSelect) levelSelect.value = lesson.level || 'A1';
                            if (durationInput) durationInput.value = lesson.duration || '';
                            if (objectivesTextarea) objectivesTextarea.value = lesson.objectives || '';
                            
                            // Load lesson content
                            if (lesson.content && Array.isArray(lesson.content)) {
                                lesson.content.forEach(contentItem => {
                                    // Create content item manually instead of calling addLessonContent with wrong parameter
                                    const contentContainer = lessonItem.querySelector('.lesson-content-container');
                                    const contentCount = contentContainer.querySelectorAll('.content-item').length + 1;
                                    
                                    const contentHTML = `
                                        <div class="content-item bg-white p-3 rounded border border-gray-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <h6 class="font-medium text-gray-700">Content Item ${contentCount}</h6>
                                                <button type="button" onclick="removeLessonContent(this)" class="text-red-600 hover:text-red-800">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Content Type</label>
                                                    <select class="content-type w-full px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateContentFields(this)">
                                                        <option value="text">Text Content</option>
                                                        <option value="image">Image</option>
                                                        <option value="audio">Audio</option>
                                                        <option value="video">Video</option>
                                                        <option value="pdf">PDF Document</option>
                                                        <option value="quiz">Interactive Quiz</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Content Title</label>
                                                    <input type="text" class="content-title w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Enter content title">
                                                </div>
                                            </div>
                                            <div class="content-fields">
                                                <div class="text-content-fields">
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                                                    <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    
                                    contentContainer.insertAdjacentHTML('beforeend', contentHTML);
                                    lucide.createIcons();
                                    
                                    // Find the last added content item
                                    const contentItems = contentContainer.querySelectorAll('.content-item');
                                    const lastContentItem = contentItems[contentItems.length - 1];
                                    
                                    if (lastContentItem) {
                                        const typeSelect = lastContentItem.querySelector('.content-type');
                                        if (typeSelect) {
                                            typeSelect.value = contentItem.type || 'text';
                                            updateContentFields(typeSelect);
                                            
                                            // Populate content based on type
                                            setTimeout(() => {
                                                const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                                if (fieldsContainer) {
                                                    switch (contentItem.type) {
                                                        case 'text':
                                                            const textArea = fieldsContainer.querySelector('textarea');
                                                            if (textArea) textArea.value = contentItem.content || '';
                                                            break;
                                                        case 'image':
                                                            const altInput = fieldsContainer.querySelector('.content-alt');
                                                            const captionInput = fieldsContainer.querySelector('.content-caption');
                                                            if (altInput) altInput.value = contentItem.alt_text || '';
                                                            if (captionInput) captionInput.value = contentItem.caption || '';
                                                            break;
                                                        case 'audio':
                                                            const audioDurationInput = fieldsContainer.querySelector('.content-duration');
                                                            const transcriptInput = fieldsContainer.querySelector('.content-transcript');
                                                            if (audioDurationInput) audioDurationInput.value = contentItem.duration || '';
                                                            if (transcriptInput) transcriptInput.value = contentItem.transcript || '';
                                                            break;
                                                        case 'video':
                                                            const videoDurationInput = fieldsContainer.querySelector('.content-duration');
                                                            const videoDescInput = fieldsContainer.querySelector('.content-description');
                                                            if (videoDurationInput) videoDurationInput.value = contentItem.duration || '';
                                                            if (videoDescInput) videoDescInput.value = contentItem.description || '';
                                                            break;
                                                        case 'pdf':
                                                            const pagesInput = fieldsContainer.querySelector('.content-pages');
                                                            const synonymInput = fieldsContainer.querySelector('.content-synonym');
                                                            const instructionsInput = fieldsContainer.querySelector('.content-instructions');
                                                            if (pagesInput) pagesInput.value = contentItem.page_range || '';
                                                            if (synonymInput) synonymInput.value = contentItem.synonym || '';
                                                            if (instructionsInput) instructionsInput.value = contentItem.instructions || '';
                                                            break;
                                                        case 'quiz':
                                                            const titleInput = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                            const questionsInput = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                            if (titleInput) titleInput.value = contentItem.title || '';
                                                            if (questionsInput) questionsInput.value = contentItem.questions || '';
                                                            break;
                                                    }
                                                }
                                            }, 100);
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading lesson content:', error);
            }
        }

        // Function to load lesson data from database for editing using RPC
        async function loadLessonContentFromDatabase(courseId) {
            try {
                if (window.__lessonsLoading) {
                    console.warn('Lesson load already in progress, skipping this invocation.');
                    return;
                }
                window.__lessonsLoading = true;
                if (!supabase) {
                    console.error('Supabase not initialized');
                    return;
                }
                
                console.log(' Loading lessons with materials using RPC for course:', courseId);
                
                // Fetch lessons with materials using the RPC function
                const { data: lessonsWithMaterials, error } = await supabase
                    .rpc('get_course_lessons_with_materials', { p_course_id: courseId });
                
                if (error) {
                    console.error(' Error fetching lessons with materials:', error);
                    // Fallback to the original method if RPC fails
                    console.log(' Falling back to separate queries...');
                    return await loadLessonContentFromDatabaseFallback(courseId);
                }
                
                if (!lessonsWithMaterials || lessonsWithMaterials.length === 0) {
                    console.log(' No lessons found for course:', courseId);
                    return;
                }
                
                console.log(' Found lessons with materials:', lessonsWithMaterials.length, 'rows');
                
                // Clear existing lessons
                const lessonsContainer = document.getElementById('lessonsContainer');
                if (lessonsContainer) {
                    lessonsContainer.innerHTML = '';
                }
                
                // Group materials by lesson_id to organize the data
                const lessonsMap = new Map();
                
                lessonsWithMaterials.forEach(row => {
                    const lessonId = row.lesson_id;
                    
                    if (!lessonsMap.has(lessonId)) {
                        lessonsMap.set(lessonId, {
                            id: lessonId,
                            title: row.lesson_title,
                            description: row.lesson_description,
                            order_index: row.lesson_order,
                            materials: []
                        });
                    }
                    
                    // Add material if it exists (some lessons might not have materials)
                    if (row.material_id) {
                        lessonsMap.get(lessonId).materials.push({
                            id: row.material_id,
                            type: row.material_type,
                            content: row.material_content,
                            url: row.file_url || row.url,
                            metadata: row.metadata
                        });
                    }
                });
                
                // Convert map to array and sort by lesson order
                const lessons = Array.from(lessonsMap.values()).sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
                
                console.log(' Organized into', lessons.length, 'lessons');
                
                // Populate each lesson in the form
                for (const lesson of lessons) {
                    addLesson(lesson.id);
                    
                    // Get the last added lesson container
                    const lessonContainers = document.querySelectorAll('.lesson-item');
                    const currentLesson = lessonContainers[lessonContainers.length - 1];
                    
                    if (currentLesson) {
                        // Populate lesson fields
                        const titleInput = currentLesson.querySelector('.lesson-title');
                        const levelSelect = currentLesson.querySelector('.lesson-cefr');
                        const durationInput = currentLesson.querySelector('.lesson-duration');
                        const objectivesTextarea = currentLesson.querySelector('.lesson-objectives');
                        
                        if (titleInput) titleInput.value = lesson.title || '';
                        if (levelSelect) levelSelect.value = 'A1'; // Default CEFR level
                        if (durationInput) durationInput.value = '30'; // Default duration
                        if (objectivesTextarea) objectivesTextarea.value = lesson.description || '';
                        
                        // Populate materials for this lesson
                        await populateLessonMaterials(lesson.materials, currentLesson);
                    }
                }

                // After populating all lessons/materials, sync data for Review step
                try {
                    courseWizardData.lessons = collectLessonsData();
                    if (typeof updateReviewStep === 'function') {
                        setTimeout(() => { 
                            try { 
                                updateReviewStep(); 
                            } catch (e) { 
                                console.warn('updateReviewStep failed:', e); 
                            } 
                        }, 500);
                    }
                } catch (e) {
                    console.warn('Failed to sync lessons to review:', e);
                }
                
                console.log(' Successfully loaded', lessons.length, 'lessons with materials');
                
            } catch (error) {
                console.error(' Error loading lesson content from database:', error);
                // Try fallback method
                return await loadLessonContentFromDatabaseFallback(courseId);
            } finally {
                window.__lessonsLoading = false;
            }
        }
        
        // Fallback function for separate queries (original implementation)
        async function loadLessonContentFromDatabaseFallback(courseId) {
            try {
                console.log(' Using fallback method to load lessons...');
                
                // Fetch lessons for this course
                const { data: lessons, error } = await supabase
                    .from('lessons')
                    .select('*')
                    .eq('course_id', courseId)
                    .order('order_index', { ascending: true });
                
                if (error) {
                    console.error('Error fetching lessons:', error);
                    return;
                }
                
                if (lessons && lessons.length > 0) {
                    // Clear existing lessons
                    const lessonsContainer = document.getElementById('lessonsContainer');
                    if (lessonsContainer) {
                        lessonsContainer.innerHTML = '';
                    }
                    
                    // Add each lesson
                    for (const lesson of lessons) {
                        addLesson();
                        
                        // Get the last added lesson container (matches addLesson template)
                        const lessonContainers = document.querySelectorAll('.lesson-item');
                        const currentLesson = lessonContainers[lessonContainers.length - 1];
                        
                        if (currentLesson) {
                            // Populate lesson fields
                            const titleInput = currentLesson.querySelector('.lesson-title');
                            const levelSelect = currentLesson.querySelector('.lesson-cefr');
                            const durationInput = currentLesson.querySelector('.lesson-duration');
                            const objectivesTextarea = currentLesson.querySelector('.lesson-objectives');
                            
                            if (titleInput) titleInput.value = lesson.title || '';
                            if (levelSelect) levelSelect.value = lesson.cefr_level || 'A1';
                            if (durationInput) durationInput.value = lesson.duration || '';
                            if (objectivesTextarea) objectivesTextarea.value = lesson.objectives || '';
                            
                            // Load lesson materials/content if available (await to ensure DOM is populated sequentially)
                            await loadLessonMaterials(lesson.id, currentLesson, courseId);
                        }
                    }

                    // After populating all lessons/materials, sync data for Review step
                    try {
                        courseWizardData.lessons = collectLessonsData();
                        if (typeof updateReviewStep === 'function') {
                            setTimeout(() => { 
                                try { 
                                    updateReviewStep(); 
                                } catch (e) { 
                                    console.warn('updateReviewStep failed:', e); 
                                } 
                            }, 500);
                        }
                    } catch (e) {
                        console.warn('Failed to sync lessons to review:', e);
                    }
                } else {
                    console.log('No lessons found for course:', courseId);
                }
            } catch (error) {
                console.error('Error loading lesson content from database (fallback):', error);
            }
        }
        
        // Function to populate materials for a lesson using pre-fetched data
        // Function to check and load existing images from Supabase storage
        async function checkAndLoadExistingImage(lessonId, contentIndex, contentItem) {
            try {
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                if (!client) {
                    console.warn('Supabase not initialized');
                    return null;
                }
                
                // List files in the standardized content directory
                const { data: files, error } = await client.storage
                    .from('course-materials')
                    .list(`lessons/${lessonId}/content`, {
                        limit: 100,
                        offset: 0
                    });
                
                if (error) {
                    console.log('No existing images found or error:', error.message || error);
                    return null;
                }
                
                // Find a file that matches this content index pattern
                const matching = (files || []).filter(file => 
                    file.name.includes(`content-${contentIndex}`) && 
                    /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)
                );
                
                if (matching.length) {
                    // Get the most recent image by name
                    const latest = matching.sort((a,b) => b.name.localeCompare(a.name))[0];
                    const path = `lessons/${lessonId}/content/${latest.name}`;
                    // Get public URL for the image
                    const { data: { publicUrl } } = client.storage
                        .from('course-materials')
                        .getPublicUrl(path);
                    
                    if (publicUrl) {
                        const fieldsContainer = contentItem.querySelector('.content-fields');
                        if (fieldsContainer) {
                            let preview = fieldsContainer.querySelector('.image-loaded-preview');
                            if (preview) {
                                preview.style.display = 'block';
                                const imgEl = preview.querySelector('img');
                                const urlInput = preview.querySelector('.current-image-url');
                                if (imgEl) imgEl.src = publicUrl;
                                if (urlInput) urlInput.value = publicUrl;
                                console.log(' Loaded existing image:', latest.name);
                                return publicUrl;
                            }
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error checking for existing image:', error);
                return null;
            }
        }

        async function populateLessonMaterials(materials, lessonContainer) {
            try {
                if (!materials || materials.length === 0) {
                    console.log(' No materials to populate for this lesson');
                    return;
                }
                
                console.log(' Populating', materials.length, 'materials...');
                
                const contentContainer = lessonContainer.querySelector('.lesson-content-container');
                if (!contentContainer) {
                    console.warn('Content container not found in lesson');
                    return;
                }
                
                // Add each material as content synchronously
                for (let index = 0; index < materials.length; index++) {
                    const material = materials[index];
                    
                    // Click the existing Add Content button in this lesson item
                    const addMaterialBtn = lessonContainer.querySelector('button[onclick^="addLessonContent"]');
                    if (addMaterialBtn) {
                        addMaterialBtn.click();
                        
                        // Wait for DOM to update
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        // Get the last added content item
                        const contentItems = contentContainer.querySelectorAll('.content-item');
                        const lastContentItem = contentItems[contentItems.length - 1];
                        
                        if (lastContentItem) {
                            console.log(` Populating material ${index + 1}:`, material);
                            
                            // Populate material data
                            const titleInput = lastContentItem.querySelector('.content-title');
                            const typeSelect = lastContentItem.querySelector('.content-type');
                            
                            if (titleInput) titleInput.value = `Material ${index + 1}`;
                            if (typeSelect) {
                                const materialType = (material.type || 'text').toLowerCase();
                                typeSelect.value = materialType;
                                
                                // Trigger the change event to update fields
                                const changeEvent = new Event('change', { bubbles: true });
                                typeSelect.dispatchEvent(changeEvent);
                                
                                // Wait for fields to update
                                await new Promise(resolve => setTimeout(resolve, 100));
                                
                                // Populate type-specific fields
                                const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                if (fieldsContainer) {
                                    // Parse content data
                                    let contentData = {};
                                    if (material.content) {
                                        if (typeof material.content === 'string') {
                                            try {
                                                contentData = JSON.parse(material.content);
                                            } catch (e) {
                                                if (materialType === 'text') {
                                                    contentData = { text: material.content };
                                                }
                                            }
                                        } else {
                                            contentData = material.content;
                                        }
                                    }
                                    if (!contentData || Object.keys(contentData).length === 0) {
                                        contentData = material.metadata || {};
                                    }
                                    
                                    console.log(` Content data for material ${index + 1}:`, contentData);
                                    
                                    // Populate based on material type
                                    switch (materialType) {
                                        case 'text':
                                            const textArea = fieldsContainer.querySelector('textarea');
                                            if (textArea) {
                                                const textContent = typeof material.content === 'string' ? material.content : (contentData.text || contentData.content || '');
                                                textArea.value = textContent;
                                                console.log(' Text content populated:', textContent);
                                            }
                                            break;
                                        case 'video':
                                            const videoDuration = fieldsContainer.querySelector('.content-duration');
                                            const videoDesc = fieldsContainer.querySelector('.content-description');
                                            if (videoDuration) videoDuration.value = contentData.duration || '';
                                            if (videoDesc) videoDesc.value = contentData.description || '';
                                            break;
                                        case 'audio':
                                            const audioDuration = fieldsContainer.querySelector('.content-duration');
                                            const transcript = fieldsContainer.querySelector('.content-transcript');
                                            if (audioDuration) audioDuration.value = contentData.duration || '';
                                            if (transcript) transcript.value = contentData.transcript || '';
                                            break;
                                        case 'pdf':
                                            const pages = fieldsContainer.querySelector('.content-pages');
                                            const synonym = fieldsContainer.querySelector('.content-synonym');
                                            const instructions = fieldsContainer.querySelector('.content-instructions');
                                            if (pages) pages.value = contentData.page_range || '';
                                            if (synonym) synonym.value = contentData.synonym || '';
                                            if (instructions) instructions.value = contentData.instructions || '';
                                            break;
                                        case 'quiz':
                                            const quizTitle = fieldsContainer.querySelector('input[placeholder*="title"]');
                                            const questions = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                            if (quizTitle) quizTitle.value = contentData.title || '';
                                            if (questions) questions.value = contentData.questions || '';
                                            break;
                                        case 'image':
                                            const altInput = fieldsContainer.querySelector('.content-alt');
                                            const captionInput = fieldsContainer.querySelector('.content-caption');
                                            if (altInput) altInput.value = contentData.alt_text || '';
                                            if (captionInput) captionInput.value = contentData.caption || '';
                                            

                                            // Populate based on material type
                                            switch (materialType) {
                                                case 'text':
                                                    const textArea = fieldsContainer.querySelector('textarea');
                                                    if (textArea) textArea.value = typeof material.content === 'string' ? material.content : (contentData.text || contentData.content || '');
                                                    break;
                                                case 'video':
                                                    const videoDuration = fieldsContainer.querySelector('.content-duration');
                                                    const videoDesc = fieldsContainer.querySelector('.content-description');
                                                    if (videoDuration) videoDuration.value = contentData.duration || '';
                                                    if (videoDesc) videoDesc.value = contentData.description || '';
                                                    break;
                                                case 'audio':
                                                    const audioDuration = fieldsContainer.querySelector('.content-duration');
                                                    const transcript = fieldsContainer.querySelector('.content-transcript');
                                                    if (audioDuration) audioDuration.value = contentData.duration || '';
                                                    if (transcript) transcript.value = contentData.transcript || '';
                                                    break;
                                                case 'pdf':
                                                    const pages = fieldsContainer.querySelector('.content-pages');
                                                    const synonym = fieldsContainer.querySelector('.content-synonym');
                                                    const instructions = fieldsContainer.querySelector('.content-instructions');
                                                    if (pages) pages.value = contentData.page_range || '';
                                                    if (synonym) synonym.value = contentData.synonym || '';
                                                    if (instructions) instructions.value = contentData.instructions || '';
                                                    break;
                                                case 'quiz':
                                                    const quizTitle = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                    const questions = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                    if (quizTitle) quizTitle.value = contentData.title || '';
                                                    if (questions) questions.value = contentData.questions || '';
                                                    break;
                                                case 'image':
                                                    const altInput = fieldsContainer.querySelector('.content-alt');
                                                    const captionInput = fieldsContainer.querySelector('.content-caption');
                                                    if (altInput) altInput.value = contentData.alt_text || '';
                                                    if (captionInput) captionInput.value = contentData.caption || '';
                                                    
                                                    // Show preview of existing image using stored URL or generate if missing
                                                    let imageUrl = material.url;
                                                    if (!imageUrl && material.path) {
                                                        const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                                                        const { data: { publicUrl } } = client.storage
                                                            .from('course-materials')
                                                            .getPublicUrl(material.path);
                                                        imageUrl = publicUrl;
                                                        material.url = publicUrl;
                                                    }
                                                    if (imageUrl) {
                                                        let preview = fieldsContainer.querySelector('.image-loaded-preview');
                                                        if (!preview) {
                                                            preview = document.createElement('div');
                                                            preview.className = 'image-loaded-preview mt-2';
                                                            preview.innerHTML = `<img class="max-h-40 rounded border" alt="Image preview">`;
                                                            fieldsContainer.appendChild(preview);
                                                        }
                                                        const imgEl = preview.querySelector('img');
                                                        if (imgEl) imgEl.src = imageUrl;
                                                    }
                                                    break;

                                            }
                                            break;
                                    }
                                }
                            }
                        }
                    }
                }
                
                console.log(' All materials populated successfully');
                return true;
                
            } catch (error) {
                console.error(' Error populating lesson materials:', error);
            }
        }
        
        // Function to load lesson materials for a specific lesson
        async function loadLessonMaterials(lessonId, lessonContainer, courseId) {
            try {
                if (!supabase) {
                    console.error('Supabase not initialized');
                    return;
                }
                
                // Fetch lesson materials
                const { data: materials, error } = await supabase
                    .from('lesson_materials')
                    .select('*')
                    .eq('lesson_id', lessonId)
                    .order('order_index', { ascending: true });
                
                if (error) {
                    console.error('Error fetching lesson materials:', error);
                    return;
                }
                
                if (materials && materials.length > 0) {
                    // Use the correct container class from the template
                    const contentContainer = lessonContainer.querySelector('.lesson-content-container');
                    if (contentContainer) {
                        // Add each material as content
                        materials.forEach(material => {
                            // Click the existing Add Content button in this lesson item
                            const addMaterialBtn = lessonContainer.querySelector('button[onclick^="addLessonContent"]');
                            if (addMaterialBtn) {
                                addMaterialBtn.click();
                                
                                // Get the last added content item
                                setTimeout(() => {
                                    const contentItems = contentContainer.querySelectorAll('.content-item');
                                    const lastContentItem = contentItems[contentItems.length - 1];
                                    
                                    if (lastContentItem) {
                                        // Populate material data
                                        const titleInput = lastContentItem.querySelector('.content-title');
                                        const typeSelect = lastContentItem.querySelector('.content-type');
                                        
                                        if (titleInput) titleInput.value = material.title || '';
                                        if (typeSelect) {
                                            const materialType = (material.type || 'text').toLowerCase();
                                            typeSelect.value = materialType;
                                            updateContentFields(typeSelect);
                                            
                                            // Populate type-specific fields
                                            setTimeout(() => {
                                                const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                                if (fieldsContainer) {
                                                    // Safely parse content data if it's a JSON string; else fallback to metadata
                                                    let contentData = {};
                                                    if (material.content) {
                                                        if (typeof material.content === 'string') {
                                                            try {
                                                                contentData = JSON.parse(material.content);
                                                            } catch (e) {
                                                                // If plain string for text type
                                                                if (materialType === 'text') {
                                                                    contentData = { text: material.content };
                                                                } else {
                                                                    contentData = {};
                                                                }
                                                            }
                                                        } else {
                                                            contentData = material.content;
                                                        }
                                                    }
                                                    if (!contentData || Object.keys(contentData).length === 0) {
                                                        contentData = material.metadata || {};
                                                    }
                                                    
                                                    // Populate based on material type
                                                    switch (materialType) {
                                                        case 'text':
                                                            const textArea = fieldsContainer.querySelector('textarea');
                                                            if (textArea) textArea.value = typeof material.content === 'string' ? material.content : (contentData.text || contentData.content || '');
                                                            break;
                                                        case 'video':
                                                            const videoDuration = fieldsContainer.querySelector('.content-duration');
                                                            const videoDesc = fieldsContainer.querySelector('.content-description');
                                                            if (videoDuration) videoDuration.value = contentData.duration || '';
                                                            if (videoDesc) videoDesc.value = contentData.description || '';
                                                            break;
                                                        case 'audio':
                                                            const audioDuration = fieldsContainer.querySelector('.content-duration');
                                                            const transcript = fieldsContainer.querySelector('.content-transcript');
                                                            if (audioDuration) audioDuration.value = contentData.duration || '';
                                                            if (transcript) transcript.value = contentData.transcript || '';
                                                            break;
                                                        case 'pdf':
                                                            const pages = fieldsContainer.querySelector('.content-pages');
                                                            const synonym = fieldsContainer.querySelector('.content-synonym');
                                                            const instructions = fieldsContainer.querySelector('.content-instructions');
                                                            if (pages) pages.value = contentData.page_range || '';
                                                            if (synonym) synonym.value = contentData.synonym || '';
                                                            if (instructions) instructions.value = contentData.instructions || '';
                                                            
                                                            // Hydrate PDF highlights table from database
                                                            try {
                                                                // First try to load from metadata (for backward compatibility)
                                                                const metadataHighlights = Array.isArray(material.metadata?.highlights) ? material.metadata.highlights : (Array.isArray(contentData.highlights) ? contentData.highlights : []);
                                                                
                                                                if (metadataHighlights && metadataHighlights.length) {
                                                                    console.log('Loading highlights from metadata:', metadataHighlights.length);
                                                                    metadataHighlights.forEach(h => appendPdfHighlightRowWithValues(lastContentItem, h));
                                                                } else {
                                                                    // If no metadata highlights, try to fetch from database
                                                                    const pdfUrl = material.url || material.file_url;
                                                                    if (pdfUrl && courseId) {
                                                                        console.log('No metadata highlights found, fetching from database for PDF:', pdfUrl);
                                                                        // Use setTimeout to ensure the content item is fully rendered
                                                                        setTimeout(async () => {
                                                                            await populatePdfHighlightsTable(lastContentItem, courseId, pdfUrl);
                                                                        }, 100);
                                                                    }
                                                                }
                                                            } catch (e) {
                                                                console.warn('Error loading PDF highlights:', e);
                                                            }
                                                            break;
                                                        case 'quiz':
                                                            const quizTitle = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                            const questions = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                            if (quizTitle) quizTitle.value = contentData.title || '';
                                                            if (questions) questions.value = contentData.questions || '';
                                                            break;
                                                        case 'image':
                                                            const altInput = fieldsContainer.querySelector('.content-alt');
                                                            const captionInput = fieldsContainer.querySelector('.content-caption');
                                                            if (altInput) altInput.value = contentData.alt_text || '';
                                                            if (captionInput) captionInput.value = contentData.caption || '';
                                                            // Show preview of existing image using stored URL or generate if missing
                                            let imageUrl2 = material.url;
                                            if (!imageUrl2 && material.path) {
                                                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                                                const { data: { publicUrl } } = client.storage
                                                    .from('course-materials')
                                                    .getPublicUrl(material.path);
                                                imageUrl2 = publicUrl;
                                                material.url = publicUrl;
                                            }
                                            if (imageUrl2) {
                                                let preview = fieldsContainer.querySelector('.image-loaded-preview');
                                                if (!preview) {
                                                    preview = document.createElement('div');
                                                    preview.className = 'image-loaded-preview mt-2';
                                                    preview.innerHTML = `<img class=\"max-h-40 rounded border\" alt=\"Image preview\" loading=\"lazy\" decoding=\"async\" referrerpolicy=\"no-referrer\" crossorigin=\"anonymous\" fetchpriority=\"low\" onerror=\"this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22160%22><rect width=%22240%22 height=%22160%22 fill=%23f3f4f6/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%236b7280%22>Image unavailable</text></svg>';\">`;
                                                    fieldsContainer.appendChild(preview);
                                                }
                                                const imgEl = preview.querySelector('img');
                                                if (imgEl) imgEl.src = imageUrl2;
                                            }
                                                            break;
                                                    }
                                                }
                                            }, 200);
                                        }
                                    }
                                }, 100);
                            }
                        });
                    }
                }

                // small delay to allow nested timeouts to finish updating the DOM before returning
                await new Promise(resolve => setTimeout(resolve, 350));
                return true;
            } catch (error) {
                console.error('Error loading lesson materials:', error);
            }
        }

        // Assignment management functions
        function editAssignment(assignmentId) {
            console.log('Editing assignment:', assignmentId);
            // TODO: Implement assignment editing functionality
            createToast({ type: 'info', message: 'Assignment editing functionality will be implemented soon.' });
        }

        async function deleteAssignment(assignmentId) {
            console.log(' Delete assignment called with ID:', assignmentId);
            
            if (!confirm('Are you sure you want to delete this assignment?')) {
                console.log(' User cancelled assignment deletion');
                return;
            }
            
            console.log(' User confirmed deletion, proceeding...');
            
            try {
                // Use admin client for delete operations to bypass RLS
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'Admin' : 'Regular');
                
                const { data, error } = await client
                    .from('assignments')
                    .delete()
                    .eq('id', assignmentId);
                
                console.log(' Delete operation result:', { data, error });
                
                if (error) {
                    console.error(' Supabase delete error:', error);
                    throw error;
                }
                
                console.log(' Assignment deleted successfully, reloading assignments...');
                await loadAssignments();
                updateLastUpdated();
                console.log(' Assignment list reloaded');
            } catch (error) {
                console.error(' Error deleting assignment:', error);
                showError(`Failed to delete assignment: ${error.message}`);
            }
        }

        // File Management Functions
        let currentFiles = [];
        let storageStats = {};

        // Show files tab
        async function showFilesTab() {
            showTab('files');
            await loadFiles();
            await loadStorageStats();
        }

        // Verify uploaded files in lessons
        async function verifyLessonFiles() {
            try {
                // Get course name from DOM
                let courseName = '';
                const courseTitleInput = document.getElementById('courseTitle') || document.querySelector('input[name="title"]');
                if (courseTitleInput && courseTitleInput.value) {
                    courseName = courseTitleInput.value.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
                } else {
                    showError('Please enter a course title first');
                    return;
                }

                // Get all lessons from the current course
                const lessons = document.querySelectorAll('.lesson-item');
                const verificationResults = [];

                for (let i = 0; i < lessons.length; i++) {
                    const lessonNumber = i + 1;
                    const lessonPath = `${courseName}/lesson_${lessonNumber}`;
                    
                    try {
                        // List files in this lesson folder
                        const { data: files, error } = await supabase.storage
                            .from('course-materials')
                            .list(lessonPath, {
                                limit: 100,
                                offset: 0
                            });

                        if (error) {
                            console.warn(`Error accessing lesson ${lessonNumber}:`, error);
                            verificationResults.push({
                                lessonNumber,
                                lessonPath,
                                files: [],
                                error: error.message
                            });
                            continue;
                        }

                        // Get public URLs for each file
                        const filesWithUrls = [];
                        if (files && files.length > 0) {
                            for (const file of files) {
                                if (file.name && !file.name.includes('.emptyFolderPlaceholder')) {
                                    const { data: { publicUrl } } = supabase.storage
                                        .from('course-materials')
                                        .getPublicUrl(`${lessonPath}/${file.name}`);
                                    
                                    filesWithUrls.push({
                                        name: file.name,
                                        url: publicUrl,
                                        size: file.metadata?.size || 0,
                                        created: file.created_at || file.updated_at
                                    });
                                }
                            }
                        }

                        verificationResults.push({
                            lessonNumber,
                            lessonPath,
                            files: filesWithUrls,
                            error: null
                        });

                    } catch (lessonError) {
                        console.error(`Error checking lesson ${lessonNumber}:`, lessonError);
                        verificationResults.push({
                            lessonNumber,
                            lessonPath,
                            files: [],
                            error: lessonError.message
                        });
                    }
                }

                // Display verification results
                displayVerificationResults(courseName, verificationResults);
                
            } catch (error) {
                console.error('Error verifying lesson files:', error);
                showError('Failed to verify lesson files: ' + error.message);
            }
        }

        // Display verification results
        function displayVerificationResults(courseName, results) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i data-lucide="folder-check" class="w-5 h-5 inline mr-2"></i>
                            File Verification - ${courseName.replace(/_/g, ' ').toUpperCase()}
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[70vh]">
                        ${results.map(result => `
                            <div class="mb-6 border border-gray-200 rounded-lg">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                    <h4 class="font-medium text-gray-900">
                                        <i data-lucide="book-open" class="w-4 h-4 inline mr-2"></i>
                                        Lesson ${result.lessonNumber}
                                    </h4>
                                    <p class="text-sm text-gray-600 mt-1">Storage Path: ${result.lessonPath}</p>
                                </div>
                                <div class="p-4">
                                    ${result.error ? `
                                        <div class="text-red-600 text-sm">
                                            <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                                            Error: ${result.error}
                                        </div>
                                    ` : ''}
                                    ${result.files.length === 0 ? `
                                        <div class="text-gray-500 text-sm">
                                            <i data-lucide="folder-open" class="w-4 h-4 inline mr-1"></i>
                                            No files found in this lesson
                                        </div>
                                    ` : `
                                        <div class="space-y-2">
                                            ${result.files.map(file => `
                                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                    <div class="flex items-center">
                                                        <i data-lucide="${getFileIcon(file.name)}" class="w-4 h-4 text-gray-400 mr-2"></i>
                                                        <span class="text-sm font-medium text-gray-900">${file.name}</span>
                                                        <span class="text-xs text-gray-500 ml-2">(${formatFileSize(file.size)})</span>
                                                    </div>
                                                    <a href="${file.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                                        <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>
                                                        View
                                                    </a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end p-6 border-t border-gray-200">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // Load files from Supabase Storage
        async function loadFiles() {
            try {
                const buckets = ['course-files', 'assignment-files', 'general-files', 'images', 'documents'];
                currentFiles = [];

                for (const bucket of buckets) {
                    try {
                        const { data: files, error } = await supabase.storage
                            .from(bucket)
                            .list('', {
                                limit: 100,
                                offset: 0
                            });

                        if (!error && files) {
                            for (const file of files) {
                                const { data: { publicUrl } } = supabase.storage
                                    .from(bucket)
                                    .getPublicUrl(file.name);

                                const fileRecord = {
                                    ...file,
                                    bucket: bucket,
                                    category: bucket.replace('-files', '').replace('-', ' '),
                                    url: publicUrl
                                };
                                currentFiles.push(fileRecord);

                                try {
                                    await supabase.from('documents').upsert({
                                        name: file.name.split('/').pop(),
                                        path: file.name,
                                        bucket: bucket,
                                        url: publicUrl
                                    }, { onConflict: 'path' });
                                } catch (dbError) {
                                    console.error('Error updating file URL:', dbError);
                                }
                            }
                        }
                    } catch (bucketError) {
                        console.warn(`Bucket ${bucket} not accessible:`, bucketError);
                    }
                }

                displayFiles(currentFiles);
            } catch (error) {
                console.error('Error loading files:', error);
                showError('Failed to load files');
            }
        }

        // Display files in the table
        function displayFiles(files) {
            const tableBody = document.getElementById('files-table-body');
            if (!tableBody) return;

            if (files.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i data-lucide="folder-open" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p>No files found</p>
                            <button onclick="openFileUploadModal()" class="mt-2 text-blue-600 hover:text-blue-800">Upload your first file</button>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            tableBody.innerHTML = files.map(file => {
                const fileSize = formatFileSize(file.metadata?.size || 0);
                const fileType = getFileType(file.name);
                const uploadDate = new Date(file.created_at || file.updated_at).toLocaleDateString();

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-lucide="${getFileIcon(file.name)}" class="w-5 h-5 text-gray-400 mr-3"></i>
                                <span class="text-sm font-medium text-gray-900">${file.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileSize}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${uploadDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="downloadFile('${file.bucket}', '${file.name}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteFile('${file.bucket}', '${file.name}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        // Load storage statistics
        async function loadStorageStats() {
            try {
                const buckets = ['course-files', 'assignment-files', 'general-files', 'images', 'documents'];
                let totalFiles = 0;
                let totalSize = 0;

                for (const bucket of buckets) {
                    try {
                        const { data: files, error } = await supabase.storage
                            .from(bucket)
                            .list('', { limit: 1000 });

                        if (!error && files) {
                            totalFiles += files.length;
                            totalSize += files.reduce((sum, file) => sum + (file.metadata?.size || 0), 0);
                        }
                    } catch (bucketError) {
                        console.warn(`Bucket ${bucket} not accessible:`, bucketError);
                    }
                }

                storageStats = { totalFiles, totalSize };
                displayStorageStats();
            } catch (error) {
                console.error('Error loading storage stats:', error);
            }
        }

        // Display storage statistics
        function displayStorageStats() {
            const statsContainer = document.getElementById('storage-stats');
            if (!statsContainer) return;

            const totalSizeFormatted = formatFileSize(storageStats.totalSize || 0);
            const maxStorage = '1 GB'; // Default limit
            const usagePercentage = Math.min((storageStats.totalSize || 0) / (1024 * 1024 * 1024) * 100, 100);

            statsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="files" class="w-8 h-8 text-blue-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Total Files</p>
                                <p class="text-2xl font-bold text-gray-900">${storageStats.totalFiles || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="hard-drive" class="w-8 h-8 text-green-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Storage Used</p>
                                <p class="text-2xl font-bold text-gray-900">${totalSizeFormatted}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="database" class="w-8 h-8 text-purple-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Storage Limit</p>
                                <p class="text-2xl font-bold text-gray-900">${maxStorage}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600">Storage Usage</span>
                        <span class="text-sm text-gray-600">${usagePercentage.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${usagePercentage}%"></div>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // File upload modal functions
        function openFileUploadModal() {
            document.getElementById('fileUploadModal').classList.remove('hidden');
        }
        window.openFileUploadModal = window.openFileUploadModal || openFileUploadModal;
        window.showUploadModal = window.showUploadModal || openFileUploadModal;

        function closeFileUploadModal() {
            document.getElementById('fileUploadModal').classList.add('hidden');
            document.getElementById('fileUploadForm').reset();
            document.getElementById('uploadProgress').classList.add('hidden');
        }
        window.closeFileUploadModal = window.closeFileUploadModal || closeFileUploadModal;

        // Handle file upload
        async function handleFileUpload(event) {
            event.preventDefault();
            if (handleFileUpload.uploading) return;
            handleFileUpload.uploading = true;

            const formData = new FormData(event.target);
            const category = formData.get('category');
            const files = document.getElementById('fileInput').files;
            const description = formData.get('description');

            if (!files || files.length === 0) {
                showError('Please select at least one file');
                handleFileUpload.uploading = false;
                return;
            }

            if (!category) {
                showError('Please select a file category');
                handleFileUpload.uploading = false;
                return;
            }

            try {
                // Show progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const uploadButton = document.getElementById('uploadButton');
                uploadButton.disabled = true;

                // Determine bucket name
                const bucketName = category === 'general' ? 'general-files' :
                                 category === 'courses' ? 'course-files' :
                                 category === 'assignments' ? 'assignment-files' :
                                 category === 'images' ? 'images' :
                                 category === 'documents' ? 'documents' : 'general-files';

                // Ensure target bucket exists
                await supabaseStorageService.ensureBucket(bucketName);

                // Upload files one by one
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const contentType = file.name.toLowerCase().endsWith('.pdf') ? 'application/pdf' : file.type;

                    progressText.textContent = `Uploading ${file.name} (${i + 1}/${files.length})...`;
                    progressBar.style.width = `${((i + 0.5) / files.length) * 100}%`;

                    try {
                        const result = await supabaseStorageService.uploadFile(file, bucketName, '', { contentType });

                        if (contentType === 'application/pdf') {
                            try {
                                await supabase.from('documents').insert({
                                    name: file.name,
                                    path: result.path,
                                    bucket: bucketName
                                });
                            } catch (dbError) {
                                console.error('Error storing file path:', dbError);
                            }
                        }

                        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                    } catch (error) {
                        throw new Error(`Failed to upload ${file.name}: ${error.message}`);
                    }
                }

                progressText.textContent = 'Upload completed!';

                // Close modal and refresh files
                setTimeout(() => {
                    closeFileUploadModal();
                    loadFiles();
                    loadStorageStats();
                }, 1000);

            } catch (error) {
                console.error('Error uploading files:', error);
                showError('Failed to upload files: ' + error.message);
            } finally {
                document.getElementById('uploadButton').disabled = false;
                handleFileUpload.uploading = false;
            }
        }

        // Download file
        async function downloadFile(bucket, fileName) {
            try {
                const { data, error } = await supabase.storage
                    .from(bucket)
                    .download(fileName);

                if (error) throw error;

                // Create download link
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.split('_').slice(1).join('_'); // Remove timestamp prefix
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error downloading file:', error);
                showError('Failed to download file');
            }
        }

        // Delete file
        async function deleteFile(bucket, fileName) {
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }

            try {
                const { error } = await supabase.storage
                    .from(bucket)
                    .remove([fileName]);

                if (error) throw error;

                await loadFiles();
                await loadStorageStats();

            } catch (error) {
                console.error('Error deleting file:', error);
                showError('Failed to delete file');
            }
        }
        window.deleteFile = window.deleteFile || deleteFile;

        // Filter files
        function filterFiles() {
            const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filteredFiles = currentFiles.filter(file => {
                const matchesSearch = file.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || file.category.includes(categoryFilter);
                const matchesType = !typeFilter || getFileType(file.name).toLowerCase().includes(typeFilter.toLowerCase());

                return matchesSearch && matchesCategory && matchesType;
            });

            displayFiles(filteredFiles);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const types = {
                'pdf': 'PDF Document',
                'doc': 'Word Document',
                'docx': 'Word Document',
                'txt': 'Text File',
                'jpg': 'Image',
                'jpeg': 'Image',
                'png': 'Image',
                'gif': 'Image',
                'mp3': 'Audio',
                'mp4': 'Video',
                'zip': 'Archive'
            };
            return types[extension] || 'Unknown';
        }

        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'file-text',
                'doc': 'file-text',
                'docx': 'file-text',
                'txt': 'file-text',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'mp3': 'music',
                'mp4': 'video',
                'zip': 'archive'
            };
            return icons[extension] || 'file';
        }

        // ===== CEFR ASSESSMENT FUNCTIONS =====

        // Show CEFR Assessments tab
        function showAssessmentsTab() {
            showTab('assessments');
            loadAssessmentStats();
            loadAssessmentQuestions();
        }

        // Show assessment sub-tabs
        function showAssessmentSubTab(tabName) {
            // Hide all sub-tab contents
            document.querySelectorAll('.assessment-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all sub-tab buttons
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                if (tab.id.includes('assessment-')) {
                    tab.classList.remove('border-blue-500', 'text-blue-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                }
            });
            
            // Show selected sub-tab content
            document.getElementById(`assessment-${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected sub-tab button
            const activeTab = document.getElementById(`assessment-${tabName}-tab`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Load specific content based on tab
            if (tabName === 'analytics') {
                loadAssessmentAnalytics();
            } else if (tabName === 'settings') {
                loadAssessmentSettings();
            }
        }

        // Load assessment statistics
        async function loadAssessmentStats() {
            try {
                // Mock data for demonstration
                const stats = {
                    totalAssessments: 15,
                    studentsAssessed: 127,
                    avgCefrLevel: 'B1',
                    completionRate: '87%'
                };
                
                if (window.updateKpiValue) {
                    updateKpiValue('total-assessments', stats.totalAssessments);
                    updateKpiValue('students-assessed', stats.studentsAssessed);
                    updateKpiValue('avg-cefr-level', stats.avgCefrLevel);
                    updateKpiValue('completion-rate', stats.completionRate);
                } else {
                    document.getElementById('total-assessments').textContent = stats.totalAssessments;
                    document.getElementById('students-assessed').textContent = stats.studentsAssessed;
                    document.getElementById('avg-cefr-level').textContent = stats.avgCefrLevel;
                    document.getElementById('completion-rate').textContent = stats.completionRate;
                }
                
            } catch (error) {
                console.error('Error loading assessment stats:', error);
            }
        }

        // Load assessment questions
        async function loadAssessmentQuestions() {
            try {
                console.log('Loading CEFR assessment questions from database...');
                
                const { data: questions, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .select(`
                        id,
                        question_type,
                        cefr_level,
                        skill_type,
                        question_text,
                        instructions,
                        options,
                        correct_answer,
                        points,
                        difficulty_level,
                        is_active,
                        created_at,
                        updated_at
                    `)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`Database error: ${error.message}`);
                }
                
                // Transform data to match expected format
                const transformedQuestions = (questions || []).map(q => ({
                    id: q.id,
                    questionText: q.question_text,
                    questionType: q.question_type,
                    cefrLevel: q.cefr_level,
                    skillType: q.skill_type,
                    instructions: q.instructions,
                    options: q.options,
                    correctAnswer: q.correct_answer,
                    points: q.points,
                    difficultyLevel: q.difficulty_level,
                    createdAt: q.created_at,
                    updatedAt: q.updated_at
                }));
                
                displayAssessmentQuestions(transformedQuestions);
                
            } catch (error) {
                console.error('Error loading assessment questions:', error);
                showError('Failed to load assessment questions: ' + error.message);
                displayAssessmentQuestions([]);
            }
        }

        // Display assessment questions
        function displayAssessmentQuestions(questions) {
            const container = document.getElementById('assessment-questions-list');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No assessment questions found</h3>
                        <p class="text-gray-500 mb-4">Create your first CEFR assessment question to get started.</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showCreateAssessmentQuestionModal()">
                            Create Question
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = questions.map(question => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${question.cefrLevel}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ${question.skillType}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    ${question.questionType.replace('_', ' ')}
                                </span>
                                <span class="text-xs text-gray-500">${question.points} pts</span>
                            </div>
                            <h4 class="text-md font-semibold text-gray-900 mb-2">${question.questionText}</h4>
                            <p class="text-sm text-gray-500">Created: ${new Date(question.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button class="text-blue-600 hover:text-blue-800 p-1" onclick="editAssessmentQuestion('${question.id}')" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800 p-1" onclick="deleteAssessmentQuestion('${question.id}')" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // Filter assessment questions
        function filterAssessmentQuestions() {
            const cefrLevel = document.getElementById('cefr-level-filter').value;
            const skillType = document.getElementById('skill-type-filter').value;
            const questionType = document.getElementById('question-type-filter').value;
            
            // In a real implementation, this would filter the actual data
            loadAssessmentQuestions();
        }

        // Show create assessment question modal
        function showCreateAssessmentQuestionModal() {
            document.getElementById('assessmentQuestionModal').classList.remove('hidden');
            resetAssessmentQuestionForm();
        }
        window.showCreateAssessmentQuestionModal = window.showCreateAssessmentQuestionModal || showCreateAssessmentQuestionModal;

        // Close assessment question modal
        function closeAssessmentQuestionModal() {
            document.getElementById('assessmentQuestionModal').classList.add('hidden');
            resetAssessmentQuestionForm();
            
            // Clear editing state
            const form = document.getElementById('assessmentQuestionForm');
            form.removeAttribute('data-editing-id');
            
            // Reset modal title
            document.querySelector('#assessmentQuestionModal h3').textContent = 'Create CEFR Assessment Question';
        }
        window.closeAssessmentQuestionModal = window.closeAssessmentQuestionModal || closeAssessmentQuestionModal;

        // Reset assessment question form
        function resetAssessmentQuestionForm() {
            document.getElementById('assessmentQuestionForm').reset();
            document.getElementById('answerOptionsContainer').innerHTML = '';
            
            // Reset media previews
            ['image', 'audio', 'video', 'pdf'].forEach(type => {
                document.getElementById(`${type}Preview`).classList.add('hidden');
            });
        }

        // Update question type fields
        function updateQuestionTypeFields() {
            const questionType = document.getElementById('questionType').value;
            const container = document.getElementById('answerOptionsContainer');
            
            switch (questionType) {
                case 'multiple-choice':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="0" id="option0" required>
                                <input type="text" name="option" placeholder="Option A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="1" id="option1">
                                <input type="text" name="option" placeholder="Option B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="2" id="option2">
                                <input type="text" name="option" placeholder="Option C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="3" id="option3">
                                <input type="text" name="option" placeholder="Option D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <p class="text-xs text-gray-500">Select the correct answer by clicking the radio button</p>
                        </div>
                    `;
                    break;
                    
                case 'true-false':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="tfCorrectAnswer" value="true" class="mr-2" required>
                                    <span>True</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="tfCorrectAnswer" value="false" class="mr-2">
                                    <span>False</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">Select the correct answer</p>
                        </div>
                    `;
                    break;
                    
                case 'short-answer':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Expected Response</label>
                                <textarea id="shortAnswer" placeholder="Describe the expected response or key points..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'fill-in-blank':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer(s)</label>
                                <input type="text" id="fillBlankAnswer" placeholder="Enter the correct answer(s), separated by commas" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <p class="text-xs text-gray-500">Use underscores (_____) in your question text to indicate blanks</p>
                        </div>
                    `;
                    break;
                    
                case 'essay':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Grading Rubric</label>
                                <textarea id="essayRubric" placeholder="Describe the grading criteria and key points to look for..." rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Word Limit</label>
                                <input type="number" id="wordLimit" placeholder="Maximum words (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg" min="50" max="1000">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'listening':
                case 'speaking':
                case 'reading':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Expected Response</label>
                                <textarea id="expectedResponse" placeholder="Describe the expected response or key points..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Criteria</label>
                                <textarea id="assessmentCriteria" placeholder="Describe how this will be assessed..." rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    container.innerHTML = '<p class="text-gray-500">Select a question type to configure answer options</p>';
            }
        }

        // Preview media files
        function previewMedia(type) {
            const input = document.getElementById(`question${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const preview = document.getElementById(`${type}Preview`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                switch (type) {
                    case 'image':
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('imagePreviewImg').src = e.target.result;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        break;
                        
                    case 'audio':
                        const audioUrl = URL.createObjectURL(file);
                        document.getElementById('audioPreviewSource').src = audioUrl;
                        document.getElementById('audioPreviewPlayer').load();
                        preview.classList.remove('hidden');
                        break;
                        
                    case 'video':
                        const videoUrl = URL.createObjectURL(file);
                        document.getElementById('videoPreviewSource').src = videoUrl;
                        document.getElementById('videoPreviewPlayer').load();
                        preview.classList.remove('hidden');
                        break;
                        
                    case 'pdf':
                        document.getElementById('pdfFileName').textContent = file.name;
                        preview.classList.remove('hidden');
                        break;
                }
            }
        }

        // Remove media files
        function removeMedia(type) {
            document.getElementById(`question${type.charAt(0).toUpperCase() + type.slice(1)}`).value = '';
            document.getElementById(`${type}Preview`).classList.add('hidden');
        }
        window.removeMedia = window.removeMedia || removeMedia;

        // Handle assessment question form submission
        async function handleAssessmentQuestionSubmit(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const editingId = event.target.getAttribute('data-editing-id');
                const isEditing = editingId !== null;
                
                // Collect form data
                const questionData = {
                    questionType: formData.get('questionType'),
                    cefrLevel: formData.get('cefrLevel'),
                    skillType: formData.get('skillType'),
                    questionText: formData.get('questionText'),
                    instructions: formData.get('questionInstructions'),
                    points: parseInt(formData.get('questionPoints'))
                };
                
                // Validate required fields
                if (!questionData.questionType || !questionData.cefrLevel || !questionData.skillType || !questionData.questionText) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                // Collect answer options based on question type
                if (questionData.questionType === 'multiple-choice') {
                    const options = [];
                    const optionInputs = document.querySelectorAll('input[name="option"]');
                    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
                    
                    optionInputs.forEach(input => {
                        if (input.value.trim()) {
                            options.push(input.value.trim());
                        }
                    });
                    
                    questionData.options = options;
                    questionData.correctAnswer = correctAnswerRadio ? parseInt(correctAnswerRadio.value) : null;
                } else if (questionData.questionType === 'true-false') {
                    const tfCorrectAnswer = document.querySelector('input[name="tfCorrectAnswer"]:checked');
                    questionData.options = ['True', 'False'];
                    questionData.correctAnswer = tfCorrectAnswer ? tfCorrectAnswer.value : null;
                } else if (questionData.questionType === 'short-answer') {
                    const shortAnswer = document.getElementById('shortAnswer');
                    questionData.expectedResponse = shortAnswer ? shortAnswer.value : null;
                } else if (questionData.questionType === 'fill-in-blank') {
                    const fillBlankAnswer = document.getElementById('fillBlankAnswer');
                    questionData.correctAnswer = fillBlankAnswer ? fillBlankAnswer.value : null;
                } else if (questionData.questionType === 'essay') {
                    const essayRubric = document.getElementById('essayRubric');
                    const wordLimit = document.getElementById('wordLimit');
                    questionData.expectedResponse = essayRubric ? essayRubric.value : null;
                    questionData.wordLimit = wordLimit ? parseInt(wordLimit.value) : null;
                } else if (['listening', 'speaking', 'reading'].includes(questionData.questionType)) {
                    const expectedResponse = document.getElementById('expectedResponse');
                    const assessmentCriteria = document.getElementById('assessmentCriteria');
                    questionData.expectedResponse = expectedResponse ? expectedResponse.value : null;
                    questionData.assessmentCriteria = assessmentCriteria ? assessmentCriteria.value : null;
                }
                
                console.log(isEditing ? 'Updating assessment question:' : 'Creating assessment question:', questionData);
                
                if (isEditing) {
                    // Update existing question
                    const updateData = {
                        question_type: questionData.questionType,
                        cefr_level: questionData.cefrLevel,
                        skill_type: questionData.skillType,
                        question_text: questionData.questionText,
                        instructions: questionData.instructions,
                        points: questionData.points,
                        options: questionData.options || null,
                        correct_answer: questionData.correctAnswer || null,
                        expected_response: questionData.expectedResponse || null,
                        updated_at: new Date().toISOString()
                    };
                    
                    // Add additional fields if they exist
                    if (questionData.wordLimit) {
                        updateData.word_limit = questionData.wordLimit;
                    }
                    if (questionData.assessmentCriteria) {
                        updateData.assessment_criteria = questionData.assessmentCriteria;
                    }
                    
                    // Update the question in the database
                    const { data, error } = await supabaseAdmin.from('cefr_assessment_questions').update({
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                UPDATE cefr_assessment_questions 
                                SET 
                                    question_type = '${updateData.question_type}',
                                    cefr_level = '${updateData.cefr_level}',
                                    skill_type = '${updateData.skill_type}',
                                    question_text = '${updateData.question_text.replace(/'/g, "''")}',
                                    instructions = '${updateData.instructions ? updateData.instructions.replace(/'/g, "''") : ''}',
                                    points = ${updateData.points},
                                    options = ${updateData.options ? `'${JSON.stringify(updateData.options).replace(/'/g, "''")}'` : 'NULL'},
                                    correct_answer = ${updateData.correct_answer !== null ? `'${updateData.correct_answer}'` : 'NULL'},
                                    expected_response = ${updateData.expected_response ? `'${updateData.expected_response.replace(/'/g, "''")}'` : 'NULL'},
                                    ${updateData.word_limit ? `word_limit = ${updateData.word_limit},` : ''}
                                    ${updateData.assessment_criteria ? `assessment_criteria = '${updateData.assessment_criteria.replace(/'/g, "''")}',` : ''}
                                    updated_at = NOW()
                                WHERE id = '${editingId}'
                            `
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log(' Assessment question updated successfully:', updateData);
                    
                    // Show success message
                    showSuccess('Assessment question updated successfully!');
                    
                } else {
                    // Create new question
                    const insertData = {
                        question_type: questionData.questionType,
                        cefr_level: questionData.cefrLevel,
                        skill_type: questionData.skillType,
                        question_text: questionData.questionText,
                        instructions: questionData.instructions,
                        points: questionData.points,
                        options: questionData.options || null,
                        correct_answer: questionData.correctAnswer || null,
                        expected_response: questionData.expectedResponse || null,
                        difficulty_level: 'medium',
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Add additional fields if they exist
                    if (questionData.wordLimit) {
                        insertData.word_limit = questionData.wordLimit;
                    }
                    if (questionData.assessmentCriteria) {
                        insertData.assessment_criteria = questionData.assessmentCriteria;
                    }
                    
                    // Create the question in the database
                    const { data, error } = await supabaseAdmin.from('cefr_assessment_questions').insert([insertData]).select();
                    
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    // Legacy compatibility - create response-like object
                    const response = { ok: true };
                    const result = { data };
                    
                    /*const response = await fetch('/api/supabase', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                INSERT INTO cefr_assessment_questions (
                                    question_type, cefr_level, skill_type, question_text, instructions, 
                                    points, options, correct_answer, expected_response, difficulty_level, 
                                    is_active, created_at, updated_at
                                    ${insertData.word_limit ? ', word_limit' : ''}
                                    ${insertData.assessment_criteria ? ', assessment_criteria' : ''}
                                ) VALUES (
                                    '${insertData.question_type}',
                                    '${insertData.cefr_level}',
                                    '${insertData.skill_type}',
                                    '${insertData.question_text.replace(/'/g, "''")}',
                                    '${insertData.instructions ? insertData.instructions.replace(/'/g, "''") : ''}',
                                    ${insertData.points},
                                    ${insertData.options ? `'${JSON.stringify(insertData.options).replace(/'/g, "''")}'` : 'NULL'},
                                    ${insertData.correct_answer !== null ? `'${insertData.correct_answer}'` : 'NULL'},
                                    ${insertData.expected_response ? `'${insertData.expected_response.replace(/'/g, "''")}'` : 'NULL'},
                                    '${insertData.difficulty_level}',
                                    ${insertData.is_active},
                                    NOW(),
                                    NOW()
                                    ${insertData.word_limit ? `, ${insertData.word_limit}` : ''}
                                    ${insertData.assessment_criteria ? `, '${insertData.assessment_criteria.replace(/'/g, "''")}'` : ''}
                                )
                                RETURNING *
                            `
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log(' Assessment question created successfully:', result.data);
                    
                    // Show success message
                    showSuccess('Assessment question created successfully!');
                */
                }
                
                // Close modal and refresh list
                closeAssessmentQuestionModal();
                loadAssessmentQuestions();
                
            } catch (error) {
                const action = event.target.getAttribute('data-editing-id') ? 'updating' : 'creating';
                console.error(`Error ${action} assessment question:`, error);
                showError(`Failed to ${action.replace('ing', 'e')} assessment question: ${error.message}`);
            }
        }

        // Load assessment analytics
        function loadAssessmentAnalytics() {
            // Mock data for student performance
            const studentPerformance = [
                {
                    id: 1,
                    name: 'John Doe',
                    email: 'john.doe@example.com',
                    cefrLevel: 'B1',
                    reading: 75,
                    writing: 68,
                    listening: 82,
                    speaking: 71,
                    lastAssessment: '2024-01-20'
                },
                {
                    id: 2,
                    name: 'Maria Garcia',
                    email: 'maria.garcia@example.com',
                    cefrLevel: 'A2',
                    reading: 65,
                    writing: 58,
                    listening: 72,
                    speaking: 61,
                    lastAssessment: '2024-01-18'
                }
            ];
            
            const tableBody = document.getElementById('student-performance-table');
            tableBody.innerHTML = studentPerformance.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div>
                            <div class="font-medium">${student.name}</div>
                            <div class="text-gray-500">${student.email}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${student.cefrLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.reading}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.writing}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.listening}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.speaking}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(student.lastAssessment).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewStudentDetails(${student.id})">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load assessment settings
        function loadAssessmentSettings() {
            // Settings are already pre-filled in the HTML
            console.log('Assessment settings loaded');
        }

        // Edit assessment question
        async function editAssessmentQuestion(questionId) {
            console.log('Editing question:', questionId);
            
            try {
                // Fetch question data from database
                const { data: questions, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .select(`
                        id,
                        question_type,
                        cefr_level,
                        skill_type,
                        question_text,
                        instructions,
                        options,
                        correct_answer,
                        points,
                        difficulty_level,
                        expected_response
                    `)
                    .eq('id', questionId)
                    .eq('is_active', true);
                
                if (error) {
                    throw new Error(error.message);
                }
                
                if (questions.length === 0) {
                    showError('Question not found');
                    return;
                }
                
                const question = questions[0];
                
                // Transform database data to match expected format
                const transformedQuestion = {
                    id: question.id,
                    questionText: question.question_text,
                    questionType: question.question_type,
                    cefrLevel: question.cefr_level,
                    skillType: question.skill_type,
                    instructions: question.instructions,
                    options: question.options ? JSON.parse(question.options) : [],
                    correctAnswer: question.correct_answer,
                    points: question.points,
                    expectedResponse: question.expected_response
                };
            
                // Open the modal
                document.getElementById('assessmentQuestionModal').classList.remove('hidden');
                
                // Update modal title
                document.querySelector('#assessmentQuestionModal h3').textContent = 'Edit CEFR Assessment Question';
                
                // Populate the form with existing data
                document.getElementById('questionType').value = transformedQuestion.questionType;
                document.getElementById('questionCefrLevel').value = transformedQuestion.cefrLevel;
                document.getElementById('skillType').value = transformedQuestion.skillType;
                document.getElementById('assessmentQuestionText').value = transformedQuestion.questionText;
                document.getElementById('questionInstructions').value = transformedQuestion.instructions || '';
                document.getElementById('questionPoints').value = transformedQuestion.points;
                
                // Update question type fields based on the question type
                updateQuestionTypeFields();
                
                // Populate answer options based on question type
                setTimeout(() => {
                    if (transformedQuestion.questionType === 'multiple-choice' && transformedQuestion.options) {
                        const optionInputs = document.querySelectorAll('input[name="option"]');
                        transformedQuestion.options.forEach((option, index) => {
                            if (optionInputs[index]) {
                                optionInputs[index].value = option;
                            }
                        });
                        
                        // Set correct answer - find the index of the correct answer
                        if (transformedQuestion.correctAnswer !== undefined) {
                            const correctIndex = transformedQuestion.options.indexOf(transformedQuestion.correctAnswer);
                            if (correctIndex !== -1) {
                                const correctRadio = document.querySelector(`input[name="correctAnswer"][value="${correctIndex}"]`);
                                if (correctRadio) {
                                    correctRadio.checked = true;
                                }
                            }
                        }
                    } else if (transformedQuestion.questionType === 'true-false' && transformedQuestion.correctAnswer !== undefined) {
                        const tfRadio = document.querySelector(`input[name="tfCorrectAnswer"][value="${transformedQuestion.correctAnswer}"]`);
                        if (tfRadio) {
                            tfRadio.checked = true;
                        }
                    } else if (transformedQuestion.questionType === 'short-answer' && transformedQuestion.expectedResponse) {
                        const shortAnswerInput = document.getElementById('shortAnswer');
                        if (shortAnswerInput) {
                            shortAnswerInput.value = transformedQuestion.expectedResponse;
                        }
                    } else if (transformedQuestion.questionType === 'fill-in-blank' && transformedQuestion.correctAnswer) {
                        const fillBlankInput = document.getElementById('fillBlankAnswer');
                        if (fillBlankInput) {
                            fillBlankInput.value = transformedQuestion.correctAnswer;
                        }
                    } else if (transformedQuestion.questionType === 'essay' && transformedQuestion.expectedResponse) {
                        const essayRubricInput = document.getElementById('essayRubric');
                        if (essayRubricInput) {
                            essayRubricInput.value = transformedQuestion.expectedResponse;
                        }
                    } else if (['listening', 'speaking', 'reading'].includes(transformedQuestion.questionType) && transformedQuestion.expectedResponse) {
                        const expectedResponseInput = document.getElementById('expectedResponse');
                        if (expectedResponseInput) {
                            expectedResponseInput.value = transformedQuestion.expectedResponse;
                        }
                    }
                }, 100); // Small delay to ensure DOM is updated
                
                // Store the question ID for updating
                document.getElementById('assessmentQuestionForm').setAttribute('data-editing-id', questionId);
                
            } catch (error) {
                console.error('Error loading question for editing:', error);
                showError('Failed to load question data: ' + error.message);
            }
        }
        window.editAssessmentQuestion = window.editAssessmentQuestion || editAssessmentQuestion;

        // Delete assessment question
        async function deleteAssessmentQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this assessment question?')) {
                return;
            }
            
            try {
                console.log('Deleting question:', questionId);
                
                const { data, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .update({ 
                        is_active: false, 
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', questionId);
                
                if (error) {
                    throw new Error(error.message);
                }
                
                showSuccess('Assessment question deleted successfully!');
                loadAssessmentQuestions();
                
            } catch (error) {
                console.error('Error deleting assessment question:', error);
                showError('Failed to delete assessment question: ' + error.message);
            }
        }
        window.deleteAssessmentQuestion = window.deleteAssessmentQuestion || deleteAssessmentQuestion;

        // View student details
        function viewStudentDetails(studentId) {
            console.log('Viewing student details:', studentId);
            // In a real implementation, this would open a detailed view of the student's assessment history
        }

        // ===== END CEFR ASSESSMENT FUNCTIONS =====

        // ===== COURSE MANAGEMENT FUNCTIONS =====

        // Course tab switching
        function switchCourseTab(tabName) {
            // Hide all course sub-tabs
            const tabs = ['course-overview', 'course-library', 'ai-creation', 'templates', 'version-control'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab + '-tab');
                if (element) element.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) selectedTab.classList.remove('hidden');
            
            // Update tab button styles
            document.querySelectorAll('.course-tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-white', 'text-gray-500', 'border-gray-300');
            });
            
            const activeBtn = document.querySelector(`[onclick="switchCourseTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-500', 'border-gray-300');
                activeBtn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        // Course grid management
        function toggleCourseSelection(courseId) {
            const checkbox = document.querySelector(`input[data-course-id="${courseId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateBulkOperationsVisibility();
            }
        }

        function selectAllCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            updateBulkOperationsVisibility();
        }

        function updateBulkOperationsVisibility() {
            const checkedBoxes = document.querySelectorAll('.course-checkbox:checked');
            const bulkToolbar = document.getElementById('bulk-operations-toolbar');
            
            if (checkedBoxes.length > 0) {
                bulkToolbar.classList.remove('hidden');
                document.getElementById('selected-count').textContent = checkedBoxes.length;
            } else {
                bulkToolbar.classList.add('hidden');
            }
        }

        // Bulk operations
        function bulkPublishCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Publish ${selectedCourses.length} selected courses?`)) {
                console.log('Publishing courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses published successfully!`);
                clearCourseSelection();
            }
        }

        function bulkArchiveCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Archive ${selectedCourses.length} selected courses?`)) {
                console.log('Archiving courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses archived successfully!`);
                clearCourseSelection();
            }
        }

        function bulkDeleteCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Delete ${selectedCourses.length} selected courses? This action cannot be undone.`)) {
                console.log('Deleting courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses deleted successfully!`);
                clearCourseSelection();
            }
        }

        function getSelectedCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.getAttribute('data-course-id'));
        }

        function clearCourseSelection() {
            document.querySelectorAll('.course-checkbox').forEach(cb => cb.checked = false);
            updateBulkOperationsVisibility();
        }

        // Course actions
        // editCourse function is implemented above (line ~3968)

        function duplicateCourse(courseId) {
            console.log('Duplicating course:', courseId);
            showSuccess('Course duplicated successfully!');
        }



        function viewCourseAnalytics(courseId) {
            console.log('Viewing analytics for course:', courseId);
            // Open analytics modal
        }

        // AI Course Generation
        function generateAICourse() {
            const topicElement = document.getElementById('ai-topic');
            const levelElement = document.getElementById('ai-level');
            const durationElement = document.getElementById('ai-duration');
            const focusElement = document.getElementById('ai-focus');
            
            if (!topicElement || !levelElement || !durationElement || !focusElement) {
                showError('AI course generation form fields not found');
                return;
            }
            
            const topic = topicElement.value;
            const level = levelElement.value;
            const duration = durationElement.value;
            const focus = focusElement.value;
            
            if (!topic || !level || !duration || !focus) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Show loading state
            const generateBtn = document.querySelector('button[onclick="generateAICourse()"]');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            // Simulate AI generation
            setTimeout(() => {
                console.log('Generating AI course:', { topic, level, duration, focus });
                showSuccess('AI course generated successfully!');
                
                // Reset button
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
                
                // Clear form
                document.getElementById('ai-course-form').reset();
            }, 3000);
        }

        function generateCurriculum() {
            const objectives = document.getElementById('curriculum-objectives').value;
            const level = document.getElementById('curriculum-level').value;
            const weeks = document.getElementById('curriculum-weeks').value;
            
            if (!objectives || !level || !weeks) {
                showError('Please fill in all required fields');
                return;
            }
            
            console.log('Generating curriculum:', { objectives, level, weeks });
            showSuccess('Curriculum generated successfully!');
        }

        function translateContent() {
            const sourceLanguage = document.getElementById('source-language').value;
            const targetLanguage = document.getElementById('target-language').value;
            const content = document.getElementById('content-to-translate').value;
            
            if (!sourceLanguage || !targetLanguage || !content) {
                showError('Please fill in all required fields');
                return;
            }
            
            console.log('Translating content:', { sourceLanguage, targetLanguage, content });
            showSuccess('Content translated successfully!');
        }

        function getContentRecommendations() {
            const courseType = document.getElementById('recommendation-course-type').value;
            const targetAudience = document.getElementById('recommendation-audience').value;
            
            if (!courseType || !targetAudience) {
                showError('Please select course type and target audience');
                return;
            }
            
            console.log('Getting recommendations:', { courseType, targetAudience });
            showSuccess('Content recommendations generated!');
        }

        // Template management
        function useTemplate(templateId) {
            console.log('Using template:', templateId);
            showSuccess('Template applied successfully!');
        }

        function editTemplate(templateId) {
            console.log('Editing template:', templateId);
            // Open template editor
        }

        function deleteTemplate(templateId) {
            if (confirm('Are you sure you want to delete this template?')) {
                console.log('Deleting template:', templateId);
                showSuccess('Template deleted successfully!');
            }
        }

        function createNewTemplate() {
            console.log('Creating new template');
            // Open template creation wizard
        }

        function importTemplate() {
            console.log('Importing template');
            // Open file picker
        }

        function exportTemplate(templateId) {
            console.log('Exporting template:', templateId);
            showSuccess('Template exported successfully!');
        }

        // Version control
        function viewVersion(versionId) {
            console.log('Viewing version:', versionId);
            // Open version viewer
        }

        function rollbackToVersion(versionId) {
            if (confirm('Are you sure you want to rollback to this version?')) {
                console.log('Rolling back to version:', versionId);
                showSuccess('Successfully rolled back to selected version!');
            }
        }

        function downloadVersion(versionId) {
            console.log('Downloading version:', versionId);
            showSuccess('Version downloaded successfully!');
        }

        function compareVersions() {
            console.log('Comparing versions');
            // Open version comparison tool
        }

        // Course library management
        function importCourse() {
            console.log('Importing course');
            // Open file picker
        }

        function exportCourse(courseId) {
            console.log('Exporting course:', courseId);
            showSuccess('Course exported successfully!');
        }

        function syncWithLibrary() {
            console.log('Syncing with library');
            showSuccess('Library synchronized successfully!');
        }

        // Show course sub-tab function
        function showCourseSubTab(tabName) {
            // 1) Hide ONLY the sub-tab contents (don't hide the nav buttons)
            document.querySelectorAll('.course-subtab-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('active');
            });

            // 2) Show the requested sub-tab content by its correct id pattern: course-${name}-content
            const targetContent = document.getElementById(`course-${tabName}-content`);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.classList.add('active');
            }

            // 3) Update sub-tab navigation button styles (border-based active state)
            const map = {
                overview: 'course-overview-tab',
                ai: 'course-ai-tab',
                templates: 'course-templates-tab',
                versions: 'course-versions-tab'
            };

            Object.entries(map).forEach(([name, id]) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                if (name === tabName) {
                    btn.classList.add('border-blue-500', 'text-blue-600');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                } else {
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                }
            });

            console.log('Switched to course sub-tab:', tabName);
        }

        // Initialize course management
        function initializeCourseManagement() {
            // Set default active sub-tab and ensure nav visible
            showCourseSubTab('overview');
            
            // Initialize event listeners
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('course-checkbox')) {
                    updateBulkOperationsVisibility();
                }
            });
            
            console.log('Course management initialized');
        }

        // ===== END COURSE MANAGEMENT FUNCTIONS =====
        
        // Image management functions for lesson materials
        async function toggleImageSourceFields(selectElement) {
            const contentItem = selectElement.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const fileInput = fieldsContainer.querySelector('.content-file');
            const existingSelect = fieldsContainer.querySelector('.existing-image-select');
            
            if (selectElement.value === 'existing') {
                fileInput.style.display = 'none';
                existingSelect.style.display = 'block';
                await populateExistingImages(existingSelect);
            } else {
                fileInput.style.display = 'block';
                existingSelect.style.display = 'none';
            }
        }
        window.toggleImageSourceFields = window.toggleImageSourceFields || toggleImageSourceFields;

        async function populateExistingImages(selectElement) {
            try {
                selectElement.innerHTML = '<option value="">Loading existing images...</option>';
                
                // Recursively list all files in course-materials bucket
                let allFiles = [];
                
                if (window.isElectron) {
                    // For Electron - assume it returns all files recursively
                    const result = await window.electronAPI.invoke('db:listFiles', 'course-materials');
                    if (result.success) {
                        allFiles = result.result;
                    }
                } else {
                    // For browser - need to recursively explore folders
                    const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                    allFiles = await listAllFilesRecursively(client, 'course-materials', '');
                }
                
                // Filter for image files
                const imageFiles = allFiles.filter(file => {
                    if (!file.name) return false;
                    const ext = file.name.toLowerCase().split('.').pop();
                    return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext);
                });
                
                // Clear loading option and populate with images
                selectElement.innerHTML = '<option value="">Select an existing image...</option>';
                
                if (imageFiles.length === 0) {
                    selectElement.innerHTML = '<option value="">No existing images found</option>';
                    return;
                }
                
                // Group images by path for better organization
                const groupedImages = {};
                imageFiles.forEach(file => {
                    const pathParts = file.name.split('/');
                    let groupKey = 'root';
                    
                    // Check if it's organized in folders (e.g., reading/lesson_1/, course_name/lesson_1/)
                    if (pathParts.length > 1) {
                        if (pathParts.length === 3) {
                            // Format: folder/lesson_x/filename
                            groupKey = `${pathParts[0]}/${pathParts[1]}`;
                        } else if (pathParts.length === 2) {
                            // Format: folder/filename
                            groupKey = pathParts[0];
                        }
                    }
                    
                    if (!groupedImages[groupKey]) {
                        groupedImages[groupKey] = [];
                    }
                    groupedImages[groupKey].push(file);
                });
                
                // Add grouped options
                Object.keys(groupedImages).sort().forEach(group => {
                    if (group !== 'root') {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = group.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        selectElement.appendChild(optgroup);
                        
                        groupedImages[group].forEach(file => {
                            const option = document.createElement('option');
                            const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                            const { data: { publicUrl } } = client.storage
                                .from('course-materials')
                                .getPublicUrl(file.name);
                            
                            option.value = publicUrl;
                            // Show just the filename for cleaner display
                            const fileName = file.name.split('/').pop();
                            option.textContent = fileName;
                            optgroup.appendChild(option);
                        });
                    }
                });
                
                // Add ungrouped files
                if (groupedImages['root']) {
                    groupedImages['root'].forEach(file => {
                        const option = document.createElement('option');
                        const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                        const { data: { publicUrl } } = client.storage
                            .from('course-materials')
                            .getPublicUrl(file.name);
                        
                        option.value = publicUrl;
                        option.textContent = file.name;
                        selectElement.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error loading existing images:', error);
                selectElement.innerHTML = '<option value="">Error loading images</option>';
            }
        }

        // Recursive helper function to list all files in a bucket
        async function listAllFilesRecursively(client, bucket, prefix = '') {
            const allFiles = [];
            const folders = [];
            
            try {
                const { data, error } = await client.storage
                    .from(bucket)
                    .list(prefix, { limit: 1000 });
                
                if (error) {
                    console.error('Error listing files at prefix:', prefix, error);
                    return allFiles;
                }
                
                if (!data) return allFiles;
                
                // Separate files from folders
                data.forEach(item => {
                    if (item.id === null) {
                        // This is a folder
                        folders.push(item.name);
                    } else {
                        // This is a file - add the full path
                        allFiles.push({
                            ...item,
                            name: prefix ? `${prefix}/${item.name}` : item.name
                        });
                    }
                });
                
                // Recursively process folders
                for (const folder of folders) {
                    const subPrefix = prefix ? `${prefix}/${folder}` : folder;
                    const subFiles = await listAllFilesRecursively(client, bucket, subPrefix);
                    allFiles.push(...subFiles);
                }
                
            } catch (error) {
                console.error('Error in recursive file listing:', error);
            }
            
            return allFiles;
        }

        async function handleExistingImageSelect(selectElement) {
            if (!selectElement.value) return;
            
            const contentItem = selectElement.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            
            // Create or update image preview
            let preview = fieldsContainer.querySelector('.image-loaded-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'image-loaded-preview mt-3';
                preview.innerHTML = `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="flex items-start justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-600">Selected Image</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                    Replace
                                </button>
                                <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                    <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous" fetchpriority="low" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22160%22><rect width=%22240%22 height=%22160%22 fill=%23f3f4f6/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%236b7280%22>Image unavailable</text></svg>';">
                        <input type="hidden" class="current-image-url" value="">
                        <input type="hidden" class="material-id" value="">
                    </div>
                `;
                fieldsContainer.appendChild(preview);
                lucide.createIcons();
            }
            
            // Show selected image
            const imgEl = preview.querySelector('img');
            const currentUrlInput = preview.querySelector('.current-image-url');
            
            if (imgEl) {
                imgEl.src = selectElement.value;
                preview.style.display = 'block';
            }
            
            if (currentUrlInput) {
                currentUrlInput.value = selectElement.value;
            }
        }
        window.handleExistingImageSelect = window.handleExistingImageSelect || handleExistingImageSelect;

        function handleImageUpload(fileInput) {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const contentItem = fileInput.closest('.content-item');
                const fieldsContainer = contentItem.querySelector('.content-fields');
                
                // Create or update image preview
                let preview = fieldsContainer.querySelector('.image-loaded-preview');
                if (!preview) {
                    preview = document.createElement('div');
                    preview.className = 'image-loaded-preview mt-3';
                    preview.innerHTML = `
                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <div class="flex items-start justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-600">Image Preview</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                        Replace
                                    </button>
                                    <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview" loading="lazy" decoding="async" crossorigin="anonymous" referrerpolicy="no-referrer" fetchpriority="low" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22240%22 height=%22160%22><rect width=%22240%22 height=%22160%22 fill=%23f3f4f6/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%236b7280%22>Image unavailable</text></svg>';">
                            <input type="hidden" class="current-image-url" value="">
                            <input type="hidden" class="material-id" value="">
                        </div>
                    `;
                    fieldsContainer.appendChild(preview);
                    lucide.createIcons();
                }
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgEl = preview.querySelector('img');
                    if (imgEl) {
                        imgEl.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        window.handleImageUpload = window.handleImageUpload || handleImageUpload;

        function replaceImage(button) {
            const contentItem = button.closest('.content-item');
            const replaceInput = contentItem.querySelector('.replace-file-input');
            if (replaceInput) {
                replaceInput.click();
            }
        }
        window.replaceImage = window.replaceImage || replaceImage;

        async function handleImageReplace(replaceInput) {
            if (!replaceInput.files || !replaceInput.files[0]) return;

            const newFile = replaceInput.files[0];
            const contentItem = replaceInput.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const currentUrlInput = fieldsContainer.querySelector('.current-image-url');
            const materialIdInput = fieldsContainer.querySelector('.material-id');
            const preview = fieldsContainer.querySelector('.image-loaded-preview');

            try {
                // Determine lessonId and contentIndex
                const lessonItem = contentItem.closest('.lesson-item');
                const lessonId = lessonItem?.getAttribute('data-lesson-db-id');
                if (!lessonId) {
                    showError('Cannot replace image: lesson ID not found');
                    return;
                }
                const contentContainer = lessonItem.querySelector('.lesson-content-container');
                const contentItems = contentContainer.querySelectorAll('.content-item');
                const contentIndex = Array.from(contentItems).indexOf(contentItem);

                // Upload new file with standardized options
                const newUrl = await uploadSingleFile(newFile, 'lessons', '', '', 0, { lessonId, contentIndex });

                // Delete old file if it exists
                const oldUrl = currentUrlInput.value;
                if (oldUrl) {
                    await deleteImageFromStorage(oldUrl);
                }

                // Update UI and hidden inputs
                const imgEl = preview.querySelector('img');
                if (imgEl) {
                    imgEl.src = newUrl;
                }
                currentUrlInput.value = newUrl;

                // Update database if material exists
                const materialId = materialIdInput.value;
                if (materialId) {
                    await updateMaterialUrl(materialId, newUrl);
                }

                // Clear the replace input
                replaceInput.value = '';
                showSuccess('Image replaced successfully!');
            } catch (error) {
                console.error('Error replacing image:', error);
                showError('Failed to replace image: ' + error.message);
            }
        }
        window.handleImageReplace = window.handleImageReplace || handleImageReplace;

        async function deleteImage(button) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            const contentItem = button.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const currentUrlInput = fieldsContainer.querySelector('.current-image-url');
            const materialIdInput = fieldsContainer.querySelector('.material-id');
            const preview = fieldsContainer.querySelector('.image-loaded-preview');
            const fileInput = fieldsContainer.querySelector('.content-file');

            try {
                // Delete from storage if URL exists
                const currentUrl = currentUrlInput.value;
                if (currentUrl) {
                    await deleteImageFromStorage(currentUrl);
                }

                // Delete from database if material exists
                const materialId = materialIdInput.value;
                if (materialId) {
                    await deleteMaterialFromDatabase(materialId);
                }

                // Clear UI
                if (preview) {
                    preview.style.display = 'none';
                }
                if (fileInput) {
                    fileInput.value = '';
                }
                currentUrlInput.value = '';
                materialIdInput.value = '';

                showSuccess('Image deleted successfully!');
            } catch (error) {
                console.error('Error deleting image:', error);
                showError('Failed to delete image: ' + error.message);
            }
        }
        window.deleteImage = window.deleteImage || deleteImage;

        async function deleteImageFromStorage(imageUrl) {
            try {
                // Extract file path from URL
                const urlParts = imageUrl.split('/storage/v1/object/public/course-materials/');
                if (urlParts.length !== 2) {
                    console.warn('Could not extract file path from URL:', imageUrl);
                    return;
                }
                
                const filePath = urlParts[1];
                
                // Use admin client for deletion if available
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                if (window.isElectron) {
                    // Use IPC for Electron environment
                    const result = await window.electronAPI.invoke('db:deleteFile', 'course-materials', filePath);
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                } else {
                    // Direct Supabase API call
                    const { error } = await client.storage
                        .from('course-materials')
                        .remove([filePath]);
                    
                    if (error) {
                        throw error;
                    }
                }
                
                console.log(' File deleted from storage:', filePath);
            } catch (error) {
                console.error(' Error deleting file from storage:', error);
                throw error;
            }
        }

        async function updateMaterialUrl(materialId, newUrl) {
            try {
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                const { error } = await client
                    .from('lesson_materials')
                    .update({ url: newUrl })
                    .eq('id', materialId);
                
                if (error) {
                    throw error;
                }
                
                console.log(' Material URL updated in database');
            } catch (error) {
                console.error(' Error updating material URL:', error);
                throw error;
            }
        }

        async function deleteMaterialFromDatabase(materialId) {
            try {
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                const { error } = await client
                    .from('lesson_materials')
                    .delete()
                    .eq('id', materialId);
                
                if (error) {
                    throw error;
                }
                
                console.log(' Material deleted from database');
            } catch (error) {
                console.error(' Error deleting material from database:', error);
                throw error;
            }
        }

    // ===== Global guarded exposures for inline onclick and external access =====
        (function() {
            if (typeof window !== 'undefined') {
                // General navigation and data actions
                window.logout = window.logout || logout;
                window.refreshData = window.refreshData || refreshData;
                window.refreshUsers = window.refreshUsers || refreshUsers;
                window.showFilesTab = window.showFilesTab || showFilesTab;
                window.loadFiles = window.loadFiles || loadFiles;
                window.showAssessmentsTab = window.showAssessmentsTab || showAssessmentsTab;
                window.showAssessmentSubTab = window.showAssessmentSubTab || showAssessmentSubTab;
                window.showCourseSubTab = window.showCourseSubTab || showCourseSubTab;

                // Course and lesson CRUD helpers
                window.editVocabulary = window.editVocabulary || editVocabulary;
                window.deleteVocabulary = window.deleteVocabulary || deleteVocabulary;
                window.editLesson = window.editLesson || editLesson;
                window.deleteLesson = window.deleteLesson || deleteLesson;
                window.deleteCourse = window.deleteCourse || deleteCourse;

                // Assignment handlers
                window.editAssignment = window.editAssignment || editAssignment;
                window.deleteAssignment = window.deleteAssignment || deleteAssignment;

                // Content builder helpers (inline onclick handlers)
                window.updateContentFields = window.updateContentFields || updateContentFields;
                window.previewContent = window.previewContent || previewContent;
                window.moveContentUp = window.moveContentUp || moveContentUp;
                window.moveContentDown = window.moveContentDown || moveContentDown;
                window.renumberContentItems = window.renumberContentItems || renumberContentItems;
                window.openQuizBuilder = window.openQuizBuilder || openQuizBuilder;
                window.addQuestion = window.addQuestion || addQuestion;
                window.removeQuestion = window.removeQuestion || removeQuestion;
                window.generateLessonContent = window.generateLessonContent || generateLessonContent;
                window.generateQuestionContent = window.generateQuestionContent || generateQuestionContent;

                // Image helpers for inline handlers
                window.toggleImageSourceFields = window.toggleImageSourceFields || toggleImageSourceFields;
                window.replaceImage = window.replaceImage || replaceImage;
                window.deleteImage = window.deleteImage || deleteImage;
                window.handleImageReplace = window.handleImageReplace || handleImageReplace;
                window.handleImageUpload = window.handleImageUpload || handleImageUpload;
                window.handleExistingImageSelect = window.handleExistingImageSelect || handleExistingImageSelect;

                // Fallback stubs for not-yet-implemented features
                if (typeof window.viewCourseDetails !== 'function') {
                    window.viewCourseDetails = function(courseId) {
                        console.warn('viewCourseDetails not implemented yet. courseId:', courseId);
                        createToast({ type: 'info', message: 'Course details view is not implemented yet.' });
                    };
                }
                if (typeof window.showTemplateGallery !== 'function') {
                    window.showTemplateGallery = function() {
                        console.warn('showTemplateGallery not implemented yet.');
                        createToast({ type: 'info', message: 'Template gallery is coming soon.' });
                    };
                }

                // Expose dark mode toggle
                if (typeof window.toggleDarkMode !== 'function') {
                    window.toggleDarkMode = function toggleDarkMode() {
                        const root = document.documentElement;
                        const current = root.getAttribute('data-theme');
                        const next = current === 'dark' ? 'light' : 'dark';
                        root.setAttribute('data-theme', next);
                        try { localStorage.setItem('edlingo-theme', next); } catch(e) {}
                        const icon = document.getElementById('theme-icon');
                        if (icon) {
                            icon.setAttribute('data-lucide', next === 'dark' ? 'sun' : 'moon');
                            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                                window.lucide.createIcons();
                            }
                        }
                    };
                }

                // Initialize theme once on load
                (function initTheme(){
                    try {
                        const saved = localStorage.getItem('edlingo-theme');
                        if (saved === 'dark') {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            const icon = document.getElementById('theme-icon');
                            if (icon) { icon.setAttribute('data-lucide', 'sun'); }
                        }
                        if (window.lucide && typeof window.lucide.createIcons === 'function') {
                            window.lucide.createIcons();
                        }
                    } catch (e) {}
                })();
            }
        })();

        // Global tooltip portal logic (prevents clipping and supports auto-flip)
        (function setupTooltipPortal(){
            try {
                const portalId = 'tooltip-portal';
                let portal = document.getElementById(portalId);
                if (!portal) {
                    portal = document.createElement('div');
                    portal.id = portalId;
                    document.body.appendChild(portal);
                }
                const show = (el) => {
                    const text = el.getAttribute('data-tooltip');
                    if (!text) return;
                    portal.textContent = text;
                    portal.classList.remove('visible');
                    portal.removeAttribute('data-placement');

                    const rect = el.getBoundingClientRect();
                    const spacing = 10;
                    // default: bottom
                    let left = rect.left + rect.width/2; // center x
                    let top = rect.bottom + spacing;
                    portal.setAttribute('data-placement', 'bottom');
                    portal.style.left = `${left}px`;
                    portal.style.top = `${top}px`;

                    // make visible to measure size
                    portal.classList.add('visible');
                    const pRect = portal.getBoundingClientRect();

                    // auto-flip if not enough space at bottom
                    const spaceBottom = window.innerHeight - rect.bottom;
                    const spaceTop = rect.top;
                    if (spaceBottom < pRect.height + spacing && spaceTop > pRect.height + spacing) {
                        top = rect.top - spacing - pRect.height;
                        portal.setAttribute('data-placement', 'top');
                        portal.style.top = `${top}px`;
                    } else {
                        portal.setAttribute('data-placement', 'bottom');
                        portal.style.top = `${rect.bottom + spacing}px`;
                    }
                    // keep inside viewport horizontally
                    const minX = 8 + pRect.width/2;
                    const maxX = window.innerWidth - 8 - pRect.width/2;
                    left = Math.min(Math.max(left, minX), maxX);
                    portal.style.left = `${left}px`;
                };
                const hide = () => portal.classList.remove('visible');

                let activeEl = null;
                // Show on mouseover (entering a trigger)
                document.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('.tooltip');
                    if (!target) return;
                    if (activeEl !== target) {
                        activeEl = target;
                        show(target);
                    }
                }, true);
                // Hide when leaving the same trigger (not when moving inside it)
                document.addEventListener('mouseout', (e) => {
                    const target = e.target.closest('.tooltip');
                    if (!target) return;
                    if (target.contains(e.relatedTarget)) return; // still inside same trigger
                    if (activeEl === target) {
                        activeEl = null;
                        hide();
                    }
                }, true);
                // Accessible focus/blur
                document.addEventListener('focusin', (e) => {
                    const target = e.target.closest('.tooltip');
                    if (target) {
                        activeEl = target;
                        show(target);
                    }
                });
                document.addEventListener('focusout', (e) => {
                    const target = e.target.closest('.tooltip');
                    if (target && activeEl === target) {
                        activeEl = null;
                        hide();
                    }
                });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { activeEl = null; hide(); } });
                window.addEventListener('scroll', () => { activeEl = null; hide(); }, true);
                window.addEventListener('resize', () => { activeEl = null; hide(); });
            } catch (e) { /* no-op */ }
        })();
    </script>
    <div id="tooltip-portal" aria-hidden="true"></div>
</body>
</html>