<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdLingo Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/env.js"></script>
    
    <!-- MCP Client for enhanced database operations (supports both browser and Electron environments) -->
    <script type="module">
        // Utility function to detect if we're in Electron environment
        window.isElectron = typeof window.electronAPI !== 'undefined' && !(window.electronAPI && window.electronAPI._isShim);
        
        // Mock MCP client for browser environments
        if (!window.isElectron) {
            // For browser environments, provide simplified MCP functionality
            window.mcpSQL = {
                execute: async (query, options = {}) => {
                    console.log('Browser MCP client: executing SQL', query);
                    // Return mock data for demonstration
                    return {
                        success: false,
                        error: { message: 'MCP client requires Electron environment' },
                        data: null
                    };
                },
                test: async () => ({ success: false, error: 'MCP not available in browser' })
            };
        }
    </script>

    <style>
        .admin-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="admin-gradient text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i data-lucide="graduation-cap" class="w-8 h-8 mr-3"></i>
                    <h1 class="text-2xl font-bold">EdLingo Admin Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">Welcome, Admin</span>
                    <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all" onclick="refreshData()">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all" onclick="logout()">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <button id="overview-tab" class="flex items-center space-x-2 px-3 py-4 border-b-2 border-blue-500 text-blue-600 font-medium" onclick="showTab('overview')">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span>Overview</span>
                </button>
                <button id="users-tab" class="flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('users')">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Users</span>
                </button>
                <button id="courses-tab" class="flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showTab('courses')">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span>Courses</span>
                </button>
                <button id="assessments-tab" class="flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showAssessmentsTab()">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    <span>CEFR Assessments</span>
                </button>
                <button id="files-tab" class="flex items-center space-x-2 px-3 py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium" onclick="showFilesTab()">
                    <i data-lucide="folder" class="w-5 h-5"></i>
                    <span>Files</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Tab -->
        <div id="overview-content" class="tab-content">
            <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Users</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-users">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i data-lucide="book-open" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Grammar Lessons</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-lessons">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Vocabulary Words</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-vocabulary">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i data-lucide="trophy" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Achievements</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-achievements">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Quick Actions</h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors" onclick="showTab('courses')">
                        <div class="text-center">
                            <i data-lucide="book-open" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Manage Courses</span>
                        </div>
                    </button>
                    <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors" onclick="showTab('assignments')">
                        <div class="text-center">
                            <i data-lucide="file-text" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Manage Assignments</span>
                        </div>
                    </button>
                    <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors" onclick="showTab('users')">
                        <div class="text-center">
                            <i data-lucide="users" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Manage Users</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
            </div>
            <div class="p-6">
                <div id="activity-list">
                    <div class="loading text-center text-gray-500">Loading recent activity...</div>
                </div>
            </div>
        </div>

        <!-- Data Management Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Vocabulary Management -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Vocabulary Management</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="vocabulary-list">
                        <div class="loading text-center text-gray-500">Loading vocabulary...</div>
                    </div>
                </div>
            </div>

            <!-- Grammar Lessons Management -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Grammar Lessons</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4" id="lessons-list">
                        <div class="loading text-center text-gray-500">Loading lessons...</div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Users Tab -->
        <div id="users-content" class="tab-content hidden">
            <!-- User Management Section -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">User Management</h2>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="refreshUsers()">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                            Refresh Users
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="users-table-body-tab">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    <div class="loading">Loading users...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
















        </div>

        <!-- Courses Tab -->
        <div id="courses-content" class="tab-content hidden">
            <!-- Course Management Header -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Course Management</h2>
                        <div class="flex space-x-3">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showTemplateGallery()">
                                <i data-lucide="layout-template" class="w-4 h-4 mr-2"></i>
                                Templates
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddCourseModal()">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Create Course
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Course Sub-navigation -->
                <div class="px-6">
                    <nav class="flex space-x-8" aria-label="Course Tabs">
                        <button id="course-overview-tab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="showCourseSubTab('overview')">
                            Overview
                        </button>
                        <button id="course-ai-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('ai')">
                            AI Creation
                        </button>
                        <button id="course-templates-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('templates')">
                            Templates
                        </button>
                        <button id="course-versions-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showCourseSubTab('versions')">
                            Version Control
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Course Overview Sub-tab -->
            <div id="course-overview-content" class="course-subtab-content">
                <!-- Course Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i data-lucide="book-open" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Courses</p>
                                <p class="text-2xl font-semibold text-gray-900" id="total-courses-stat">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Enrolled Students</p>
                                <p class="text-2xl font-semibold text-gray-900" id="enrolled-students-stat">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i data-lucide="trending-up" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Completion Rate</p>
                                <p class="text-2xl font-semibold text-gray-900" id="completion-rate-stat">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i data-lucide="star" class="w-6 h-6"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Avg Rating</p>
                                <p class="text-2xl font-semibold text-gray-900" id="avg-rating-stat">0.0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">All Courses</h3>
                            <div class="flex space-x-3">
                                <input type="text" placeholder="Search courses..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="course-search">
                                <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="course-filter">
                                    <option value="">All Levels</option>
                                    <option value="A1">A1 - Beginner</option>
                                    <option value="A2">A2 - Elementary</option>
                                    <option value="B1">B1 - Intermediate</option>
                                    <option value="B2">B2 - Upper Intermediate</option>
                                    <option value="C1">C1 - Advanced</option>
                                    <option value="C2">C2 - Proficient</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="courses-list" class="space-y-4">
                            <div class="text-center py-12">
                                <i data-lucide="book-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
                                <p class="text-gray-500 mb-4">Create your first course to get started.</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddCourseModal()">
                                    Create Course
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Assignment Management</h2>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddAssignmentModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Assignment
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="assignments-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="file-text" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No assignments found</h3>
                            <p class="text-gray-500 mb-4">Create your first assignment to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddAssignmentModal()">
                                Create Assignment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Tab -->
        <div id="questions-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Question Management</h2>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showAddQuestionModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Question
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Assignment/Test Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Assignment/Test</label>
                        <select id="questionAssignmentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadQuestionsForAssignment()">
                            <option value="">Select an assignment or test...</option>
                        </select>
                    </div>
                    
                    <!-- Questions List -->
                    <div id="questions-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="help-circle" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No questions found</h3>
                            <p class="text-gray-500 mb-4">Select an assignment or test above, then create your first question.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddQuestionModal()" disabled id="createQuestionBtn">
                                Create Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CEFR Assessments Tab -->
        <div id="assessments-content" class="tab-content hidden">
            <!-- Assessment Overview Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Assessments</p>
                            <p class="text-2xl font-semibold text-gray-900" id="total-assessments">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i data-lucide="users" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Students Assessed</p>
                            <p class="text-2xl font-semibold text-gray-900" id="students-assessed">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i data-lucide="target" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Avg CEFR Level</p>
                            <p class="text-2xl font-semibold text-gray-900" id="avg-cefr-level">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i data-lucide="trending-up" class="w-6 h-6"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Completion Rate</p>
                            <p class="text-2xl font-semibold text-gray-900" id="completion-rate">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Management Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button id="assessment-questions-tab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="showAssessmentSubTab('questions')">
                            Question Bank
                        </button>
                        <button id="assessment-analytics-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showAssessmentSubTab('analytics')">
                            Analytics Dashboard
                        </button>
                        <button id="assessment-settings-tab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="showAssessmentSubTab('settings')">
                            CEFR Settings
                        </button>
                    </nav>
                </div>

                <!-- Question Bank Sub-tab -->
                <div id="assessment-questions-content" class="assessment-subtab-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">CEFR Assessment Questions</h3>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showCreateAssessmentQuestionModal()">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Create Question
                        </button>
                    </div>

                    <!-- CEFR Level Filter -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <select id="cefr-level-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All CEFR Levels</option>
                            <option value="A1">A1 - Beginner</option>
                            <option value="A2">A2 - Elementary</option>
                            <option value="B1">B1 - Intermediate</option>
                            <option value="B2">B2 - Upper Intermediate</option>
                            <option value="C1">C1 - Advanced</option>
                            <option value="C2">C2 - Proficient</option>
                        </select>
                        <select id="skill-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All Skills</option>
                            <option value="reading">Reading</option>
                            <option value="writing">Writing</option>
                            <option value="listening">Listening</option>
                            <option value="speaking">Speaking</option>
                        </select>
                        <select id="question-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterAssessmentQuestions()">
                            <option value="">All Question Types</option>
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="fill_blank">Fill in the Blank</option>
                            <option value="essay">Essay</option>
                            <option value="listening_comprehension">Listening Comprehension</option>
                            <option value="speaking_prompt">Speaking Prompt</option>
                        </select>
                    </div>

                    <!-- Questions List -->
                    <div id="assessment-questions-list" class="space-y-4">
                        <div class="text-center py-12">
                            <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No assessment questions found</h3>
                            <p class="text-gray-500 mb-4">Create your first CEFR assessment question to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showCreateAssessmentQuestionModal()">
                                Create Question
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Dashboard Sub-tab -->
                <div id="assessment-analytics-content" class="assessment-subtab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Student Assessment Analytics</h3>
                    
                    <!-- CEFR Level Distribution Chart -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">CEFR Level Distribution</h4>
                            <div id="cefr-distribution-chart" class="h-64">
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <i data-lucide="bar-chart-3" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">Assessment Progress</h4>
                            <div id="progress-chart" class="h-64">
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <i data-lucide="trending-up" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Progress chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Performance Table -->
                    <div class="bg-white border border-gray-200 rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h4 class="text-md font-semibold text-gray-900">Student Performance Overview</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current CEFR Level</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reading</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Writing</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listening</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Speaking</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Assessment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="student-performance-table">
                                    <tr>
                                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                            <div class="loading">Loading student performance data...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CEFR Settings Sub-tab -->
                <div id="assessment-settings-content" class="assessment-subtab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">CEFR Assessment Configuration</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Level Thresholds -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">CEFR Level Thresholds</h4>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">A1 (Beginner)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="0" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 20%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">A2 (Elementary)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="21" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 40%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">B1 (Intermediate)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="41" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 60%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">B2 (Upper Intermediate)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="61" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 75%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">C1 (Advanced)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="76" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 90%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">C2 (Proficient)</span>
                                    <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" value="91" min="0" max="100">
                                    <span class="text-sm text-gray-500">- 100%</span>
                                </div>
                            </div>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                Save Thresholds
                            </button>
                        </div>

                        <!-- Assessment Settings -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">Assessment Configuration</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Questions per Assessment</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="25" min="10" max="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes)</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="45" min="15" max="120">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Adaptive Assessment</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="enabled">Enabled</option>
                                        <option value="disabled">Disabled</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Retake Policy</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="unlimited">Unlimited</option>
                                        <option value="once_per_week">Once per week</option>
                                        <option value="once_per_month">Once per month</option>
                                        <option value="no_retakes">No retakes</option>
                                    </select>
                                </div>
                            </div>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files Tab -->
        <div id="files-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">File Management</h2>
                        <div class="flex space-x-3">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="showUploadModal()">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                Upload Files
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="refreshFiles()">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Storage Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-blue-100 text-blue-600">
                                    <i data-lucide="hard-drive" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Total Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="total-files">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-green-100 text-green-600">
                                    <i data-lucide="database" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Storage Used</p>
                                    <p class="text-xl font-semibold text-gray-900" id="storage-used">0 MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-yellow-100 text-yellow-600">
                                    <i data-lucide="folder" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Course Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="course-files">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-purple-100 text-purple-600">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-600">Assignment Files</p>
                                    <p class="text-xl font-semibold text-gray-900" id="assignment-files">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Filters -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="flex-1 min-w-64">
                            <input type="text" id="file-search" placeholder="Search files..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <select id="file-type-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                            <option value="image">Images</option>
                        </select>
                        <select id="file-category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Categories</option>
                            <option value="courses">Courses</option>
                            <option value="assignments">Assignments</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <!-- Files List -->
                    <div id="files-list" class="space-y-3">
                        <div class="text-center py-12">
                            <i data-lucide="folder-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No files found</h3>
                            <p class="text-gray-500 mb-4">Upload your first file to get started.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showUploadModal()">
                                Upload Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-500"> 2024 EdLingo Admin Dashboard. All rights reserved.</p>
                <div class="flex space-x-4">
                    <span class="text-xs text-gray-400" id="last-updated">Last updated: Never</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Course Creation Wizard Modal -->
    <div id="courseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[95vh] overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 id="courseModalTitle" class="text-xl font-semibold text-gray-900">Create New Course</h3>
                        <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <!-- Progress Indicator -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span id="stepIndicator">Step 1 of 4</span>
                            <span id="stepTitle">Basic Information</span>
                        </div>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="flex h-[calc(95vh-140px)]">
                    <!-- Step Navigation -->
                    <div class="w-56 bg-gray-50 border-r border-gray-200 p-4">
                        <nav class="space-y-2">
                            <div id="step1Nav" class="flex items-center p-3 rounded-lg bg-blue-100 text-blue-700 cursor-pointer" onclick="showWizardStep(1)">
                                <div class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center mr-3">1</div>
                                <span class="text-sm font-medium">Basic Info</span>
                            </div>
                            <div id="step2Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(2)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">2</div>
                                <span class="text-sm font-medium">Course Content</span>
                            </div>
                            <div id="step3Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(3)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">3</div>
                                <span class="text-sm font-medium">Instructor Settings</span>
                            </div>
                            <div id="step4Nav" class="flex items-center p-3 rounded-lg text-gray-500 cursor-pointer" onclick="showWizardStep(4)">
                                <div class="w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3">4</div>
                                <span class="text-sm font-medium">Review & Publish</span>
                            </div>
                        </nav>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="flex-1 overflow-y-auto">
                        <form id="courseForm" class="h-full">
                            <!-- Step 1: Basic Information -->
                            <div id="step-1" class="step-content p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Course Information</h4>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Title *</label>
                                        <input type="text" id="courseTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Category</label>
                                        <select id="courseCategory" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="general">General English</option>
                                            <option value="business">Business English</option>
                                            <option value="academic">Academic English</option>
                                            <option value="conversation">Conversation</option>
                                            <option value="grammar">Grammar</option>
                                            <option value="vocabulary">Vocabulary</option>
                                            <option value="pronunciation">Pronunciation</option>
                                            <option value="test-prep">Test Preparation</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Description</label>
                                    <textarea id="courseDescription" name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Describe what students will learn in this course..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">CEFR Level</label>
                                        <select id="cefrLevel" name="level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="A1">A1 - Beginner</option>
                                            <option value="A2">A2 - Elementary</option>
                                            <option value="B1">B1 - Intermediate</option>
                                            <option value="B2">B2 - Upper Intermediate</option>
                                            <option value="C1">C1 - Advanced</option>
                                            <option value="C2">C2 - Proficiency</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Language</label>
                                        <select id="courseLanguage" name="language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="it">Italian</option>
                                            <option value="pt">Portuguese</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Duration (weeks)</label>
                                        <input type="number" id="courseDuration" name="duration" min="1" max="52" value="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Hours per week</label>
                                        <input type="number" id="courseHours" name="hoursPerWeek" min="1" max="40" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Students</label>
                                        <input type="number" id="maxStudents" name="maxStudents" min="1" max="100" value="25" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Price</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <input type="number" id="coursePrice" name="price" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <select id="courseCurrency" name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="USD">USD ($)</option>
                                                <option value="EUR">EUR ()</option>
                                                <option value="GBP">GBP ()</option>
                                                <option value="CAD">CAD ($)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Course Content & Lessons -->
                            <div id="step-2" class="wizard-step hidden p-6 space-y-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold text-gray-900">Course Content & Lessons</h4>
                                    <button type="button" onclick="addLesson()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                        Add Lesson
                                    </button>
                                </div>
                                
                                <!-- Course Overview -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Learning Objectives</label>
                                            <textarea id="learningObjectives" name="objectives" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="What will students achieve by the end of this course?"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prerequisites</label>
                                            <textarea id="prerequisites" name="prerequisites" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="What should students know before taking this course?"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Skills Focus</label>
                                        <div class="grid grid-cols-4 gap-4">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="listeningSkill" name="skillsFocus" value="listening" class="mr-2 text-blue-600">
                                                <span class="text-sm">Listening</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="speakingSkill" name="skillsFocus" value="speaking" class="mr-2 text-blue-600">
                                                <span class="text-sm">Speaking</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="readingSkill" name="skillsFocus" value="reading" class="mr-2 text-blue-600">
                                                <span class="text-sm">Reading</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="writingSkill" name="skillsFocus" value="writing" class="mr-2 text-blue-600">
                                                <span class="text-sm">Writing</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Lessons Container -->
                                <div id="lessonsContainer" class="space-y-4">
                                    <!-- Lessons will be dynamically added here -->
                                </div>

                                <!-- AI Content Assistant -->
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-blue-900 mb-2">AI Content Assistant</h5>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="generateSyllabus()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>
                                            Generate Syllabus
                                        </button>
                                        <button type="button" onclick="generateLessons()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="book-open" class="w-4 h-4 mr-1"></i>
                                            Generate Lessons
                                        </button>
                                        <button type="button" onclick="generateLessonContent()" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors text-sm flex items-center">
                                            <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i>
                                            Generate Content
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Instructor Settings -->
                            <div id="step-3" class="wizard-step hidden p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Instructor & Course Settings</h4>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Name</label>
                                        <input type="text" id="instructorName" name="instructor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Email</label>
                                        <input type="email" id="instructorEmail" name="instructorEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="instructor@example.com">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Bio</label>
                                    <textarea id="instructorBio" name="instructorBio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Brief description of your teaching experience and qualifications..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Start Date</label>
                                        <input type="date" id="startDate" name="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Enrollment Deadline</label>
                                        <input type="date" id="enrollmentDeadline" name="enrollmentDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Schedule</label>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Days of Week</label>
                                            <select id="courseDays" name="days" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="mon-wed-fri">Mon, Wed, Fri</option>
                                                <option value="tue-thu">Tue, Thu</option>
                                                <option value="weekends">Weekends</option>
                                                <option value="daily">Daily</option>
                                                <option value="flexible">Flexible</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Start Time</label>
                                            <input type="time" id="startTime" name="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Duration (minutes)</label>
                                            <input type="number" id="sessionDuration" name="sessionDuration" min="30" max="180" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Method</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="continuous" class="mr-2 text-blue-600">
                                            <span>Continuous Assessment (quizzes, assignments)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="final" class="mr-2 text-blue-600">
                                            <span>Final Exam</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="mixed" class="mr-2 text-blue-600" checked>
                                            <span>Mixed (continuous + final)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="assessment" value="portfolio" class="mr-2 text-blue-600">
                                            <span>Portfolio-based</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Policies</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="allowLateSubmissions" name="policies" value="late-submissions" class="mr-2 text-blue-600">
                                            <span>Allow late submissions (with penalty)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="requireAttendance" name="policies" value="attendance" class="mr-2 text-blue-600" checked>
                                            <span>Attendance required (minimum 80%)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="allowMakeupSessions" name="policies" value="makeup" class="mr-2 text-blue-600">
                                            <span>Allow makeup sessions</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Review & Publish -->
                            <div id="step-4" class="wizard-step hidden p-6 space-y-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Review & Publish Course</h4>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-blue-900 mb-3">Course Summary</h5>
                                    <div id="courseSummary" class="text-sm text-blue-800 space-y-2">
                                        <!-- Course summary will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Lessons and Materials Review Section -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h5 class="font-medium text-green-900 mb-3">Lessons & Materials</h5>
                                    <div id="lessonsReview" class="space-y-4">
                                        <!-- Lessons and materials will be populated here -->
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h6 class="font-medium text-gray-900 mb-2">Course Details</h6>
                                        <div id="courseDetailsReview" class="text-sm text-gray-700 space-y-1">
                                            <!-- Course details will be populated here -->
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h6 class="font-medium text-gray-900 mb-2">Instructor Info</h6>
                                        <div id="instructorReview" class="text-sm text-gray-700 space-y-1">
                                            <!-- Instructor info will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h6 class="font-medium text-yellow-900 mb-2">Publishing Options</h6>
                                    <div class="space-y-3">
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="draft" class="mr-2 text-blue-600" checked>
                                            <span class="text-sm">Save as Draft (you can edit and publish later)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="review" class="mr-2 text-blue-600">
                                            <span class="text-sm">Submit for Review (admin approval required)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publishStatus" value="publish" class="mr-2 text-blue-600">
                                            <span class="text-sm">Publish Immediately (course goes live)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h6 class="font-medium text-green-900 mb-2">Next Steps</h6>
                                    <ul class="text-sm text-green-800 space-y-1">
                                        <li> Course will be created in your dashboard</li>
                                        <li> You can add lessons and assignments after creation</li>
                                        <li> Students can enroll once published</li>
                                        <li> You'll receive notifications for new enrollments</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="flex justify-between pt-6 border-t border-gray-200">
                                <button type="button" id="prevBtn" onclick="prevWizardStep()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="display: none;">
                                    <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>
                                    Previous
                                </button>
                                <div class="flex space-x-3">
                                    <button type="button" onclick="saveDraft()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                        <i data-lucide="save" class="w-4 h-4 mr-1"></i>
                                        Save Draft
                                    </button>
                                    <button type="button" id="nextBtn" onclick="nextWizardStep()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                        Next
                                        <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                                    </button>
                                    <button type="submit" id="finishBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" style="display: none;">
                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                        Create Course
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

    <!-- Assignment Creation Modal -->
    <div id="assignmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Create New Assignment</h3>
                        <button onclick="closeAssignmentModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <form id="assignmentForm" class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Title</label>
                        <input type="text" id="assignmentTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                        <textarea id="assignmentInstructions" name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                            <input type="datetime-local" id="assignmentDueDate" name="dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                            <input type="number" id="assignmentPoints" name="points" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">Assignment Materials</label>
                        <div class="space-y-4">
                            <!-- PDF Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">PDF Documents</span>
                                    <i data-lucide="file-text" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentPdfs" multiple accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-xs text-gray-500 mt-1">Upload PDF worksheets and reading materials</p>
                            </div>
                            <!-- Audio Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Audio Files</span>
                                    <i data-lucide="headphones" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentAudio" multiple accept=".mp3,.wav,.ogg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <p class="text-xs text-gray-500 mt-1">Upload audio for listening exercises</p>
                            </div>
                            <!-- Video Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Video Files</span>
                                    <i data-lucide="video" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentVideos" multiple accept=".mp4,.webm,.ogg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                <p class="text-xs text-gray-500 mt-1">Upload instructional videos</p>
                            </div>
                            <!-- Image Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Images</span>
                                    <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                                </div>
                                <input type="file" id="assignmentImages" multiple accept=".jpg,.jpeg,.png,.gif,.webp" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                                <p class="text-xs text-gray-500 mt-1">Upload reference images and visual aids</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Create Assignment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Question Creation Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Create New Question</h3>
                        <button onclick="closeQuestionModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <form id="questionForm" class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                        <textarea id="questionText" name="questionText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required placeholder="Enter the question text..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                        <select id="questionType" name="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="handleQuestionTypeChange()" required>
                            <option value="">Select question type...</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="true-false">True/False</option>
                            <option value="short-answer">Short Answer</option>
                            <option value="essay">Essay</option>
                            <option value="fill-in-blank">Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <!-- Multiple Choice Options -->
                    <div id="multipleChoiceOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Answer Options</label>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="0" id="option0Radio" class="text-blue-600">
                                <input type="text" id="option0" placeholder="Option A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="1" id="option1Radio" class="text-blue-600">
                                <input type="text" id="option1" placeholder="Option B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="2" id="option2Radio" class="text-blue-600">
                                <input type="text" id="option2" placeholder="Option C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="correctAnswer" value="3" id="option3Radio" class="text-blue-600">
                                <input type="text" id="option3" placeholder="Option D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-sm text-gray-500">Correct</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- True/False Options -->
                    <div id="trueFalseOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="trueFalseAnswer" value="true" class="text-blue-600 mr-2">
                                <span>True</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="trueFalseAnswer" value="false" class="text-blue-600 mr-2">
                                <span>False</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Short Answer/Essay/Fill-in-blank Answer -->
                    <div id="textAnswerOptions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sample Answer/Keywords</label>
                        <textarea id="sampleAnswer" name="sampleAnswer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter sample answer or keywords for grading..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">For short answer and fill-in-blank questions, provide keywords. For essays, provide a sample answer.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                            <input type="number" id="questionPoints" name="points" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Difficulty</label>
                            <select id="questionDifficulty" name="difficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Explanation (Optional)</label>
                        <textarea id="questionExplanation" name="explanation" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Provide an explanation for the correct answer..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeQuestionModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Create Question</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Upload Files</h3>
                    <button onclick="closeFileUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="fileUploadForm" onsubmit="handleFileUpload(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">File Category</label>
                        <select id="fileCategory" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Select category...</option>
                            <option value="courses">Course Materials</option>
                            <option value="assignments">Assignment Files</option>
                            <option value="general">General Files</option>
                            <option value="images">Images</option>
                            <option value="documents">Documents</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Files</label>
                        <input type="file" id="fileInput" name="files" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp3,.mp4,.zip">
                        <p class="text-xs text-gray-500 mt-1">Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF, MP3, MP4, ZIP</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea id="fileDescription" name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Brief description of the files..."></textarea>
                    </div>
                    
                    <div id="uploadProgress" class="mb-4 hidden">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600 mt-1">Uploading...</p>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeFileUploadModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" id="uploadButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                            Upload Files
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Assessment Question Modal -->
    <div id="assessmentQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Create CEFR Assessment Question</h3>
                    <button onclick="closeAssessmentQuestionModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="assessmentQuestionForm" onsubmit="handleAssessmentQuestionSubmit(event)">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column - Question Details -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Question Type *</label>
                                <select id="questionType" name="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required onchange="updateQuestionTypeFields()">
                                    <option value="">Select question type...</option>
                                    <option value="multiple-choice">Multiple Choice</option>
                                    <option value="true-false">True/False</option>
                                    <option value="short-answer">Short Answer</option>
                                    <option value="essay">Essay</option>
                                    <option value="fill-in-blank">Fill in the Blank</option>
                                    <option value="listening">Listening</option>
                                    <option value="speaking">Speaking</option>
                                    <option value="reading">Reading</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CEFR Level *</label>
                                <select id="questionCefrLevel" name="cefrLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select CEFR level...</option>
                                    <option value="A1">A1 - Beginner</option>
                                    <option value="A2">A2 - Elementary</option>
                                    <option value="B1">B1 - Intermediate</option>
                                    <option value="B2">B2 - Upper Intermediate</option>
                                    <option value="C1">C1 - Advanced</option>
                                    <option value="C2">C2 - Proficient</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Skill Type *</label>
                                <select id="skillType" name="skillType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select skill type...</option>
                                    <option value="reading">Reading</option>
                                    <option value="writing">Writing</option>
                                    <option value="listening">Listening</option>
                                    <option value="speaking">Speaking</option>
                                    <option value="grammar">Grammar</option>
                                    <option value="vocabulary">Vocabulary</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Question Text *</label>
                                <textarea id="assessmentQuestionText" name="questionText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the question text..." required></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions (Optional)</label>
                                <textarea id="questionInstructions" name="questionInstructions" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Additional instructions for students..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Points *</label>
                                <input type="number" id="questionPoints" name="questionPoints" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="1" min="1" max="10" required>
                            </div>
                        </div>
                        
                        <!-- Right Column - Media & Options -->
                        <div class="space-y-4">
                            <!-- Media Upload Section -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-md font-semibold text-gray-900 mb-3">Media Files (Optional)</h4>
                                
                                <!-- Image Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                                    <input type="file" id="questionImage" name="questionImage" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="image/*" onchange="previewMedia('image')">
                                    <div id="imagePreview" class="mt-2 hidden">
                                        <img id="imagePreviewImg" class="max-w-full h-32 object-cover rounded" alt="Image preview">
                                        <button type="button" onclick="removeMedia('image')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Audio Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Audio</label>
                                    <input type="file" id="questionAudio" name="questionAudio" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="audio/*" onchange="previewMedia('audio')">
                                    <div id="audioPreview" class="mt-2 hidden">
                                        <audio id="audioPreviewPlayer" controls class="w-full">
                                            <source id="audioPreviewSource" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                        <button type="button" onclick="removeMedia('audio')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Video Upload -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Video</label>
                                    <input type="file" id="questionVideo" name="questionVideo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept="video/*" onchange="previewMedia('video')">
                                    <div id="videoPreview" class="mt-2 hidden">
                                        <video id="videoPreviewPlayer" controls class="w-full h-32 object-cover rounded">
                                            <source id="videoPreviewSource" type="video/mp4">
                                            Your browser does not support the video element.
                                        </video>
                                        <button type="button" onclick="removeMedia('video')" class="mt-1 text-red-600 text-sm hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- PDF Upload -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PDF Document</label>
                                    <input type="file" id="questionPdf" name="questionPdf" class="w-full px-3 py-2 border border-gray-300 rounded-lg" accept=".pdf" onchange="previewMedia('pdf')">
                                    <div id="pdfPreview" class="mt-2 hidden">
                                        <div class="flex items-center p-2 bg-white border rounded">
                                            <i data-lucide="file-text" class="w-6 h-6 text-red-600 mr-2"></i>
                                            <span id="pdfFileName" class="text-sm text-gray-700"></span>
                                            <button type="button" onclick="removeMedia('pdf')" class="ml-auto text-red-600 text-sm hover:text-red-800">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Answer Options Section -->
                            <div id="answerOptionsSection" class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-md font-semibold text-gray-900 mb-3">Answer Options</h4>
                                <div id="answerOptionsContainer">
                                    <!-- Dynamic content based on question type -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 mt-6">
                        <button type="button" onclick="closeAssessmentQuestionModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Create Question
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client with environment variables
        // Seed localStorage from env.js when running on localhost for dev convenience
        if (window.location.hostname === 'localhost' && window.__ENV__) {
            try {
                const keys = ['VITE_SUPABASE_URL', 'VITE_SUPABASE_ANON_KEY', 'VITE_SUPABASE_SERVICE_ROLE_KEY'];
                keys.forEach((k) => {
                    const v = window.__ENV__[k];
                    if (v && !localStorage.getItem(k)) {
                        localStorage.setItem(k, v);
                    }
                });
                console.log(' Seeded localStorage from env.js for localhost');
            } catch (e) {
                console.warn('Failed to seed localStorage from env.js', e);
            }
        }

        // Values come from env.js (window.__ENV__) or localhost localStorage when developing
        const supabaseUrl = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_URL) 
            || (window.location.hostname === 'localhost' ? localStorage.getItem('VITE_SUPABASE_URL') : '');
            
        const supabaseAnonKey = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_ANON_KEY) 
            || (window.location.hostname === 'localhost' ? localStorage.getItem('VITE_SUPABASE_ANON_KEY') : '');
            
        const supabaseServiceKey = (window.__ENV__ && window.__ENV__.VITE_SUPABASE_SERVICE_ROLE_KEY) 
            || (window.location.hostname === 'localhost' ? localStorage.getItem('VITE_SUPABASE_SERVICE_ROLE_KEY') : '');

        // Log configuration source
        if (window.__ENV__) {
            console.log(' Using environment variables from env.js');
        } else if (window.location.hostname === 'localhost') {
            console.log(' Using localStorage for localhost development');
        } else {
            console.warn(' Using fallback credentials - please configure environment variables');
        }

        if (!supabaseUrl || !supabaseAnonKey) {
            console.error(' Supabase URL or Anon Key is missing. Please configure environment variables.');
        }
            
        // Create regular client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // Create admin client only if service key is available
        let supabaseAdmin = null;
        if (supabaseServiceKey && supabaseServiceKey !== 'undefined') {
            supabaseAdmin = window.supabase.createClient(supabaseUrl, supabaseServiceKey);
            console.log(' Admin client initialized with service role key');
        } else {
            console.warn(' Service role key not found. Admin operations will be limited.');
            console.warn('Please add VITE_SUPABASE_SERVICE_ROLE_KEY to your environment variables (Netlify) or localStorage for localhost.');
            // Use regular client as fallback (will be limited by RLS)
            supabaseAdmin = supabase;
        }
        
        // Expose clients to global window object for admin-scripts.js
        window.supabaseClient = supabase;
        window.supabaseAdminClient = supabaseAdmin;
        console.log(' Supabase clients exposed to window object');
        
        // Connection status check
        async function checkConnection() {
            try {
                const { data, error } = await supabase.from('user_profiles').select('id').limit(1);
                if (error && error.code === '42P01') {
                    console.warn(' Database tables not found. Please run the database migration.');
                    return false;
                }
                return true;
            } catch (error) {
                console.error(' Connection check failed:', error);
                return false;
            }
        }
         
        // Display demo users for testing and when RLS prevents data access
        function displayDemoUsers() {
             const demoUsers = [
                 {
                     id: 'demo-user-1',
                     email: 'john.doe@example.com',
                     full_name: 'John Doe',
                     created_at: '2024-01-15T10:30:00Z',
                     user_progress: [{
                         current_level: 'intermediate',
                         total_xp: 1250,
                         daily_streak: 15
                     }]
                 },
                 {
                     id: 'demo-user-2',
                     email: 'maria.garcia@example.com',
                     full_name: 'Maria Garcia',
                     created_at: '2024-01-20T14:15:00Z',
                     user_progress: [{
                         current_level: 'beginner',
                         total_xp: 680,
                         daily_streak: 8
                     }]
                 },
                 {
                     id: 'demo-user-3',
                     email: 'alex.chen@example.com',
                     full_name: 'Alex Chen',
                     created_at: '2024-01-10T09:45:00Z',
                     user_progress: [{
                         current_level: 'advanced',
                         total_xp: 2890,
                         daily_streak: 32
                     }]
                 },
                 {
                     id: 'demo-user-4',
                     email: 'sophie.martin@example.com',
                     full_name: 'Sophie Martin',
                     created_at: '2024-01-25T16:20:00Z',
                     user_progress: [{
                         current_level: 'intermediate',
                         total_xp: 1890,
                         daily_streak: 22
                     }]
                 },
                 {
                     id: 'demo-user-5',
                     email: 'carlos.rodriguez@example.com',
                     full_name: 'Carlos Rodriguez',
                     created_at: '2024-01-05T11:10:00Z',
                     user_progress: [{
                         current_level: 'beginner',
                         total_xp: 420,
                         daily_streak: 5
                     }]
                 }
             ];
             
             const tableBody = document.getElementById('users-table-body-tab');
             if (!tableBody) {
                 console.error(' Could not find users-table-body-tab element');
                 return;
             }
             
             console.log(' Rendering demo user table with', demoUsers.length, 'users');
             tableBody.innerHTML = demoUsers.map(user => {
                 const progress = user.user_progress?.[0] || {};
                 const createdAt = new Date(user.created_at).toLocaleDateString();
                 
                 return `
                     <tr class="hover:bg-gray-50">
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
                             ${user.id.substring(0, 8)}...
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${user.email || 'N/A'}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${user.full_name || user.email || 'N/A'}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${createdAt}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             <div class="flex flex-col">
                                 <span class="text-xs text-gray-500">Level: ${progress.current_level || 'beginner'}</span>
                                 <span class="text-xs text-gray-500">XP: ${progress.total_xp || 0}</span>
                                 <span class="text-xs text-gray-500">Streak: ${progress.daily_streak || 0}</span>
                             </div>
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                             <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewUser('${user.id}')">
                                 View
                             </button>
                             <button class="text-red-600 hover:text-red-900" onclick="deleteUser('${user.id}')">
                                 Delete
                             </button>
                         </td>
                     </tr>
                 `;
             }).join('');
             
             // Add a notice that this is demo data
             const noticeRow = `
                 <tr>
                     <td colspan="6" class="px-6 py-2">
                         <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                             <div class="flex items-center">
                                 <i data-lucide="info" class="w-4 h-4 text-blue-600 mr-2"></i>
                                 <span class="text-sm text-blue-800">Demo Data: Showing sample users for demonstration purposes</span>
                             </div>
                         </div>
                     </td>
                 </tr>
             `;
             
             tableBody.innerHTML += noticeRow;
             lucide.createIcons();
             console.log(' Demo user table rendered successfully');
         }

        // Handle question type changes in the modal
        function handleQuestionTypeChange() {
            const questionTypeElement = document.getElementById('questionType');
            const answerOptionsDiv = document.getElementById('answerOptions');
            
            if (!questionTypeElement || !answerOptionsDiv) {
                console.error('Question type form elements not found');
                return;
            }
            
            const questionType = questionTypeElement.value;
            
            // Clear previous content
            answerOptionsDiv.innerHTML = '';
            
            if (questionType === 'multiple-choice') {
                answerOptionsDiv.innerHTML = `
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">Answer Options</label>
                        <div id="mcOptions" class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="0" class="text-blue-600">
                                <input type="text" name="option" placeholder="Option 1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="1" class="text-blue-600">
                                <input type="text" name="option" placeholder="Option 2" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        <button type="button" onclick="addMCOption()" class="text-blue-600 hover:text-blue-800 text-sm">+ Add Option</button>
                    </div>
                `;
            } else if (questionType === 'true-false') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="tfCorrectAnswer" value="true" class="text-blue-600 mr-2">
                                <span>True</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tfCorrectAnswer" value="false" class="text-blue-600 mr-2">
                                <span>False</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (questionType === 'short-answer') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="shortAnswer" class="block text-sm font-medium text-gray-700 mb-2">Sample Answer (Optional)</label>
                        <textarea name="shortAnswer" id="shortAnswer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Provide a sample answer or key points..."></textarea>
                    </div>
                `;
            } else if (questionType === 'essay') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="essayAnswer" class="block text-sm font-medium text-gray-700 mb-2">Grading Rubric (Optional)</label>
                        <textarea name="essayAnswer" id="essayAnswer" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Describe the grading criteria or key points to look for..."></textarea>
                    </div>
                `;
            } else if (questionType === 'fill-in-blank') {
                answerOptionsDiv.innerHTML = `
                    <div>
                        <label for="fillBlankAnswer" class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <input type="text" name="fillBlankAnswer" id="fillBlankAnswer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter the correct answer" required>
                        <p class="text-sm text-gray-500 mt-1">Use _____ in your question text to indicate where the blank should be.</p>
                    </div>
                `;
            }
        }

        // Add new multiple choice option
        function addMCOption() {
            const mcOptions = document.getElementById('mcOptions');
            const optionCount = mcOptions.children.length;
            
            const newOption = document.createElement('div');
            newOption.className = 'flex items-center space-x-2';
            newOption.innerHTML = `
                <input type="radio" name="correctAnswer" value="${optionCount}" class="text-blue-600">
                <input type="text" name="option" placeholder="Option ${optionCount + 1}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <button type="button" onclick="removeMCOption(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
            `;
            
            mcOptions.appendChild(newOption);
        }

        // Remove multiple choice option
        function removeMCOption(button) {
            const mcOptions = document.getElementById('mcOptions');
            if (mcOptions.children.length > 2) {
                button.parentElement.remove();
                
                // Update radio button values
                const options = mcOptions.children;
                for (let i = 0; i < options.length; i++) {
                    const radio = options[i].querySelector('input[type="radio"]');
                    const textInput = options[i].querySelector('input[type="text"]');
                    radio.value = i;
                    textInput.placeholder = `Option ${i + 1}`;
                }
            }
        }

        // Auto-refresh dashboard data every 30 seconds
        let refreshInterval = null;

        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(async () => {
                try {
                    console.log(' Auto-refreshing dashboard data...');
                    const isConnected = await checkConnection();
                    if (isConnected) {
                        await loadDashboardData();
                        console.log(' Auto-refresh completed');
                    } else {
                        console.warn(' Auto-refresh skipped - database connection unavailable');
                    }
                } catch (error) {
                    console.error(' Auto-refresh failed:', error);
                }
            }, 30000); // 30 seconds
            
            console.log(' Auto-refresh started (30 second intervals)');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log(' Auto-refresh stopped');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            
            // Check authentication first
            if (!checkAuthentication()) {
                redirectToLogin();
                return;
            }
            
            // Authenticate with Supabase using a demo user
            await authenticateWithSupabase();
            
            // Check connection first
            const isConnected = await checkConnection();
            if (isConnected) {
                await loadDashboardData();
                // Start auto-refresh only after initial load succeeds
                startAutoRefresh();
            } else {
                showConnectionError();
            }
            
            // Initialize course management
            initializeCourseManagement();
        });

        // Stop auto-refresh when page is about to unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // Pause auto-refresh when page is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
                console.log(' Page hidden - pausing auto-refresh');
            } else {
                startAutoRefresh();
                console.log(' Page visible - resuming auto-refresh');
            }
        });

        // Question form submission
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const assignmentId = document.getElementById('questionAssignmentSelect').value;
            const questionText = formData.get('questionText');
            const questionType = formData.get('questionType');
            const points = formData.get('points');
            const difficulty = formData.get('difficulty');
            const explanation = formData.get('explanation');
            
            if (!assignmentId) {
                showError('Please select an assignment first');
                return;
            }
            
            if (!questionText || !questionType) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Collect answer options based on question type
            let options = null;
            let correctAnswer = null;
            
            if (questionType === 'multiple-choice') {
                const optionInputs = document.querySelectorAll('[name="option"]');
                const correctAnswerInput = document.querySelector('[name="correctAnswer"]:checked');
                
                options = Array.from(optionInputs).map(input => input.value).filter(val => val.trim());
                correctAnswer = correctAnswerInput ? correctAnswerInput.value : null;
                
                if (options.length < 2) {
                    showError('Please provide at least 2 options for multiple choice questions');
                    return;
                }
                if (!correctAnswer) {
                    showError('Please select the correct answer');
                    return;
                }
            } else if (questionType === 'true-false') {
                const correctAnswerInput = document.querySelector('[name="tfCorrectAnswer"]:checked');
                correctAnswer = correctAnswerInput ? correctAnswerInput.value : null;
                
                if (!correctAnswer) {
                    showError('Please select the correct answer for true/false question');
                    return;
                }
            } else if (questionType === 'short-answer' || questionType === 'essay') {
                correctAnswer = formData.get('shortAnswer') || formData.get('essayAnswer');
            } else if (questionType === 'fill-in-blank') {
                correctAnswer = formData.get('fillBlankAnswer');
                if (!correctAnswer) {
                    showError('Please provide the correct answer for fill-in-the-blank question');
                    return;
                }
            }
            
            // Show loading state
            const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                // Create question in database
                const { data, error } = await supabase
                    .from('questions')
                    .insert({
                        assignment_id: assignmentId,
                        question_text: questionText,
                        question_type: questionType,
                        options: options ? JSON.stringify(options) : null,
                        correct_answer: correctAnswer,
                        points: parseInt(points) || 1,
                        difficulty: difficulty || 'medium',
                        explanation: explanation || null
                    })
                    .select();
                
                if (error) throw error;
                
                // Reset form and close modal
                e.target.reset();
                closeQuestionModal();
                
                // Refresh questions list
                await loadQuestionsForAssignment();
                updateLastUpdated();
                
                // Show success message
                alert('Question created successfully!');
                
            } catch (error) {
                console.error('Error creating question:', error);
                showError('Failed to create question: ' + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
        });

        // Question management functions
        function editQuestion(questionId) {
            console.log('Editing question:', questionId);
            // TODO: Implement question editing functionality
            alert('Question editing functionality will be implemented soon.');
        }

        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('questions')
                    .delete()
                    .eq('id', questionId);
                
                if (error) throw error;
                
                await loadQuestionsForAssignment();
                updateLastUpdated();
                
                alert('Question deleted successfully!');
            } catch (error) {
                console.error('Error deleting question:', error);
                showError('Failed to delete question');
            }
        }
        
        function checkAuthentication() {
            return localStorage.getItem('adminAuthenticated') === 'true';
        }
        
        function redirectToLogin() {
            if (window.isElectron) {
                window.location.href = '#/admin-login';
            } else {
                window.location.href = 'admin-login.html';
            }
        }
        
        async function authenticateWithSupabase() {
             try {
                 // For admin dashboard, we'll use a service role approach
                 // First check if we can access the database without authentication
                 const { data: testData, error: testError } = await supabase
                     .from('user_profiles')
                     .select('id')
                     .limit(1);
                 
                 if (!testError) {
                     console.log(' Admin dashboard connected to Supabase (public access)');
                     return true;
                 }
                 
                 // If public access fails, try with a valid admin email
                 const { data, error } = await supabase.auth.signInWithPassword({
                     email: 'admin@edlingo.com',
                     password: 'admin123456'
                 });
                 
                 if (error) {
                     console.warn('Admin auth failed, attempting to create admin user:', error.message);
                     
                     // Try to create the admin user with a valid email format
                     const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                         email: 'admin@edlingo.com',
                         password: 'admin123456',
                         options: {
                             data: {
                                 full_name: 'Admin User',
                                 role: 'admin'
                             }
                         }
                     });
                     
                     if (signUpError) {
                         console.error('Failed to create admin user:', signUpError);
                         // Continue without authentication for read-only access
                         console.log(' Continuing with read-only access');
                         return false;
                     } else {
                         console.log(' Admin user created successfully');
                         return true;
                     }
                 } else {
                     console.log(' Authenticated with Supabase as admin');
                     return true;
                 }
             } catch (error) {
                 console.error('Authentication error:', error);
                 return false;
             }
         }
         
         async function logout() {
             try {
                 await supabase.auth.signOut();
                 localStorage.removeItem('adminAuthenticated');
                 redirectToLogin();
             } catch (error) {
                 console.error('Logout error:', error);
             }
         }
        
        function showConnectionError() {
            const errorMessage = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                        <h3 class="text-red-800 font-medium">Database Connection Error</h3>
                    </div>
                    <p class="text-red-700 mt-2">Unable to connect to the database. Please check:</p>
                    <ul class="text-red-700 mt-2 ml-4 list-disc">
                        <li>Database is running and accessible</li>
                        <li>Environment variables are correctly set</li>
                        <li>Database schema has been applied</li>
                    </ul>
                    <p class="text-red-700 mt-2">See SETUP_DATABASE.md for setup instructions.</p>
                </div>
            `;
            document.querySelector('main').innerHTML = errorMessage;
            lucide.createIcons();
        }

        async function loadDashboardData() {
            try {
                console.log(' Loading dashboard data...');
                await Promise.all([
                    loadStats(),
                    loadUsers(),
                    loadVocabulary(),
                    loadGrammarLessons(),
                    loadCourses(),
                    loadAssignments(),
                    loadRecentActivity()
                ]);
                updateLastUpdated();
                console.log(' Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleString();
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Last updated: ${timeString}`;
            }
        }

        async function loadCourses() {
            try {
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('id,title,description,level,language,duration,duration_weeks,hours_per_week,is_active,created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const coursesList = document.getElementById('courses-list');
                
                if (!courses || courses.length === 0) {
                    if (coursesList) {
                        coursesList.innerHTML = `
                            <div class="text-center py-12">
                                <i data-lucide="book-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
                                <p class="text-gray-500 mb-4">Create your first course to get started.</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showAddCourseModal()">
                                    Create Course
                                </button>
                            </div>
                            <!-- Test Course Card for debugging -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow mt-4">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Test Course</h3>
                                        <p class="text-gray-600 mb-3">This is a test course for debugging the edit functionality</p>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                beginner
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                Spanish
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                10 hours
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500">Created: Today</p>
                                    </div>
                                    <div class="flex space-x-2 ml-4">
                                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="editCourse('test-course-id')">
                                            <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                                            Edit
                                        </button>
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="deleteCourse('test-course-id')">
                                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                                    <span class="text-sm text-gray-500">
                                        Status: <span class="font-medium text-green-600">
                                            Active
                                        </span>
                                    </span>
                                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="viewCourseDetails('test-course-id')">
                                        View Details 
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    return;
                }

                if (coursesList) {
                    coursesList.innerHTML = courses.map(course => {
                        const createdAt = new Date(course.created_at).toLocaleDateString();
                        const durationText = course.duration ? `${course.duration} weeks` : 'Duration not set';
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${course.title || 'Untitled Course'}</h3>
                                        <p class="text-gray-600 mb-3">${course.description || 'No description'}</p>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                ${course.level || 'beginner'}
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                ${course.language || 'Language not set'}
                                            </span>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                ${durationText}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500">Created: ${createdAt}</p>
                                    </div>
                                    <div class="flex space-x-2 ml-4">
                                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="editCourse('${course.id}')">
                                            <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                                            Edit
                                        </button>
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="deleteCourse('${course.id}')">
                                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                                    <span class="text-sm text-gray-500">
                                        Status: <span class="font-medium ${course.is_active ? 'text-green-600' : 'text-red-600'}">
                                            ${course.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </span>
                                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="viewCourseDetails('${course.id}')">
                                        View Details 
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Re-initialize Lucide icons for the new content
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                const coursesList = document.getElementById('courses-list');
                if (coursesList) {
                    coursesList.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Error loading courses</h3>
                            <p class="text-red-500 mb-4">${error.message}</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="loadCourses()">
                                Try Again
                            </button>
                        </div>
                    `;
                    
                    // Re-initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }
        }

        async function loadAssignments() {
            try {
                const { data: assignments, error } = await supabase
                    .from('assignments')
                    .select('id,title,description,due_date,created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const assignmentsTableBody = document.getElementById('assignments-table-body');
                
                if (!assignments || assignments.length === 0) {
                    if (assignmentsTableBody) {
                        assignmentsTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                    No assignments found
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                if (assignmentsTableBody) {
                    assignmentsTableBody.innerHTML = assignments.map(assignment => {
                        const createdAt = new Date(assignment.created_at).toLocaleDateString();
                        const dueDate = assignment.due_date ? new Date(assignment.due_date).toLocaleDateString() : 'No due date';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${assignment.title || 'Untitled Assignment'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${assignment.description || 'No description'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${dueDate}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${assignment.max_score !== undefined ? assignment.max_score : 0} points
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editAssignment('${assignment.id}')">
                                        Edit
                                    </button>
                                    <button class="text-red-600 hover:text-red-900" onclick="deleteAssignment('${assignment.id}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                const assignmentsTableBody = document.getElementById('assignments-table-body');
                if (assignmentsTableBody) {
                    assignmentsTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-red-500">
                                Error loading assignments: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        async function loadStats() {
            try {
                console.log(' Loading stats...');
                // Load stats with fallback for missing tables
                const statsPromises = [
                    loadTableCount('user_profiles', 'total-users'),
                    loadTableCount('grammar_lessons', 'total-lessons'),
                    loadTableCount('user_vocabulary', 'total-vocabulary'),
                    loadTableCount('user_achievements', 'total-achievements'),
                    loadTableCount('courses', 'total-courses-stat')
                ];

                await Promise.allSettled(statsPromises);
                console.log(' Stats loaded');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadTableCount(tableName, elementId) {
            try {
                console.log(` Loading count for ${tableName}...`);
                
                // Try MCP first if in Electron environment
                if (window.isElectron && window.electronAPI?.runMcp) {
                    try {
                        console.log(` Using MCP for ${tableName} count...`);
                        const mcpResult = await window.electronAPI.runMcp(
                            'mcp.config.usrlocalmcp.Postgrest',
                            'postgrestRequest',
                            {
                                method: 'GET',
                                path: `/${tableName}?select=count()&head=true`
                            }
                        );
                        
                        if (mcpResult && !mcpResult.error) {
                            // PostgREST returns count in response headers or as a single value
                            let count = 0;
                            if (mcpResult.data && Array.isArray(mcpResult.data)) {
                                count = mcpResult.data.length;
                            } else if (mcpResult.count !== undefined) {
                                count = mcpResult.count;
                            } else if (typeof mcpResult.data === 'number') {
                                count = mcpResult.data;
                            }
                            
                            console.log(` MCP ${tableName} count: ${count}`);
                            document.getElementById(elementId).textContent = count;
                            return;
                        } else {
                            console.warn(` MCP failed for ${tableName}:`, mcpResult?.error);
                            // Fall through to Supabase client
                        }
                    } catch (mcpError) {
                        console.warn(` MCP error for ${tableName}:`, mcpError);
                        // Fall through to Supabase client
                    }
                }
                
                // Fallback to direct Supabase client
                console.log(` Using Supabase client for ${tableName} count...`);
                const adminTables = ['user_profiles', 'user_achievements', 'user_vocabulary'];
                const client = adminTables.includes(tableName) ? supabaseAdmin : supabase;
                const { count, error } = await client
                    .from(tableName)
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === '42P01') {
                        // Table doesn't exist
                        console.warn(` Table ${tableName} does not exist, setting count to 0`);
                        document.getElementById(elementId).textContent = '0';
                    } else if (error.code === '42501' || error.message.includes('row-level security')) {
                        // RLS policy restriction - show 0 for user_profiles, demo for others
                        console.warn(` RLS restriction for ${tableName}`);
                        if (tableName === 'user_profiles') {
                            document.getElementById(elementId).textContent = '0';
                        } else {
                            const demoCount = getDemoCount(tableName);
                            document.getElementById(elementId).textContent = demoCount;
                        }
                    } else {
                        console.error(` Error with table ${tableName}:`, error);
                        document.getElementById(elementId).textContent = '0';
                    }
                } else {
                    console.log(` ${tableName} count: ${count}`);
                    document.getElementById(elementId).textContent = count || 0;
                }
            } catch (error) {
                console.error(`Error loading count for ${tableName}:`, error);
                // Show appropriate message based on error type
                if (tableName === 'user_profiles') {
                    if (error.code === '42501' || error.message.includes('row-level security')) {
                        document.getElementById(elementId).textContent = 'RLS Active';
                        document.getElementById(elementId).title = 'Row Level Security policies are preventing access to user count';
                    } else {
                        document.getElementById(elementId).textContent = '0';
                    }
                } else {
                    const demoCount = getDemoCount(tableName);
                    document.getElementById(elementId).textContent = demoCount;
                }
            }
        }
        
        function getDemoCount(tableName) {
            const demoCounts = {
                'user_profiles': 5,
                'grammar_lessons': 12,
                'user_vocabulary': 248,
                'user_achievements': 18,
                'courses': 3
            };
            return demoCounts[tableName] || 0;
        }

        async function loadUsers() {
            try {
                console.log(' Loading users from auth.users...');
                
                // Try to load users from auth.users table (requires admin access)
                let { data: authUsers, error: authError } = await supabaseAdmin.auth.admin.listUsers();
                
                if (authError) {
                    console.warn('Failed to load from auth.users, trying user_profiles:', authError.message);
                    
                    // Fallback to user_profiles table
                    let { data: users, error } = await supabaseAdmin
                        .from('user_profiles')
                        .select(`
                            id,
                            email,
                            full_name,
                            created_at,
                            avatar_url,
                            last_active_at,
                            user_progress(
                                current_level,
                                total_xp,
                                daily_streak
                            )
                        `)
                        .order('created_at', { ascending: false });

                    if (error) {
                        // If relationship fails, try loading users without progress
                        console.warn('Failed to load users with progress, trying without:', error.message);
                        
                        const { data: simpleUsers, error: simpleError } = await supabaseAdmin
                            .from('user_profiles')
                            .select('id,email,full_name,created_at,avatar_url,last_active_at')
                            .order('created_at', { ascending: false });
                        
                        if (simpleError) {
                            if (simpleError.code === '42P01') {
                                // Table doesn't exist
                                const tableBody = document.getElementById('users-table-body-tab');
                                if (tableBody) {
                                    tableBody.innerHTML = `
                                        <tr>
                                            <td colspan="6" class="px-6 py-4">
                                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                    <div class="flex items-center">
                                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
                                                        <h3 class="text-sm font-medium text-blue-800">No User Data</h3>
                                                    </div>
                                                    <div class="mt-2 text-sm text-blue-700">
                                                        <p>The user_profiles table doesn't exist yet. Users will appear here once they start using the application.</p>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                    lucide.createIcons();
                                }
                                return;
                            }
                            throw simpleError;
                        }
                        
                        users = simpleUsers;
                    }
                    
                    // Process user_profiles data
                    await renderUsersTable(users, 'user_profiles');
                    return;
                }
                
                // Process auth.users data
                 const users = authUsers.users || [];
                 await renderUsersTable(users, 'auth_users');
                 
            } catch (error) {
                console.error('Error loading users:', error);
                await handleUserLoadError(error);
            }
        }
        
        async function renderUsersTable(users, dataSource) {
            const tableBody = document.getElementById('users-table-body-tab');
            if (!tableBody) {
                console.error(' Could not find users-table-body-tab element');
                return;
            }
            
            console.log(` Found ${users ? users.length : 0} users from ${dataSource}`);
            
            if (!users || users.length === 0) {
                console.log(' No users found');
                
                // Update the total users count to 0 in the overview
                const totalUsersElement = document.getElementById('total-users');
                if (totalUsersElement) {
                    totalUsersElement.textContent = '0';
                }
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="users" class="w-5 h-5 text-blue-600 mr-2"></i>
                                    <h3 class="text-sm font-medium text-blue-800">No Users Found</h3>
                                </div>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>No users have registered yet. Users will appear here once they sign up for the application.</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            console.log(' Rendering user table with', users.length, 'users');
            
            // Update the total users count in the overview
            const totalUsersElement = document.getElementById('total-users');
            if (totalUsersElement) {
                totalUsersElement.textContent = users.length;
            }
            
            tableBody.innerHTML = users.map(user => {
                // Handle different data formats
                let userId, email, fullName, createdAt, progress;
                
                if (dataSource === 'auth_users') {
                    // auth.users format
                    userId = user.id;
                    email = user.email;
                    fullName = user.user_metadata?.full_name || user.user_metadata?.name || email;
                    createdAt = new Date(user.created_at).toLocaleDateString();
                    progress = {}; // No progress data from auth.users
                } else {
                    // user_profiles format
                    userId = user.id;
                    email = user.email;
                    fullName = user.full_name || email;
                    createdAt = new Date(user.created_at).toLocaleDateString();
                    progress = user.user_progress?.[0] || {};
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
                            ${userId.substring(0, 8)}...
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${email || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${fullName || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${createdAt}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-500">Level: ${progress.current_level || 'beginner'}</span>
                                <span class="text-xs text-gray-500">XP: ${progress.total_xp || 0}</span>
                                <span class="text-xs text-gray-500">Streak: ${progress.daily_streak || 0}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewUser('${userId}')">
                                View
                            </button>
                            <button class="text-red-600 hover:text-red-900" onclick="deleteUser('${userId}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            console.log(' User table rendered successfully');
        }
        
        async function handleUserLoadError(error) {
            console.error('Error loading users:', error);
            const tableBody = document.getElementById('users-table-body-tab');
            if (!tableBody) return;
            
            // Handle RLS restrictions
            if (error.code === '42501' || error.message.includes('row-level security')) {
                console.log(' RLS restriction detected');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="shield-alert" class="w-5 h-5 text-yellow-600 mr-2"></i>
                                    <h3 class="text-sm font-medium text-yellow-800">Row Level Security Active</h3>
                                </div>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p>The user_profiles table has Row Level Security (RLS) policies enabled.</p>
                                    <p class="mt-1">This prevents unauthorized access to user data, which is a security feature.</p>
                                    <p class="mt-2"><strong>To view users:</strong></p>
                                    <ul class="list-disc ml-4 mt-1">
                                        <li>Authenticate as an admin user, or</li>
                                        <li>Modify RLS policies to allow admin access, or</li>
                                        <li>Use the service role key instead of anon key</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-yellow-600">Current status: Using anonymous access (limited permissions)</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                                    <h3 class="text-sm font-medium text-red-800">Error Loading Users</h3>
                                </div>
                                <div class="mt-2 text-sm text-red-700">
                                    <p>Failed to load user data: ${error.message}</p>
                                    <p class="mt-1">Please check the database connection and table structure.</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            lucide.createIcons();
        }

         // User management functions
         function viewUser(userId) {
             alert(`View user details for ID: ${userId}\n\nThis feature will show detailed user information, progress, and activity history.`);
         }

         function deleteUser(userId) {
             if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                 // In a real implementation, this would delete the user from the database
                 console.log(`Delete user with ID: ${userId}`);
                 alert('User deletion functionality would be implemented here.');
             }
         }

        async function loadVocabulary() {
            try {
                const { data: vocabulary, error } = await supabase
                    .from('user_vocabulary')
                    .select('id,word,translation,difficulty_level,created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const vocabularyList = document.getElementById('vocabulary-list');
                
                if (!vocabulary || vocabulary.length === 0) {
                    vocabularyList.innerHTML = '<div class="text-center text-gray-500">No vocabulary words found</div>';
                    return;
                }

                vocabularyList.innerHTML = vocabulary.map(word => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div>
                            <h3 class="font-medium text-gray-900">${word.word}</h3>
                            <p class="text-sm text-gray-500">${word.translation}</p>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${word.difficulty_level || 'beginner'}
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editVocabulary('${word.id}')">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteVocabulary('${word.id}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading vocabulary:', error);
                document.getElementById('vocabulary-list').innerHTML = `
                    <div class="text-center text-red-500">Error loading vocabulary: ${error.message}</div>
                `;
            }
        }

        async function loadGrammarLessons() {
            try {
                // Check if grammar_lessons table exists first
                const { data: lessons, error } = await supabase
                    .from('grammar_lessons')
                    .select('id,title,description,language,level,created_at,is_active')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    // If table doesn't exist, show setup message
                    if (error.message.includes('does not exist')) {
                        document.getElementById('lessons-list').innerHTML = `
                            <div class="text-center p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="text-yellow-800 mb-2">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-2"></i>
                                    <h3 class="font-medium">Grammar Lessons Table Missing</h3>
                                </div>
                                <p class="text-sm text-yellow-700 mb-3">
                                    The grammar_lessons table needs to be created in your Supabase database.
                                </p>
                                <button onclick="showGrammarSetupInstructions()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                                    Show Setup Instructions
                                </button>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                    throw error;
                }

                const lessonsList = document.getElementById('lessons-list');
                
                if (!lessons || lessons.length === 0) {
                    lessonsList.innerHTML = '<div class="text-center text-gray-500">No grammar lessons found</div>';
                    return;
                }

                lessonsList.innerHTML = lessons.map(lesson => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div>
                            <h3 class="font-medium text-gray-900">${lesson.title}</h3>
                            <p class="text-sm text-gray-500">${lesson.description}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    ${lesson.level || 'beginner'}
                                </span>
                                <span class="text-xs text-gray-500">Language: ${lesson.language || 'Spanish'}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="editLesson('${lesson.id}')">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteLesson('${lesson.id}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading grammar lessons:', error);
                document.getElementById('lessons-list').innerHTML = `
                    <div class="text-center text-red-500">Error loading lessons: ${error.message}</div>
                `;
            }
        }

        // Utility functions
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleString();
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Last updated: ${timeString}`;
            }
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

        function showSuccess(message) {
            alert(`Success: ${message}`);
        }

        function saveDraft() {
            // Save current wizard data as draft
            saveCurrentStepData();
            
            // Store draft in localStorage for now (in production, save to database)
            localStorage.setItem('courseWizardDraft', JSON.stringify(courseWizardData));
            
            showSuccess('Draft saved successfully!');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

            if (diffInMinutes < 60) {
                return `${diffInMinutes} minutes ago`;
            } else if (diffInHours < 24) {
                return `${diffInHours} hours ago`;
            } else {
                return `${diffInDays} days ago`;
            }
        }

        async function loadRecentActivity() {
            try {
                console.log('Loading recent activity...');

                // Connection guard to fail fast with better error handling
                if (typeof checkConnection === 'function') {
                    const ok = await checkConnection();
                    if (!ok) {
                        const activityList = document.getElementById('activity-list');
                        if (activityList) {
                            activityList.innerHTML = `
                                <div class="text-center p-6">
                                    <div class="text-yellow-600 mb-4">
                                        <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-2"></i>
                                        <h3 class="text-lg font-semibold">Database connection unavailable</h3>
                                    </div>
                                    <p class="text-gray-600">Please ensure the database is reachable and try again.</p>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                        return;
                    }
                }

                // Step 1: fetch recent sessions with minimal columns (avoid select(*))
                const { data: sessions, error: sessionsError } = await supabase
                    .from('learning_sessions')
                    .select('id,user_id,created_at,lesson_type,completed')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (sessionsError) {
                    console.error('Supabase error in loadRecentActivity (sessions):', sessionsError);
                    throw sessionsError;
                }

                console.log('Recent activity sessions:', sessions);
                const activityList = document.getElementById('activity-list');
                
                if (!sessions || sessions.length === 0) {
                    activityList.innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-gray-400 mb-4">
                                <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2"></i>
                                <h3 class="text-lg font-semibold text-gray-600">No Recent Activity</h3>
                            </div>
                            <p class="text-gray-500 mb-4">Learning sessions will appear here once users start using the application.</p>
                            <div class="text-sm text-gray-400">
                                <p> Tip: Users need to complete lessons or assessments to generate activity data.</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Step 2: fetch user profiles in separate call (avoid relational select)
                const userIds = Array.from(new Set(sessions.map(s => s.user_id).filter(Boolean)));
                let profilesById = {};
                if (userIds.length > 0) {
                    const { data: profiles, error: profilesError } = await supabase
                        .from('user_profiles')
                        .select('id,full_name,email')
                        .in('id', userIds);

                    if (profilesError) {
                        console.warn('Non-fatal: failed to fetch user profiles for recent activity:', profilesError);
                    } else if (profiles && profiles.length) {
                        profilesById = profiles.reduce((acc, p) => {
                            acc[p.id] = p;
                            return acc;
                        }, {});
                    }
                }

                // Render list
                activityList.innerHTML = sessions.map(activity => {
                    const profile = profilesById[activity.user_id] || null;
                    const userName = profile?.full_name || profile?.email || 'Unknown User';
                    const timeAgo = getTimeAgo(new Date(activity.created_at));
                    const action = activity.completed ? 'Completed session' : 'Started session';
                    const target = activity.lesson_type || 'Learning session';
                    
                    return `
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${userName}</p>
                                <p class="text-sm text-gray-500">${action}: ${target}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="text-xs text-gray-400">${timeAgo}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading recent activity:', error);
                const activityList = document.getElementById('activity-list');
                if (activityList) {
                    const msg = (error && error.message) ? error.message : 'Unknown error';
                    activityList.innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-red-600 mb-4">
                                <i data-lucide="wifi-off" class="w-12 h-12 mx-auto mb-2"></i>
                                <h3 class="text-lg font-semibold">Unable to load recent activity</h3>
                            </div>
                            <p class="text-gray-600 mb-2">${msg}</p>
                            <p class="text-gray-500">Please check your internet connection or try again shortly.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        }

        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('[id$="-tab"]');
            tabs.forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active state to selected tab
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Load data for specific tabs
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'questions') {
                loadQuestions();
            }
        }

        // Modal functions
        function showAddCourseModal() {
            // Reset modal to create mode
            const modalTitleElement = document.getElementById('courseModalTitle');
            const finishBtnElement = document.getElementById('finishBtn');
            
            if (modalTitleElement) {
                modalTitleElement.textContent = 'Create New Course';
            }
            if (finishBtnElement) {
                finishBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Create Course';
            }
            
            // Clear any edit data
            const form = document.getElementById('courseForm');
            delete form.dataset.courseId;
            delete form.dataset.isEdit;
            form.reset();
            
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.add('hidden');
            
            // Reset form and clear edit data
            const form = document.getElementById('courseForm');
            form.reset();
            delete form.dataset.courseId;
            delete form.dataset.isEdit;
            
            // Reset modal to default state
            const modalTitleElement = document.getElementById('courseModalTitle');
            const finishBtnElement = document.getElementById('finishBtn');
            
            if (modalTitleElement) {
                modalTitleElement.textContent = 'Create New Course';
            }
            if (finishBtnElement) {
                finishBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Create Course';
            }
            
            // Reset wizard to first step
            showWizardStep(1);
        }

        // Course Creation Wizard Functions
        let currentWizardStep = 1;
        const totalWizardSteps = 4;
        let courseWizardData = {};

        function showWizardStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= totalWizardSteps; i++) {
                const step = document.getElementById(`step-${i}`);
                if (step) {
                    step.classList.add('hidden');
                }
            }
            
            // Show current step
            const currentStep = document.getElementById(`step-${stepNumber}`);
            if (currentStep) {
                currentStep.classList.remove('hidden');
            }
            
            // Ensure a default lesson with one material exists when entering Course Content (Step 2)
            if (stepNumber === 2) {
                try {
                    const lessonsContainer = document.getElementById('lessonsContainer');
                    if (lessonsContainer) {
                        const existingLessons = lessonsContainer.querySelectorAll('.lesson-item');
                        if (existingLessons.length === 0 && typeof addLesson === 'function') {
                            // Add the first lesson
                            addLesson();
                            
                            // Add a default content item and basic defaults
                            const firstLesson = lessonsContainer.querySelector('.lesson-item');
                            if (firstLesson) {
                                const titleInput = firstLesson.querySelector('.lesson-title');
                                if (titleInput && !titleInput.value) {
                                    titleInput.value = 'Lesson 1';
                                }
                                const objectivesInput = firstLesson.querySelector('.lesson-objectives');
                                if (objectivesInput && !objectivesInput.value) {
                                    objectivesInput.value = 'Introduce the lesson and outline goals.';
                                }
                                
                                const addContentBtn = firstLesson.querySelector('button[onclick*="addLessonContent"]');
                                if (addContentBtn) {
                                    addContentBtn.click();
                                    
                                    const contentItem = firstLesson.querySelector('.content-item');
                                    if (contentItem) {
                                        const contentTitle = contentItem.querySelector('.content-title');
                                        if (contentTitle && !contentTitle.value) {
                                            contentTitle.value = 'Welcome Text';
                                        }
                                        const contentText = contentItem.querySelector('.content-text');
                                        if (contentText && !contentText.value) {
                                            contentText.value = 'This is a starter material. Replace or add more as needed.';
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Failed to inject default lesson/material:', e);
                }
            }
            
            // Update navigation highlighting
            updateNavigationHighlighting(stepNumber);
            
            // Update progress indicator
            updateProgressIndicator(stepNumber);
            
            // Update navigation buttons
            updateNavigationButtons(stepNumber);
            
            currentWizardStep = stepNumber;
        }

        function updateNavigationHighlighting(currentStep) {
            // Reset all navigation items
            for (let i = 1; i <= totalWizardSteps; i++) {
                const navItem = document.getElementById(`step${i}Nav`);
                const circle = navItem?.querySelector('div');
                
                if (navItem && circle) {
                    if (i === currentStep) {
                        // Current step - highlighted
                        navItem.className = 'flex items-center p-3 rounded-lg bg-blue-100 text-blue-700 cursor-pointer';
                        circle.className = 'w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center mr-3';
                    } else {
                        // Other steps - default
                        navItem.className = 'flex items-center p-3 rounded-lg text-gray-500 cursor-pointer';
                        circle.className = 'w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-3';
                    }
                }
            }
        }

        function updateProgressIndicator(currentStep) {
            // Update textual step indicator (e.g., "Step 2 of 4")
            const stepIndicator = document.getElementById('stepIndicator');
            if (stepIndicator) {
                stepIndicator.textContent = `Step ${currentStep} of ${totalWizardSteps}`;
            }

            // Update the step title based on the current step
            const stepTitle = document.getElementById('stepTitle');
            if (stepTitle) {
                const titles = {
                    1: 'Basic Information',
                    2: 'Course Content',
                    3: 'Instructor Settings',
                    4: 'Review & Publish'
                };
                stepTitle.textContent = titles[currentStep] || '';
            }

            // Update the progress bar width. Prefer the header progress bar inside the course modal.
            const courseModal = document.getElementById('courseModal');
            const progressBar = courseModal ? courseModal.querySelector('#progressBar') : document.getElementById('progressBar');
            if (progressBar) {
                const percent = Math.max(0, Math.min(100, (currentStep / totalWizardSteps) * 100));
                progressBar.style.width = `${percent}%`;
            }
        }

        function updateNavigationButtons(currentStep) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const createBtn = document.getElementById('finishBtn');
            
            // Previous button
            if (prevBtn) {
                prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
            }
            
            // Next/Create button
            if (currentStep === totalWizardSteps) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (createBtn) createBtn.style.display = 'inline-flex';
                // Update review step when reaching final step
                updateReviewStep();
            } else {
                if (nextBtn) nextBtn.style.display = 'inline-flex';
                if (createBtn) createBtn.style.display = 'none';
            }
        }

        function nextWizardStep() {
            if (validateCurrentStep() && currentWizardStep < totalWizardSteps) {
                saveCurrentStepData();
                showWizardStep(currentWizardStep + 1);
            }
        }

        function prevWizardStep() {
            if (currentWizardStep > 1) {
                showWizardStep(currentWizardStep - 1);
            }
        }

        function validateCurrentStep() {
            switch (currentWizardStep) {
                case 1: // Basic Information
                    const title = document.getElementById('courseTitle')?.value;
                    const category = document.getElementById('courseCategory')?.value;
                    const cefrLevel = document.getElementById('cefrLevel')?.value;
                    if (!title || !category || !cefrLevel) {
                        showError('Please fill in all required fields');
                        return false;
                    }
                    return true;
                case 2: // Course Content
                    const objectives = document.getElementById('learningObjectives')?.value;
                    if (!objectives) {
                        showError('Please provide learning objectives');
                        return false;
                    }
                    return true;
                case 3: // Instructor Settings
                    const instructorName = document.getElementById('instructorName')?.value;
                    const instructorEmail = document.getElementById('instructorEmail')?.value;
                    if (!instructorName || !instructorEmail) {
                        showError('Please provide instructor information');
                        return false;
                    }
                    return true;
                case 4: // Review & Publish
                    return true;
                default:
                    return true;
            }
        }

        function saveCurrentStepData() {
            switch (currentWizardStep) {
                case 1: // Basic Information
                    courseWizardData.title = document.getElementById('courseTitle')?.value;
                    courseWizardData.category = document.getElementById('courseCategory')?.value;
                    courseWizardData.description = document.getElementById('courseDescription')?.value;
                    courseWizardData.cefrLevel = document.getElementById('cefrLevel')?.value;
                    courseWizardData.language = document.getElementById('courseLanguage')?.value;
                    courseWizardData.duration = document.getElementById('courseDuration')?.value;
                    courseWizardData.hoursPerWeek = document.getElementById('courseHours')?.value;
                    courseWizardData.maxStudents = document.getElementById('maxStudents')?.value;
                    courseWizardData.price = document.getElementById('coursePrice')?.value;
                    courseWizardData.currency = document.getElementById('courseCurrency')?.value;
                    break;
                case 2: // Course Content
                    courseWizardData.learningObjectives = document.getElementById('learningObjectives')?.value;
            courseWizardData.prerequisites = document.getElementById('prerequisites')?.value;
            // Collect skills focus selections
            courseWizardData.skillsFocus = Array.from(document.querySelectorAll('input[name="skillsFocus"]:checked')).map(cb => cb.value);
            courseWizardData.materials = document.getElementById('requiredMaterials')?.value;
                    courseWizardData.syllabus = document.getElementById('courseSyllabus')?.value;
                    
                    // Collect lesson data
                    try {
                        courseWizardData.lessons = collectLessonsData();
                        console.log(' Lessons data collected and saved to courseWizardData:', courseWizardData.lessons);
                    } catch (error) {
                        console.error(' Error collecting lessons data:', error);
                        courseWizardData.lessons = [];
                    }
                    break;
                case 3: // Instructor Settings
                    courseWizardData.instructorName = document.getElementById('instructorName')?.value;
                    courseWizardData.instructorEmail = document.getElementById('instructorEmail')?.value;
                    courseWizardData.instructorBio = document.getElementById('instructorBio')?.value;
                    courseWizardData.startDate = document.getElementById('startDate')?.value;
                    courseWizardData.enrollmentDeadline = document.getElementById('enrollmentDeadline')?.value;
                    courseWizardData.cancellationPolicy = document.getElementById('cancellationPolicy')?.value;
                    break;
                case 4: // Review & Publish
                    // All data already saved in previous steps
                    break;
            }
        }

        function updateReviewStep() {
            // Update course summary
            const courseSummary = document.getElementById('courseSummary');
            const courseDetailsReview = document.getElementById('courseDetailsReview');
            const instructorReview = document.getElementById('instructorReview');

            // Render lessons & materials into the review step
            const lessonsReview = document.getElementById('lessonsReview');
            if (lessonsReview) {
                const renderLessons = (lessonsArr) => {
                    lessonsReview.innerHTML = '';
                    const lessonsData = Array.isArray(lessonsArr) ? lessonsArr : [];
                    if (lessonsData.length === 0) {
                        lessonsReview.innerHTML = '<div class="text-sm text-gray-600">No lessons added yet. Go back to Step 2 to add lessons and materials.</div>';
                        return;
                    }
                    lessonsData.forEach((lesson, idx) => {
                        const safe = v => (v === null || v === undefined) ? '' : v;
                        const materials = Array.isArray(lesson.materials) ? lesson.materials : [];
                        const materialsHtml = materials.map((m, mi) => {
                            const type = (m.type || '').toUpperCase();
                            let detail = '';
                            if (m.type === 'text') {
                                const text = String(safe(m.content));
                                const preview = text.length > 140 ? text.slice(0, 140) + '' : text;
                                detail = `<div class=\"text-gray-700\">${preview}</div>`;
                            } else if (m.file_url || m.url) {
                                 const linkUrl = m.file_url || m.url;
                                 detail = `<a class=\"text-blue-700 underline break-all\" href=\"${linkUrl}\" target=\"_blank\" rel=\"noopener\">${linkUrl}</a>`;
                            } else if (m.content) {
                                detail = `<div class=\"text-gray-700\">${m.content}</div>`;
                            }
                            const meta = m.metadata ? `<div class=\"text-xs text-gray-500\">${Object.entries(m.metadata).map(([k,v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`).join('  ')}</div>` : '';
                            return `
                                <li class=\"pl-2\">
                                    <div class=\"text-sm\"><span class=\"inline-block px-2 py-0.5 rounded bg-gray-200 text-gray-800 mr-2\">${type}</span> ${m.metadata?.title || m.content || `Material ${mi+1}`}</div>
                                    ${detail}
                                    ${meta}
                                </li>
                            `;
                        }).join('');

                        const block = `
                            <div class=\"bg-white rounded border border-gray-200 p-3\">
                                <div class=\"font-medium text-gray-900\">Lesson ${lesson.order_number || idx + 1}: ${lesson.title || 'Untitled'}</div>
                                ${lesson.description ? `<div class=\"text-sm text-gray-600 mt-1\">${lesson.description}</div>` : ''}
                                <ul class=\"list-disc ml-5 mt-2 space-y-1\">${materialsHtml || '<li class=\"text-sm text-gray-500\">No materials added</li>'}</ul>
                            </div>
                        `;
                        lessonsReview.insertAdjacentHTML('beforeend', block);
                    });
                };

                // Resolve lessons if it's a Promise
                let candidate = (typeof courseWizardData !== 'undefined') ? courseWizardData.lessons : undefined;

                // Fallback: if no cached lessons yet but DOM has lessons, collect directly from DOM
                try {
                    const hasDomLessons = document.querySelectorAll('.lesson-item').length > 0;
                    if ((!candidate || (Array.isArray(candidate) && candidate.length === 0)) && hasDomLessons) {
                        const collected = collectLessonsData(); // async, returns a Promise
                        if (collected && typeof collected.then === 'function') {
                            courseWizardData.lessons = collected;
                            candidate = collected; // will be handled by the Promise branch below
                        } else if (Array.isArray(collected)) {
                            courseWizardData.lessons = collected;
                            candidate = collected;
                        }
                    }
                } catch (err) {
                    console.warn('Could not collect lessons on review step:', err);
                }

                if (candidate && typeof candidate.then === 'function') {
                    lessonsReview.innerHTML = '<div class="text-sm text-gray-600">Collecting lesson data</div>';
                    candidate.then(ls => renderLessons(ls)).catch(err => {
                        console.error('Failed to resolve lessons for review:', err);
                        lessonsReview.innerHTML = '<div class="text-sm text-red-700">Failed to load lessons. Please go back to Step 2 and try again.</div>';
                    });
                } else {
                    renderLessons(candidate);
                }
            }
            
            if (courseSummary) {
                const title = document.getElementById('courseTitle')?.value || 'Untitled Course';
                const category = document.getElementById('courseCategory')?.value || 'General';
                const cefrLevel = document.getElementById('cefrLevel')?.value || 'A1';
                const duration = document.getElementById('courseDuration')?.value || '4';
                const hours = document.getElementById('courseHours')?.value || '2';
                const price = document.getElementById('coursePrice')?.value || '0';
                const currency = document.getElementById('courseCurrency')?.value || 'USD';
                
                courseSummary.innerHTML = `
                    <div><strong>${title}</strong></div>
                    <div>Category: ${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div>CEFR Level: ${cefrLevel}</div>
                    <div>Duration: ${duration} weeks (${hours} hours/week)</div>
                    <div>Price: ${price} ${currency}</div>
                `;
            }
            
            if (courseDetailsReview) {
                const maxStudents = document.getElementById('maxStudents')?.value || '20';
                const duration = document.getElementById('courseDuration')?.value || '4';
                const hours = document.getElementById('courseHours')?.value || '2';
                const cefrLevel = document.getElementById('cefrLevel')?.value || 'A1';
                const category = document.getElementById('courseCategory')?.value || 'General';
                const language = document.getElementById('courseLanguage')?.value || 'English';
                
                courseDetailsReview.innerHTML = `
                    <div>Max Students: ${maxStudents}</div>
                    <div>Duration: ${duration} weeks</div>
                    <div>Hours per week: ${hours}</div>
                    <div>CEFR Level: ${cefrLevel}</div>
                    <div>Category: ${category}</div>
                    <div>Language: ${language}</div>
                `;
            }
            
            if (instructorReview) {
                const instructorName = document.getElementById('instructorName')?.value || 'Not specified';
                const instructorEmail = document.getElementById('instructorEmail')?.value || 'Not specified';
                const startDate = document.getElementById('startDate')?.value || 'Not set';
                const enrollmentDeadline = document.getElementById('enrollmentDeadline')?.value || 'Not set';
                
                instructorReview.innerHTML = `
                    <div>Name: ${instructorName}</div>
                    <div>Email: ${instructorEmail}</div>
                    <div>Start Date: ${startDate}</div>
                    <div>Enrollment Deadline: ${enrollmentDeadline}</div>
                `;
            }
        }



        // Lesson Management Functions
        function addLesson() {
            const lessonsContainer = document.getElementById('lessonsContainer');
            const lessonCount = document.querySelectorAll('.lesson-item').length + 1;
            
            const lessonHTML = `
                <div id="lesson-${lessonCount}" class="lesson-item bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-900">Lesson ${lessonCount}</h4>
                        <button type="button" onclick="removeLesson(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Title</label>
                            <input type="text" class="lesson-title w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter lesson title">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">CEFR Level</label>
                            <select class="lesson-cefr w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="A1">A1 - Beginner</option>
                                <option value="A2">A2 - Elementary</option>
                                <option value="B1">B1 - Intermediate</option>
                                <option value="B2">B2 - Upper Intermediate</option>
                                <option value="C1">C1 - Advanced</option>
                                <option value="C2">C2 - Proficient</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes)</label>
                            <input type="number" class="lesson-duration w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="30" min="5" max="120">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                            <select class="lesson-content-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="mixed">Mixed Content</option>
                                <option value="reading">Reading Focus</option>
                                <option value="listening">Listening Focus</option>
                                <option value="speaking">Speaking Focus</option>
                                <option value="writing">Writing Focus</option>
                                <option value="grammar">Grammar Focus</option>
                                <option value="vocabulary">Vocabulary Focus</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Learning Objectives</label>
                        <textarea class="lesson-objectives w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="What will students learn in this lesson?"></textarea>
                    </div>
                    
                    <!-- Lesson Content Section -->
                    <div class="mt-4 border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-medium text-gray-800">Lesson Content</h5>
                            <button type="button" onclick="addLessonContent(this)" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Add Content
                            </button>
                        </div>
                        <div class="lesson-content-container space-y-3">
                            <!-- Content items will be added here -->
                        </div>
                    </div>
                    
                    <div class="mt-3 flex space-x-2">
                        <button type="button" onclick="generateLessonContent(this)" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                            AI Generate Content
                        </button>
                        <button type="button" onclick="addLessonQuestions(this)" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <i data-lucide="help-circle" class="w-4 h-4 inline mr-1"></i>
                            Add Questions
                        </button>
                    </div>
                </div>
            `;
            
            lessonsContainer.insertAdjacentHTML('beforeend', lessonHTML);
            lucide.createIcons();
        }

        function removeLesson(button) {
            if (!button) {
                console.error('Button element is null in removeLesson');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found');
                return;
            }
            lessonItem.remove();
            
            // Renumber remaining lessons
            document.querySelectorAll('.lesson-item').forEach((item, index) => {
                const title = item.querySelector('h4');
                if (title && title.textContent.startsWith('Lesson ')) {
                    title.textContent = `Lesson ${index + 1}`;
                }
            });
        }

        // Lesson Content Management Functions
        function addLessonContent(button) {
            if (!button) {
                console.error('Button element is null in addLessonContent');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found');
                return;
            }
            const contentContainer = lessonItem.querySelector('.lesson-content-container');
            const contentCount = contentContainer.querySelectorAll('.content-item').length + 1;
            
            const contentHTML = `
                <div class="content-item bg-white p-3 rounded border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h6 class="font-medium text-gray-700">Content Item ${contentCount}</h6>
                        <button type="button" onclick="removeLessonContent(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Content Type</label>
                            <select class="content-type w-full px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateContentFields(this)">
                                <option value="text">Text Content</option>
                                <option value="image">Image</option>
                                <option value="audio">Audio</option>
                                <option value="video">Video</option>
                                <option value="pdf">PDF Document</option>
                                <option value="quiz">Interactive Quiz</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Content Title</label>
                            <input type="text" class="content-title w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Enter content title">
                        </div>
                    </div>
                    
                    <!-- Dynamic content fields based on type -->
                    <div class="content-fields">
                        <!-- Text Content (default) -->
                        <div class="text-content-fields">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                            <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-2 flex space-x-2">
                        <button type="button" onclick="previewContent(this)" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                            <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>
                            Preview
                        </button>
                        <button type="button" onclick="moveContentUp(this)" class="px-2 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                            <i data-lucide="arrow-up" class="w-3 h-3 inline mr-1"></i>
                            Up
                        </button>
                        <button type="button" onclick="moveContentDown(this)" class="px-2 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
                            <i data-lucide="arrow-down" class="w-3 h-3 inline mr-1"></i>
                            Down
                        </button>
                    </div>
                </div>
            `;
            
            contentContainer.insertAdjacentHTML('beforeend', contentHTML);
            lucide.createIcons();
        }

        function removeLessonContent(button) {
            if (!button) {
                console.error('Button element is null in removeLessonContent');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const container = contentItem.parentElement;
            contentItem.remove();
            
            // Renumber remaining content items
            container.querySelectorAll('.content-item').forEach((item, index) => {
                const title = item.querySelector('h6');
                if (title && title.textContent.startsWith('Content Item ')) {
                    title.textContent = `Content Item ${index + 1}`;
                }
            });
        }

        function updateContentFields(selectElement) {
            if (!selectElement) {
                console.error('Select element is null in updateContentFields');
                return;
            }
            const contentItem = selectElement.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const contentFields = contentItem.querySelector('.content-fields');
            const contentType = selectElement.value;
            
            let fieldsHTML = '';
            
            switch(contentType) {
                case 'text':
                    fieldsHTML = `
                        <div class="text-content-fields">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                            <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                        </div>
                    `;
                    break;
                case 'image':
                    fieldsHTML = `
                        <div class="image-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Image Source</label>
                                    <select class="image-source-type w-full px-2 py-1 border border-gray-300 rounded text-sm mb-2" onchange="toggleImageSourceFields(this)">
                                        <option value="upload">Upload New Image</option>
                                        <option value="existing">Select Existing Image</option>
                                    </select>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="image/*" onchange="handleImageUpload(this)">
                                    <select class="existing-image-select w-full px-2 py-1 border border-gray-300 rounded text-sm" style="display: none;" onchange="handleExistingImageSelect(this)">
                                        <option value="">Loading existing images...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Alt Text</label>
                                    <input type="text" class="content-alt w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Describe the image">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Caption (optional)</label>
                                <input type="text" class="content-caption w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Image caption">
                            </div>
                            <!-- Image preview and management section -->
                            <div class="image-loaded-preview mt-3" style="display: none;">
                                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                                    <div class="flex items-start justify-between mb-2">
                                        <label class="block text-sm font-medium text-gray-600">Current Image</label>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                                Replace
                                            </button>
                                            <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                                <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                    <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview">
                                    <input type="hidden" class="current-image-url" value="">
                                    <input type="hidden" class="material-id" value="">
                                </div>
                            </div>
                            <!-- File replacement input (hidden) -->
                            <input type="file" class="replace-file-input" accept="image/*" style="display: none;" onchange="handleImageReplace(this)">
                        </div>
                    `;
                    break;
                case 'audio':
                    fieldsHTML = `
                        <div class="audio-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Audio File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="audio/*">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Duration (seconds)</label>
                                    <input type="number" class="content-duration w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Audio duration">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Transcript (optional)</label>
                                <textarea class="content-transcript w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Audio transcript for accessibility"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'video':
                    fieldsHTML = `
                        <div class="video-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Video File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept="video/*">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Duration (seconds)</label>
                                    <input type="number" class="content-duration w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Video duration">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Video Description</label>
                                <textarea class="content-description w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Describe what the video covers"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'pdf':
                    fieldsHTML = `
                        <div class="pdf-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">PDF File</label>
                                    <input type="file" class="content-file w-full px-2 py-1 border border-gray-300 rounded text-sm" accept=".pdf">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Page Range (optional)</label>
                                    <input type="text" class="content-pages w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="e.g., 1-10">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Teaching Tool PDF Synonym</label>
                                <input type="text" class="content-synonym w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Alternative name or teaching tool reference for this PDF">
                            </div>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-600 mb-1">Reading Instructions</label>
                                <textarea class="content-instructions w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="2" placeholder="Instructions for students on how to use this PDF"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'quiz':
                    fieldsHTML = `
                        <div class="quiz-content-fields">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Quiz Type</label>
                                    <select class="quiz-type w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="true-false">True/False</option>
                                        <option value="fill-blank">Fill in the Blank</option>
                                        <option value="matching">Matching</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Number of Questions</label>
                                    <input type="number" class="quiz-questions w-full px-2 py-1 border border-gray-300 rounded text-sm" value="5" min="1" max="20">
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" onclick="openQuizBuilder(this)" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                    <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i>
                                    Build Quiz Questions
                                </button>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            contentFields.innerHTML = fieldsHTML;
        }

        function previewContent(button) {
            if (!button) {
                console.error('Button element is null in previewContent');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found');
                return;
            }
            const contentType = contentItem.querySelector('.content-type').value;
            const contentTitle = contentItem.querySelector('.content-title').value;
            
            // Create a simple preview modal or alert
            alert(`Preview: ${contentType.toUpperCase()} - ${contentTitle || 'Untitled'}`);
        }

        function moveContentUp(button) {
            if (!button) {
                console.error('Button is null in moveContentUp');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found in moveContentUp');
                return;
            }
            const previousItem = contentItem.previousElementSibling;
            if (previousItem) {
                contentItem.parentNode.insertBefore(contentItem, previousItem);
                renumberContentItems(contentItem.parentNode);
            }
        }

        function moveContentDown(button) {
            if (!button) {
                console.error('Button is null in moveContentDown');
                return;
            }
            const contentItem = button.closest('.content-item');
            if (!contentItem) {
                console.error('Content item not found in moveContentDown');
                return;
            }
            const nextItem = contentItem.nextElementSibling;
            if (nextItem) {
                contentItem.parentNode.insertBefore(nextItem, contentItem);
                renumberContentItems(contentItem.parentNode);
            }
        }

        function renumberContentItems(container) {
            container.querySelectorAll('.content-item').forEach((item, index) => {
                const title = item.querySelector('h6');
                if (title && title.textContent.startsWith('Content Item ')) {
                    title.textContent = `Content Item ${index + 1}`;
                }
            });
        }

        function openQuizBuilder(button) {
            // This would open a more detailed quiz builder modal
            alert('Quiz Builder would open here - allowing creation of detailed quiz questions');
        }

        // Question Management Functions
        function addQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionCount = document.querySelectorAll('.question-item').length + 1;
            
            const questionHTML = `
                <div class="question-item bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-900">Question ${questionCount}</h4>
                        <button type="button" onclick="removeQuestion(this)" class="text-red-600 hover:text-red-800">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
                            <select class="question-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="true-false">True/False</option>
                                <option value="fill-blank">Fill in the Blank</option>
                                <option value="short-answer">Short Answer</option>
                                <option value="essay">Essay</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
                            <select class="question-difficulty w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Points</label>
                            <input type="number" class="question-points w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="1" min="1" max="10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Question Text</label>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Enter your question here..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="generateQuestionContent(this)" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                            AI Generate
                        </button>
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
            lucide.createIcons();
        }

        function removeQuestion(button) {
            if (!button) {
                console.error('Button is null in removeQuestion');
                return;
            }
            const questionItem = button.closest('.question-item');
            if (!questionItem) {
                console.error('Question item not found in removeQuestion');
                return;
            }
            questionItem.remove();
            
            // Renumber remaining questions
            document.querySelectorAll('.question-item').forEach((item, index) => {
                const title = item.querySelector('h4');
                if (title && title.textContent.startsWith('Question ')) {
                    title.textContent = `Question ${index + 1}`;
                }
            });
        }

        // AI Content Generation Functions
        async function generateLessonContent(button) {
            if (!button) {
                console.error('Button is null in generateLessonContent');
                return;
            }
            const lessonItem = button.closest('.lesson-item');
            if (!lessonItem) {
                console.error('Lesson item not found in generateLessonContent');
                return;
            }
            const titleElement = lessonItem.querySelector('.lesson-title');
            const cefrElement = lessonItem.querySelector('.lesson-cefr');
            const contentTypeElement = lessonItem.querySelector('.lesson-content-type');
            
            if (!titleElement || !cefrElement || !contentTypeElement) {
                showError('Required lesson fields not found');
                return;
            }
            
            const title = titleElement.value;
            const cefrLevel = cefrElement.value;
            const contentType = contentTypeElement.value;
            
            if (!title) {
                showError('Please enter a lesson title first');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Generating...';
            
            try {
                // Simulate AI content generation (replace with actual AI service call)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const objectives = lessonItem.querySelector('.lesson-objectives');
                if (!objectives) {
                    showError('Objectives field not found');
                    return;
                }
                const generatedContent = `Students will learn ${contentType} skills at ${cefrLevel} level through "${title}". Key objectives include vocabulary building, comprehension exercises, and practical application.`;
                
                objectives.value = generatedContent;
                showSuccess('Lesson content generated successfully!');
            } catch (error) {
                console.error('Error generating lesson content:', error);
                showError('Failed to generate lesson content');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>AI Generate Content';
                lucide.createIcons();
            }
        }

        async function generateQuestionContent(button) {
            if (!button) {
                console.error('Button is null in generateQuestionContent');
                return;
            }
            const questionItem = button.closest('.question-item');
            if (!questionItem) {
                console.error('Question item not found in generateQuestionContent');
                return;
            }
            const questionTypeElement = questionItem.querySelector('.question-type');
            const difficultyElement = questionItem.querySelector('.question-difficulty');
            
            if (!questionTypeElement || !difficultyElement) {
                showError('Required question fields not found');
                return;
            }
            
            const questionType = questionTypeElement.value;
            const difficulty = difficultyElement.value;
            
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Generating...';
            
            try {
                // Simulate AI question generation (replace with actual AI service call)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const questionText = questionItem.querySelector('.question-text');
                if (!questionText) {
                    showError('Question text field not found');
                    return;
                }
                const generatedQuestion = `This is a ${difficulty} ${questionType} question generated by AI based on the course content and CEFR level.`;
                
                questionText.value = generatedQuestion;
                showSuccess('Question generated successfully!');
            } catch (error) {
                console.error('Error generating question:', error);
                showError('Failed to generate question');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>AI Generate';
                lucide.createIcons();
            }
        }

        // Course Creation Function
        async function createCourseFromWizard() {
            try {
                // Save final step data
                saveCurrentStepData();
                
                // Validate all required data
                if (!courseWizardData.title || !courseWizardData.category || !courseWizardData.instructorName) {
                    showError('Missing required course information');
                    return;
                }
                
                // Show loading state
                const createBtn = document.getElementById('finishBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i>Creating Course...';
                }
                
                // Check if publishing immediately
                const publishImmediately = document.getElementById('publishImmediately')?.checked || false;
                
                // Capture the review HTML from the lesson review section
                let reviewHtml = '';
                const lessonsReviewElement = document.getElementById('lessonsReview');
                if (lessonsReviewElement) {
                    reviewHtml = lessonsReviewElement.innerHTML;
                    console.log(' Captured review HTML:', reviewHtml);
                }

                // Create course in database
                const courseData = {
                    title: courseWizardData.title,
                    description: courseWizardData.description,
                    category: courseWizardData.category,
                    level: courseWizardData.cefrLevel,
                    language: courseWizardData.language,
                    duration_weeks: parseInt(courseWizardData.duration) || 4,
                    hours_per_week: parseInt(courseWizardData.hoursPerWeek) || 2,
                    max_students: parseInt(courseWizardData.maxStudents) || 20,
                    price: parseFloat(courseWizardData.price) || 0,
                    currency: courseWizardData.currency || 'USD',
                    learning_objectives: courseWizardData.learningObjectives,
                    prerequisites: courseWizardData.prerequisites,
                    skills_focus: courseWizardData.skillsFocus || [],
                    required_materials: courseWizardData.materials,
                    syllabus: courseWizardData.syllabus,
                    instructor_name: courseWizardData.instructorName,
                    instructor_email: courseWizardData.instructorEmail,
                    instructor_bio: courseWizardData.instructorBio,
                    start_date: courseWizardData.startDate,
                    enrollment_deadline: courseWizardData.enrollmentDeadline,
                    cancellation_policy: courseWizardData.cancellationPolicy,
                    is_active: publishImmediately,
                    review_html: reviewHtml, // Save the captured review HTML
                    created_at: new Date().toISOString()
                };
                
                // Create course using Supabase Admin client for proper permissions
                console.log(' Using admin client for course creation to bypass RLS policies');
                console.log(' Course data being inserted:', courseData);
                
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'supabaseAdmin' : 'supabase (fallback)');
                
                const { data, error } = await client
                    .from('courses')
                    .insert([courseData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                const createdCourse = data[0];
                console.log(' Course created successfully:', createdCourse);
                
                // Now save lessons if any exist
                if (courseWizardData.lessons && courseWizardData.lessons.length > 0) {
                    console.log(' Saving lessons for course:', createdCourse.id);
                    
                    try {
                        // Collect lessons data
                        const lessonsData = await collectLessonsData();
                        
                        if (lessonsData && lessonsData.length > 0) {
                            // Use IPC to save lessons if in Electron environment
                            if (window.isElectron) {
                                const result = await window.electronAPI.invoke('db:createLessons', createdCourse.id, lessonsData);
                                if (result.success) {
                                    console.log(' Lessons saved successfully via Electron IPC');
                                } else {
                                    console.error(' Failed to save lessons via IPC:', result.error);
                                    throw new Error(result.error);
                                }
                            } else {
                                // Fallback to direct Supabase insertion for web environment
                                const lessonsToInsert = lessonsData.map(lesson => ({
                                    course_id: createdCourse.id,
                                    title: lesson.title,
                                    description: lesson.description || '',
                                    lesson_type: lesson.type || 'content',
                                    content: lesson.content,
                                    order_index: lesson.order_index || 0,
                                    duration_minutes: lesson.duration || 30,
                                    difficulty_level: lesson.level || 'beginner',
                                    learning_objectives: lesson.objectives || [],
                                    is_published: publishImmediately
                                }));
                                
                                const { error: lessonsError } = await client
                                    .from('lessons')
                                    .insert(lessonsToInsert);
                                
                                if (lessonsError) {
                                    console.error(' Failed to save lessons:', lessonsError);
                                    throw lessonsError;
                                }
                                
                                console.log(' Lessons saved successfully via direct Supabase');
                            }
                        }
                    } catch (lessonError) {
                        console.error(' Error saving lessons:', lessonError);
                        // Don't fail the entire course creation, just warn
                        showError('Course created but failed to save lessons: ' + lessonError.message);
                    }
                }
                
                const message = publishImmediately ? 'Course created and published successfully!' : 'Course created as draft successfully!';
                showSuccess(message);
                closeCourseModal();
                
                // Reset wizard data
                courseWizardData = {};
                currentWizardStep = 1;
                
                // Reload courses
                if (typeof loadCourses === 'function') {
                    loadCourses();
                }
                
            } catch (error) {
                console.error('Error creating course:', error);
                showError('Failed to create course: ' + (error.message || 'Unknown error'));
            } finally {
                const createBtn = document.getElementById('finishBtn');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'Create Course';
                    lucide.createIcons();
                }
            }
        }

        // Initialize wizard when modal opens
        function showAddCourseModal() {
            // Reset modal to create mode
            document.getElementById('courseModalTitle').textContent = 'Create New Course';
            
            // Clear any edit data and reset wizard
            const form = document.getElementById('courseForm');
            if (form) {
                delete form.dataset.courseId;
                delete form.dataset.isEdit;
                form.reset();
            }
            
            // Reset wizard data and show first step
            courseWizardData = {};
            currentWizardStep = 1;
            showWizardStep(1);
            
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function showAddAssignmentModal() {
            document.getElementById('assignmentModal').classList.remove('hidden');
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('hidden');
            document.getElementById('assignmentForm').reset();
        }

        function showAddQuestionModal() {
            document.getElementById('questionModal').classList.remove('hidden');
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.add('hidden');
            document.getElementById('questionForm').reset();
        }

        async function loadQuestionsForAssignment() {
            const assignmentSelect = document.getElementById('questionAssignmentSelect');
            const selectedAssignmentId = assignmentSelect.value;
            const questionsContainer = document.getElementById('questionsContainer');
            const noQuestionsMessage = document.getElementById('noQuestionsMessage');
            const createQuestionBtn = document.getElementById('createQuestionBtn');
            
            if (!selectedAssignmentId) {
                questionsContainer.innerHTML = '';
                noQuestionsMessage.classList.remove('hidden');
                createQuestionBtn.disabled = true;
                return;
            }
            
            createQuestionBtn.disabled = false;
            
            try {
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('id,assignment_id,question_text,question_type,points,difficulty,options,created_at')
                    .eq('assignment_id', selectedAssignmentId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (questions && questions.length > 0) {
                    questionsContainer.innerHTML = questions.map(question => `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900">${question.question_text}</h4>
                                <div class="flex space-x-2">
                                    <button onclick="editQuestion('${question.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        Edit
                                    </button>
                                    <button onclick="deleteQuestion('${question.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="inline-block bg-gray-100 px-2 py-1 rounded mr-2">Type: ${question.question_type}</span>
                                <span class="inline-block bg-blue-100 px-2 py-1 rounded mr-2">Points: ${question.points}</span>
                                <span class="inline-block bg-green-100 px-2 py-1 rounded">Difficulty: ${question.difficulty}</span>
                            </div>
                            ${question.options ? `<div class="text-sm text-gray-600">Options: ${JSON.parse(question.options).join(', ')}</div>` : ''}
                        </div>
                    `).join('');
                    noQuestionsMessage.classList.add('hidden');
                } else {
                    questionsContainer.innerHTML = '';
                    noQuestionsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                showError('Failed to load questions');
            }
        }

        async function loadQuestions() {
            try {
                // Load assignments for the dropdown
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('assignments')
                    .select('id, title')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (assignmentsError) throw assignmentsError;
                
                const assignmentSelect = document.getElementById('questionAssignmentSelect');
                assignmentSelect.innerHTML = '<option value="">Select an assignment/test...</option>';
                
                if (assignments && assignments.length > 0) {
                    assignments.forEach(assignment => {
                        assignmentSelect.innerHTML += `<option value="${assignment.id}">${assignment.title}</option>`;
                    });
                } else {
                    assignmentSelect.innerHTML += '<option value="" disabled>No assignments available</option>';
                }
            } catch (error) {
                console.error('Error loading assignments for questions:', error);
                showError('Failed to load assignments');
            }
        }

        function showGrammarSetupInstructions() {
            const instructions = `
To fix the missing grammar_lessons table, please run the following SQL in your Supabase SQL Editor:

CREATE TABLE IF NOT EXISTS public.grammar_lessons (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    language TEXT NOT NULL DEFAULT 'Spanish',
    level TEXT DEFAULT 'beginner',
    content JSONB,
    difficulty_score INTEGER DEFAULT 1,
    estimated_duration_minutes INTEGER DEFAULT 15,
    tags TEXT[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_grammar_lessons_language ON public.grammar_lessons(language);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_level ON public.grammar_lessons(level);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_created_at ON public.grammar_lessons(created_at);
CREATE INDEX IF NOT EXISTS idx_grammar_lessons_active ON public.grammar_lessons(is_active);

ALTER TABLE public.grammar_lessons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active grammar lessons" ON public.grammar_lessons
    FOR SELECT USING (is_active = true);

CREATE POLICY "Authenticated users can manage grammar lessons" ON public.grammar_lessons
    FOR ALL USING (auth.role() = 'authenticated');

CREATE TRIGGER update_grammar_lessons_updated_at
    BEFORE UPDATE ON public.grammar_lessons
    FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

INSERT INTO public.grammar_lessons (title, description, language, level, content, difficulty_score, estimated_duration_minutes, tags) VALUES
('Present Tense Basics', 'Learn the fundamentals of present tense in Spanish', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 2, 20, '{"grammar", "present-tense", "verbs"}'),
('Ser vs Estar', 'Understanding the difference between ser and estar', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 3, 25, '{"grammar", "verbs", "ser", "estar"}'),
('Past Tense (Pretrito)', 'Master the Spanish past tense', 'Spanish', 'intermediate', '{"type": "lesson", "exercises": []}', 5, 30, '{"grammar", "past-tense", "preterito"}'),
('Subjunctive Mood', 'Introduction to the subjunctive mood', 'Spanish', 'advanced', '{"type": "lesson", "exercises": []}', 8, 45, '{"grammar", "subjunctive", "mood"}'),
('Articles and Gender', 'Learn about definite and indefinite articles', 'Spanish', 'beginner', '{"type": "lesson", "exercises": []}', 2, 15, '{"grammar", "articles", "gender"}');

After running this SQL, refresh the admin dashboard to see the grammar lessons.
            `;
            
            alert(instructions);
        }

        function showUserManagementSetup() {
            const instructions = `
To fix the User Management relationship errors, please run the following SQL in your Supabase SQL Editor:

-- Fix user_progress table column names
ALTER TABLE public.user_progress 
ADD COLUMN IF NOT EXISTS current_level TEXT,
ADD COLUMN IF NOT EXISTS total_xp INTEGER,
ADD COLUMN IF NOT EXISTS daily_streak INTEGER;

UPDATE public.user_progress 
SET 
    current_level = level,
    total_xp = xp_points,
    daily_streak = streak_days
WHERE current_level IS NULL OR total_xp IS NULL OR daily_streak IS NULL;

ALTER TABLE public.user_progress 
ALTER COLUMN current_level SET DEFAULT 'beginner',
ALTER COLUMN total_xp SET DEFAULT 0,
ALTER COLUMN daily_streak SET DEFAULT 0;

ALTER TABLE public.user_progress 
ALTER COLUMN current_level SET NOT NULL,
ALTER COLUMN total_xp SET NOT NULL,
ALTER COLUMN daily_streak SET NOT NULL;

-- Add foreign key constraint
ALTER TABLE public.user_progress 
ADD CONSTRAINT fk_user_progress_user_profiles 
FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;

-- Fix learning_sessions table
ALTER TABLE public.learning_sessions 
ADD COLUMN IF NOT EXISTS user_id UUID,
ADD COLUMN IF NOT EXISTS lesson_type TEXT DEFAULT 'general',
ADD COLUMN IF NOT EXISTS completed BOOLEAN DEFAULT false;

ALTER TABLE public.learning_sessions 
ADD CONSTRAINT fk_learning_sessions_user_profiles 
FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_user_progress_current_level ON public.user_progress(current_level);
CREATE INDEX IF NOT EXISTS idx_learning_sessions_user_id ON public.learning_sessions(user_id);

After running this SQL, refresh the admin dashboard to see the user management working properly.
            `;
            
            alert(instructions);
        }

        // File upload helper function
         async function uploadFiles(files, folder, courseId = null, assignmentId = null) {
             const uploadedFiles = [];
             
             for (const file of files) {
                 const fileExt = file.name.split('.').pop();
                 const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
                 const filePath = `${folder}/${fileName}`;
                 
                 try {
                     const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                     const { data, error } = await client.storage
                         .from('course-materials')
                         .upload(filePath, file, { contentType: file.type });
                     
                     if (error) throw error;
                     
                     // Get public URL
                     const { data: { publicUrl } } = client.storage
                         .from('course-materials')
                         .getPublicUrl(filePath);
                     
                     uploadedFiles.push({
                         name: file.name,
                         url: publicUrl,
                         type: file.type,
                         size: file.size,
                         path: filePath
                     });
                 } catch (error) {
                     console.error(`Error uploading ${file.name}:`, error);
                 }
             }
             
             return uploadedFiles;
         }

         // Course form submission
         document.getElementById('courseForm').addEventListener('submit', async function(e) {
            console.log('Form submission triggered!');
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const description = formData.get('description');
            const level = formData.get('level');
            const publishStatus = formData.get('publishStatus'); // Get publish status from radio buttons
            
            console.log('Form data:', { title, description, level, publishStatus });
            
            // Check if this is an edit operation
            const isEdit = e.target.dataset.isEdit === 'true';
            const courseId = e.target.dataset.courseId;
            
            if (!title || !description) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (isEdit && !courseId) {
                showError('Course ID not found for update operation');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = isEdit ? 'Updating...' : 'Creating...';
                submitBtn.disabled = true;
                
                // Collect lesson data
                const lessonsData = await collectLessonsData();
                
                // Collect course overview data
                const learningObjectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (!learningObjectivesElement || !prerequisitesElement) {
                    showError('Required course overview fields not found');
                    return;
                }
                
                const learningObjectives = learningObjectivesElement.value;
                const prerequisites = prerequisitesElement.value;
                const skillsFocus = Array.from(document.querySelectorAll('input[name="skillsFocus"]:checked')).map(cb => cb.value);
                
                // Get additional form fields
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                
                // Capture review HTML from review tab if present
                let reviewHtml = '';
                const reviewEl = document.getElementById('lessonsReview');
                if (reviewEl) {
                    reviewHtml = reviewEl.innerHTML;
                }

                const courseData = {
                    title: title,
                    description: description,
                    language: languageElement ? languageElement.value : 'Spanish',
                    cefr_level: level || 'A1', // Use cefr_level column as per database schema
                    duration_weeks: durationElement ? parseInt(durationElement.value) : 10,
                    hours_per_week: hoursElement ? parseInt(hoursElement.value) : 3,
                    category: categoryElement ? categoryElement.value : 'language',
                    is_active: publishStatus === 'publish', // Set active only if publish is selected
                    learning_objectives: learningObjectives,
                    prerequisites: prerequisites,
                    skills_focus: skillsFocus,
                    required_materials: '', // Default empty materials
                    syllabus: '', // Default empty syllabus
                    instructor_name: 'Default Instructor',
                    instructor_email: 'instructor@edlingo.com',
                    review_html: reviewHtml
                };
                
                let result;
                let createdCourse;
                if (isEdit) {
                    // Update existing course
                    result = await supabase
                        .from('courses')
                        .update(courseData)
                        .eq('id', courseId)
                        .select();
                    createdCourse = result.data && result.data.length ? result.data[0] : null;
                } else {
                    // Create new course
                    result = await supabase
                        .from('courses')
                        .insert(courseData)
                        .select();
                    createdCourse = result.data && result.data.length ? result.data[0] : null;
                }
                
                if (result.error) throw result.error;

                // Create lessons if any
                if (lessonsData && lessonsData.length > 0 && createdCourse) {
                    console.log(' Creating lessons for course:', createdCourse.id);
                    try {
                        if (window.isElectron) {
                            const lessonResult = await window.electronAPI.invoke('db:createLessons', createdCourse.id, lessonsData);
                            if (lessonResult && lessonResult.error) {
                                console.error(' Failed to create lessons via IPC:', lessonResult.error);
                                showError('Course saved but lessons failed: ' + lessonResult.error);
                            } else {
                                console.log(' Lessons created via IPC:', lessonResult);
                            }
                        } else {
                            const { data: lessonData, error: lessonError } = await supabase
                                .rpc('create_lessons_with_materials', { p_course_id: createdCourse.id, p_lessons: lessonsData });
                            if (lessonError) {
                                console.error(' Failed to create lessons via Supabase:', lessonError);
                                showError('Course saved but lessons failed: ' + lessonError.message);
                            } else {
                                console.log(' Lessons created via Supabase:', lessonData);
                            }
                        }
                    } catch (lessonError) {
                        console.error(' Error creating lessons:', lessonError);
                        showError('Course saved but lessons failed: ' + lessonError.message);
                    }
                }
                
                // Reset form and close modal
                e.target.reset();
                delete e.target.dataset.isEdit;
                delete e.target.dataset.courseId;
                closeCourseModal();
                
                // Refresh courses list
                await loadCourses();
                updateLastUpdated();
                
                // Show success message
                const successMessage = isEdit ? 'Course updated successfully!' : (lessonsData && lessonsData.length > 0 ? `Course created successfully with ${lessonsData.length} lessons!` : 'Course created successfully!');
                alert(successMessage);
                
            } catch (error) {
                console.error(isEdit ? 'Error updating course:' : 'Error creating course:', error);
                showError((isEdit ? 'Failed to update course: ' : 'Failed to create course: ') + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
         });

         // Add direct click event listener for finishBtn as backup
         document.getElementById('finishBtn').addEventListener('click', function(e) {
            console.log('FinishBtn clicked!');
            console.log('Button type:', e.target.type);
            console.log('Button disabled:', e.target.disabled);
            
            // Check form field values
            const titleField = document.querySelector('input[name="title"]');
            const descField = document.querySelector('textarea[name="description"]');
            console.log('Title field value:', titleField ? titleField.value : 'not found');
            console.log('Description field value:', descField ? descField.value : 'not found');
            
            const courseForm = document.getElementById('courseForm');
            if (courseForm) {
                console.log('Triggering form submission manually');
                // Trigger form submission
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                courseForm.dispatchEvent(submitEvent);
            } else {
                console.error('Course form not found!');
            }
         });

         // Function to collect lessons data from the form
         async function collectLessonsData() {
            const lessons = [];
            const lessonItems = document.querySelectorAll('.lesson-item');
            
            for (let i = 0; i < lessonItems.length; i++) {
                const lessonItem = lessonItems[i];
                
                const titleElement = lessonItem.querySelector('.lesson-title');
                const levelElement = lessonItem.querySelector('.lesson-cefr');
                const durationElement = lessonItem.querySelector('.lesson-duration');
                const contentTypeElement = lessonItem.querySelector('.lesson-content-type');
                const objectivesElement = lessonItem.querySelector('.lesson-objectives');
                
                if (!titleElement || !levelElement || !durationElement || !contentTypeElement || !objectivesElement) {
                    console.error('Missing lesson fields in lesson item', i);
                    continue;
                }
                
                // Determine folder names for organized uploads
                const lessonNameForPath = (titleElement.value || `lesson_${i + 1}`).trim();
                const sectionNameForPath = 'Course Content';
                
                const materials = [];
                
                // Collect materials for this lesson
                const contentItemElements = lessonItem.querySelectorAll('.content-item');
                for (let j = 0; j < contentItemElements.length; j++) {
                    const contentItem = contentItemElements[j];
                    
                    const contentTypeElement = contentItem.querySelector('.content-type');
                    const contentTitleElement = contentItem.querySelector('.content-title');
                    
                    if (!contentTypeElement || !contentTitleElement) {
                        console.error('Missing content fields in content item', j, 'of lesson', i);
                        continue;
                    }
                    
                    const materialType = contentTypeElement.value;
                    const materialTitle = contentTitleElement.value;
                    
                    // Base material data structure matching the enhanced lesson_materials schema
                    const materialData = {
                        type: materialType,
                        content: materialTitle,
                        order_number: j + 1,
                        file_url: null,
                        file_size: null,
                        file_type: null,
                        duration: null,
                        metadata: {}
                    };
                    
                    // Collect type-specific data and handle file uploads
                    switch(materialType) {
                        case 'text':
                            const textContent = contentItem.querySelector('.content-text')?.value || '';
                            materialData.content = textContent;
                            materialData.metadata = {
                                title: materialTitle,
                                word_count: textContent.split(' ').length
                            };
                            break;
                            
                        case 'image':
                            const imageFile = contentItem.querySelector('.content-file')?.files[0];
                            if (imageFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(imageFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = imageFile.size;
                                    materialData.file_type = imageFile.type;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        alt_text: contentItem.querySelector('.content-alt')?.value || '',
                                        caption: contentItem.querySelector('.content-caption')?.value || ''
                                    };
                                } catch (error) {
                                    console.error('Failed to upload image file:', error);
                                }
                            }
                            break;
                            
                        case 'audio':
                            const audioFile = contentItem.querySelector('.content-file')?.files[0];
                            if (audioFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(audioFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = audioFile.size;
                                    materialData.file_type = audioFile.type;
                                    const durationValue = contentItem.querySelector('.content-duration')?.value;
                                    materialData.duration = durationValue ? parseInt(durationValue) : null;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        transcript: contentItem.querySelector('.content-transcript')?.value || '',
                                        quality: 'standard'
                                    };
                                } catch (error) {
                                    console.error('Failed to upload audio file:', error);
                                }
                            }
                            break;
                            
                        case 'video':
                            const videoFile = contentItem.querySelector('.content-file')?.files[0];
                            if (videoFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(videoFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = videoFile.size;
                                    materialData.file_type = videoFile.type;
                                    const durationValue = contentItem.querySelector('.content-duration')?.value;
                                    materialData.duration = durationValue ? parseInt(durationValue) : null;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        description: contentItem.querySelector('.content-description')?.value || '',
                                        resolution: '720p',
                                        has_subtitles: false
                                    };
                                } catch (error) {
                                    console.error('Failed to upload video file:', error);
                                }
                            }
                            break;
                            
                        case 'pdf':
                            const pdfFile = contentItem.querySelector('.content-file')?.files[0];
                            if (pdfFile) {
                                try {
                                    materialData.file_url = await uploadSingleFile(pdfFile, 'lessons', sectionNameForPath, lessonNameForPath, i);
                                    materialData.file_size = pdfFile.size;
                                    materialData.file_type = pdfFile.type;
                                    materialData.metadata = {
                                        title: materialTitle,
                                        page_range: contentItem.querySelector('.content-pages')?.value || '',
                                        instructions: contentItem.querySelector('.content-instructions')?.value || '',
                                        page_count: 0 // Would need PDF parsing to get actual count
                                    };
                                } catch (error) {
                                    console.error('Failed to upload PDF file:', error);
                                }
                            }
                            break;
                            
                        case 'quiz':
                            materialData.content = materialTitle;
                            materialData.metadata = {
                                title: materialTitle,
                                quiz_type: contentItem.querySelector('.quiz-type')?.value || 'multiple-choice',
                                question_count: parseInt(contentItem.querySelector('.quiz-questions')?.value) || 5,
                                time_limit: 30,
                                passing_score: 70
                            };
                            break;
                            
                        case 'interactive':
                            materialData.content = materialTitle;
                            materialData.metadata = {
                                title: materialTitle,
                                interaction_type: 'exercise',
                                estimated_time: 15
                            };
                            break;
                    }
                    
                    materials.push(materialData);
                }
                
                // Create lesson data structure that matches the enhanced database schema
                const lessonData = {
                    title: titleElement.value,
                    description: `${contentTypeElement.value} lesson for ${levelElement.value} level - ${objectivesElement.value}`,
                    order_number: i + 1,
                    materials: materials
                };
                
                lessons.push(lessonData);
            }
            
            console.log(' Collected lessons data with multimedia materials:', lessons);
            return lessons;
         }

         // Make collectLessonsData available globally
         window.collectLessonsData = collectLessonsData;

         // Helper function to upload a single file with organized folder structure
         async function uploadSingleFile(file, folder, sectionName = '', lessonName = '', lessonIndex = 0) {
            try {
                const fileName = `${Date.now()}_${file.name}`;
                
                // Get course name from DOM
                let courseName = '';
                const courseTitleInput = document.getElementById('courseTitle') || document.querySelector('input[name="title"]');
                if (courseTitleInput && courseTitleInput.value) {
                    courseName = courseTitleInput.value.trim();
                }
                
                // Create organized path structure: courseName/lesson_number/fileName
                let filePath = '';
                if (courseName) {
                    const sanitizedCourse = courseName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
                    filePath = sanitizedCourse;
                } else {
                    filePath = 'course_content'; // fallback if no course name
                }
                
                // Add lesson number (1-based index)
                const lessonNumber = lessonIndex + 1;
                filePath += `/lesson_${lessonNumber}`;
                
                filePath += `/${fileName}`;
                
                // Use IPC for file upload if in Electron environment
                if (window.isElectron) {
                    // Convert file to buffer for IPC
                    const arrayBuffer = await file.arrayBuffer();
                    const buffer = new Uint8Array(arrayBuffer);
                    
                    const result = await window.electronAPI.invoke('db:uploadFile', buffer, fileName, 'course-materials', filePath);
                    
                    if (result.success) {
                        console.log(' File uploaded successfully via Electron IPC:', result.result);
                        return result.result.publicUrl || result.result;
                    } else {
                        console.error(' Failed to upload file via IPC:', result.error);
                        throw new Error(result.error);
                    }
                } else {
                    // Fallback to direct Supabase upload for web environment (prefer admin client if available)
                    const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                    const { data, error } = await client.storage
                        .from('course-materials')
                        .upload(filePath, file, { contentType: file.type });
                    
                    if (error) throw error;
                    
                    // Get public URL
                    const { data: { publicUrl } } = client.storage
                        .from('course-materials')
                        .getPublicUrl(filePath);
                    
                    console.log(' File uploaded successfully via direct Supabase:', publicUrl);
                    return publicUrl;
                }
            } catch (error) {
                console.error(' Error uploading file:', error);
                throw error;
            }
         }

         // Make uploadSingleFile available globally
         window.uploadSingleFile = uploadSingleFile;

        // Assignment form submission
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const description = formData.get('description');
            const dueDate = formData.get('dueDate');
            const points = formData.get('points');
            const pdfFiles = document.getElementById('assignmentPdfs').files;
            const audioFiles = document.getElementById('assignmentAudio').files;
            const videoFiles = document.getElementById('assignmentVideos').files;
            const imageFiles = document.getElementById('assignmentImages').files;
            
            if (!title || !description) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Show loading state
                const submitBtn = document.getElementById('finishBtn');
            if (!submitBtn) {
                console.error('Submit button not found in form');
                showError('Form error: Submit button not found');
                return;
            }
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                // Upload files if any
                let uploadedFiles = [];
                if (pdfFiles.length > 0 || audioFiles.length > 0 || videoFiles.length > 0 || imageFiles.length > 0) {
                    const allFiles = [...pdfFiles, ...audioFiles, ...videoFiles, ...imageFiles];
                    uploadedFiles = await uploadFiles(allFiles, 'assignments');
                }
                
                // Create assignment in database
                 const { data, error } = await supabase
                     .from('assignments')
                     .insert({
                         course_id: null, // Will be set by admin later
                         title: title,
                         description: description,
                         assignment_type: 'exercise',
                         difficulty_level: 'beginner',
                         // points field omitted; max_score column not present in current DB schema
                         due_date: dueDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Default to 7 days from now
                         is_active: true
                     })
                     .select();
                
                if (error) throw error;
                
                // Reset form and close modal
                e.target.reset();
                closeAssignmentModal();
                
                // Refresh assignments list
                await loadAssignments();
                updateLastUpdated();
                
                // Show success message
                alert('Assignment created successfully!');
                
            } catch (error) {
                console.error('Error creating assignment:', error);
                showError('Failed to create assignment: ' + error.message);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        });

        // Action functions
        async function refreshData() {
            try {
                await loadDashboardData();
                updateLastUpdated();
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh data');
            }
        }

        async function refreshUsers() {
            try {
                await loadUsers();
                updateLastUpdated();
            } catch (error) {
                console.error('Error refreshing users:', error);
                showError('Failed to refresh users');
            }
        }

        function viewUser(userId) {
            alert(`View user details for: ${userId}`);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                await loadUsers();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
            }
        }

        function editVocabulary(wordId) {
            alert(`Edit vocabulary word: ${wordId}`);
        }

        async function deleteVocabulary(wordId) {
            if (!confirm('Are you sure you want to delete this vocabulary word?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_vocabulary')
                    .delete()
                    .eq('id', wordId);
                
                if (error) throw error;
                
                await loadVocabulary();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting vocabulary:', error);
                showError('Failed to delete vocabulary word');
            }
        }

        function editLesson(lessonId) {
            alert(`Edit lesson: ${lessonId}`);
        }

        async function deleteLesson(lessonId) {
            if (!confirm('Are you sure you want to delete this lesson?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('grammar_lessons')
                    .delete()
                    .eq('id', lessonId);
                
                if (error) throw error;
                
                await loadGrammarLessons();
                updateLastUpdated();
            } catch (error) {
                console.error('Error deleting lesson:', error);
                showError('Failed to delete lesson');
            }
        }

        // Course management functions
        async function editCourse(courseId) {
            console.log('editCourse called with courseId:', courseId);
            
            // Handle test course ID
            if (courseId === 'test-course-id') {
                console.log('Test course detected, showing modal with test data');
                
                // Populate form with test data
                const titleElement = document.getElementById('courseTitle');
                const descElement = document.getElementById('courseDescription');
                const levelElement = document.getElementById('cefrLevel'); // Fixed: use the correct ID
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                const modalElement = document.getElementById('courseModal');
                
                if (titleElement) titleElement.value = 'Test Course';
                if (descElement) descElement.value = 'This is a test course for debugging';
                if (levelElement) levelElement.value = 'A1'; // Fixed: use valid CEFR level
                if (categoryElement) categoryElement.value = 'conversation';
                if (languageElement) languageElement.value = 'es';
                if (durationElement) durationElement.value = 12;
                if (hoursElement) hoursElement.value = 5;
                
                // Populate instructor fields for test course
                const instructorNameElement = document.getElementById('instructorName');
                const instructorEmailElement = document.getElementById('instructorEmail');
                const instructorBioElement = document.getElementById('instructorBio');
                
                if (instructorNameElement) instructorNameElement.value = 'Test Instructor';
                if (instructorEmailElement) instructorEmailElement.value = 'test@example.com';
                if (instructorBioElement) instructorBioElement.value = 'Test instructor bio for debugging purposes';
                
                // Update modal title and button
                const modalTitleElement = document.getElementById('courseModalTitle');
                const submitBtnElement = document.getElementById('finishBtn');
                
                if (modalTitleElement) modalTitleElement.textContent = 'Edit Test Course';
                if (submitBtnElement) {
                    submitBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Update Course';
                    submitBtnElement.style.display = 'inline-flex'; // Show the button for editing
                }
                
                // Start from step 1 for editing to show all form steps
                showWizardStep(1);
                
                // Load test lesson content
                const testCourse = {
                    learning_objectives: 'Learn basic Spanish conversation skills',
                    prerequisites: 'No prior Spanish knowledge required',
                    skills_focus: ['speaking', 'listening'],
                    lessons: [
                        {
                            title: 'Introduction to Spanish',
                            level: 'A1',
                            duration: '45 minutes',
                            objectives: 'Learn basic greetings and introductions',
                            content: [
                                {
                                    type: 'text',
                                    content: 'Welcome to Spanish! In this lesson, we will learn basic greetings.'
                                },
                                {
                                    type: 'audio',
                                    description: 'Listen to basic greetings',
                                    duration: '2 minutes'
                                },
                                {
                                    type: 'quiz',
                                    title: 'Greetings Quiz',
                                    questions: '5'
                                }
                            ]
                        },
                        {
                            title: 'Numbers and Colors',
                            level: 'A1',
                            duration: '30 minutes',
                            objectives: 'Learn numbers 1-20 and basic colors',
                            content: [
                                {
                                    type: 'text',
                                    content: 'In this lesson, we will learn numbers and colors in Spanish.'
                                },
                                {
                                    type: 'image',
                                    description: 'Color chart in Spanish'
                                },
                                {
                                    type: 'video',
                                    description: 'Numbers pronunciation guide',
                                    duration: '3 minutes'
                                },
                                {
                                    type: 'pdf',
                                    page_range: '1-5',
                                    synonym: 'Spanish Numbers Reference Guide',
                                    instructions: 'Use this PDF as a reference for practicing numbers and colors'
                                }
                            ]
                        }
                    ]
                };
                
                await loadLessonContent(testCourse);
                
                // Store course ID for update
                document.getElementById('courseForm').dataset.courseId = courseId;
                document.getElementById('courseForm').dataset.isEdit = 'true';
                
                // Show modal
                if (modalElement) {
                    modalElement.classList.remove('hidden');
                    console.log('Test modal should be visible now');
                }
                return;
            }
            
            try {
                // Check if supabase is available
                if (typeof supabase === 'undefined') {
                    console.error('Supabase client not initialized');
                    alert('Database connection not available. Please refresh the page.');
                    return;
                }

                console.log('Fetching course data...');
                // Fetch course data
                const { data: course, error } = await supabase
                    .from('courses')
                    .select('id,title,description,level,cefr_level,language,category,duration,duration_weeks,hours_per_week,is_active,created_at,instructor_name,instructor_email,instructor_bio,learning_objectives,prerequisites,skills_focus')
                    .eq('id', courseId)
                    .single();

                if (error) {
                    console.error('Error fetching course:', error);
                    alert('Error loading course data: ' + error.message);
                    return;
                }

                console.log('Course data fetched:', course);

                // Check if form elements exist
                const titleElement = document.getElementById('courseTitle');
                const descElement = document.getElementById('courseDescription');
                const levelElement = document.getElementById('cefrLevel'); // Fixed: use the correct ID
                const categoryElement = document.getElementById('courseCategory');
                const languageElement = document.getElementById('courseLanguage');
                const durationElement = document.getElementById('courseDuration');
                const hoursElement = document.getElementById('courseHours');
                const modalElement = document.getElementById('courseModal');
                
                if (!titleElement || !descElement || !levelElement || !modalElement) {
                    console.error('Required form elements not found');
                    alert('Form elements not found. Please refresh the page.');
                    return;
                }

                // Populate form with course data
                titleElement.value = course.title || '';
                descElement.value = course.description || '';
                // Map course level to CEFR level format
                const cefrLevel = course.level || course.cefr_level || 'A1';
                levelElement.value = cefrLevel;
                
                // Populate other form fields if they exist
                if (categoryElement) categoryElement.value = course.category || 'general';
                if (languageElement) languageElement.value = course.language || 'Spanish';
                if (durationElement) durationElement.value = course.duration_weeks || course.duration || 8;
                if (hoursElement) hoursElement.value = course.hours_per_week || 3;
                
                // Populate instructor fields
                const instructorNameElement = document.getElementById('instructorName');
                const instructorEmailElement = document.getElementById('instructorEmail');
                const instructorBioElement = document.getElementById('instructorBio');
                
                if (instructorNameElement) instructorNameElement.value = course.instructor_name || '';
                if (instructorEmailElement) instructorEmailElement.value = course.instructor_email || '';
                if (instructorBioElement) instructorBioElement.value = course.instructor_bio || '';
                
                // Populate step 2 fields (learning objectives, prerequisites, skills focus)
                const objectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (objectivesElement) objectivesElement.value = course.learning_objectives || '';
                if (prerequisitesElement) prerequisitesElement.value = course.prerequisites || '';

                // Update modal title and button
                const modalTitleElement = document.getElementById('courseModalTitle');
                const submitBtnElement = document.getElementById('finishBtn');
                
                if (modalTitleElement) modalTitleElement.textContent = 'Edit Course';
                if (submitBtnElement) {
                    submitBtnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i>Update Course';
                    submitBtnElement.style.display = 'inline-flex'; // Show the button for editing
                }
                
                // Start from step 1 for editing to show all form steps
                showWizardStep(1);

                // Load lesson content from database
                await loadLessonContentFromDatabase(courseId);

                // Store course ID for update
                document.getElementById('courseForm').dataset.courseId = courseId;
                document.getElementById('courseForm').dataset.isEdit = 'true';

                console.log('Showing modal...');
                // Show modal
                modalElement.classList.remove('hidden');
                console.log('Modal should be visible now');
            } catch (error) {
                console.error('Error in editCourse:', error);
                alert('Error loading course for editing: ' + error.message);
            }
        }

        async function deleteCourse(courseId) {
            console.log(' Delete course called with ID:', courseId);
            
            if (!confirm('Are you sure you want to delete this course?')) {
                console.log(' User cancelled course deletion');
                return;
            }
            
            console.log(' User confirmed deletion, proceeding...');
            
            try {
                // Use admin client for delete operations to bypass RLS
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'Admin' : 'Regular');
                
                const { data, error } = await client
                    .from('courses')
                    .delete()
                    .eq('id', courseId);
                
                console.log(' Delete operation result:', { data, error });
                
                if (error) {
                    console.error(' Supabase delete error:', error);
                    throw error;
                }
                
                console.log(' Course deleted successfully, reloading courses...');
                await loadCourses();
                updateLastUpdated();
                console.log(' Course list reloaded');
            } catch (error) {
                console.error(' Error deleting course:', error);
                showError(`Failed to delete course: ${error.message}`);
            }
        }

        // Load lesson content for editing
        async function loadLessonContent(course) {
            try {
                // Clear existing lessons
                const lessonsContainer = document.getElementById('lessonsContainer');
                if (lessonsContainer) {
                    lessonsContainer.innerHTML = '';
                }

                // Populate learning objectives, prerequisites, and skills focus
                const objectivesElement = document.getElementById('learningObjectives');
                const prerequisitesElement = document.getElementById('prerequisites');
                
                if (objectivesElement && course.learning_objectives) {
                    objectivesElement.value = course.learning_objectives;
                }
                if (prerequisitesElement && course.prerequisites) {
                    prerequisitesElement.value = course.prerequisites;
                }

                // Handle skills focus checkboxes
                // First clear all checkboxes to avoid stale selections
                const allSkillCheckboxes = document.querySelectorAll('input[name="skillsFocus"]');
                allSkillCheckboxes.forEach(cb => { cb.checked = false; });
                // Then set based on course data
                if (course.skills_focus) {
                    const skills = Array.isArray(course.skills_focus) ? course.skills_focus : course.skills_focus.split(',');
                    skills.forEach(skill => {
                        const checkbox = document.querySelector(`input[name="skillsFocus"][value="${skill.trim()}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }

                // Load lessons if available
                if (course.lessons && Array.isArray(course.lessons)) {
                    course.lessons.forEach((lesson, index) => {
                        addLesson();
                        
                        // Populate lesson data
                        const lessonItem = document.querySelector(`#lesson-${index + 1}`);
                        if (lessonItem) {
                            const titleInput = lessonItem.querySelector('.lesson-title');
                            const levelSelect = lessonItem.querySelector('.lesson-cefr');
                            const durationInput = lessonItem.querySelector('.lesson-duration');
                            const objectivesTextarea = lessonItem.querySelector('.lesson-objectives');
                            
                            if (titleInput) titleInput.value = lesson.title || '';
                            if (levelSelect) levelSelect.value = lesson.level || 'A1';
                            if (durationInput) durationInput.value = lesson.duration || '';
                            if (objectivesTextarea) objectivesTextarea.value = lesson.objectives || '';
                            
                            // Load lesson content
                            if (lesson.content && Array.isArray(lesson.content)) {
                                lesson.content.forEach(contentItem => {
                                    // Create content item manually instead of calling addLessonContent with wrong parameter
                                    const contentContainer = lessonItem.querySelector('.lesson-content-container');
                                    const contentCount = contentContainer.querySelectorAll('.content-item').length + 1;
                                    
                                    const contentHTML = `
                                        <div class="content-item bg-white p-3 rounded border border-gray-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <h6 class="font-medium text-gray-700">Content Item ${contentCount}</h6>
                                                <button type="button" onclick="removeLessonContent(this)" class="text-red-600 hover:text-red-800">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Content Type</label>
                                                    <select class="content-type w-full px-2 py-1 border border-gray-300 rounded text-sm" onchange="updateContentFields(this)">
                                                        <option value="text">Text Content</option>
                                                        <option value="image">Image</option>
                                                        <option value="audio">Audio</option>
                                                        <option value="video">Video</option>
                                                        <option value="pdf">PDF Document</option>
                                                        <option value="quiz">Interactive Quiz</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Content Title</label>
                                                    <input type="text" class="content-title w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Enter content title">
                                                </div>
                                            </div>
                                            <div class="content-fields">
                                                <div class="text-content-fields">
                                                    <label class="block text-sm font-medium text-gray-600 mb-1">Text Content</label>
                                                    <textarea class="content-text w-full px-2 py-1 border border-gray-300 rounded text-sm" rows="3" placeholder="Enter your text content here..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    
                                    contentContainer.insertAdjacentHTML('beforeend', contentHTML);
                                    lucide.createIcons();
                                    
                                    // Find the last added content item
                                    const contentItems = contentContainer.querySelectorAll('.content-item');
                                    const lastContentItem = contentItems[contentItems.length - 1];
                                    
                                    if (lastContentItem) {
                                        const typeSelect = lastContentItem.querySelector('.content-type');
                                        if (typeSelect) {
                                            typeSelect.value = contentItem.type || 'text';
                                            updateContentFields(typeSelect);
                                            
                                            // Populate content based on type
                                            setTimeout(() => {
                                                const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                                if (fieldsContainer) {
                                                    switch (contentItem.type) {
                                                        case 'text':
                                                            const textArea = fieldsContainer.querySelector('textarea');
                                                            if (textArea) textArea.value = contentItem.content || '';
                                                            break;
                                                        case 'image':
                                                            const altInput = fieldsContainer.querySelector('.content-alt');
                                                            const captionInput = fieldsContainer.querySelector('.content-caption');
                                                            if (altInput) altInput.value = contentItem.alt_text || '';
                                                            if (captionInput) captionInput.value = contentItem.caption || '';
                                                            break;
                                                        case 'audio':
                                                            const audioDurationInput = fieldsContainer.querySelector('.content-duration');
                                                            const transcriptInput = fieldsContainer.querySelector('.content-transcript');
                                                            if (audioDurationInput) audioDurationInput.value = contentItem.duration || '';
                                                            if (transcriptInput) transcriptInput.value = contentItem.transcript || '';
                                                            break;
                                                        case 'video':
                                                            const videoDurationInput = fieldsContainer.querySelector('.content-duration');
                                                            const videoDescInput = fieldsContainer.querySelector('.content-description');
                                                            if (videoDurationInput) videoDurationInput.value = contentItem.duration || '';
                                                            if (videoDescInput) videoDescInput.value = contentItem.description || '';
                                                            break;
                                                        case 'pdf':
                                                            const pagesInput = fieldsContainer.querySelector('.content-pages');
                                                            const synonymInput = fieldsContainer.querySelector('.content-synonym');
                                                            const instructionsInput = fieldsContainer.querySelector('.content-instructions');
                                                            if (pagesInput) pagesInput.value = contentItem.page_range || '';
                                                            if (synonymInput) synonymInput.value = contentItem.synonym || '';
                                                            if (instructionsInput) instructionsInput.value = contentItem.instructions || '';
                                                            break;
                                                        case 'quiz':
                                                            const titleInput = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                            const questionsInput = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                            if (titleInput) titleInput.value = contentItem.title || '';
                                                            if (questionsInput) questionsInput.value = contentItem.questions || '';
                                                            break;
                                                    }
                                                }
                                            }, 100);
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading lesson content:', error);
            }
        }

        // Function to load lesson data from database for editing using RPC
        async function loadLessonContentFromDatabase(courseId) {
            try {
                if (!supabase) {
                    console.error('Supabase not initialized');
                    return;
                }
                
                console.log(' Loading lessons with materials using RPC for course:', courseId);
                
                // Fetch lessons with materials using the RPC function
                const { data: lessonsWithMaterials, error } = await supabase
                    .rpc('get_course_lessons_with_materials', { p_course_id: courseId });
                
                if (error) {
                    console.error(' Error fetching lessons with materials:', error);
                    // Fallback to the original method if RPC fails
                    console.log(' Falling back to separate queries...');
                    return await loadLessonContentFromDatabaseFallback(courseId);
                }
                
                if (!lessonsWithMaterials || lessonsWithMaterials.length === 0) {
                    console.log(' No lessons found for course:', courseId);
                    return;
                }
                
                console.log(' Found lessons with materials:', lessonsWithMaterials.length, 'rows');
                
                // Clear existing lessons
                const lessonsContainer = document.getElementById('lessonsContainer');
                if (lessonsContainer) {
                    lessonsContainer.innerHTML = '';
                }
                
                // Group materials by lesson_id to organize the data
                const lessonsMap = new Map();
                
                lessonsWithMaterials.forEach(row => {
                    const lessonId = row.lesson_id;
                    
                    if (!lessonsMap.has(lessonId)) {
                        lessonsMap.set(lessonId, {
                            id: lessonId,
                            title: row.lesson_title,
                            description: row.lesson_description,
                            order_index: row.lesson_order,
                            materials: []
                        });
                    }
                    
                    // Add material if it exists (some lessons might not have materials)
                    if (row.material_id) {
                        lessonsMap.get(lessonId).materials.push({
                            id: row.material_id,
                            type: row.material_type,
                            content: row.material_content,
                            url: row.file_url,
                            metadata: row.metadata
                        });
                    }
                });
                
                // Convert map to array and sort by lesson order
                const lessons = Array.from(lessonsMap.values()).sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
                
                console.log(' Organized into', lessons.length, 'lessons');
                
                // Populate each lesson in the form
                for (const lesson of lessons) {
                    addLesson();
                    
                    // Get the last added lesson container
                    const lessonContainers = document.querySelectorAll('.lesson-item');
                    const currentLesson = lessonContainers[lessonContainers.length - 1];
                    
                    if (currentLesson) {
                        // Populate lesson fields
                        const titleInput = currentLesson.querySelector('.lesson-title');
                        const levelSelect = currentLesson.querySelector('.lesson-cefr');
                        const durationInput = currentLesson.querySelector('.lesson-duration');
                        const objectivesTextarea = currentLesson.querySelector('.lesson-objectives');
                        
                        if (titleInput) titleInput.value = lesson.title || '';
                        if (levelSelect) levelSelect.value = 'A1'; // Default CEFR level
                        if (durationInput) durationInput.value = '30'; // Default duration
                        if (objectivesTextarea) objectivesTextarea.value = lesson.description || '';
                        
                        // Populate materials for this lesson
                        await populateLessonMaterials(lesson.materials, currentLesson);
                    }
                }

                // After populating all lessons/materials, sync data for Review step
                try {
                    courseWizardData.lessons = collectLessonsData();
                    if (typeof updateReviewStep === 'function') {
                        setTimeout(() => { 
                            try { 
                                updateReviewStep(); 
                            } catch (e) { 
                                console.warn('updateReviewStep failed:', e); 
                            } 
                        }, 500);
                    }
                } catch (e) {
                    console.warn('Failed to sync lessons to review:', e);
                }
                
                console.log(' Successfully loaded', lessons.length, 'lessons with materials');
                
            } catch (error) {
                console.error(' Error loading lesson content from database:', error);
                // Try fallback method
                return await loadLessonContentFromDatabaseFallback(courseId);
            }
        }
        
        // Fallback function for separate queries (original implementation)
        async function loadLessonContentFromDatabaseFallback(courseId) {
            try {
                console.log(' Using fallback method to load lessons...');
                
                // Fetch lessons for this course
                const { data: lessons, error } = await supabase
                    .from('lessons')
                    .select('*')
                    .eq('course_id', courseId)
                    .order('order_index', { ascending: true });
                
                if (error) {
                    console.error('Error fetching lessons:', error);
                    return;
                }
                
                if (lessons && lessons.length > 0) {
                    // Clear existing lessons
                    const lessonsContainer = document.getElementById('lessonsContainer');
                    if (lessonsContainer) {
                        lessonsContainer.innerHTML = '';
                    }
                    
                    // Add each lesson
                    for (const lesson of lessons) {
                        addLesson();
                        
                        // Get the last added lesson container (matches addLesson template)
                        const lessonContainers = document.querySelectorAll('.lesson-item');
                        const currentLesson = lessonContainers[lessonContainers.length - 1];
                        
                        if (currentLesson) {
                            // Populate lesson fields
                            const titleInput = currentLesson.querySelector('.lesson-title');
                            const levelSelect = currentLesson.querySelector('.lesson-cefr');
                            const durationInput = currentLesson.querySelector('.lesson-duration');
                            const objectivesTextarea = currentLesson.querySelector('.lesson-objectives');
                            
                            if (titleInput) titleInput.value = lesson.title || '';
                            if (levelSelect) levelSelect.value = lesson.cefr_level || 'A1';
                            if (durationInput) durationInput.value = lesson.duration || '';
                            if (objectivesTextarea) objectivesTextarea.value = lesson.objectives || '';
                            
                            // Load lesson materials/content if available (await to ensure DOM is populated sequentially)
                            await loadLessonMaterials(lesson.id, currentLesson);
                        }
                    }

                    // After populating all lessons/materials, sync data for Review step
                    try {
                        courseWizardData.lessons = collectLessonsData();
                        if (typeof updateReviewStep === 'function') {
                            setTimeout(() => { 
                                try { 
                                    updateReviewStep(); 
                                } catch (e) { 
                                    console.warn('updateReviewStep failed:', e); 
                                } 
                            }, 500);
                        }
                    } catch (e) {
                        console.warn('Failed to sync lessons to review:', e);
                    }
                } else {
                    console.log('No lessons found for course:', courseId);
                }
            } catch (error) {
                console.error('Error loading lesson content from database (fallback):', error);
            }
        }
        
        // Function to populate materials for a lesson using pre-fetched data
        async function populateLessonMaterials(materials, lessonContainer) {
            try {
                if (!materials || materials.length === 0) {
                    console.log(' No materials to populate for this lesson');
                    return;
                }
                
                console.log(' Populating', materials.length, 'materials...');
                
                const contentContainer = lessonContainer.querySelector('.lesson-content-container');
                if (!contentContainer) {
                    console.warn('Content container not found in lesson');
                    return;
                }
                
                // Add each material as content
                materials.forEach((material, index) => {
                    // Click the existing Add Content button in this lesson item
                    const addMaterialBtn = lessonContainer.querySelector('button[onclick^="addLessonContent"]');
                    if (addMaterialBtn) {
                        addMaterialBtn.click();
                        
                        // Get the last added content item
                        setTimeout(() => {
                            const contentItems = contentContainer.querySelectorAll('.content-item');
                            const lastContentItem = contentItems[contentItems.length - 1];
                            
                            if (lastContentItem) {
                                // Populate material data
                                const titleInput = lastContentItem.querySelector('.content-title');
                                const typeSelect = lastContentItem.querySelector('.content-type');
                                
                                if (titleInput) titleInput.value = `Material ${index + 1}`;
                                if (typeSelect) {
                                    const materialType = (material.type || 'text').toLowerCase();
                                    typeSelect.value = materialType;
                                    updateContentFields(typeSelect);
                                    
                                    // Populate type-specific fields
                                    setTimeout(() => {
                                        const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                        if (fieldsContainer) {
                                            // Parse content data
                                            let contentData = {};
                                            if (material.content) {
                                                if (typeof material.content === 'string') {
                                                    try {
                                                        contentData = JSON.parse(material.content);
                                                    } catch (e) {
                                                        if (materialType === 'text') {
                                                            contentData = { text: material.content };
                                                        }
                                                    }
                                                } else {
                                                    contentData = material.content;
                                                }
                                            }
                                            if (!contentData || Object.keys(contentData).length === 0) {
                                                contentData = material.metadata || {};
                                            }
                                            
                                            // Populate based on material type
                                            switch (materialType) {
                                                case 'text':
                                                    const textArea = fieldsContainer.querySelector('textarea');
                                                    if (textArea) textArea.value = typeof material.content === 'string' ? material.content : (contentData.text || contentData.content || '');
                                                    break;
                                                case 'video':
                                                    const videoDuration = fieldsContainer.querySelector('.content-duration');
                                                    const videoDesc = fieldsContainer.querySelector('.content-description');
                                                    if (videoDuration) videoDuration.value = contentData.duration || '';
                                                    if (videoDesc) videoDesc.value = contentData.description || '';
                                                    break;
                                                case 'audio':
                                                    const audioDuration = fieldsContainer.querySelector('.content-duration');
                                                    const transcript = fieldsContainer.querySelector('.content-transcript');
                                                    if (audioDuration) audioDuration.value = contentData.duration || '';
                                                    if (transcript) transcript.value = contentData.transcript || '';
                                                    break;
                                                case 'pdf':
                                                    const pages = fieldsContainer.querySelector('.content-pages');
                                                    const synonym = fieldsContainer.querySelector('.content-synonym');
                                                    const instructions = fieldsContainer.querySelector('.content-instructions');
                                                    if (pages) pages.value = contentData.page_range || '';
                                                    if (synonym) synonym.value = contentData.synonym || '';
                                                    if (instructions) instructions.value = contentData.instructions || '';
                                                    break;
                                                case 'quiz':
                                                    const quizTitle = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                    const questions = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                    if (quizTitle) quizTitle.value = contentData.title || '';
                                                    if (questions) questions.value = contentData.questions || '';
                                                    break;
                                                case 'image':
                                                    const altInput = fieldsContainer.querySelector('.content-alt');
                                                    const captionInput = fieldsContainer.querySelector('.content-caption');
                                                    if (altInput) altInput.value = contentData.alt_text || '';
                                                    if (captionInput) captionInput.value = contentData.caption || '';
                                                    
                                                    // Show preview of existing image if we have a url
                                                    if (material.url) {
                                                        let preview = fieldsContainer.querySelector('.image-loaded-preview');
                                                        if (!preview) {
                                                            preview = document.createElement('div');
                                                            preview.className = 'image-loaded-preview mt-2';
                                                            preview.innerHTML = `<img class="max-h-40 rounded border" alt="Image preview">`;
                                                            fieldsContainer.appendChild(preview);
                                                        }
                                                        const imgEl = preview.querySelector('img');
                                                        if (imgEl) imgEl.src = material.url;
                                                    }
                                                    break;
                                            }
                                        }
                                    }, 200);
                                }
                            }
                        }, 100 * (index + 1)); // Stagger the population to avoid DOM conflicts
                    }
                });

                // Wait for all materials to be populated
                await new Promise(resolve => setTimeout(resolve, 350 + (materials.length * 100)));
                return true;
                
            } catch (error) {
                console.error(' Error populating lesson materials:', error);
            }
        }
        
        // Function to load lesson materials for a specific lesson
        async function loadLessonMaterials(lessonId, lessonContainer) {
            try {
                if (!supabase) {
                    console.error('Supabase not initialized');
                    return;
                }
                
                // Fetch lesson materials
                const { data: materials, error } = await supabase
                    .from('lesson_materials')
                    .select('*')
                    .eq('lesson_id', lessonId)
                    .order('order_index', { ascending: true });
                
                if (error) {
                    console.error('Error fetching lesson materials:', error);
                    return;
                }
                
                if (materials && materials.length > 0) {
                    // Use the correct container class from the template
                    const contentContainer = lessonContainer.querySelector('.lesson-content-container');
                    if (contentContainer) {
                        // Add each material as content
                        materials.forEach(material => {
                            // Click the existing Add Content button in this lesson item
                            const addMaterialBtn = lessonContainer.querySelector('button[onclick^="addLessonContent"]');
                            if (addMaterialBtn) {
                                addMaterialBtn.click();
                                
                                // Get the last added content item
                                setTimeout(() => {
                                    const contentItems = contentContainer.querySelectorAll('.content-item');
                                    const lastContentItem = contentItems[contentItems.length - 1];
                                    
                                    if (lastContentItem) {
                                        // Populate material data
                                        const titleInput = lastContentItem.querySelector('.content-title');
                                        const typeSelect = lastContentItem.querySelector('.content-type');
                                        
                                        if (titleInput) titleInput.value = material.title || '';
                                        if (typeSelect) {
                                            const materialType = (material.type || 'text').toLowerCase();
                                            typeSelect.value = materialType;
                                            updateContentFields(typeSelect);
                                            
                                            // Populate type-specific fields
                                            setTimeout(() => {
                                                const fieldsContainer = lastContentItem.querySelector('.content-fields');
                                                if (fieldsContainer) {
                                                    // Safely parse content data if it's a JSON string; else fallback to metadata
                                                    let contentData = {};
                                                    if (material.content) {
                                                        if (typeof material.content === 'string') {
                                                            try {
                                                                contentData = JSON.parse(material.content);
                                                            } catch (e) {
                                                                // If plain string for text type
                                                                if (materialType === 'text') {
                                                                    contentData = { text: material.content };
                                                                } else {
                                                                    contentData = {};
                                                                }
                                                            }
                                                        } else {
                                                            contentData = material.content;
                                                        }
                                                    }
                                                    if (!contentData || Object.keys(contentData).length === 0) {
                                                        contentData = material.metadata || {};
                                                    }
                                                    
                                                    // Populate based on material type
                                                    switch (materialType) {
                                                        case 'text':
                                                            const textArea = fieldsContainer.querySelector('textarea');
                                                            if (textArea) textArea.value = typeof material.content === 'string' ? material.content : (contentData.text || contentData.content || '');
                                                            break;
                                                        case 'video':
                                                            const videoDuration = fieldsContainer.querySelector('.content-duration');
                                                            const videoDesc = fieldsContainer.querySelector('.content-description');
                                                            if (videoDuration) videoDuration.value = contentData.duration || '';
                                                            if (videoDesc) videoDesc.value = contentData.description || '';
                                                            break;
                                                        case 'audio':
                                                            const audioDuration = fieldsContainer.querySelector('.content-duration');
                                                            const transcript = fieldsContainer.querySelector('.content-transcript');
                                                            if (audioDuration) audioDuration.value = contentData.duration || '';
                                                            if (transcript) transcript.value = contentData.transcript || '';
                                                            break;
                                                        case 'pdf':
                                                            const pages = fieldsContainer.querySelector('.content-pages');
                                                            const synonym = fieldsContainer.querySelector('.content-synonym');
                                                            const instructions = fieldsContainer.querySelector('.content-instructions');
                                                            if (pages) pages.value = contentData.page_range || '';
                                                            if (synonym) synonym.value = contentData.synonym || '';
                                                            if (instructions) instructions.value = contentData.instructions || '';
                                                            break;
                                                        case 'quiz':
                                                            const quizTitle = fieldsContainer.querySelector('input[placeholder*="title"]');
                                                            const questions = fieldsContainer.querySelector('input[placeholder*="questions"]');
                                                            if (quizTitle) quizTitle.value = contentData.title || '';
                                                            if (questions) questions.value = contentData.questions || '';
                                                            break;
                                                        case 'image':
                                                            const altInput = fieldsContainer.querySelector('.content-alt');
                                                            const captionInput = fieldsContainer.querySelector('.content-caption');
                                                            if (altInput) altInput.value = contentData.alt_text || '';
                                                            if (captionInput) captionInput.value = contentData.caption || '';
                                                            // Show preview of existing image if we have a url
                                            if (material.url) {
                                                let preview = fieldsContainer.querySelector('.image-loaded-preview');
                                                if (!preview) {
                                                    preview = document.createElement('div');
                                                    preview.className = 'image-loaded-preview mt-2';
                                                    preview.innerHTML = `<img class=\"max-h-40 rounded border\" alt=\"Image preview\">`;
                                                    fieldsContainer.appendChild(preview);
                                                }
                                                const imgEl = preview.querySelector('img');
                                                if (imgEl) imgEl.src = material.url;
                                            }
                                                            break;
                                                    }
                                                }
                                            }, 200);
                                        }
                                    }
                                }, 100);
                            }
                        });
                    }
                }

                // small delay to allow nested timeouts to finish updating the DOM before returning
                await new Promise(resolve => setTimeout(resolve, 350));
                return true;
            } catch (error) {
                console.error('Error loading lesson materials:', error);
            }
        }

        // Assignment management functions
        function editAssignment(assignmentId) {
            console.log('Editing assignment:', assignmentId);
            // TODO: Implement assignment editing functionality
            alert('Assignment editing functionality will be implemented soon.');
        }

        async function deleteAssignment(assignmentId) {
            console.log(' Delete assignment called with ID:', assignmentId);
            
            if (!confirm('Are you sure you want to delete this assignment?')) {
                console.log(' User cancelled assignment deletion');
                return;
            }
            
            console.log(' User confirmed deletion, proceeding...');
            
            try {
                // Use admin client for delete operations to bypass RLS
                const client = supabaseAdmin || supabase;
                console.log(' Using client:', client === supabaseAdmin ? 'Admin' : 'Regular');
                
                const { data, error } = await client
                    .from('assignments')
                    .delete()
                    .eq('id', assignmentId);
                
                console.log(' Delete operation result:', { data, error });
                
                if (error) {
                    console.error(' Supabase delete error:', error);
                    throw error;
                }
                
                console.log(' Assignment deleted successfully, reloading assignments...');
                await loadAssignments();
                updateLastUpdated();
                console.log(' Assignment list reloaded');
            } catch (error) {
                console.error(' Error deleting assignment:', error);
                showError(`Failed to delete assignment: ${error.message}`);
            }
        }

        // File Management Functions
        let currentFiles = [];
        let storageStats = {};

        // Show files tab
        async function showFilesTab() {
            showTab('files');
            await loadFiles();
            await loadStorageStats();
        }

        // Load files from Supabase Storage
        async function loadFiles() {
            try {
                const buckets = ['course-materials', 'assignment-materials', 'shared-resources'];
                currentFiles = [];

                for (const bucket of buckets) {
                    try {
                        const { data: files, error } = await supabase.storage
                            .from(bucket)
                            .list('', {
                                limit: 100,
                                offset: 0
                            });

                        if (!error && files) {
                            const categoryMap = {
                                'course-materials': 'courses',
                                'assignment-materials': 'assignments',
                                'shared-resources': 'general'
                            };
                            const filesWithBucket = files.map(file => ({
                                ...file,
                                bucket: bucket,
                                category: categoryMap[bucket] || 'general'
                            }));
                            currentFiles.push(...filesWithBucket);
                        }
                    } catch (bucketError) {
                        console.warn(`Bucket ${bucket} not accessible:`, bucketError);
                    }
                }

                displayFiles(currentFiles);
            } catch (error) {
                console.error('Error loading files:', error);
                showError('Failed to load files');
            }
        }

        // Display files in the table
        function displayFiles(files) {
            const tableBody = document.getElementById('files-table-body');
            if (!tableBody) return;

            if (files.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i data-lucide="folder-open" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p>No files found</p>
                            <button onclick="openFileUploadModal()" class="mt-2 text-blue-600 hover:text-blue-800">Upload your first file</button>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            tableBody.innerHTML = files.map(file => {
                const fileSize = formatFileSize(file.metadata?.size || 0);
                const fileType = getFileType(file.name);
                const uploadDate = new Date(file.created_at || file.updated_at).toLocaleDateString();

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-lucide="${getFileIcon(file.name)}" class="w-5 h-5 text-gray-400 mr-3"></i>
                                <span class="text-sm font-medium text-gray-900">${file.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileSize}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${uploadDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="downloadFile('${file.bucket}', '${file.name}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteFile('${file.bucket}', '${file.name}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        // Load storage statistics
        async function loadStorageStats() {
            try {
                const buckets = ['course-materials', 'assignment-materials', 'shared-resources'];
                let totalFiles = 0;
                let totalSize = 0;

                for (const bucket of buckets) {
                    try {
                        const { data: files, error } = await supabase.storage
                            .from(bucket)
                            .list('', { limit: 1000 });

                        if (!error && files) {
                            totalFiles += files.length;
                            totalSize += files.reduce((sum, file) => sum + (file.metadata?.size || 0), 0);
                        }
                    } catch (bucketError) {
                        console.warn(`Bucket ${bucket} not accessible:`, bucketError);
                    }
                }

                storageStats = { totalFiles, totalSize };
                displayStorageStats();
            } catch (error) {
                console.error('Error loading storage stats:', error);
            }
        }

        // Display storage statistics
        function displayStorageStats() {
            const statsContainer = document.getElementById('storage-stats');
            if (!statsContainer) return;

            const totalSizeFormatted = formatFileSize(storageStats.totalSize || 0);
            const maxStorage = '1 GB'; // Default limit
            const usagePercentage = Math.min((storageStats.totalSize || 0) / (1024 * 1024 * 1024) * 100, 100);

            statsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="files" class="w-8 h-8 text-blue-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Total Files</p>
                                <p class="text-2xl font-bold text-gray-900">${storageStats.totalFiles || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="hard-drive" class="w-8 h-8 text-green-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Storage Used</p>
                                <p class="text-2xl font-bold text-gray-900">${totalSizeFormatted}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex items-center">
                            <i data-lucide="database" class="w-8 h-8 text-purple-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Storage Limit</p>
                                <p class="text-2xl font-bold text-gray-900">${maxStorage}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600">Storage Usage</span>
                        <span class="text-sm text-gray-600">${usagePercentage.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${usagePercentage}%"></div>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // File upload modal functions
        function openFileUploadModal() {
            document.getElementById('fileUploadModal').classList.remove('hidden');
        }

        function closeFileUploadModal() {
            document.getElementById('fileUploadModal').classList.add('hidden');
            document.getElementById('fileUploadForm').reset();
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        // Handle file upload
        async function handleFileUpload(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const category = formData.get('category');
            const files = document.getElementById('fileInput').files;
            const description = formData.get('description');

            if (!files || files.length === 0) {
                showError('Please select at least one file');
                return;
            }

            if (!category) {
                showError('Please select a file category');
                return;
            }

            try {
                // Show progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const uploadButton = document.getElementById('uploadButton');
                uploadButton.disabled = true;

                // Determine bucket name (mapped to existing Supabase buckets)
                const bucketName = category === 'general' ? 'shared-resources' : 
                                 category === 'courses' ? 'course-materials' :
                                 category === 'assignments' ? 'assignment-materials' :
                                 category === 'images' ? 'shared-resources' :
                                 category === 'documents' ? 'shared-resources' : 'shared-resources';

                // Upload files one by one
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${Date.now()}_${file.name}`;

                    progressText.textContent = `Uploading ${file.name} (${i + 1}/${files.length})...`;
                    progressBar.style.width = `${((i + 0.5) / files.length) * 100}%`;

                    const { data, error } = await supabase.storage
                        .from(bucketName)
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) {
                        throw new Error(`Failed to upload ${file.name}: ${error.message}`);
                    }

                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                }

                progressText.textContent = 'Upload completed!';
                
                // Close modal and refresh files
                setTimeout(() => {
                    closeFileUploadModal();
                    loadFiles();
                    loadStorageStats();
                }, 1000);

            } catch (error) {
                console.error('Error uploading files:', error);
                showError('Failed to upload files: ' + error.message);
            } finally {
                document.getElementById('uploadButton').disabled = false;
            }
        }

        // Download file
        async function downloadFile(bucket, fileName) {
            try {
                const { data, error } = await supabase.storage
                    .from(bucket)
                    .download(fileName);

                if (error) throw error;

                // Create download link
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.split('_').slice(1).join('_'); // Remove timestamp prefix
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error downloading file:', error);
                showError('Failed to download file');
            }
        }

        // Delete file
        async function deleteFile(bucket, fileName) {
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }

            try {
                const { error } = await supabase.storage
                    .from(bucket)
                    .remove([fileName]);

                if (error) throw error;

                await loadFiles();
                await loadStorageStats();

            } catch (error) {
                console.error('Error deleting file:', error);
                showError('Failed to delete file');
            }
        }

        // Filter files
        function filterFiles() {
            const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filteredFiles = currentFiles.filter(file => {
                const matchesSearch = file.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || file.category.includes(categoryFilter);
                const matchesType = !typeFilter || getFileType(file.name).toLowerCase().includes(typeFilter.toLowerCase());

                return matchesSearch && matchesCategory && matchesType;
            });

            displayFiles(filteredFiles);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const types = {
                'pdf': 'PDF Document',
                'doc': 'Word Document',
                'docx': 'Word Document',
                'txt': 'Text File',
                'jpg': 'Image',
                'jpeg': 'Image',
                'png': 'Image',
                'gif': 'Image',
                'mp3': 'Audio',
                'mp4': 'Video',
                'zip': 'Archive'
            };
            return types[extension] || 'Unknown';
        }

        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'file-text',
                'doc': 'file-text',
                'docx': 'file-text',
                'txt': 'file-text',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'mp3': 'music',
                'mp4': 'video',
                'zip': 'archive'
            };
            return icons[extension] || 'file';
        }

        // ===== CEFR ASSESSMENT FUNCTIONS =====

        // Show CEFR Assessments tab
        function showAssessmentsTab() {
            showTab('assessments');
            loadAssessmentStats();
            loadAssessmentQuestions();
        }

        // Show assessment sub-tabs
        function showAssessmentSubTab(tabName) {
            // Hide all sub-tab contents
            document.querySelectorAll('.assessment-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all sub-tab buttons
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                if (tab.id.includes('assessment-')) {
                    tab.classList.remove('border-blue-500', 'text-blue-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                }
            });
            
            // Show selected sub-tab content
            document.getElementById(`assessment-${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected sub-tab button
            const activeTab = document.getElementById(`assessment-${tabName}-tab`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Load specific content based on tab
            if (tabName === 'analytics') {
                loadAssessmentAnalytics();
            } else if (tabName === 'settings') {
                loadAssessmentSettings();
            }
        }

        // Load assessment statistics
        async function loadAssessmentStats() {
            try {
                // Mock data for demonstration
                const stats = {
                    totalAssessments: 15,
                    studentsAssessed: 127,
                    avgCefrLevel: 'B1',
                    completionRate: '87%'
                };
                
                document.getElementById('total-assessments').textContent = stats.totalAssessments;
                document.getElementById('students-assessed').textContent = stats.studentsAssessed;
                document.getElementById('avg-cefr-level').textContent = stats.avgCefrLevel;
                document.getElementById('completion-rate').textContent = stats.completionRate;
                
            } catch (error) {
                console.error('Error loading assessment stats:', error);
            }
        }

        // Load assessment questions
        async function loadAssessmentQuestions() {
            try {
                console.log('Loading CEFR assessment questions from database...');
                
                const { data: questions, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .select(`
                        id,
                        question_type,
                        cefr_level,
                        skill_type,
                        question_text,
                        instructions,
                        options,
                        correct_answer,
                        points,
                        difficulty_level,
                        is_active,
                        created_at,
                        updated_at
                    `)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`Database error: ${error.message}`);
                }
                
                // Transform data to match expected format
                const transformedQuestions = (questions || []).map(q => ({
                    id: q.id,
                    questionText: q.question_text,
                    questionType: q.question_type,
                    cefrLevel: q.cefr_level,
                    skillType: q.skill_type,
                    instructions: q.instructions,
                    options: q.options,
                    correctAnswer: q.correct_answer,
                    points: q.points,
                    difficultyLevel: q.difficulty_level,
                    createdAt: q.created_at,
                    updatedAt: q.updated_at
                }));
                
                displayAssessmentQuestions(transformedQuestions);
                
            } catch (error) {
                console.error('Error loading assessment questions:', error);
                showError('Failed to load assessment questions: ' + error.message);
                displayAssessmentQuestions([]);
            }
        }

        // Display assessment questions
        function displayAssessmentQuestions(questions) {
            const container = document.getElementById('assessment-questions-list');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No assessment questions found</h3>
                        <p class="text-gray-500 mb-4">Create your first CEFR assessment question to get started.</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="showCreateAssessmentQuestionModal()">
                            Create Question
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = questions.map(question => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${question.cefrLevel}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ${question.skillType}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    ${question.questionType.replace('_', ' ')}
                                </span>
                                <span class="text-xs text-gray-500">${question.points} pts</span>
                            </div>
                            <h4 class="text-md font-semibold text-gray-900 mb-2">${question.questionText}</h4>
                            <p class="text-sm text-gray-500">Created: ${new Date(question.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button class="text-blue-600 hover:text-blue-800 p-1" onclick="editAssessmentQuestion('${question.id}')" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800 p-1" onclick="deleteAssessmentQuestion('${question.id}')" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // Filter assessment questions
        function filterAssessmentQuestions() {
            const cefrLevel = document.getElementById('cefr-level-filter').value;
            const skillType = document.getElementById('skill-type-filter').value;
            const questionType = document.getElementById('question-type-filter').value;
            
            // In a real implementation, this would filter the actual data
            loadAssessmentQuestions();
        }

        // Show create assessment question modal
        function showCreateAssessmentQuestionModal() {
            document.getElementById('assessmentQuestionModal').classList.remove('hidden');
            resetAssessmentQuestionForm();
        }

        // Close assessment question modal
        function closeAssessmentQuestionModal() {
            document.getElementById('assessmentQuestionModal').classList.add('hidden');
            resetAssessmentQuestionForm();
            
            // Clear editing state
            const form = document.getElementById('assessmentQuestionForm');
            form.removeAttribute('data-editing-id');
            
            // Reset modal title
            document.querySelector('#assessmentQuestionModal h3').textContent = 'Create CEFR Assessment Question';
        }

        // Reset assessment question form
        function resetAssessmentQuestionForm() {
            document.getElementById('assessmentQuestionForm').reset();
            document.getElementById('answerOptionsContainer').innerHTML = '';
            
            // Reset media previews
            ['image', 'audio', 'video', 'pdf'].forEach(type => {
                document.getElementById(`${type}Preview`).classList.add('hidden');
            });
        }

        // Update question type fields
        function updateQuestionTypeFields() {
            const questionType = document.getElementById('questionType').value;
            const container = document.getElementById('answerOptionsContainer');
            
            switch (questionType) {
                case 'multiple-choice':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="0" id="option0" required>
                                <input type="text" name="option" placeholder="Option A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="1" id="option1">
                                <input type="text" name="option" placeholder="Option B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="2" id="option2">
                                <input type="text" name="option" placeholder="Option C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctAnswer" value="3" id="option3">
                                <input type="text" name="option" placeholder="Option D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <p class="text-xs text-gray-500">Select the correct answer by clicking the radio button</p>
                        </div>
                    `;
                    break;
                    
                case 'true-false':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="tfCorrectAnswer" value="true" class="mr-2" required>
                                    <span>True</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="tfCorrectAnswer" value="false" class="mr-2">
                                    <span>False</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">Select the correct answer</p>
                        </div>
                    `;
                    break;
                    
                case 'short-answer':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Expected Response</label>
                                <textarea id="shortAnswer" placeholder="Describe the expected response or key points..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'fill-in-blank':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer(s)</label>
                                <input type="text" id="fillBlankAnswer" placeholder="Enter the correct answer(s), separated by commas" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <p class="text-xs text-gray-500">Use underscores (_____) in your question text to indicate blanks</p>
                        </div>
                    `;
                    break;
                    
                case 'essay':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Grading Rubric</label>
                                <textarea id="essayRubric" placeholder="Describe the grading criteria and key points to look for..." rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Word Limit</label>
                                <input type="number" id="wordLimit" placeholder="Maximum words (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg" min="50" max="1000">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'listening':
                case 'speaking':
                case 'reading':
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Expected Response</label>
                                <textarea id="expectedResponse" placeholder="Describe the expected response or key points..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Criteria</label>
                                <textarea id="assessmentCriteria" placeholder="Describe how this will be assessed..." rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    container.innerHTML = '<p class="text-gray-500">Select a question type to configure answer options</p>';
            }
        }

        // Preview media files
        function previewMedia(type) {
            const input = document.getElementById(`question${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const preview = document.getElementById(`${type}Preview`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                switch (type) {
                    case 'image':
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('imagePreviewImg').src = e.target.result;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        break;
                        
                    case 'audio':
                        const audioUrl = URL.createObjectURL(file);
                        document.getElementById('audioPreviewSource').src = audioUrl;
                        document.getElementById('audioPreviewPlayer').load();
                        preview.classList.remove('hidden');
                        break;
                        
                    case 'video':
                        const videoUrl = URL.createObjectURL(file);
                        document.getElementById('videoPreviewSource').src = videoUrl;
                        document.getElementById('videoPreviewPlayer').load();
                        preview.classList.remove('hidden');
                        break;
                        
                    case 'pdf':
                        document.getElementById('pdfFileName').textContent = file.name;
                        preview.classList.remove('hidden');
                        break;
                }
            }
        }

        // Remove media files
        function removeMedia(type) {
            document.getElementById(`question${type.charAt(0).toUpperCase() + type.slice(1)}`).value = '';
            document.getElementById(`${type}Preview`).classList.add('hidden');
        }

        // Handle assessment question form submission
        async function handleAssessmentQuestionSubmit(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const editingId = event.target.getAttribute('data-editing-id');
                const isEditing = editingId !== null;
                
                // Collect form data
                const questionData = {
                    questionType: formData.get('questionType'),
                    cefrLevel: formData.get('cefrLevel'),
                    skillType: formData.get('skillType'),
                    questionText: formData.get('questionText'),
                    instructions: formData.get('questionInstructions'),
                    points: parseInt(formData.get('questionPoints'))
                };
                
                // Validate required fields
                if (!questionData.questionType || !questionData.cefrLevel || !questionData.skillType || !questionData.questionText) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                // Collect answer options based on question type
                if (questionData.questionType === 'multiple-choice') {
                    const options = [];
                    const optionInputs = document.querySelectorAll('input[name="option"]');
                    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
                    
                    optionInputs.forEach(input => {
                        if (input.value.trim()) {
                            options.push(input.value.trim());
                        }
                    });
                    
                    questionData.options = options;
                    questionData.correctAnswer = correctAnswerRadio ? parseInt(correctAnswerRadio.value) : null;
                } else if (questionData.questionType === 'true-false') {
                    const tfCorrectAnswer = document.querySelector('input[name="tfCorrectAnswer"]:checked');
                    questionData.options = ['True', 'False'];
                    questionData.correctAnswer = tfCorrectAnswer ? tfCorrectAnswer.value : null;
                } else if (questionData.questionType === 'short-answer') {
                    const shortAnswer = document.getElementById('shortAnswer');
                    questionData.expectedResponse = shortAnswer ? shortAnswer.value : null;
                } else if (questionData.questionType === 'fill-in-blank') {
                    const fillBlankAnswer = document.getElementById('fillBlankAnswer');
                    questionData.correctAnswer = fillBlankAnswer ? fillBlankAnswer.value : null;
                } else if (questionData.questionType === 'essay') {
                    const essayRubric = document.getElementById('essayRubric');
                    const wordLimit = document.getElementById('wordLimit');
                    questionData.expectedResponse = essayRubric ? essayRubric.value : null;
                    questionData.wordLimit = wordLimit ? parseInt(wordLimit.value) : null;
                } else if (['listening', 'speaking', 'reading'].includes(questionData.questionType)) {
                    const expectedResponse = document.getElementById('expectedResponse');
                    const assessmentCriteria = document.getElementById('assessmentCriteria');
                    questionData.expectedResponse = expectedResponse ? expectedResponse.value : null;
                    questionData.assessmentCriteria = assessmentCriteria ? assessmentCriteria.value : null;
                }
                
                console.log(isEditing ? 'Updating assessment question:' : 'Creating assessment question:', questionData);
                
                if (isEditing) {
                    // Update existing question
                    const updateData = {
                        question_type: questionData.questionType,
                        cefr_level: questionData.cefrLevel,
                        skill_type: questionData.skillType,
                        question_text: questionData.questionText,
                        instructions: questionData.instructions,
                        points: questionData.points,
                        options: questionData.options || null,
                        correct_answer: questionData.correctAnswer || null,
                        expected_response: questionData.expectedResponse || null,
                        updated_at: new Date().toISOString()
                    };
                    
                    // Add additional fields if they exist
                    if (questionData.wordLimit) {
                        updateData.word_limit = questionData.wordLimit;
                    }
                    if (questionData.assessmentCriteria) {
                        updateData.assessment_criteria = questionData.assessmentCriteria;
                    }
                    
                    // Update the question in the database
                    const { data, error } = await supabaseAdmin.from('cefr_assessment_questions').update({
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                UPDATE cefr_assessment_questions 
                                SET 
                                    question_type = '${updateData.question_type}',
                                    cefr_level = '${updateData.cefr_level}',
                                    skill_type = '${updateData.skill_type}',
                                    question_text = '${updateData.question_text.replace(/'/g, "''")}',
                                    instructions = '${updateData.instructions ? updateData.instructions.replace(/'/g, "''") : ''}',
                                    points = ${updateData.points},
                                    options = ${updateData.options ? `'${JSON.stringify(updateData.options).replace(/'/g, "''")}'` : 'NULL'},
                                    correct_answer = ${updateData.correct_answer !== null ? `'${updateData.correct_answer}'` : 'NULL'},
                                    expected_response = ${updateData.expected_response ? `'${updateData.expected_response.replace(/'/g, "''")}'` : 'NULL'},
                                    ${updateData.word_limit ? `word_limit = ${updateData.word_limit},` : ''}
                                    ${updateData.assessment_criteria ? `assessment_criteria = '${updateData.assessment_criteria.replace(/'/g, "''")}',` : ''}
                                    updated_at = NOW()
                                WHERE id = '${editingId}'
                            `
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log(' Assessment question updated successfully:', updateData);
                    
                    // Show success message
                    showSuccess('Assessment question updated successfully!');
                    
                } else {
                    // Create new question
                    const insertData = {
                        question_type: questionData.questionType,
                        cefr_level: questionData.cefrLevel,
                        skill_type: questionData.skillType,
                        question_text: questionData.questionText,
                        instructions: questionData.instructions,
                        points: questionData.points,
                        options: questionData.options || null,
                        correct_answer: questionData.correctAnswer || null,
                        expected_response: questionData.expectedResponse || null,
                        difficulty_level: 'medium',
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Add additional fields if they exist
                    if (questionData.wordLimit) {
                        insertData.word_limit = questionData.wordLimit;
                    }
                    if (questionData.assessmentCriteria) {
                        insertData.assessment_criteria = questionData.assessmentCriteria;
                    }
                    
                    // Create the question in the database
                    const { data, error } = await supabaseAdmin.from('cefr_assessment_questions').insert([insertData]).select();
                    
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    // Legacy compatibility - create response-like object
                    const response = { ok: true };
                    const result = { data };
                    
                    /*const response = await fetch('/api/supabase', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                INSERT INTO cefr_assessment_questions (
                                    question_type, cefr_level, skill_type, question_text, instructions, 
                                    points, options, correct_answer, expected_response, difficulty_level, 
                                    is_active, created_at, updated_at
                                    ${insertData.word_limit ? ', word_limit' : ''}
                                    ${insertData.assessment_criteria ? ', assessment_criteria' : ''}
                                ) VALUES (
                                    '${insertData.question_type}',
                                    '${insertData.cefr_level}',
                                    '${insertData.skill_type}',
                                    '${insertData.question_text.replace(/'/g, "''")}',
                                    '${insertData.instructions ? insertData.instructions.replace(/'/g, "''") : ''}',
                                    ${insertData.points},
                                    ${insertData.options ? `'${JSON.stringify(insertData.options).replace(/'/g, "''")}'` : 'NULL'},
                                    ${insertData.correct_answer !== null ? `'${insertData.correct_answer}'` : 'NULL'},
                                    ${insertData.expected_response ? `'${insertData.expected_response.replace(/'/g, "''")}'` : 'NULL'},
                                    '${insertData.difficulty_level}',
                                    ${insertData.is_active},
                                    NOW(),
                                    NOW()
                                    ${insertData.word_limit ? `, ${insertData.word_limit}` : ''}
                                    ${insertData.assessment_criteria ? `, '${insertData.assessment_criteria.replace(/'/g, "''")}'` : ''}
                                )
                                RETURNING *
                            `
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log(' Assessment question created successfully:', result.data);
                    
                    // Show success message
                    showSuccess('Assessment question created successfully!');
                */
                }
                
                // Close modal and refresh list
                closeAssessmentQuestionModal();
                loadAssessmentQuestions();
                
            } catch (error) {
                const action = event.target.getAttribute('data-editing-id') ? 'updating' : 'creating';
                console.error(`Error ${action} assessment question:`, error);
                showError(`Failed to ${action.replace('ing', 'e')} assessment question: ${error.message}`);
            }
        }

        // Load assessment analytics
        function loadAssessmentAnalytics() {
            // Mock data for student performance
            const studentPerformance = [
                {
                    id: 1,
                    name: 'John Doe',
                    email: 'john.doe@example.com',
                    cefrLevel: 'B1',
                    reading: 75,
                    writing: 68,
                    listening: 82,
                    speaking: 71,
                    lastAssessment: '2024-01-20'
                },
                {
                    id: 2,
                    name: 'Maria Garcia',
                    email: 'maria.garcia@example.com',
                    cefrLevel: 'A2',
                    reading: 65,
                    writing: 58,
                    listening: 72,
                    speaking: 61,
                    lastAssessment: '2024-01-18'
                }
            ];
            
            const tableBody = document.getElementById('student-performance-table');
            tableBody.innerHTML = studentPerformance.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div>
                            <div class="font-medium">${student.name}</div>
                            <div class="text-gray-500">${student.email}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${student.cefrLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.reading}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.writing}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.listening}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.speaking}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(student.lastAssessment).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewStudentDetails(${student.id})">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load assessment settings
        function loadAssessmentSettings() {
            // Settings are already pre-filled in the HTML
            console.log('Assessment settings loaded');
        }

        // Edit assessment question
        async function editAssessmentQuestion(questionId) {
            console.log('Editing question:', questionId);
            
            try {
                // Fetch question data from database
                const { data: questions, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .select(`
                        id,
                        question_type,
                        cefr_level,
                        skill_type,
                        question_text,
                        instructions,
                        options,
                        correct_answer,
                        points,
                        difficulty_level,
                        expected_response
                    `)
                    .eq('id', questionId)
                    .eq('is_active', true);
                
                if (error) {
                    throw new Error(error.message);
                }
                
                if (questions.length === 0) {
                    showError('Question not found');
                    return;
                }
                
                const question = questions[0];
                
                // Transform database data to match expected format
                const transformedQuestion = {
                    id: question.id,
                    questionText: question.question_text,
                    questionType: question.question_type,
                    cefrLevel: question.cefr_level,
                    skillType: question.skill_type,
                    instructions: question.instructions,
                    options: question.options ? JSON.parse(question.options) : [],
                    correctAnswer: question.correct_answer,
                    points: question.points,
                    expectedResponse: question.expected_response
                };
            
                // Open the modal
                document.getElementById('assessmentQuestionModal').classList.remove('hidden');
                
                // Update modal title
                document.querySelector('#assessmentQuestionModal h3').textContent = 'Edit CEFR Assessment Question';
                
                // Populate the form with existing data
                document.getElementById('questionType').value = transformedQuestion.questionType;
                document.getElementById('questionCefrLevel').value = transformedQuestion.cefrLevel;
                document.getElementById('skillType').value = transformedQuestion.skillType;
                document.getElementById('assessmentQuestionText').value = transformedQuestion.questionText;
                document.getElementById('questionInstructions').value = transformedQuestion.instructions || '';
                document.getElementById('questionPoints').value = transformedQuestion.points;
                
                // Update question type fields based on the question type
                updateQuestionTypeFields();
                
                // Populate answer options based on question type
                setTimeout(() => {
                    if (transformedQuestion.questionType === 'multiple-choice' && transformedQuestion.options) {
                        const optionInputs = document.querySelectorAll('input[name="option"]');
                        transformedQuestion.options.forEach((option, index) => {
                            if (optionInputs[index]) {
                                optionInputs[index].value = option;
                            }
                        });
                        
                        // Set correct answer - find the index of the correct answer
                        if (transformedQuestion.correctAnswer !== undefined) {
                            const correctIndex = transformedQuestion.options.indexOf(transformedQuestion.correctAnswer);
                            if (correctIndex !== -1) {
                                const correctRadio = document.querySelector(`input[name="correctAnswer"][value="${correctIndex}"]`);
                                if (correctRadio) {
                                    correctRadio.checked = true;
                                }
                            }
                        }
                    } else if (transformedQuestion.questionType === 'true-false' && transformedQuestion.correctAnswer !== undefined) {
                        const tfRadio = document.querySelector(`input[name="tfCorrectAnswer"][value="${transformedQuestion.correctAnswer}"]`);
                        if (tfRadio) {
                            tfRadio.checked = true;
                        }
                    } else if (transformedQuestion.questionType === 'short-answer' && transformedQuestion.expectedResponse) {
                        const shortAnswerInput = document.getElementById('shortAnswer');
                        if (shortAnswerInput) {
                            shortAnswerInput.value = transformedQuestion.expectedResponse;
                        }
                    } else if (transformedQuestion.questionType === 'fill-in-blank' && transformedQuestion.correctAnswer) {
                        const fillBlankInput = document.getElementById('fillBlankAnswer');
                        if (fillBlankInput) {
                            fillBlankInput.value = transformedQuestion.correctAnswer;
                        }
                    } else if (transformedQuestion.questionType === 'essay' && transformedQuestion.expectedResponse) {
                        const essayRubricInput = document.getElementById('essayRubric');
                        if (essayRubricInput) {
                            essayRubricInput.value = transformedQuestion.expectedResponse;
                        }
                    } else if (['listening', 'speaking', 'reading'].includes(transformedQuestion.questionType) && transformedQuestion.expectedResponse) {
                        const expectedResponseInput = document.getElementById('expectedResponse');
                        if (expectedResponseInput) {
                            expectedResponseInput.value = transformedQuestion.expectedResponse;
                        }
                    }
                }, 100); // Small delay to ensure DOM is updated
                
                // Store the question ID for updating
                document.getElementById('assessmentQuestionForm').setAttribute('data-editing-id', questionId);
                
            } catch (error) {
                console.error('Error loading question for editing:', error);
                showError('Failed to load question data: ' + error.message);
            }
        }

        // Delete assessment question
        async function deleteAssessmentQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this assessment question?')) {
                return;
            }
            
            try {
                console.log('Deleting question:', questionId);
                
                const { data, error } = await supabaseAdmin
                    .from('cefr_assessment_questions')
                    .update({ 
                        is_active: false, 
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', questionId);
                
                if (error) {
                    throw new Error(error.message);
                }
                
                showSuccess('Assessment question deleted successfully!');
                loadAssessmentQuestions();
                
            } catch (error) {
                console.error('Error deleting assessment question:', error);
                showError('Failed to delete assessment question: ' + error.message);
            }
        }

        // View student details
        function viewStudentDetails(studentId) {
            console.log('Viewing student details:', studentId);
            // In a real implementation, this would open a detailed view of the student's assessment history
        }

        // ===== END CEFR ASSESSMENT FUNCTIONS =====

        // ===== COURSE MANAGEMENT FUNCTIONS =====

        // Course tab switching
        function switchCourseTab(tabName) {
            // Hide all course sub-tabs
            const tabs = ['course-overview', 'course-library', 'ai-creation', 'templates', 'version-control'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab + '-tab');
                if (element) element.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) selectedTab.classList.remove('hidden');
            
            // Update tab button styles
            document.querySelectorAll('.course-tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-white', 'text-gray-500', 'border-gray-300');
            });
            
            const activeBtn = document.querySelector(`[onclick="switchCourseTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-500', 'border-gray-300');
                activeBtn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }
        }

        // Course grid management
        function toggleCourseSelection(courseId) {
            const checkbox = document.querySelector(`input[data-course-id="${courseId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateBulkOperationsVisibility();
            }
        }

        function selectAllCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            updateBulkOperationsVisibility();
        }

        function updateBulkOperationsVisibility() {
            const checkedBoxes = document.querySelectorAll('.course-checkbox:checked');
            const bulkToolbar = document.getElementById('bulk-operations-toolbar');
            
            if (checkedBoxes.length > 0) {
                bulkToolbar.classList.remove('hidden');
                document.getElementById('selected-count').textContent = checkedBoxes.length;
            } else {
                bulkToolbar.classList.add('hidden');
            }
        }

        // Bulk operations
        function bulkPublishCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Publish ${selectedCourses.length} selected courses?`)) {
                console.log('Publishing courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses published successfully!`);
                clearCourseSelection();
            }
        }

        function bulkArchiveCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Archive ${selectedCourses.length} selected courses?`)) {
                console.log('Archiving courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses archived successfully!`);
                clearCourseSelection();
            }
        }

        function bulkDeleteCourses() {
            const selectedCourses = getSelectedCourses();
            if (selectedCourses.length === 0) return;
            
            if (confirm(`Delete ${selectedCourses.length} selected courses? This action cannot be undone.`)) {
                console.log('Deleting courses:', selectedCourses);
                showSuccess(`${selectedCourses.length} courses deleted successfully!`);
                clearCourseSelection();
            }
        }

        function getSelectedCourses() {
            const checkboxes = document.querySelectorAll('.course-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.getAttribute('data-course-id'));
        }

        function clearCourseSelection() {
            document.querySelectorAll('.course-checkbox').forEach(cb => cb.checked = false);
            updateBulkOperationsVisibility();
        }

        // Course actions
        // editCourse function is implemented above (line ~3968)

        function duplicateCourse(courseId) {
            console.log('Duplicating course:', courseId);
            showSuccess('Course duplicated successfully!');
        }



        function viewCourseAnalytics(courseId) {
            console.log('Viewing analytics for course:', courseId);
            // Open analytics modal
        }

        // AI Course Generation
        function generateAICourse() {
            const topicElement = document.getElementById('ai-topic');
            const levelElement = document.getElementById('ai-level');
            const durationElement = document.getElementById('ai-duration');
            const focusElement = document.getElementById('ai-focus');
            
            if (!topicElement || !levelElement || !durationElement || !focusElement) {
                showError('AI course generation form fields not found');
                return;
            }
            
            const topic = topicElement.value;
            const level = levelElement.value;
            const duration = durationElement.value;
            const focus = focusElement.value;
            
            if (!topic || !level || !duration || !focus) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Show loading state
            const generateBtn = document.querySelector('button[onclick="generateAICourse()"]');
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            // Simulate AI generation
            setTimeout(() => {
                console.log('Generating AI course:', { topic, level, duration, focus });
                showSuccess('AI course generated successfully!');
                
                // Reset button
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
                
                // Clear form
                document.getElementById('ai-course-form').reset();
            }, 3000);
        }

        function generateCurriculum() {
            const objectives = document.getElementById('curriculum-objectives').value;
            const level = document.getElementById('curriculum-level').value;
            const weeks = document.getElementById('curriculum-weeks').value;
            
            if (!objectives || !level || !weeks) {
                showError('Please fill in all required fields');
                return;
            }
            
            console.log('Generating curriculum:', { objectives, level, weeks });
            showSuccess('Curriculum generated successfully!');
        }

        function translateContent() {
            const sourceLanguage = document.getElementById('source-language').value;
            const targetLanguage = document.getElementById('target-language').value;
            const content = document.getElementById('content-to-translate').value;
            
            if (!sourceLanguage || !targetLanguage || !content) {
                showError('Please fill in all required fields');
                return;
            }
            
            console.log('Translating content:', { sourceLanguage, targetLanguage, content });
            showSuccess('Content translated successfully!');
        }

        function getContentRecommendations() {
            const courseType = document.getElementById('recommendation-course-type').value;
            const targetAudience = document.getElementById('recommendation-audience').value;
            
            if (!courseType || !targetAudience) {
                showError('Please select course type and target audience');
                return;
            }
            
            console.log('Getting recommendations:', { courseType, targetAudience });
            showSuccess('Content recommendations generated!');
        }

        // Template management
        function useTemplate(templateId) {
            console.log('Using template:', templateId);
            showSuccess('Template applied successfully!');
        }

        function editTemplate(templateId) {
            console.log('Editing template:', templateId);
            // Open template editor
        }

        function deleteTemplate(templateId) {
            if (confirm('Are you sure you want to delete this template?')) {
                console.log('Deleting template:', templateId);
                showSuccess('Template deleted successfully!');
            }
        }

        function createNewTemplate() {
            console.log('Creating new template');
            // Open template creation wizard
        }

        function importTemplate() {
            console.log('Importing template');
            // Open file picker
        }

        function exportTemplate(templateId) {
            console.log('Exporting template:', templateId);
            showSuccess('Template exported successfully!');
        }

        // Version control
        function viewVersion(versionId) {
            console.log('Viewing version:', versionId);
            // Open version viewer
        }

        function rollbackToVersion(versionId) {
            if (confirm('Are you sure you want to rollback to this version?')) {
                console.log('Rolling back to version:', versionId);
                showSuccess('Successfully rolled back to selected version!');
            }
        }

        function downloadVersion(versionId) {
            console.log('Downloading version:', versionId);
            showSuccess('Version downloaded successfully!');
        }

        function compareVersions() {
            console.log('Comparing versions');
            // Open version comparison tool
        }

        // Course library management
        function importCourse() {
            console.log('Importing course');
            // Open file picker
        }

        function exportCourse(courseId) {
            console.log('Exporting course:', courseId);
            showSuccess('Course exported successfully!');
        }

        function syncWithLibrary() {
            console.log('Syncing with library');
            showSuccess('Library synchronized successfully!');
        }

        // Show course sub-tab function
        function showCourseSubTab(tabName) {
            // Hide all sub-tab content
            const subTabs = document.querySelectorAll('[id^="course-"]');
            subTabs.forEach(tab => {
                if (tab.id.includes('-content') || tab.id.includes('-tab')) {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                }
            });
            
            // Show the selected sub-tab
            const targetTab = document.getElementById(`course-${tabName}`);
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
            
            // Update sub-tab navigation buttons
            const navButtons = document.querySelectorAll('button[onclick*="showCourseSubTab"]');
            navButtons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // Highlight active button
            const activeButton = document.querySelector(`button[onclick="showCourseSubTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-100', 'text-gray-700');
                activeButton.classList.add('bg-blue-600', 'text-white');
            }
            
            console.log('Switched to course sub-tab:', tabName);
        }

        // Initialize course management
        function initializeCourseManagement() {
            // Set default active tab
            switchCourseTab('course-overview');
            
            // Initialize event listeners
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('course-checkbox')) {
                    updateBulkOperationsVisibility();
                }
            });
            
            console.log('Course management initialized');
        }

        // ===== END COURSE MANAGEMENT FUNCTIONS =====
        
        // Image management functions for lesson materials
        async function toggleImageSourceFields(selectElement) {
            const contentItem = selectElement.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const fileInput = fieldsContainer.querySelector('.content-file');
            const existingSelect = fieldsContainer.querySelector('.existing-image-select');
            
            if (selectElement.value === 'existing') {
                fileInput.style.display = 'none';
                existingSelect.style.display = 'block';
                await populateExistingImages(existingSelect);
            } else {
                fileInput.style.display = 'block';
                existingSelect.style.display = 'none';
            }
        }

        async function populateExistingImages(selectElement) {
            try {
                selectElement.innerHTML = '<option value="">Loading existing images...</option>';
                
                // Recursively list all files in course-materials bucket
                let allFiles = [];
                
                if (window.isElectron) {
                    // For Electron - assume it returns all files recursively
                    const result = await window.electronAPI.invoke('db:listFiles', 'course-materials');
                    if (result.success) {
                        allFiles = result.result;
                    }
                } else {
                    // For browser - need to recursively explore folders
                    const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                    allFiles = await listAllFilesRecursively(client, 'course-materials', '');
                }
                
                // Filter for image files
                const imageFiles = allFiles.filter(file => {
                    if (!file.name) return false;
                    const ext = file.name.toLowerCase().split('.').pop();
                    return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext);
                });
                
                // Clear loading option and populate with images
                selectElement.innerHTML = '<option value="">Select an existing image...</option>';
                
                if (imageFiles.length === 0) {
                    selectElement.innerHTML = '<option value="">No existing images found</option>';
                    return;
                }
                
                // Group images by path for better organization
                const groupedImages = {};
                imageFiles.forEach(file => {
                    const pathParts = file.name.split('/');
                    let groupKey = 'root';
                    
                    // Check if it's organized in folders (e.g., reading/lesson_1/, course_name/lesson_1/)
                    if (pathParts.length > 1) {
                        if (pathParts.length === 3) {
                            // Format: folder/lesson_x/filename
                            groupKey = `${pathParts[0]}/${pathParts[1]}`;
                        } else if (pathParts.length === 2) {
                            // Format: folder/filename
                            groupKey = pathParts[0];
                        }
                    }
                    
                    if (!groupedImages[groupKey]) {
                        groupedImages[groupKey] = [];
                    }
                    groupedImages[groupKey].push(file);
                });
                
                // Add grouped options
                Object.keys(groupedImages).sort().forEach(group => {
                    if (group !== 'root') {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = group.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        selectElement.appendChild(optgroup);
                        
                        groupedImages[group].forEach(file => {
                            const option = document.createElement('option');
                            const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                            const { data: { publicUrl } } = client.storage
                                .from('course-materials')
                                .getPublicUrl(file.name);
                            
                            option.value = publicUrl;
                            // Show just the filename for cleaner display
                            const fileName = file.name.split('/').pop();
                            option.textContent = fileName;
                            optgroup.appendChild(option);
                        });
                    }
                });
                
                // Add ungrouped files
                if (groupedImages['root']) {
                    groupedImages['root'].forEach(file => {
                        const option = document.createElement('option');
                        const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                        const { data: { publicUrl } } = client.storage
                            .from('course-materials')
                            .getPublicUrl(file.name);
                        
                        option.value = publicUrl;
                        option.textContent = file.name;
                        selectElement.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error loading existing images:', error);
                selectElement.innerHTML = '<option value="">Error loading images</option>';
            }
        }

        // Recursive helper function to list all files in a bucket
        async function listAllFilesRecursively(client, bucket, prefix = '') {
            const allFiles = [];
            const folders = [];
            
            try {
                const { data, error } = await client.storage
                    .from(bucket)
                    .list(prefix, { limit: 1000 });
                
                if (error) {
                    console.error('Error listing files at prefix:', prefix, error);
                    return allFiles;
                }
                
                if (!data) return allFiles;
                
                // Separate files from folders
                data.forEach(item => {
                    if (item.id === null) {
                        // This is a folder
                        folders.push(item.name);
                    } else {
                        // This is a file - add the full path
                        allFiles.push({
                            ...item,
                            name: prefix ? `${prefix}/${item.name}` : item.name
                        });
                    }
                });
                
                // Recursively process folders
                for (const folder of folders) {
                    const subPrefix = prefix ? `${prefix}/${folder}` : folder;
                    const subFiles = await listAllFilesRecursively(client, bucket, subPrefix);
                    allFiles.push(...subFiles);
                }
                
            } catch (error) {
                console.error('Error in recursive file listing:', error);
            }
            
            return allFiles;
        }

        async function handleExistingImageSelect(selectElement) {
            if (!selectElement.value) return;
            
            const contentItem = selectElement.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            
            // Create or update image preview
            let preview = fieldsContainer.querySelector('.image-loaded-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'image-loaded-preview mt-3';
                preview.innerHTML = `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="flex items-start justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-600">Selected Image</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                    Replace
                                </button>
                                <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                    <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview">
                        <input type="hidden" class="current-image-url" value="">
                        <input type="hidden" class="material-id" value="">
                    </div>
                `;
                fieldsContainer.appendChild(preview);
                lucide.createIcons();
            }
            
            // Show selected image
            const imgEl = preview.querySelector('img');
            const currentUrlInput = preview.querySelector('.current-image-url');
            
            if (imgEl) {
                imgEl.src = selectElement.value;
                preview.style.display = 'block';
            }
            
            if (currentUrlInput) {
                currentUrlInput.value = selectElement.value;
            }
        }

        function handleImageUpload(fileInput) {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const contentItem = fileInput.closest('.content-item');
                const fieldsContainer = contentItem.querySelector('.content-fields');
                
                // Create or update image preview
                let preview = fieldsContainer.querySelector('.image-loaded-preview');
                if (!preview) {
                    preview = document.createElement('div');
                    preview.className = 'image-loaded-preview mt-3';
                    preview.innerHTML = `
                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <div class="flex items-start justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-600">Image Preview</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="replaceImage(this)" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                                        Replace
                                    </button>
                                    <button type="button" onclick="deleteImage(this)" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <img class="max-h-40 w-auto rounded border shadow-sm" alt="Image preview">
                            <input type="hidden" class="current-image-url" value="">
                            <input type="hidden" class="material-id" value="">
                        </div>
                    `;
                    fieldsContainer.appendChild(preview);
                    lucide.createIcons();
                }
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgEl = preview.querySelector('img');
                    if (imgEl) {
                        imgEl.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function replaceImage(button) {
            const contentItem = button.closest('.content-item');
            const replaceInput = contentItem.querySelector('.replace-file-input');
            if (replaceInput) {
                replaceInput.click();
            }
        }

        async function handleImageReplace(replaceInput) {
            if (!replaceInput.files || !replaceInput.files[0]) return;

            const newFile = replaceInput.files[0];
            const contentItem = replaceInput.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const currentUrlInput = fieldsContainer.querySelector('.current-image-url');
            const materialIdInput = fieldsContainer.querySelector('.material-id');
            const preview = fieldsContainer.querySelector('.image-loaded-preview');

            try {
                // Get lesson index for upload path
                const lessonItem = contentItem.closest('.lesson-item');
                const allLessons = document.querySelectorAll('.lesson-item');
                const lessonIndex = Array.from(allLessons).indexOf(lessonItem);

                // Upload new file
                const newUrl = await uploadSingleFile(newFile, 'lessons', 'Course Content', `lesson_${lessonIndex + 1}`, lessonIndex);

                // Delete old file if it exists
                const oldUrl = currentUrlInput.value;
                if (oldUrl) {
                    await deleteImageFromStorage(oldUrl);
                }

                // Update UI and hidden inputs
                const imgEl = preview.querySelector('img');
                if (imgEl) {
                    imgEl.src = newUrl;
                }
                currentUrlInput.value = newUrl;

                // Update database if material exists
                const materialId = materialIdInput.value;
                if (materialId) {
                    await updateMaterialUrl(materialId, newUrl);
                }

                // Clear the replace input
                replaceInput.value = '';
                showSuccess('Image replaced successfully!');
            } catch (error) {
                console.error('Error replacing image:', error);
                showError('Failed to replace image: ' + error.message);
            }
        }

        async function deleteImage(button) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            const contentItem = button.closest('.content-item');
            const fieldsContainer = contentItem.querySelector('.content-fields');
            const currentUrlInput = fieldsContainer.querySelector('.current-image-url');
            const materialIdInput = fieldsContainer.querySelector('.material-id');
            const preview = fieldsContainer.querySelector('.image-loaded-preview');
            const fileInput = fieldsContainer.querySelector('.content-file');

            try {
                // Delete from storage if URL exists
                const currentUrl = currentUrlInput.value;
                if (currentUrl) {
                    await deleteImageFromStorage(currentUrl);
                }

                // Delete from database if material exists
                const materialId = materialIdInput.value;
                if (materialId) {
                    await deleteMaterialFromDatabase(materialId);
                }

                // Clear UI
                if (preview) {
                    preview.style.display = 'none';
                }
                if (fileInput) {
                    fileInput.value = '';
                }
                currentUrlInput.value = '';
                materialIdInput.value = '';

                showSuccess('Image deleted successfully!');
            } catch (error) {
                console.error('Error deleting image:', error);
                showError('Failed to delete image: ' + error.message);
            }
        }

        async function deleteImageFromStorage(imageUrl) {
            try {
                // Extract file path from URL
                const urlParts = imageUrl.split('/storage/v1/object/public/course-materials/');
                if (urlParts.length !== 2) {
                    console.warn('Could not extract file path from URL:', imageUrl);
                    return;
                }
                
                const filePath = urlParts[1];
                
                // Use admin client for deletion if available
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                if (window.isElectron) {
                    // Use IPC for Electron environment
                    const result = await window.electronAPI.invoke('db:deleteFile', 'course-materials', filePath);
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                } else {
                    // Direct Supabase API call
                    const { error } = await client.storage
                        .from('course-materials')
                        .remove([filePath]);
                    
                    if (error) {
                        throw error;
                    }
                }
                
                console.log(' File deleted from storage:', filePath);
            } catch (error) {
                console.error(' Error deleting file from storage:', error);
                throw error;
            }
        }

        async function updateMaterialUrl(materialId, newUrl) {
            try {
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                const { error } = await client
                    .from('lesson_materials')
                    .update({ url: newUrl })
                    .eq('id', materialId);
                
                if (error) {
                    throw error;
                }
                
                console.log(' Material URL updated in database');
            } catch (error) {
                console.error(' Error updating material URL:', error);
                throw error;
            }
        }

        async function deleteMaterialFromDatabase(materialId) {
            try {
                const client = window.supabaseAdminClient || window.supabaseClient || supabase;
                
                const { error } = await client
                    .from('lesson_materials')
                    .delete()
                    .eq('id', materialId);
                
                if (error) {
                    throw error;
                }
                
                console.log(' Material deleted from database');
            } catch (error) {
                console.error(' Error deleting material from database:', error);
                throw error;
            }
        }

    </script>
</body>
</html>